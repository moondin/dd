---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 944
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 944 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0354_alter_realm_message_content_delete_limit_seconds.py]---
Location: zulip-main/zerver/migrations/0354_alter_realm_message_content_delete_limit_seconds.py
Signals: Django

```python
# Generated by Django 3.2.4 on 2021-06-14 12:12

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def make_zero_invalid_for_message_delete_limit(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.DEFAULT_MESSAGE_CONTENT_DELETE_LIMIT_SECONDS = 600

    Realm.objects.filter(
        allow_message_deleting=True, message_content_delete_limit_seconds=0
    ).update(message_content_delete_limit_seconds=None)

    Realm.objects.filter(
        allow_message_deleting=False, message_content_delete_limit_seconds=0
    ).update(
        message_content_delete_limit_seconds=Realm.DEFAULT_MESSAGE_CONTENT_DELETE_LIMIT_SECONDS
    )


def reverse_make_zero_invalid_for_message_delete_limit(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.DEFAULT_MESSAGE_CONTENT_DELETE_LIMIT_SECONDS = 600

    Realm.objects.filter(
        allow_message_deleting=True, message_content_delete_limit_seconds=None
    ).update(message_content_delete_limit_seconds=0)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0353_remove_realm_default_twenty_four_hour_time"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="message_content_delete_limit_seconds",
            field=models.IntegerField(default=600, null=True),
        ),
        migrations.RunPython(
            make_zero_invalid_for_message_delete_limit,
            reverse_code=reverse_make_zero_invalid_for_message_delete_limit,
            elidable=True,
        ),
        migrations.AlterField(
            model_name="realm",
            name="message_content_delete_limit_seconds",
            field=models.PositiveIntegerField(default=600, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0355_realm_delete_own_message_policy.py]---
Location: zulip-main/zerver/migrations/0355_realm_delete_own_message_policy.py
Signals: Django

```python
# Generated by Django 3.2.4 on 2021-06-09 10:00

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0354_alter_realm_message_content_delete_limit_seconds"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="delete_own_message_policy",
            field=models.PositiveSmallIntegerField(default=5),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0356_migrate_to_delete_own_message_policy.py]---
Location: zulip-main/zerver/migrations/0356_migrate_to_delete_own_message_policy.py
Signals: Django

```python
# Generated by Django 3.2.4 on 2021-06-09 10:02

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def migrate_to_delete_own_message_policy(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.POLICY_EVERYONE = 5
    Realm.POLICY_ADMINS_ONLY = 2
    Realm.objects.filter(allow_message_deleting=False).update(
        delete_own_message_policy=Realm.POLICY_ADMINS_ONLY
    )
    Realm.objects.filter(allow_message_deleting=True).update(
        delete_own_message_policy=Realm.POLICY_EVERYONE
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0355_realm_delete_own_message_policy"),
    ]

    operations = [
        migrations.RunPython(
            migrate_to_delete_own_message_policy,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0357_remove_realm_allow_message_deleting.py]---
Location: zulip-main/zerver/migrations/0357_remove_realm_allow_message_deleting.py
Signals: Django

```python
# Generated by Django 3.2.4 on 2021-06-09 13:17

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0356_migrate_to_delete_own_message_policy"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="allow_message_deleting",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0358_split_create_stream_policy.py]---
Location: zulip-main/zerver/migrations/0358_split_create_stream_policy.py
Signals: Django

```python
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F


def copy_stream_policy_field(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.all().update(create_public_stream_policy=F("create_stream_policy"))
    Realm.objects.all().update(create_private_stream_policy=F("create_stream_policy"))


# When reversing the migration, we have to pick one of the new fields
# to store in the original field name. This does destroy information,
# but in most cases downgrades that would reverse migrations happen
# before any real usage, so it's very likely that both values are
# identical.
def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.all().update(create_stream_policy=F("create_public_stream_policy"))


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0357_remove_realm_allow_message_deleting"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="create_private_stream_policy",
            field=models.PositiveSmallIntegerField(default=1),
        ),
        migrations.AddField(
            model_name="realm",
            name="create_public_stream_policy",
            field=models.PositiveSmallIntegerField(default=1),
        ),
        migrations.RunPython(copy_stream_policy_field, reverse_code=reverse_code, elidable=True),
        migrations.RemoveField(
            model_name="realm",
            name="create_stream_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0359_re2_linkifiers.py]---
Location: zulip-main/zerver/migrations/0359_re2_linkifiers.py
Signals: Django

```python
import re2
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def delete_re2_invalid(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    options = re2.Options()
    options.log_errors = False

    RealmFilter = apps.get_model("zerver", "RealmFilter")
    found_errors = False
    for linkifier in RealmFilter.objects.all().iterator():
        try:
            re2.compile(linkifier.pattern, options=options)
        except re2.error:
            if not found_errors:
                print()
            found_errors = True
            print(
                f"Deleting linkifier {linkifier.id} in realm {linkifier.realm.string_id} which is not compatible with new re2 engine:"
            )
            print(f"  {linkifier.pattern} -> {linkifier.url_format_string}")
            linkifier.delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0325_alter_realmplayground_unique_together"),
    ]

    operations = [
        migrations.RunPython(
            delete_re2_invalid,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0360_merge_0358_0359.py]---
Location: zulip-main/zerver/migrations/0360_merge_0358_0359.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-04 17:49

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0358_split_create_stream_policy"),
        ("zerver", "0359_re2_linkifiers"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0361_realm_create_web_public_stream_policy.py]---
Location: zulip-main/zerver/migrations/0361_realm_create_web_public_stream_policy.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-04 06:23

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0360_merge_0358_0359"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="create_web_public_stream_policy",
            field=models.PositiveSmallIntegerField(default=7),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0362_send_typing_notifications_user_setting.py]---
Location: zulip-main/zerver/migrations/0362_send_typing_notifications_user_setting.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-03 07:09

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0361_realm_create_web_public_stream_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="send_private_typing_notifications",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="realmuserdefault",
            name="send_stream_typing_notifications",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="send_private_typing_notifications",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="send_stream_typing_notifications",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0363_send_read_receipts_user_setting.py]---
Location: zulip-main/zerver/migrations/0363_send_read_receipts_user_setting.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-03 07:12

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0362_send_typing_notifications_user_setting"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="send_read_receipts",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="send_read_receipts",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0364_rename_members_usergroup_direct_members.py]---
Location: zulip-main/zerver/migrations/0364_rename_members_usergroup_direct_members.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-12 21:09

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0363_send_read_receipts_user_setting"),
    ]

    operations = [
        migrations.RenameField(
            model_name="usergroup",
            old_name="members",
            new_name="direct_members",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0365_alter_user_group_related_fields.py]---
Location: zulip-main/zerver/migrations/0365_alter_user_group_related_fields.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-10 10:13

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0364_rename_members_usergroup_direct_members"),
    ]

    operations = [
        migrations.AlterField(
            model_name="usergroup",
            name="direct_members",
            field=models.ManyToManyField(
                related_name="direct_groups",
                through="zerver.UserGroupMembership",
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AlterField(
            model_name="usergroupmembership",
            name="user_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
        migrations.AlterField(
            model_name="usergroupmembership",
            name="user_profile",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="+",
                to=settings.AUTH_USER_MODEL,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0366_group_group_membership.py]---
Location: zulip-main/zerver/migrations/0366_group_group_membership.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-09-29 23:34

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0365_alter_user_group_related_fields"),
    ]

    operations = [
        migrations.CreateModel(
            name="GroupGroupMembership",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "subgroup",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="+",
                        to="zerver.usergroup",
                    ),
                ),
                (
                    "supergroup",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="+",
                        to="zerver.usergroup",
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="usergroup",
            name="direct_subgroups",
            field=models.ManyToManyField(
                related_name="direct_supergroups",
                through="zerver.GroupGroupMembership",
                through_fields=("supergroup", "subgroup"),
                to="zerver.UserGroup",
            ),
        ),
        migrations.AddConstraint(
            model_name="groupgroupmembership",
            constraint=models.UniqueConstraint(
                fields=("supergroup", "subgroup"), name="zerver_groupgroupmembership_uniq"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0367_scimclient.py]---
Location: zulip-main/zerver/migrations/0367_scimclient.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-03 18:04

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0366_group_group_membership"),
    ]

    operations = [
        migrations.CreateModel(
            name="SCIMClient",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "name",
                    models.TextField(),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
            options={
                "unique_together": {("realm", "name")},
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0368_alter_realmfilter_url_format_string.py]---
Location: zulip-main/zerver/migrations/0368_alter_realmfilter_url_format_string.py
Signals: Django

```python
# Generated by Django 3.2.8 on 2021-10-20 23:42

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0367_scimclient"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0369_add_escnav_default_display_user_setting.py]---
Location: zulip-main/zerver/migrations/0369_add_escnav_default_display_user_setting.py
Signals: Django

```python
# Generated by Django 3.2.8 on 2021-10-25 12:12

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0368_alter_realmfilter_url_format_string"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="escape_navigates_to_default_view",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="escape_navigates_to_default_view",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0370_realm_enable_spectator_access.py]---
Location: zulip-main/zerver/migrations/0370_realm_enable_spectator_access.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-06 11:42

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0369_add_escnav_default_display_user_setting"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="enable_spectator_access",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0371_invalid_characters_in_topics.py]---
Location: zulip-main/zerver/migrations/0371_invalid_characters_in_topics.py
Signals: Django

```python
import unicodedata

from django.db import connection, migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

# There are 66 Unicode non-characters; see
# https://www.unicode.org/faq/private_use.html#nonchar4
unicode_non_chars = {
    chr(x)
    for r in [
        range(0xFDD0, 0xFDF0),  # FDD0 through FDEF, inclusive
        range(0xFFFE, 0x110000, 0x10000),  # 0xFFFE, 0x1FFFE, ... 0x10FFFE inclusive
        range(0xFFFF, 0x110000, 0x10000),  # 0xFFFF, 0x1FFFF, ... 0x10FFFF inclusive
    ]
    for x in r
}


def character_is_printable(character: str) -> bool:
    return not (unicodedata.category(character) in ["Cc", "Cs"] or character in unicode_non_chars)


def fix_topics(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Message = apps.get_model("zerver", "Message")
    BATCH_SIZE = 10000
    messages_updated = 0
    lower_bound = 0

    max_id = Message.objects.aggregate(models.Max("id"))["id__max"]
    if max_id is None:
        # Nothing to do if there are no messages.
        return

    print()
    while lower_bound < max_id:
        print(f"Processed {lower_bound} / {max_id}")
        with connection.cursor() as cursor:
            cursor.execute(
                "SELECT DISTINCT subject FROM zerver_message WHERE id > %s AND id <= %s",
                [lower_bound, lower_bound + BATCH_SIZE],
            )

            results = cursor.fetchall()

            topics = [r[0] for r in results]
            for topic in topics:
                fixed_topic = "".join(
                    character for character in topic if character_is_printable(character)
                )
                if fixed_topic == topic:
                    continue

                # We don't want empty topics for stream messages, so we
                # use (no topic) if the above clean-up leaves us with an empty string.
                if fixed_topic == "":
                    fixed_topic = "(no topic)"

                cursor.execute(
                    "UPDATE zerver_message SET subject = %s WHERE subject = %s AND id > %s AND id <= %s",
                    [fixed_topic, topic, lower_bound, lower_bound + BATCH_SIZE],
                )
                messages_updated += cursor.rowcount
            lower_bound += BATCH_SIZE

    if messages_updated > 0:
        print(f"Fixed invalid topics for {messages_updated} messages.")


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0370_realm_enable_spectator_access"),
    ]

    operations = [
        migrations.RunPython(fix_topics, reverse_code=migrations.RunPython.noop, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0372_realmemoji_unique_realm_emoji_when_false_deactivated.py]---
Location: zulip-main/zerver/migrations/0372_realmemoji_unique_realm_emoji_when_false_deactivated.py
Signals: Django

```python
# Generated by Django 3.2.9 on 2021-12-09 19:46

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0371_invalid_characters_in_topics"),
    ]

    operations = [
        migrations.AddConstraint(
            model_name="realmemoji",
            constraint=models.UniqueConstraint(
                condition=models.Q(("deactivated", False)),
                fields=("realm", "name"),
                name="unique_realm_emoji_when_false_deactivated",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0373_fix_deleteduser_dummies.py]---
Location: zulip-main/zerver/migrations/0373_fix_deleteduser_dummies.py
Signals: Django

```python
from email.headerregistry import Address
from typing import Any

from django.conf import settings
from django.core.exceptions import ValidationError
from django.core.validators import validate_email
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def host_for_subdomain(subdomain: str) -> str:
    if subdomain == "":
        return settings.EXTERNAL_HOST
    default_host = f"{subdomain}.{settings.EXTERNAL_HOST}"
    return settings.REALM_HOSTS.get(subdomain, default_host)


def get_fake_email_domain(realm: Any) -> str:
    """
    Taken from zerver.models. Adjusted to work in a migration without changing
    behavior.
    """
    try:
        # Check that realm.host can be used to form valid email addresses.
        realm_host = host_for_subdomain(realm.string_id)
        validate_email(Address(username="bot", domain=realm_host).addr_spec)
        return realm_host
    except ValidationError:
        pass

    try:
        # Check that the fake email domain can be used to form valid email addresses.
        validate_email(Address(username="bot", domain=settings.FAKE_EMAIL_DOMAIN).addr_spec)
    except ValidationError:
        raise Exception(
            settings.FAKE_EMAIL_DOMAIN + " is not a valid domain. "
            "Consider setting the FAKE_EMAIL_DOMAIN setting."
        )

    return settings.FAKE_EMAIL_DOMAIN


def fix_dummy_users(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """
    do_delete_users had two bugs:
    1. Creating the replacement dummy users with active=True
    2. Creating the replacement dummy users with email domain set to realm.url,
    which may not be a valid email domain.
    Prior commits fixed the bugs, and this migration fixes the pre-existing objects.
    """

    UserProfile = apps.get_model("zerver", "UserProfile")
    Subscription = apps.get_model("zerver", "Subscription")
    users_to_fix = UserProfile.objects.filter(
        is_mirror_dummy=True, is_active=True, delivery_email__regex=r"^deleteduser\d+@.+"
    )

    update_fields = ["is_active"]
    for user_profile in users_to_fix:
        user_profile.is_active = False
        try:
            validate_email(user_profile.delivery_email)
        except ValidationError:
            user_profile.delivery_email = Address(
                username=f"deleteduser{user_profile.id}",
                domain=get_fake_email_domain(user_profile.realm),
            ).addr_spec

            update_fields.append("delivery_email")

    UserProfile.objects.bulk_update(users_to_fix, update_fields)
    # The denormalized is_user_active field needs to be updated too.
    Subscription.objects.filter(user_profile__in=users_to_fix).update(is_user_active=False)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0372_realmemoji_unique_realm_emoji_when_false_deactivated"),
    ]

    operations = [
        migrations.RunPython(
            fix_dummy_users,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0374_backfill_user_delete_realmauditlog.py]---
Location: zulip-main/zerver/migrations/0374_backfill_user_delete_realmauditlog.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def backfill_user_deleted_logs(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.USER_DELETED = 106

    UserProfile = apps.get_model("zerver", "UserProfile")

    objects_to_create = []
    for user_profile in UserProfile.objects.filter(
        is_mirror_dummy=True, is_active=False, delivery_email__regex=r"^deleteduser\d+@.+"
    ):
        entry = RealmAuditLog(
            realm_id=user_profile.realm_id,
            modified_user=user_profile,
            acting_user=user_profile,
            event_type=RealmAuditLog.USER_DELETED,
            # For old dummy users, the date_joined is the time of the deletion.
            event_time=user_profile.date_joined,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RealmAuditLog.objects.bulk_create(objects_to_create)


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.USER_DELETED = 106

    RealmAuditLog.objects.filter(event_type=RealmAuditLog.USER_DELETED, backfilled=True).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0373_fix_deleteduser_dummies"),
    ]

    operations = [
        migrations.RunPython(
            backfill_user_deleted_logs,
            reverse_code=reverse_code,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0375_invalid_characters_in_stream_names.py]---
Location: zulip-main/zerver/migrations/0375_invalid_characters_in_stream_names.py
Signals: Django

```python
import unicodedata

from django.db import connection, migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

# There are 66 Unicode non-characters; see
# https://www.unicode.org/faq/private_use.html#nonchar4
unicode_non_chars = {
    chr(x)
    for r in [
        range(0xFDD0, 0xFDF0),  # FDD0 through FDEF, inclusive
        range(0xFFFE, 0x110000, 0x10000),  # 0xFFFE, 0x1FFFE, ... 0x10FFFE inclusive
        range(0xFFFF, 0x110000, 0x10000),  # 0xFFFF, 0x1FFFF, ... 0x10FFFF inclusive
    ]
    for x in r
}


def character_is_printable(character: str) -> bool:
    return not (unicodedata.category(character) in ["Cc", "Cs"] or character in unicode_non_chars)


def fix_stream_names(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Stream = apps.get_model("zerver", "Stream")
    Realm = apps.get_model("zerver", "Realm")

    total_fixed_count = 0
    realm_ids = Realm.objects.values_list("id", flat=True)
    if len(realm_ids) == 0:
        return

    print()
    for realm_id in realm_ids:
        print(f"Processing realm {realm_id}")
        realm_stream_dicts = Stream.objects.filter(realm_id=realm_id).values("id", "name")
        occupied_stream_names = {stream_dict["name"] for stream_dict in realm_stream_dicts}

        for stream_dict in realm_stream_dicts:
            stream_name = stream_dict["name"]
            fixed_stream_name = "".join(
                [
                    character if character_is_printable(character) else "\N{REPLACEMENT CHARACTER}"
                    for character in stream_name
                ]
            )

            if fixed_stream_name == stream_name:
                continue

            if fixed_stream_name == "":
                fixed_stream_name = "(no name)"

            # The process of stripping invalid characters can lead to collisions,
            # with the new stream name being the same as the name of another existing stream.
            # We append underscore until the name no longer conflicts.
            while fixed_stream_name in occupied_stream_names:
                fixed_stream_name += "_"

            occupied_stream_names.add(fixed_stream_name)
            total_fixed_count += 1
            with connection.cursor() as cursor:
                cursor.execute(
                    "UPDATE zerver_stream SET name = %s WHERE id = %s",
                    [fixed_stream_name, stream_dict["id"]],
                )

    print(f"Fixed {total_fixed_count} stream names")


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0374_backfill_user_delete_realmauditlog"),
    ]

    operations = [
        migrations.RunPython(
            fix_stream_names,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0376_set_realmemoji_author_and_reupload_realmemoji.py]---
Location: zulip-main/zerver/migrations/0376_set_realmemoji_author_and_reupload_realmemoji.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef, Subquery


def set_emoji_author(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """
    This migration establishes the invariant that all RealmEmoji objects have .author set
    and queues events for reuploading all RealmEmoji.
    """

    RealmEmoji = apps.get_model("zerver", "RealmEmoji")
    UserProfile = apps.get_model("zerver", "UserProfile")
    ROLE_REALM_OWNER = 100

    RealmEmoji.objects.filter(author=None).update(
        author=Subquery(
            UserProfile.objects.filter(
                realm=OuterRef("realm"), is_active=True, role=ROLE_REALM_OWNER
            )
            .order_by("id")[:1]
            .values("pk")
        )
    )

    # Previously, this also pushed `reupload_realm_emoji` events onto
    # the `deferred_work` queue; however,
    # https://github.com/zulip/zulip/issues/21608 made those possibly
    # run too early, and that work was repeated in migration 0387 to
    # ensure it ran.  As such, the work has been removed from this
    # migration, so it does not unnecessarily run twice.


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0375_invalid_characters_in_stream_names"),
    ]

    operations = [
        migrations.RunPython(
            set_emoji_author, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0377_message_edit_history_format.py]---
Location: zulip-main/zerver/migrations/0377_message_edit_history_format.py
Signals: Django

```python
import time
from typing import Any, TypedDict

import orjson
from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Min

BATCH_SIZE = 10000
STREAM = 2


# Legacy TypedDict has "prev_topic" field for any edit_history entries that
# were saved to the database after the legacy "prev_subject" field stopped
# being written to the database in the pre-migration commit.
class LegacyEditHistoryEvent(TypedDict, total=False):
    user_id: int
    timestamp: int
    prev_stream: int
    prev_subject: str
    prev_topic: str
    prev_content: str
    prev_rendered_content: str | None
    prev_rendered_content_version: int | None


class EditHistoryEvent(TypedDict, total=False):
    user_id: int | None
    timestamp: int
    prev_stream: int
    stream: int
    prev_topic: str
    topic: str
    prev_content: str
    prev_rendered_content: str | None
    prev_rendered_content_version: int | None


@transaction.atomic
def backfill_message_edit_history_chunk(
    first_id: int, last_id: int, message_model: type[Any]
) -> None:
    """
    Migrate edit history events for the messages in the provided range to:
    * Rename prev_subject => prev_topic.
    * Provide topic and stream fields with the current values.

    The range of message IDs to be processed is inclusive on both ends.
    """
    messages = (
        message_model.objects.select_for_update()
        .only(
            "recipient",
            "recipient__type",
            "recipient__type_id",
            "subject",
            "edit_history",
        )
        .filter(edit_history__isnull=False, id__range=(first_id, last_id))
    )

    for message in messages:
        legacy_edit_history: list[LegacyEditHistoryEvent] = orjson.loads(message.edit_history)
        recipient_type = message.recipient.type
        modern_edit_history: list[EditHistoryEvent] = []

        # Only Stream messages have topic / stream edit history data.
        if recipient_type == STREAM:
            topic = message.subject
            stream_id = message.recipient.type_id

        for edit_history_event in legacy_edit_history:
            modern_entry: EditHistoryEvent = {
                "user_id": edit_history_event.get("user_id"),
                "timestamp": edit_history_event["timestamp"],
            }

            if "prev_content" in edit_history_event:
                modern_entry["prev_content"] = edit_history_event["prev_content"]
                modern_entry["prev_rendered_content"] = edit_history_event["prev_rendered_content"]
                modern_entry["prev_rendered_content_version"] = edit_history_event[
                    "prev_rendered_content_version"
                ]

            if recipient_type == STREAM:
                if "prev_subject" in edit_history_event:
                    # Add topic edit key/value pairs from legacy format.
                    modern_entry["topic"] = topic
                    modern_entry["prev_topic"] = edit_history_event["prev_subject"]

                    # Because edit_history is ordered chronologically,
                    # most recent to least recent, we set the topic
                    # variable to the `prev_topic` value for this edit
                    # for any subsequent topic edits in the loop.
                    topic = edit_history_event["prev_subject"]

                elif "prev_topic" in edit_history_event:
                    # Add topic edit key/value pairs from modern format.
                    modern_entry["topic"] = topic
                    modern_entry["prev_topic"] = edit_history_event["prev_topic"]

                    # Same logic as above but for modern format.
                    topic = edit_history_event["prev_topic"]

                if "prev_stream" in edit_history_event:
                    # Add stream edit key/value pairs.
                    modern_entry["stream"] = stream_id
                    modern_entry["prev_stream"] = edit_history_event["prev_stream"]

                    # Same logic as above for the topic variable.
                    stream_id = edit_history_event["prev_stream"]

            modern_edit_history.append(modern_entry)

        message.edit_history = orjson.dumps(modern_edit_history).decode()

    message_model.objects.bulk_update(messages, ["edit_history"])


def copy_and_update_message_edit_history(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Message = apps.get_model("zerver", "Message")
    ArchivedMessage = apps.get_model("zerver", "ArchivedMessage")

    message_models = [Message, ArchivedMessage]
    for message_model in message_models:
        if not message_model.objects.filter(edit_history__isnull=False).exists():
            # No messages with "edit_history"
            continue

        first_id_to_update = message_model.objects.filter(edit_history__isnull=False).aggregate(
            Min("id")
        )["id__min"]

        last_id = message_model.objects.latest("id").id

        id_range_lower_bound = first_id_to_update
        id_range_upper_bound = first_id_to_update + BATCH_SIZE

        while id_range_upper_bound <= last_id:
            backfill_message_edit_history_chunk(
                id_range_lower_bound, id_range_upper_bound, message_model
            )
            print(f"Modernized edit history for {id_range_upper_bound}/{last_id} messages.")
            id_range_lower_bound = id_range_upper_bound + 1
            id_range_upper_bound = id_range_lower_bound + BATCH_SIZE
            time.sleep(0.1)

        if last_id >= id_range_lower_bound:
            # Copy/update for the last batch, or if only 1 message with edit_history in db
            backfill_message_edit_history_chunk(id_range_lower_bound, last_id, message_model)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0376_set_realmemoji_author_and_reupload_realmemoji"),
    ]

    operations = [
        migrations.RunPython(
            copy_and_update_message_edit_history,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0378_alter_realmuserdefault_realm.py]---
Location: zulip-main/zerver/migrations/0378_alter_realmuserdefault_realm.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-05 02:59

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0377_message_edit_history_format"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realmuserdefault",
            name="realm",
            field=models.OneToOneField(
                on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
