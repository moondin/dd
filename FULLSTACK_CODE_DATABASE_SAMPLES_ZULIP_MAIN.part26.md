---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:12Z
part: 26
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 26 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0023_zulipsponsorshiprequest_customer.py]---
Location: zulip-main/corporate/migrations/0023_zulipsponsorshiprequest_customer.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-26 16:00

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0022_session_is_manual_license_management_upgrade_session"),
    ]

    operations = [
        migrations.AddField(
            model_name="zulipsponsorshiprequest",
            name="customer",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="corporate.customer"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0024_zulipsponsorshiprequest_fill_customer_data.py]---
Location: zulip-main/corporate/migrations/0024_zulipsponsorshiprequest_fill_customer_data.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0023_zulipsponsorshiprequest_customer"),
    ]

    operations = [
        migrations.RunSQL(
            """
            UPDATE corporate_zulipsponsorshiprequest
            SET customer_id = (
                SELECT id FROM corporate_customer WHERE corporate_customer.realm_id = corporate_zulipsponsorshiprequest.realm_id
            )
        """,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0025_alter_zulipsponsorshiprequest_customer.py]---
Location: zulip-main/corporate/migrations/0025_alter_zulipsponsorshiprequest_customer.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-26 16:13

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0024_zulipsponsorshiprequest_fill_customer_data"),
    ]

    operations = [
        migrations.AlterField(
            model_name="zulipsponsorshiprequest",
            name="customer",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE, to="corporate.customer"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0026_remove_zulipsponsorshiprequest_realm.py]---
Location: zulip-main/corporate/migrations/0026_remove_zulipsponsorshiprequest_realm.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-26 16:14

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0025_alter_zulipsponsorshiprequest_customer"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="zulipsponsorshiprequest",
            name="realm",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0027_alter_zulipsponsorshiprequest_requested_by.py]---
Location: zulip-main/corporate/migrations/0027_alter_zulipsponsorshiprequest_requested_by.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-28 16:00

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ("corporate", "0026_remove_zulipsponsorshiprequest_realm"),
    ]

    operations = [
        migrations.AlterField(
            model_name="zulipsponsorshiprequest",
            name="requested_by",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to=settings.AUTH_USER_MODEL,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0028_zulipsponsorshiprequest_requested_plan.py]---
Location: zulip-main/corporate/migrations/0028_zulipsponsorshiprequest_requested_plan.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-08 18:03

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0027_alter_zulipsponsorshiprequest_requested_by"),
    ]

    operations = [
        migrations.AddField(
            model_name="zulipsponsorshiprequest",
            name="requested_plan",
            field=models.CharField(
                choices=[("", "UNSPECIFIED"), ("Community", "COMMUNITY"), ("Business", "BUSINESS")],
                default="",
                max_length=50,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0029_session_tier.py]---
Location: zulip-main/corporate/migrations/0029_session_tier.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-18 09:39

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0028_zulipsponsorshiprequest_requested_plan"),
    ]

    operations = [
        migrations.AddField(
            model_name="session",
            name="tier",
            field=models.SmallIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0030_alter_zulipsponsorshiprequest_requested_plan.py]---
Location: zulip-main/corporate/migrations/0030_alter_zulipsponsorshiprequest_requested_plan.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-19 11:38

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0029_session_tier"),
    ]

    operations = [
        migrations.AlterField(
            model_name="zulipsponsorshiprequest",
            name="requested_plan",
            field=models.CharField(
                choices=[
                    ("", "UNSPECIFIED"),
                    ("Community", "COMMUNITY"),
                    ("Basic", "BASIC"),
                    ("Business", "BUSINESS"),
                ],
                default="",
                max_length=50,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0031_customer_flat_discount_and_more.py]---
Location: zulip-main/corporate/migrations/0031_customer_flat_discount_and_more.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-19 12:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0030_alter_zulipsponsorshiprequest_requested_plan"),
    ]

    operations = [
        migrations.AddField(
            model_name="customer",
            name="flat_discount",
            field=models.IntegerField(default=2000),
        ),
        migrations.AddField(
            model_name="customer",
            name="flat_discounted_months",
            field=models.IntegerField(default=0),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0032_customer_minimum_licenses.py]---
Location: zulip-main/corporate/migrations/0032_customer_minimum_licenses.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-14 13:27

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0031_customer_flat_discount_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="customer",
            name="minimum_licenses",
            field=models.PositiveIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0033_customerplan_invoice_overdue_email_sent.py]---
Location: zulip-main/corporate/migrations/0033_customerplan_invoice_overdue_email_sent.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-10 07:34

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0032_customer_minimum_licenses"),
    ]

    operations = [
        migrations.AddField(
            model_name="customerplan",
            name="invoice_overdue_email_sent",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0034_customer_discount_required_tier.py]---
Location: zulip-main/corporate/migrations/0034_customer_discount_required_tier.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-09 14:28

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0033_customerplan_invoice_overdue_email_sent"),
    ]

    operations = [
        migrations.AddField(
            model_name="customer",
            name="required_plan_tier",
            field=models.SmallIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0035_update_legacy_plan_next_invoice_date.py]---
Location: zulip-main/corporate/migrations/0035_update_legacy_plan_next_invoice_date.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-25 05:49

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F


def update_legacy_plan_next_invoice_date(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    CustomerPlan = apps.get_model("corporate", "CustomerPlan")
    CustomerPlan.TIER_SELF_HOSTED_LEGACY = 101

    # For legacy plans, set next_invoice_date = end_date.
    CustomerPlan.objects.filter(tier=CustomerPlan.TIER_SELF_HOSTED_LEGACY).update(
        next_invoice_date=F("end_date")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0034_customer_discount_required_tier"),
    ]

    operations = [
        migrations.RunPython(update_legacy_plan_next_invoice_date, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0036_fix_customer_plans_scheduled_after_legacy_plan.py]---
Location: zulip-main/corporate/migrations/0036_fix_customer_plans_scheduled_after_legacy_plan.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-24 08:08

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_customer_plans_scheduled_after_legacy_plan(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    CustomerPlan = apps.get_model("corporate", "CustomerPlan")
    CustomerPlan.TIER_SELF_HOSTED_LEGACY = 101
    CustomerPlan.SWITCH_PLAN_TIER_AT_PLAN_END = 8
    CustomerPlan.NEVER_STARTED = 12
    CustomerPlan.INVOICING_STATUS_INITIAL_INVOICE_TO_BE_SENT = 3

    # Legacy plans scheduled to switch to a new plan.
    legacy_plans = CustomerPlan.objects.filter(
        tier=CustomerPlan.TIER_SELF_HOSTED_LEGACY, status=CustomerPlan.SWITCH_PLAN_TIER_AT_PLAN_END
    )

    for legacy_plan in legacy_plans:
        CustomerPlan.objects.filter(
            customer=legacy_plan.customer,
            billing_cycle_anchor=legacy_plan.end_date,
            status=CustomerPlan.NEVER_STARTED,
        ).update(
            next_invoice_date=legacy_plan.end_date,
            invoicing_status=CustomerPlan.INVOICING_STATUS_INITIAL_INVOICE_TO_BE_SENT,
        )


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0035_update_legacy_plan_next_invoice_date"),
    ]

    operations = [
        migrations.RunPython(fix_customer_plans_scheduled_after_legacy_plan, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0037_customerplanoffer.py]---
Location: zulip-main/corporate/migrations/0037_customerplanoffer.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-27 09:03

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0036_fix_customer_plans_scheduled_after_legacy_plan"),
    ]

    operations = [
        migrations.CreateModel(
            name="CustomerPlanOffer",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("fixed_price", models.IntegerField(null=True)),
                ("tier", models.SmallIntegerField()),
                ("status", models.SmallIntegerField()),
                (
                    "customer",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="corporate.customer"
                    ),
                ),
            ],
            options={
                "abstract": False,
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0038_customerplanoffer_sent_invoice_id_invoice.py]---
Location: zulip-main/corporate/migrations/0038_customerplanoffer_sent_invoice_id_invoice.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-02 10:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0037_customerplanoffer"),
    ]

    operations = [
        migrations.AddField(
            model_name="customerplanoffer",
            name="sent_invoice_id",
            field=models.CharField(max_length=255, null=True),
        ),
        migrations.CreateModel(
            name="Invoice",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("stripe_invoice_id", models.CharField(max_length=255, unique=True)),
                ("status", models.SmallIntegerField()),
                (
                    "customer",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="corporate.customer"
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0039_backfill_end_date_for_fixed_price_plans.py]---
Location: zulip-main/corporate/migrations/0039_backfill_end_date_for_fixed_price_plans.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-21 11:53

from datetime import datetime

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def add_months(dt: datetime, months: int) -> datetime:
    assert months >= 0
    # It's fine that the max day in Feb is 28 for leap years.
    MAX_DAY_FOR_MONTH = {
        1: 31,
        2: 28,
        3: 31,
        4: 30,
        5: 31,
        6: 30,
        7: 31,
        8: 31,
        9: 30,
        10: 31,
        11: 30,
        12: 31,
    }
    year = dt.year
    month = dt.month + months
    while month > 12:
        year += 1
        month -= 12
    day = min(dt.day, MAX_DAY_FOR_MONTH[month])
    # datetimes don't support leap seconds, so don't need to worry about those
    return dt.replace(year=year, month=month, day=day)


def backfill_end_date_for_fixed_price_plans(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    CustomerPlan = apps.get_model("corporate", "CustomerPlan")
    CustomerPlan.ACTIVE = 1

    fixed_price_plans = CustomerPlan.objects.filter(
        status=CustomerPlan.ACTIVE, fixed_price__isnull=False
    )
    for plan in fixed_price_plans:
        assert plan.end_date is None
        assert plan.billing_cycle_anchor is not None
        plan.end_date = add_months(plan.billing_cycle_anchor, 12)
        plan.save(update_fields=["end_date"])


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0038_customerplanoffer_sent_invoice_id_invoice"),
    ]

    operations = [
        migrations.RunPython(
            backfill_end_date_for_fixed_price_plans,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0040_customerplan_reminder_to_review_plan_email_sent.py]---
Location: zulip-main/corporate/migrations/0040_customerplan_reminder_to_review_plan_email_sent.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-15 06:47

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0039_backfill_end_date_for_fixed_price_plans"),
    ]

    operations = [
        migrations.AddField(
            model_name="customerplan",
            name="reminder_to_review_plan_email_sent",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0041_fix_plans_on_free_trial_with_changes_in_schedule.py]---
Location: zulip-main/corporate/migrations/0041_fix_plans_on_free_trial_with_changes_in_schedule.py
Signals: Django

```python
# Generated by Django 4.2.10 on 2024-03-01 14:05

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_plans_on_free_trial_with_changes_in_schedule(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    CustomerPlan = apps.get_model("corporate", "CustomerPlan")
    LicenseLedger = apps.get_model("corporate", "LicenseLedger")
    CustomerPlan.FREE_TRIAL = 3
    CustomerPlan.ENDED = 11
    CustomerPlan.INVOICING_STATUS_DONE = 1

    plans_on_free_trial_with_changed_schedule = CustomerPlan.objects.filter(
        status=CustomerPlan.FREE_TRIAL, invoiced_through=None
    )
    for plan in plans_on_free_trial_with_changed_schedule:
        assert plan.customer is not None
        assert plan.billing_cycle_anchor is not None

        ledger_entries = LicenseLedger.objects.filter(
            plan=plan,
            is_renewal=True,
            event_time=plan.billing_cycle_anchor,
        )
        assert ledger_entries.count() == 1
        plan.invoiced_through = ledger_entries.first()
        plan.invoicing_status = CustomerPlan.INVOICING_STATUS_DONE
        plan.save(update_fields=["invoiced_through", "invoicing_status"])

        CustomerPlan.objects.filter(
            customer=plan.customer,
            status=CustomerPlan.ENDED,
            billing_cycle_anchor=plan.billing_cycle_anchor,
        ).update(next_invoice_date=None)


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0040_customerplan_reminder_to_review_plan_email_sent"),
    ]

    operations = [
        migrations.RunPython(
            fix_plans_on_free_trial_with_changes_in_schedule,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0042_invoice_is_created_for_free_trial_upgrade_and_more.py]---
Location: zulip-main/corporate/migrations/0042_invoice_is_created_for_free_trial_upgrade_and_more.py
Signals: Django

```python
# Generated by Django 4.2.11 on 2024-04-10 03:17

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0041_fix_plans_on_free_trial_with_changes_in_schedule"),
    ]

    operations = [
        migrations.AddField(
            model_name="invoice",
            name="is_created_for_free_trial_upgrade",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="invoice",
            name="plan",
            field=models.ForeignKey(
                default=None,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to="corporate.customerplan",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0043_remove_customer_default_discount_and_more.py]---
Location: zulip-main/corporate/migrations/0043_remove_customer_default_discount_and_more.py
Signals: Django

```python
# Generated by Django 5.0.5 on 2024-05-03 06:50

from decimal import Decimal

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

# It's generally unsafe to import product code from migrations,
# because the migration will be run with the **current** version of
# that code, not the version at the time of the migration. But because
# this migration will only be run for Zulip Cloud, this is OK.
from corporate.lib.stripe import get_price_per_license


def calculate_discounted_price_per_license(
    original_price_per_license: int, discount: Decimal
) -> int:
    # There are no fractional cents in Stripe, so round down to nearest integer.
    return int(float(original_price_per_license * (1 - discount / 100)) + 0.00001)


def calculate_discounted_price(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Migrates existing customers with a configured default discount to
    instead have discounted prices for their configured required_plan_tier.

    Does not operate on CustomerPlan fields, since those are already
    resolved into a price.
    """
    BILLING_SCHEDULE_ANNUAL = 1
    BILLING_SCHEDULE_MONTHLY = 2

    Customer = apps.get_model("corporate", "Customer")
    customers_to_update = []
    for customer in Customer.objects.all().iterator():
        if not customer.required_plan_tier or not customer.default_discount:
            continue

        annual_price_per_license = get_price_per_license(
            customer.required_plan_tier, BILLING_SCHEDULE_ANNUAL
        )
        customer.annual_discounted_price = calculate_discounted_price_per_license(
            annual_price_per_license, customer.default_discount
        )
        monthly_price_per_license = get_price_per_license(
            customer.required_plan_tier, BILLING_SCHEDULE_MONTHLY
        )
        customer.monthly_discounted_price = calculate_discounted_price_per_license(
            monthly_price_per_license, customer.default_discount
        )
        customers_to_update.append(customer)
        print(
            f"\nChanging price for {customer.id}: {customer.default_discount} => {customer.annual_discounted_price}/{customer.monthly_discounted_price}"
        )

    Customer.objects.bulk_update(
        customers_to_update, ["annual_discounted_price", "monthly_discounted_price"]
    )


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0042_invoice_is_created_for_free_trial_upgrade_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="customer",
            name="annual_discounted_price",
            field=models.IntegerField(default=0),
        ),
        migrations.AddField(
            model_name="customer",
            name="monthly_discounted_price",
            field=models.IntegerField(default=0),
        ),
        # Populate the new discounted price fields based on existing default discount.
        migrations.RunPython(calculate_discounted_price, elidable=True),
        migrations.RemoveField(
            model_name="customer",
            name="default_discount",
        ),
        # This automatically converts the decimal to string so we don't need to do anything here.
        migrations.AlterField(
            model_name="customerplan",
            name="discount",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0044_convert_ids_to_bigints.py]---
Location: zulip-main/corporate/migrations/0044_convert_ids_to_bigints.py
Signals: Django

```python
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("corporate", "0043_remove_customer_default_discount_and_more"),
    ]

    operations = [
        migrations.AlterField(
            model_name="customer",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="customerplan",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="customerplanoffer",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="event",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="invoice",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="licenseledger",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="paymentintent",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="session",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
        migrations.AlterField(
            model_name="zulipsponsorshiprequest",
            name="id",
            field=models.BigAutoField(
                auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0045_zulipsponsorshiprequest_plan_to_use_zulip.py]---
Location: zulip-main/corporate/migrations/0045_zulipsponsorshiprequest_plan_to_use_zulip.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-14 17:16

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0001_squashed_0044_convert_ids_to_bigints"),
    ]

    operations = [
        migrations.AddField(
            model_name="zulipsponsorshiprequest",
            name="plan_to_use_zulip",
            field=models.TextField(default=""),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0046_rename_customerplan_invoice_overdue_email_sent.py]---
Location: zulip-main/corporate/migrations/0046_rename_customerplan_invoice_overdue_email_sent.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-27 14:26

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("corporate", "0045_zulipsponsorshiprequest_plan_to_use_zulip"),
    ]

    operations = [
        migrations.RenameField(
            model_name="customerplan",
            old_name="invoice_overdue_email_sent",
            new_name="stale_audit_log_data_email_sent",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: customers.py]---
Location: zulip-main/corporate/models/customers.py
Signals: Django

```python
from django.db import models
from django.db.models import CASCADE, Q
from typing_extensions import override

from zerver.models import Realm
from zilencer.models import RemoteRealm, RemoteZulipServer


class Customer(models.Model):
    """
    This model primarily serves to connect a Realm with
    the corresponding Stripe customer object for payment purposes
    and the active plan, if any.
    """

    # The actual model object that this customer is associated
    # with. Exactly one of the following will be non-null.
    realm = models.OneToOneField(Realm, on_delete=CASCADE, null=True)
    remote_realm = models.OneToOneField(RemoteRealm, on_delete=CASCADE, null=True)
    remote_server = models.OneToOneField(RemoteZulipServer, on_delete=CASCADE, null=True)

    stripe_customer_id = models.CharField(max_length=255, null=True, unique=True)
    sponsorship_pending = models.BooleanField(default=False)

    # Discounted price for required_plan_tier in cents.
    # We treat 0 as no discount. Not using `null` here keeps the
    # checks simpler and avoids the cases where we forget to
    # check for both `null` and 0.
    monthly_discounted_price = models.IntegerField(default=0, null=False)
    annual_discounted_price = models.IntegerField(default=0, null=False)

    minimum_licenses = models.PositiveIntegerField(null=True)
    # Used for limiting discounted price or a fixed_price
    # to be used only for a particular CustomerPlan tier.
    required_plan_tier = models.SmallIntegerField(null=True)
    # Some non-profit organizations on manual license management pay
    # only for their paid employees.  We don't prevent these
    # organizations from adding more users than the number of licenses
    # they purchased.
    exempt_from_license_number_check = models.BooleanField(default=False)

    # In cents.
    flat_discount = models.IntegerField(default=2000)
    # Number of months left in the flat discount period.
    flat_discounted_months = models.IntegerField(default=0)

    class Meta:
        # Enforce that at least one of these is set.
        constraints = [
            models.CheckConstraint(
                condition=Q(realm__isnull=False)
                | Q(remote_server__isnull=False)
                | Q(remote_realm__isnull=False),
                name="has_associated_model_object",
            )
        ]

    @override
    def __str__(self) -> str:
        if self.realm is not None:
            return f"{self.realm!r} (stripe: {self.stripe_customer_id})"
        elif self.remote_realm is not None:
            return f"{self.remote_realm!r} (stripe: {self.stripe_customer_id})"
        else:
            return f"{self.remote_server!r} (stripe: {self.stripe_customer_id})"

    def get_discounted_price_for_plan(self, plan_tier: int, schedule: int) -> int | None:
        from corporate.models.plans import CustomerPlan

        if plan_tier != self.required_plan_tier:
            return None

        if schedule == CustomerPlan.BILLING_SCHEDULE_ANNUAL:
            return self.annual_discounted_price

        assert schedule == CustomerPlan.BILLING_SCHEDULE_MONTHLY
        return self.monthly_discounted_price


def get_customer_by_realm(realm: Realm) -> Customer | None:
    return Customer.objects.filter(realm=realm).first()


def get_customer_by_remote_server(remote_server: RemoteZulipServer) -> Customer | None:
    return Customer.objects.filter(remote_server=remote_server).first()


def get_customer_by_remote_realm(remote_realm: RemoteRealm) -> Customer | None:  # nocoverage
    return Customer.objects.filter(remote_realm=remote_realm).first()
```

--------------------------------------------------------------------------------

---[FILE: licenses.py]---
Location: zulip-main/corporate/models/licenses.py
Signals: Django

```python
from django.db import models
from django.db.models import CASCADE
from typing_extensions import override

from corporate.models.plans import CustomerPlan


class LicenseLedger(models.Model):
    """
    This table's purpose is to store the current, and historical,
    count of "seats" purchased by the organization.

    Because we want to keep historical data, when the purchased
    seat count changes, a new LicenseLedger object is created,
    instead of updating the old one. This lets us preserve
    the entire history of how the seat count changes, which is
    important for analytics as well as auditing and debugging
    in case of issues.
    """

    plan = models.ForeignKey(CustomerPlan, on_delete=CASCADE)

    # Also True for the initial upgrade.
    is_renewal = models.BooleanField(default=False)

    event_time = models.DateTimeField()

    # The number of licenses ("seats") purchased by the organization at the time of ledger
    # entry creation. Normally, to add a user the organization needs at least one spare license.
    # Once a license is purchased, it is valid till the end of the billing period, irrespective
    # of whether the license is used or not. So the value of licenses will never decrease for
    # subsequent LicenseLedger entries in the same billing period.
    licenses = models.IntegerField()

    # The number of licenses the organization needs in the next billing cycle. The value of
    # licenses_at_next_renewal can increase or decrease for subsequent LicenseLedger entries in
    # the same billing period. For plans on automatic license management this value is usually
    # equal to the number of activated users in the organization.
    licenses_at_next_renewal = models.IntegerField(null=True)

    @override
    def __str__(self) -> str:
        ledger_type = "renewal" if self.is_renewal else "update"
        ledger_time = self.event_time.replace(tzinfo=None).isoformat(" ", "minutes")
        return f"License {ledger_type}, {self.licenses} purchased, {self.licenses_at_next_renewal} next cycle, {ledger_time} (id={self.id})"
```

--------------------------------------------------------------------------------

````
