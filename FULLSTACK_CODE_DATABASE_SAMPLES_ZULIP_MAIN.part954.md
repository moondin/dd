---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 954
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 954 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0572_alter_usergroup_can_manage_group.py]---
Location: zulip-main/zerver/migrations/0572_alter_usergroup_can_manage_group.py
Signals: Django

```python
# Generated by Django 4.2.2 on 2023-07-16 12:57

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0571_set_default_for_can_manage_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="namedusergroup",
            name="can_manage_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0573_directmessagegroup_group_size.py]---
Location: zulip-main/zerver/migrations/0573_directmessagegroup_group_size.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-08-16 06:36

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0572_alter_usergroup_can_manage_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="directmessagegroup",
            name="group_size",
            field=models.IntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0574_backfill_directmessagegroup_group_size.py]---
Location: zulip-main/zerver/migrations/0574_backfill_directmessagegroup_group_size.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-08-16 06:44

from django.db import connection, migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

BATCH_SIZE = 1000


def backfill_group_size_field_for_direct_message_groups(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Recipient = apps.get_model("zerver", "Recipient")

    RECIPIENT_DIRECT_MESSAGE_GROUP = 3

    direct_message_group_recipient_entries = Recipient.objects.filter(
        type=RECIPIENT_DIRECT_MESSAGE_GROUP
    )

    if not direct_message_group_recipient_entries.exists():
        return

    recipient_id_lower_bound = direct_message_group_recipient_entries.earliest("id").id
    max_recipient_id = Recipient.objects.latest("id").id

    # We would like to set the upper bound significantly past the
    # maximum recipient id, because it is likely that new Direct
    # Message Groups are created during this transaction, and their
    # recipient id is assigned as the one right after the max id.
    max_recipient_id += BATCH_SIZE

    while recipient_id_lower_bound <= max_recipient_id:
        do_backfill_group_size_field_for_direct_message_groups(
            recipient_id_lower_bound,
            min(recipient_id_lower_bound + BATCH_SIZE, max_recipient_id),
        )
        recipient_id_lower_bound += BATCH_SIZE + 1


def do_backfill_group_size_field_for_direct_message_groups(
    recipient_id_lower_bound: int,
    recipient_id_upper_bound: int,
) -> None:
    with connection.cursor() as cursor:
        update_query = """
        UPDATE zerver_huddle
        SET group_size = (
            SELECT COUNT(*)
            FROM zerver_subscription
            WHERE zerver_subscription.recipient_id = zerver_huddle.recipient_id
        )
        WHERE zerver_huddle.recipient_id BETWEEN %(lower_bound)s AND %(upper_bound)s
        AND zerver_huddle.group_size IS NULL
        """

        cursor.execute(
            update_query,
            {
                "lower_bound": recipient_id_lower_bound,
                "upper_bound": recipient_id_upper_bound,
            },
        )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0573_directmessagegroup_group_size"),
    ]

    operations = [
        migrations.RunPython(
            backfill_group_size_field_for_direct_message_groups,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0575_alter_directmessagegroup_group_size.py]---
Location: zulip-main/zerver/migrations/0575_alter_directmessagegroup_group_size.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-08-21 13:25

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0574_backfill_directmessagegroup_group_size"),
    ]

    operations = [
        migrations.AlterField(
            model_name="directmessagegroup",
            name="group_size",
            field=models.IntegerField(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0576_backfill_imageattachment.py]---
Location: zulip-main/zerver/migrations/0576_backfill_imageattachment.py
Signals: Django

```python
import os
from functools import reduce
from operator import or_

import boto3
import pyvips
from botocore.client import Config
from botocore.exceptions import ClientError
from botocore.response import StreamingBody
from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Exists, OuterRef, Q

from zerver.lib.partial import partial


def backfill_imageattachment(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    ImageAttachment = apps.get_model("zerver", "ImageAttachment")
    Attachment = apps.get_model("zerver", "Attachment")

    if settings.LOCAL_UPLOADS_DIR is None:
        upload_bucket = boto3.resource(
            "s3",
            aws_access_key_id=settings.S3_KEY,
            aws_secret_access_key=settings.S3_SECRET_KEY,
            region_name=settings.S3_REGION,
            endpoint_url=settings.S3_ENDPOINT_URL,
            config=Config(
                signature_version=None,
                s3={"addressing_style": settings.S3_ADDRESSING_STYLE},
            ),
        ).Bucket(settings.S3_AUTH_UPLOADS_BUCKET)

    # Historical attachments do not have a mime_type value, so we used
    # to rely on the file extension.  We replicate that when
    # backfilling.  This is the value from zerver.lib.markdown:
    IMAGE_EXTENSIONS = [".bmp", ".gif", ".jpe", ".jpeg", ".jpg", ".png", ".webp"]

    extension_limits = Q()
    extension_limits = reduce(
        or_,
        [Q(file_name__endswith=extension) for extension in IMAGE_EXTENSIONS],
        extension_limits,
    )

    attachments_query = (
        Attachment.objects.alias(
            has_imageattachment=Exists(ImageAttachment.objects.filter(path_id=OuterRef("path_id")))
        )
        .filter(extension_limits, has_imageattachment=False)
        .order_by("id")
    )

    already_processed = 0
    total_to_process = attachments_query.count()
    min_id: int | None = 0
    while True:
        attachments = attachments_query.filter(id__gt=min_id)[:100]

        min_id = None
        for attachment in attachments:
            min_id = attachment.id
            already_processed += 1

            if settings.LOCAL_UPLOADS_DIR is None:
                try:
                    metadata = upload_bucket.Object(attachment.path_id).get()
                except ClientError:
                    print(f"{attachment.path_id}: Missing!")
                    continue

                def s3_read(streamingbody: StreamingBody, size: int) -> bytes:
                    return streamingbody.read(amt=size)

                # We use the streaming body to only pull down as much
                # of the image as we need to examine the headers --
                # generally about 40k
                source: pyvips.Source = pyvips.SourceCustom()
                source.on_read(partial(s3_read, metadata["Body"]))
            else:
                assert settings.LOCAL_FILES_DIR is not None
                attachment_path = os.path.join(settings.LOCAL_FILES_DIR, attachment.path_id)
                if not os.path.exists(attachment_path):
                    print(f"{attachment.path_id}: Missing!")
                    continue
                source = pyvips.Source.new_from_file(attachment_path)
            try:
                image = pyvips.Image.new_from_source(source, "", access="sequential")

                # "original_width_px" and "original_height_px" here are
                # _as rendered_, after applying the orientation
                # information which the image may contain.
                if (
                    "orientation" in image.get_fields()
                    and image.get("orientation") >= 5
                    and image.get("orientation") <= 8
                ):
                    (width, height) = (image.height, image.width)
                else:
                    (width, height) = (image.width, image.height)

                ImageAttachment.objects.create(
                    realm_id=attachment.realm_id,
                    path_id=attachment.path_id,
                    original_width_px=width,
                    original_height_px=height,
                    frames=image.get_n_pages(),
                    thumbnail_metadata=[],
                )
            except pyvips.Error:
                pass

        print(f"Processed {already_processed}/{total_to_process}")
        if min_id is None:
            break


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        # Because this will be backported to 9.x, we only depend on the last migration in 9.x
        ("zerver", "0558_realmuserdefault_web_animate_image_previews_and_more"),
    ]

    operations = [
        migrations.RunPython(
            backfill_imageattachment, reverse_code=migrations.RunPython.noop, elidable=True
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0577_merge_20240829_0153.py]---
Location: zulip-main/zerver/migrations/0577_merge_20240829_0153.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0575_alter_directmessagegroup_group_size"),
        ("zerver", "0576_backfill_imageattachment"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0578_namedusergroup_deactivated.py]---
Location: zulip-main/zerver/migrations/0578_namedusergroup_deactivated.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-05-15 13:12

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0577_merge_20240829_0153"),
    ]

    operations = [
        migrations.AddField(
            model_name="namedusergroup",
            name="deactivated",
            field=models.BooleanField(default=False, db_default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0579_realm_can_delete_own_message_group.py]---
Location: zulip-main/zerver/migrations/0579_realm_can_delete_own_message_group.py
Signals: Django

```python
# Generated by Django 5.0.7 on 2024-08-28 05:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0578_namedusergroup_deactivated"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_delete_own_message_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0580_set_default_value_for_can_delete_own_message_group.py]---
Location: zulip-main/zerver/migrations/0580_set_default_value_for_can_delete_own_message_group.py
Signals: Django

```python
# Generated by Django 4.2.1 on 2023-06-12 10:47

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_delete_own_message_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    delete_own_message_policy_to_user_group = {
        1: "role:members",
        2: "role:administrators",
        3: "role:fullmembers",
        4: "role:moderators",
        5: "role:everyone",
    }

    for id, user_group in delete_own_message_policy_to_user_group.items():
        Realm.objects.filter(
            can_delete_own_message_group=None, delete_own_message_policy=id
        ).update(
            can_delete_own_message_group=NamedUserGroup.objects.filter(
                name=user_group, realm=OuterRef("id"), is_system_group=True
            ).values("pk")
        )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0579_realm_can_delete_own_message_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_delete_own_message_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0581_alter_realm_can_delete_own_message_group.py]---
Location: zulip-main/zerver/migrations/0581_alter_realm_can_delete_own_message_group.py
Signals: Django

```python
# Generated by Django 5.0.7 on 2024-08-28 05:31

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0580_set_default_value_for_can_delete_own_message_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_delete_own_message_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0582_remove_realm_delete_own_message_policy.py]---
Location: zulip-main/zerver/migrations/0582_remove_realm_delete_own_message_policy.py
Signals: Django

```python
# Generated by Django 5.0.7 on 2024-09-09 12:53

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0581_alter_realm_can_delete_own_message_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="delete_own_message_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0583_namedusergroup_creator_namedusergroup_date_created.py]---
Location: zulip-main/zerver/migrations/0583_namedusergroup_creator_namedusergroup_date_created.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-08-31 08:09

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0582_remove_realm_delete_own_message_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="namedusergroup",
            name="creator",
            field=models.ForeignKey(
                db_column="creator_id",
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="+",
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AddField(
            model_name="namedusergroup",
            name="date_created",
            field=models.DateTimeField(default=django.utils.timezone.now, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0584_namedusergroup_creator_date_created_backfill.py]---
Location: zulip-main/zerver/migrations/0584_namedusergroup_creator_date_created_backfill.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-08-31 08:09

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def backfill_creator_id_and_date_created_from_realm_audit_log(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.USER_GROUP_CREATED = 701
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    user_group_creator_updates = []
    for audit_log_entry in RealmAuditLog.objects.select_related("modified_user_group").filter(
        event_type=RealmAuditLog.USER_GROUP_CREATED,
        acting_user_id__isnull=False,
    ):
        assert audit_log_entry.modified_user_group is not None
        user_group = audit_log_entry.modified_user_group
        user_group.creator_id = audit_log_entry.acting_user_id
        user_group_creator_updates.append(user_group)

    NamedUserGroup.objects.bulk_update(user_group_creator_updates, ["creator_id"], batch_size=1000)

    user_group_date_created_updates = []
    for audit_log_entry in RealmAuditLog.objects.select_related("modified_user_group").filter(
        event_type=RealmAuditLog.USER_GROUP_CREATED,
        event_time__isnull=False,
    ):
        assert audit_log_entry.modified_user_group is not None
        user_group = audit_log_entry.modified_user_group
        user_group.date_created = audit_log_entry.event_time
        user_group_date_created_updates.append(user_group)

    NamedUserGroup.objects.bulk_update(
        user_group_date_created_updates, ["date_created"], batch_size=1000
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0583_namedusergroup_creator_namedusergroup_date_created"),
    ]

    operations = [
        migrations.RunPython(
            backfill_creator_id_and_date_created_from_realm_audit_log,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0585_userprofile_allow_private_data_export_and_more.py]---
Location: zulip-main/zerver/migrations/0585_userprofile_allow_private_data_export_and_more.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-09 08:57

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0584_namedusergroup_creator_date_created_backfill"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="allow_private_data_export",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="allow_private_data_export",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0586_customprofilefield_editable_by_user.py]---
Location: zulip-main/zerver/migrations/0586_customprofilefield_editable_by_user.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-29 20:06

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0585_userprofile_allow_private_data_export_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="customprofilefield",
            name="editable_by_user",
            field=models.BooleanField(db_default=True, default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0587_savedsnippet.py]---
Location: zulip-main/zerver/migrations/0587_savedsnippet.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-24 14:51

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0586_customprofilefield_editable_by_user"),
    ]

    operations = [
        migrations.CreateModel(
            name="SavedSnippet",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("title", models.TextField(max_length=60)),
                ("content", models.TextField(max_length=10000)),
                ("date_created", models.DateTimeField(default=django.utils.timezone.now)),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0588_realm_add_can_create_groups.py]---
Location: zulip-main/zerver/migrations/0588_realm_add_can_create_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-04 10:30

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0587_savedsnippet"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_create_groups",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0589_set_can_create_groups.py]---
Location: zulip-main/zerver/migrations/0589_set_can_create_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-05 06:11

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_can_create_groups_for_existing_realms(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MEMBERS_ONLY = 1
    ADMINS_ONLY = 2
    FULL_MEMBERS_ONLY = 3
    MODERATORS_ONLY = 4

    Realm.objects.filter(can_create_groups=None, user_group_edit_policy=MEMBERS_ONLY).update(
        can_create_groups=NamedUserGroup.objects.filter(
            name="role:members", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(can_create_groups=None, user_group_edit_policy=ADMINS_ONLY).update(
        can_create_groups=NamedUserGroup.objects.filter(
            name="role:administrators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(can_create_groups=None, user_group_edit_policy=FULL_MEMBERS_ONLY).update(
        can_create_groups=NamedUserGroup.objects.filter(
            name="role:fullmembers", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(can_create_groups=None, user_group_edit_policy=MODERATORS_ONLY).update(
        can_create_groups=NamedUserGroup.objects.filter(
            name="role:moderators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0588_realm_add_can_create_groups"),
    ]

    operations = [
        migrations.RunPython(
            set_can_create_groups_for_existing_realms,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0590_alter_realm_can_create_groups.py]---
Location: zulip-main/zerver/migrations/0590_alter_realm_can_create_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-05 08:34

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0589_set_can_create_groups"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_create_groups",
            field=models.ForeignKey(
                on_delete=models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0591_realm_add_can_manage_all_groups.py]---
Location: zulip-main/zerver/migrations/0591_realm_add_can_manage_all_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-13 14:34

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0590_alter_realm_can_create_groups"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_manage_all_groups",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0592_set_can_manage_all_groups.py]---
Location: zulip-main/zerver/migrations/0592_set_can_manage_all_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-05 06:11

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_can_manage_all_groups_for_existing_realms(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MEMBERS_ONLY = 1
    ADMINS_ONLY = 2
    FULL_MEMBERS_ONLY = 3
    MODERATORS_ONLY = 4

    Realm.objects.filter(can_manage_all_groups=None, user_group_edit_policy=MEMBERS_ONLY).update(
        can_manage_all_groups=NamedUserGroup.objects.filter(
            name="role:members", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(can_manage_all_groups=None, user_group_edit_policy=ADMINS_ONLY).update(
        can_manage_all_groups=NamedUserGroup.objects.filter(
            name="role:administrators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_manage_all_groups=None, user_group_edit_policy=FULL_MEMBERS_ONLY
    ).update(
        can_manage_all_groups=NamedUserGroup.objects.filter(
            name="role:fullmembers", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(can_manage_all_groups=None, user_group_edit_policy=MODERATORS_ONLY).update(
        can_manage_all_groups=NamedUserGroup.objects.filter(
            name="role:moderators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0591_realm_add_can_manage_all_groups"),
    ]

    operations = [
        migrations.RunPython(
            set_can_manage_all_groups_for_existing_realms,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0593_alter_realm_manage_all_groups.py]---
Location: zulip-main/zerver/migrations/0593_alter_realm_manage_all_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-05 08:34

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0592_set_can_manage_all_groups"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_manage_all_groups",
            field=models.ForeignKey(
                on_delete=models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0594_remove_realm_user_group_edit_policy.py]---
Location: zulip-main/zerver/migrations/0594_remove_realm_user_group_edit_policy.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-17 10:47

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0593_alter_realm_manage_all_groups"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="user_group_edit_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0595_add_realmexport_table_and_backfill.py]---
Location: zulip-main/zerver/migrations/0595_add_realmexport_table_and_backfill.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-10-04 09:57

from datetime import datetime, timezone

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def timestamp_to_datetime(timestamp: float | None) -> datetime | None:
    if timestamp is None:
        return None
    return datetime.fromtimestamp(float(timestamp), tz=timezone.utc)


def datetime_to_timestamp(dt: datetime) -> int:
    return int(dt.timestamp())


def backfill_realm_export(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    REALM_EXPORTED = 206
    REQUESTED = 1
    STARTED = 2
    SUCCEEDED = 3
    FAILED = 4
    DELETED = 5
    EXPORT_PUBLIC = 1

    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmExport = apps.get_model("zerver", "RealmExport")

    for audit_log in RealmAuditLog.objects.filter(event_type=REALM_EXPORTED).order_by("id"):
        if audit_log.acting_user is None:
            # This audit_log is for an export made through shell.
            # We don't have enough data to determine if the export was
            # successful or failed.
            continue

        extra_data = audit_log.extra_data
        started_timestamp = extra_data.get("started_timestamp")
        failed_timestamp = extra_data.get("failed_timestamp")
        deleted_timestamp = extra_data.get("deleted_timestamp")
        export_path = extra_data.get("export_path")

        status = REQUESTED
        if deleted_timestamp is not None:
            status = DELETED
        elif failed_timestamp is not None:
            status = FAILED
        elif export_path is not None:
            status = SUCCEEDED
        elif started_timestamp is not None:
            status = STARTED

        # We don't have historical data to set `date_succeeded`.
        RealmExport.objects.create(
            realm=audit_log.realm,
            acting_user=audit_log.acting_user,
            type=EXPORT_PUBLIC,
            status=status,
            date_requested=audit_log.event_time,
            date_started=timestamp_to_datetime(started_timestamp),
            date_failed=timestamp_to_datetime(failed_timestamp),
            date_deleted=timestamp_to_datetime(deleted_timestamp),
            export_path=export_path,
        )


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmExport = apps.get_model("zerver", "RealmExport")

    RealmExport.objects.all().delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0594_remove_realm_user_group_edit_policy"),
    ]

    operations = [
        migrations.CreateModel(
            name="RealmExport",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("type", models.PositiveSmallIntegerField(default=1)),
                ("status", models.PositiveSmallIntegerField(default=1)),
                ("date_requested", models.DateTimeField()),
                ("date_started", models.DateTimeField(default=None, null=True)),
                ("date_succeeded", models.DateTimeField(default=None, null=True)),
                ("date_failed", models.DateTimeField(default=None, null=True)),
                ("date_deleted", models.DateTimeField(default=None, null=True)),
                ("export_path", models.TextField(default=None, null=True)),
                ("sha256sum_hex", models.CharField(default=None, max_length=64, null=True)),
                ("tarball_size_bytes", models.PositiveIntegerField(default=None, null=True)),
                ("stats", models.JSONField(default=None, null=True)),
                (
                    "acting_user",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
        ),
        migrations.RunPython(backfill_realm_export, reverse_code=reverse_code, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0596_namedusergroup_can_join_group.py]---
Location: zulip-main/zerver/migrations/0596_namedusergroup_can_join_group.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-19 10:34

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0595_add_realmexport_table_and_backfill"),
    ]

    operations = [
        migrations.AddField(
            model_name="namedusergroup",
            name="can_join_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0597_set_default_value_for_can_join_group.py]---
Location: zulip-main/zerver/migrations/0597_set_default_value_for_can_join_group.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-19 10:34

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_join_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = NamedUserGroup.objects.filter(can_join_group=None).aggregate(Max("id"))["id__max"]
    if max_id is None:
        # Do nothing if there are no user groups on the server.
        return

    lower_bound = NamedUserGroup.objects.filter(can_join_group=None).aggregate(Min("id"))["id__min"]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for NamedUserGroup")

        with transaction.atomic():
            # Owners will naturally have the permission to join the
            # group via their permission to manage all groups or add
            # anyone to this group.
            NamedUserGroup.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_join_group=None,
            ).update(
                can_join_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_for_sharding"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0596_namedusergroup_can_join_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_join_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0598_alter_namedusergroup_can_join_group.py]---
Location: zulip-main/zerver/migrations/0598_alter_namedusergroup_can_join_group.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-19 10:40

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0597_set_default_value_for_can_join_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="namedusergroup",
            name="can_join_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0599_namedusergroup_add_can_add_members_group.py]---
Location: zulip-main/zerver/migrations/0599_namedusergroup_add_can_add_members_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-10-07 07:23

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0598_alter_namedusergroup_can_join_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="namedusergroup",
            name="can_add_members_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
