---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 947
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 947 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0427_migrate_to_user_level_email_address_visibility_setting.py]---
Location: zulip-main/zerver/migrations/0427_migrate_to_user_level_email_address_visibility_setting.py
Signals: Django

```python
# Generated by Django 3.2.8 on 2021-10-27 14:25

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def migrate_to_user_level_email_address_visibility_setting(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    UserProfile = apps.get_model("zerver", "UserProfile")
    realms = Realm.objects.all()
    for realm in realms:
        # For bots, the database-level default
        # `EMAIL_ADDRESS_VISIBILITY_EVERYONE` is correct.
        UserProfile.objects.filter(realm=realm, is_bot=False).update(
            email_address_visibility=realm.email_address_visibility
        )
        RealmUserDefault.objects.filter(realm=realm).update(
            email_address_visibility=realm.email_address_visibility
        )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0426_add_email_address_visibility_setting"),
    ]

    operations = [
        migrations.RunPython(
            migrate_to_user_level_email_address_visibility_setting,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0428_remove_realm_email_address_visibility.py]---
Location: zulip-main/zerver/migrations/0428_remove_realm_email_address_visibility.py
Signals: Django

```python
# Generated by Django 3.2.8 on 2021-10-28 14:53

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0427_migrate_to_user_level_email_address_visibility_setting"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="email_address_visibility",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0429_user_topic_case_insensitive_unique_toghether.py]---
Location: zulip-main/zerver/migrations/0429_user_topic_case_insensitive_unique_toghether.py
Signals: Django

```python
# Generated by Django 4.1.6 on 2023-02-11 05:16

import django.db.models.functions.text
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0428_remove_realm_email_address_visibility"),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name="usertopic",
            unique_together=set(),
        ),
        # Before adding the constraint, remove any pre-existing duplicates from the table
        migrations.RunSQL(
            """
        DELETE FROM zerver_usertopic WHERE id NOT IN (SELECT max(id) FROM zerver_usertopic GROUP BY (user_profile_id, stream_id, upper(topic_name::text)));
        """,
            elidable=True,
        ),
        migrations.AddConstraint(
            model_name="usertopic",
            constraint=models.UniqueConstraint(
                models.F("user_profile"),
                models.F("stream"),
                django.db.models.functions.text.Lower("topic_name"),
                name="usertopic_case_insensitive_topic_uniq",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0430_fix_audit_log_objects_for_group_based_stream_settings.py]---
Location: zulip-main/zerver/migrations/0430_fix_audit_log_objects_for_group_based_stream_settings.py
Signals: Django

```python
# Generated by Django 4.1.6 on 2023-02-17 12:06
import json

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_audit_log_objects_for_group_based_stream_settings(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    """
    This adds the property_name field to any STREAM_GROUP_BASED_SETTING_CHANGED
    audit log entries that were created before the previous commit.
    """
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")

    STREAM_GROUP_BASED_SETTING_CHANGED = 608
    OLD_VALUE = "1"
    NEW_VALUE = "2"

    for audit_log_object in RealmAuditLog.objects.filter(
        event_type=STREAM_GROUP_BASED_SETTING_CHANGED
    ):
        extra_data = json.loads(audit_log_object.extra_data)
        old_value = extra_data[OLD_VALUE]
        new_value = extra_data[NEW_VALUE]

        audit_log_object.extra_data = json.dumps(
            {
                OLD_VALUE: old_value,
                NEW_VALUE: new_value,
                "property": "can_remove_subscribers_group",
            }
        )
        audit_log_object.save(update_fields=["extra_data"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0429_user_topic_case_insensitive_unique_toghether"),
    ]

    operations = [
        migrations.RunPython(
            fix_audit_log_objects_for_group_based_stream_settings,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0431_alter_archivedreaction_unique_together_and_more.py]---
Location: zulip-main/zerver/migrations/0431_alter_archivedreaction_unique_together_and_more.py
Signals: Django

```python
# Generated by Django 4.1.6 on 2023-02-25 01:22

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0430_fix_audit_log_objects_for_group_based_stream_settings"),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name="archivedreaction",
            unique_together={("user_profile", "message", "reaction_type", "emoji_code")},
        ),
        migrations.AlterUniqueTogether(
            name="reaction",
            unique_together={("user_profile", "message", "reaction_type", "emoji_code")},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0432_alter_and_migrate_realm_name_in_notifications.py]---
Location: zulip-main/zerver/migrations/0432_alter_and_migrate_realm_name_in_notifications.py
Signals: Django

```python
# Generated by Django 4.1.5 on 2023-01-11 20:21

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

# We include a copy of this structure as it was at the time this
# migration was merged, since future should not impact the migration.
REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_AUTOMATIC = 1
REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_ALWAYS = 2
REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_NEVER = 3


# The value of 'realm_name_in_email_notifications_policy' for those users
# who have manually changed the value of 'realm_name_in_notifications' as 'true'
# should be updated as 'Always', not 'Automatic'
def update_realm_name_in_email_notifications_policy_values(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserProfile.objects.filter(realm_name_in_notifications=True).update(
        realm_name_in_email_notifications_policy=REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_ALWAYS
    )


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserProfile.objects.filter(
        realm_name_in_email_notifications_policy=REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_ALWAYS
    ).update(realm_name_in_notifications=True)


def update_realm_name_in_email_notifications_policy_values_for_realm_user_default(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    RealmUserDefault.objects.filter(realm_name_in_notifications=True).update(
        realm_name_in_email_notifications_policy=REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_ALWAYS
    )


def reverse_code_for_realm_user_default(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    RealmUserDefault.objects.filter(
        realm_name_in_email_notifications_policy=REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_ALWAYS
    ).update(realm_name_in_notifications=True)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0431_alter_archivedreaction_unique_together_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="realm_name_in_email_notifications_policy",
            field=models.PositiveSmallIntegerField(
                default=REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_AUTOMATIC
            ),
        ),
        migrations.RunPython(
            update_realm_name_in_email_notifications_policy_values_for_realm_user_default,
            reverse_code=reverse_code_for_realm_user_default,
            elidable=True,
        ),
        migrations.AddField(
            model_name="userprofile",
            name="realm_name_in_email_notifications_policy",
            field=models.PositiveSmallIntegerField(
                default=REALM_NAME_IN_EMAIL_NOTIFICATIONS_POLICY_AUTOMATIC
            ),
        ),
        migrations.RunPython(
            update_realm_name_in_email_notifications_policy_values,
            reverse_code=reverse_code,
            elidable=True,
        ),
        migrations.RemoveField(
            model_name="realmuserdefault",
            name="realm_name_in_notifications",
        ),
        migrations.RemoveField(
            model_name="userprofile",
            name="realm_name_in_notifications",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0433_preregistrationrealm.py]---
Location: zulip-main/zerver/migrations/0433_preregistrationrealm.py
Signals: Django

```python
# Generated by Django 4.1.7 on 2023-03-07 09:14

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0432_alter_and_migrate_realm_name_in_notifications"),
    ]

    operations = [
        migrations.CreateModel(
            name="PreregistrationRealm",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("name", models.CharField(max_length=40)),
                (
                    "org_type",
                    models.PositiveSmallIntegerField(
                        choices=[
                            (0, "Unspecified"),
                            (10, "Business"),
                            (20, "Open-source project"),
                            (30, "Education (non-profit)"),
                            (35, "Education (for-profit)"),
                            (40, "Research"),
                            (50, "Event or conference"),
                            (60, "Non-profit (registered)"),
                            (70, "Government"),
                            (80, "Political group"),
                            (90, "Community"),
                            (100, "Personal"),
                            (1000, "Other"),
                        ],
                        default=0,
                    ),
                ),
                ("string_id", models.CharField(max_length=40)),
                ("email", models.EmailField(max_length=254)),
                ("status", models.IntegerField(default=0)),
                (
                    "created_realm",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="+",
                        to="zerver.realm",
                    ),
                ),
                (
                    "created_user",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="+",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0434_create_nobody_system_group.py]---
Location: zulip-main/zerver/migrations/0434_create_nobody_system_group.py
Signals: Django

```python
# Generated by Django 4.1.7 on 2023-03-27 03:00

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def create_nobody_system_user_group_for_existing_realms(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    UserGroup = apps.get_model("zerver", "UserGroup")
    NOBODY_GROUP_NAME = "@role:nobody"
    NOBODY_GROUP_DESCRIPTION = "Nobody"

    groups_to_create = [
        UserGroup(
            name=NOBODY_GROUP_NAME,
            description=NOBODY_GROUP_DESCRIPTION,
            realm=realm,
            is_system_group=True,
        )
        for realm in Realm.objects.all()
    ]

    UserGroup.objects.bulk_create(groups_to_create)


def delete_nobody_system_user_groups(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    UserGroup = apps.get_model("zerver", "UserGroup")
    NOBODY_GROUP_NAME = "@role:nobody"

    UserGroup.objects.filter(name=NOBODY_GROUP_NAME, is_system_group=True).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0433_preregistrationrealm"),
    ]

    operations = [
        migrations.RunPython(
            create_nobody_system_user_group_for_existing_realms,
            reverse_code=delete_nobody_system_user_groups,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0435_scheduledmessage_rendered_content.py]---
Location: zulip-main/zerver/migrations/0435_scheduledmessage_rendered_content.py
Signals: Django

```python
# Generated by Django 4.1.5 on 2023-01-16 08:35

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0434_create_nobody_system_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="scheduledmessage",
            name="rendered_content",
            field=models.TextField(default=""),
            preserve_default=False,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0436_realmauthenticationmethods.py]---
Location: zulip-main/zerver/migrations/0436_realmauthenticationmethods.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-04-13 23:45

import django.db.models.deletion
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fill_RealmAuthenticationMethod_data(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    RealmAuthenticationMethod = apps.get_model("zerver", "RealmAuthenticationMethod")
    rows_to_create = []
    for realm in Realm.objects.order_by("id"):
        for key, value in realm.authentication_methods.iteritems():
            if value:
                rows_to_create.append(RealmAuthenticationMethod(name=key, realm_id=realm.id))

    RealmAuthenticationMethod.objects.bulk_create(rows_to_create, batch_size=10000)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0435_scheduledmessage_rendered_content"),
    ]

    operations = [
        migrations.CreateModel(
            name="RealmAuthenticationMethod",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("name", models.CharField(max_length=80)),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
            options={
                "unique_together": {("realm", "name")},
            },
        ),
        migrations.RunPython(fill_RealmAuthenticationMethod_data, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0437_remove_realm_authentication_methods.py]---
Location: zulip-main/zerver/migrations/0437_remove_realm_authentication_methods.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-04-16 10:55

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0436_realmauthenticationmethods"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="authentication_methods",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0438_add_web_mark_read_on_scroll_policy_setting.py]---
Location: zulip-main/zerver/migrations/0438_add_web_mark_read_on_scroll_policy_setting.py
Signals: Django

```python
# Generated by Django 4.1.7 on 2023-04-05 01:19

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0437_remove_realm_authentication_methods"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_mark_read_on_scroll_policy",
            field=models.SmallIntegerField(default=1),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_mark_read_on_scroll_policy",
            field=models.SmallIntegerField(default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0439_fix_deleteduser_email.py]---
Location: zulip-main/zerver/migrations/0439_fix_deleteduser_email.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-04-17 18:25

from email.headerregistry import Address
from functools import lru_cache

from django.conf import settings
from django.core.exceptions import ValidationError
from django.core.validators import validate_email
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Q


@lru_cache
def get_fake_email_domain(apps: StateApps, realm_id: int) -> str:
    Realm = apps.get_model("zerver", "Realm")
    realm = Realm.objects.get(id=realm_id)

    # Build out realm.host
    subdomain = realm.string_id
    if subdomain == "":
        host = settings.EXTERNAL_HOST
    else:
        default_host = f"{subdomain}.{settings.EXTERNAL_HOST}"
        host = settings.REALM_HOSTS.get(subdomain, default_host)

    # Implement get_fake_email_domain
    try:
        validate_email(Address(username="bot", domain=host).addr_spec)
        return host
    except ValidationError:
        pass

    try:
        # Check that the fake email domain can be used to form valid email addresses.
        validate_email(Address(username="bot", domain=settings.FAKE_EMAIL_DOMAIN).addr_spec)
        return settings.FAKE_EMAIL_DOMAIN
    except ValidationError:
        raise Exception(
            settings.FAKE_EMAIL_DOMAIN + " is not a valid domain. "
            "Consider setting the FAKE_EMAIL_DOMAIN setting."
        )


def fix_invalid_emails(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Find deleted users prior to the fix in 208c0c303405, which have
    invalid delivery_email values; fixing them allows them to survive
    an export/import.
    """

    UserProfile = apps.get_model("zerver", "UserProfile")
    invalid_users = UserProfile.objects.filter(is_active=False).filter(
        Q(delivery_email__icontains="@https://") | Q(delivery_email__icontains="@http://")
    )
    for invalid_user in invalid_users:
        local_part = invalid_user.delivery_email.split("@")[0]
        invalid_user.delivery_email = (
            local_part + "@" + get_fake_email_domain(apps, invalid_user.realm_id)
        )
        invalid_user.save(update_fields=["delivery_email"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0438_add_web_mark_read_on_scroll_policy_setting"),
    ]

    operations = [
        migrations.RunPython(
            fix_invalid_emails, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0440_realmfilter_url_template.py]---
Location: zulip-main/zerver/migrations/0440_realmfilter_url_template.py
Signals: Django

```python
# Generated by Django 4.0.7 on 2022-10-02 20:50

from django.db import migrations, models

from zerver.models.linkifiers import url_template_validator


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0439_fix_deleteduser_email"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmfilter",
            name="url_template",
            field=models.TextField(validators=[url_template_validator], null=True),
        ),
        migrations.AlterField(
            model_name="realmfilter",
            name="url_format_string",
            field=models.TextField(null=True, blank=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0441_backfill_realmfilter_url_template.py]---
Location: zulip-main/zerver/migrations/0441_backfill_realmfilter_url_template.py
Signals: Django

```python
# Generated by Django 4.0.7 on 2022-10-02 20:50

import re

import uri_template
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def transform_to_url_template_syntax(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    linkifier_model = apps.get_model("zerver", "RealmFilter")

    linkifiers = linkifier_model.objects.all()
    # Matches anything of the form %(variable_name)s
    var_pattern = re.compile(r"(?<!%)((?:%%)*)%\(([a-zA-Z0-9_-]+)\)s")
    escape_table = str.maketrans(
        {
            "{": "%7B",
            "}": "%7D",
        }
    )
    for linkifier in linkifiers:
        converted_template = linkifier.url_format_string.translate(escape_table)
        # Replace format string variables with the RFC 6570 URI Template syntax
        converted_template = var_pattern.sub(r"\1{\2}", converted_template).replace("%%", "%")
        if not uri_template.validate(converted_template):
            raise RuntimeError(
                f'Failed to convert url format "{var_pattern}". The converted template "{converted_template}" is invalid.'
            )
        linkifier.url_template = converted_template
    linkifier_model.objects.bulk_update(linkifiers, fields=["url_template"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0440_realmfilter_url_template"),
    ]

    operations = [
        migrations.RunPython(
            transform_to_url_template_syntax,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0442_remove_realmfilter_url_format_string.py]---
Location: zulip-main/zerver/migrations/0442_remove_realmfilter_url_format_string.py
Signals: Django

```python
from django.db import migrations, models

from zerver.models.linkifiers import url_template_validator


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0441_backfill_realmfilter_url_template"),
    ]

    operations = [
        migrations.RemoveField(model_name="realmfilter", name="url_format_string"),
        migrations.AlterField(
            model_name="realmfilter",
            name="url_template",
            field=models.TextField(validators=[url_template_validator], null=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0443_userpresence_new_table_schema.py]---
Location: zulip-main/zerver/migrations/0443_userpresence_new_table_schema.py
Signals: Django

```python
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models

from zerver.lib.migrate import rename_indexes_constraints


class Migration(migrations.Migration):
    """
    First step of migrating to a new UserPresence data model. Creates a new
    table with the intended fields, into which in the next step
    data can be ported over from the current UserPresence model.
    In the last step, the old model will be replaced with the new one.
    """

    dependencies = [
        ("zerver", "0442_remove_realmfilter_url_format_string"),
    ]

    operations = [
        # Django doesn't rename indexes and constraints when renaming
        # a table (https://code.djangoproject.com/ticket/23577). This
        # means that after renaming UserPresence->UserPresenceOld the
        # UserPresenceOld indexes/constraints retain their old name
        # causing a conflict when CreateModel tries to create them for
        # the new UserPresence table.
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunPython(
                    rename_indexes_constraints("zerver_userpresence", "zerver_userpresenceold"),
                    reverse_code=rename_indexes_constraints(
                        "zerver_userpresenceold", "zerver_userpresence"
                    ),
                )
            ],
            state_operations=[
                migrations.RenameModel(
                    old_name="UserPresence",
                    new_name="UserPresenceOld",
                ),
                migrations.RenameIndex(
                    model_name="userpresenceold",
                    old_name="zerver_userpresence_realm_id_timestamp_25f410da_idx",
                    new_name="zerver_userpresenceold_realm_id_timestamp_52ef5fd3_idx",
                ),
            ],
        ),
        migrations.CreateModel(
            name="UserPresence",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "last_connected_time",
                    models.DateTimeField(
                        db_index=True, default=django.utils.timezone.now, null=True
                    ),
                ),
                (
                    "last_active_time",
                    models.DateTimeField(
                        db_index=True, default=django.utils.timezone.now, null=True
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.Realm"
                    ),
                ),
                (
                    "user_profile",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
        migrations.AddIndex(
            model_name="userpresence",
            index=models.Index(
                fields=["realm", "last_active_time"],
                name="zerver_userpresence_realm_id_last_active_time_1c5aa9a2_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="userpresence",
            index=models.Index(
                fields=["realm", "last_connected_time"],
                name="zerver_userpresence_realm_id_last_connected_time_98d2fc9f_idx",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0444_userpresence_fill_data.py]---
Location: zulip-main/zerver/migrations/0444_userpresence_fill_data.py
Signals: Django

```python
from django.db import connection, migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fill_new_columns(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserPresence = apps.get_model("zerver", "UserPresence")

    # In theory, we'd like to preserve the distinction between the
    # IDLE and ACTIVE statuses in legacy data.  However, there is no
    # correct way to do so; the previous data structure only stored
    # the current IDLE/ACTIVE status of the last update for each
    # (user, client) pair. There's no way to know whether the last
    # time the user had the other status with that client was minutes
    # or months beforehand.
    #
    # So the only sane thing we can do with this migration is to treat
    # the last presence update as having been a PRESENCE_ACTIVE_STATUS
    # event. This will result in some currently-idle users being
    # incorrectly recorded as having been active at the last moment
    # that they were idle before this migration.  This error is
    # unlikely to be significant in practice, and in any case is an
    # unavoidable flaw caused by the legacy previous data model.
    with connection.cursor() as cursor:
        cursor.execute(
            "SELECT realm_id, user_profile_id, MAX(timestamp) FROM zerver_userpresenceold WHERE status IN (1, 2) GROUP BY realm_id, user_profile_id"
        )
        latest_presence_per_user = cursor.fetchall()

    UserPresence.objects.bulk_create(
        [
            UserPresence(
                user_profile_id=presence_row[1],
                realm_id=presence_row[0],
                last_connected_time=presence_row[2],
                last_active_time=presence_row[2],
            )
            for presence_row in latest_presence_per_user
        ],
        # Limit the size of individual network requests for very large
        # servers.
        batch_size=10000,
        # If the UserPresence worker has already started, or a user
        # has changed their invisible status while migrations are
        # running, then some UserPresence rows may exist. Those will
        # generally be newer than what we have here, so ignoring
        # conflicts so we can complete backfilling users who don't
        # have more current data is the right resolution.
        ignore_conflicts=True,
    )


def clear_new_columns(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserPresence = apps.get_model("zerver", "UserPresence")
    UserPresence.objects.all().delete()


class Migration(migrations.Migration):
    """
    Ports data from the UserPresence model into the new one.
    """

    atomic = False

    dependencies = [
        ("zerver", "0443_userpresence_new_table_schema"),
    ]

    operations = [
        migrations.RunPython(fill_new_columns, reverse_code=clear_new_columns, elidable=True)
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0445_drop_userpresenceold.py]---
Location: zulip-main/zerver/migrations/0445_drop_userpresenceold.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    """
    Finalizes the migration to the new UserPresence model.
    We can get rid of the old table together with its data.
    """

    dependencies = [
        ("zerver", "0444_userpresence_fill_data"),
    ]

    operations = [migrations.DeleteModel(name="UserPresenceOld")]
```

--------------------------------------------------------------------------------

---[FILE: 0446_realmauditlog_zerver_realmauditlog_user_subscriptions_idx.py]---
Location: zulip-main/zerver/migrations/0446_realmauditlog_zerver_realmauditlog_user_subscriptions_idx.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-04-28 19:06

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0445_drop_userpresenceold"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="realmauditlog",
            index=models.Index(
                name="zerver_realmauditlog_user_subscriptions_idx",
                fields=["modified_user", "modified_stream"],
                condition=models.Q(
                    event_type__in=[
                        301,  # RealmAuditLog.SUBSCRIPTION_CREATED
                        302,  # RealmAuditLog.SUBSCRIPTION_ACTIVATED
                        303,  # RealmAuditLog.SUBSCRIPTION_DEACTIVATED
                    ]
                ),
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0447_attachment_scheduled_messages_and_more.py]---
Location: zulip-main/zerver/migrations/0447_attachment_scheduled_messages_and_more.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-05-06 23:34

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0446_realmauditlog_zerver_realmauditlog_user_subscriptions_idx"),
    ]

    operations = [
        migrations.AddField(
            model_name="attachment",
            name="scheduled_messages",
            field=models.ManyToManyField(to="zerver.scheduledmessage"),
        ),
        migrations.AddField(
            model_name="scheduledmessage",
            name="has_attachment",
            field=models.BooleanField(db_index=True, default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0448_scheduledmessage_new_fields.py]---
Location: zulip-main/zerver/migrations/0448_scheduledmessage_new_fields.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-05-05 00:18

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0447_attachment_scheduled_messages_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="scheduledmessage",
            name="failed",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="scheduledmessage",
            name="failure_message",
            field=models.TextField(null=True),
        ),
        migrations.AddField(
            model_name="scheduledmessage",
            name="delivered_message",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zerver.message"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0449_scheduledmessage_zerver_unsent_scheduled_messages_indexes.py]---
Location: zulip-main/zerver/migrations/0449_scheduledmessage_zerver_unsent_scheduled_messages_indexes.py
Signals: Django

```python
# Generated by Django 4.2 on 2023-05-09 00:58

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0448_scheduledmessage_new_fields"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="scheduledmessage",
            index=models.Index(
                condition=models.Q(("delivered", False), ("failed", False)),
                fields=["scheduled_timestamp"],
                name="zerver_unsent_scheduled_messages_by_time",
            ),
        ),
        migrations.AddIndex(
            model_name="scheduledmessage",
            index=models.Index(
                condition=models.Q(("delivered", False)),
                fields=["sender", "delivery_type", "scheduled_timestamp"],
                name="zerver_unsent_scheduled_messages_by_user",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
