---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 942
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 942 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0285_remove_realm_google_hangouts_domain.py]---
Location: zulip-main/zerver/migrations/0285_remove_realm_google_hangouts_domain.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-14 01:58

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

VIDEO_CHAT_PROVIDERS = {
    "jitsi_meet": {
        "name": "Jitsi Meet",
        "id": 1,
    },
    "google_hangouts": {
        "name": "Google Hangouts",
        "id": 2,
    },
}


def remove_google_hangouts_provider(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    # We are removing the Google Hangout integration because Google has
    # removed the Hangouts brand. All the realms that used Hangouts as
    # their video chat provided are now set to the default, Jitsi.
    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.filter(video_chat_provider=VIDEO_CHAT_PROVIDERS["google_hangouts"]["id"]).update(
        video_chat_provider=VIDEO_CHAT_PROVIDERS["jitsi_meet"]["id"]
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0284_convert_realm_admins_to_realm_owners"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="google_hangouts_domain",
        ),
        migrations.RunPython(
            remove_google_hangouts_provider, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0286_merge_0260_0285.py]---
Location: zulip-main/zerver/migrations/0286_merge_0260_0285.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-17 06:26

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0261_pregistrationuser_clear_invited_as_admin"),
        ("zerver", "0285_remove_realm_google_hangouts_domain"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0287_clear_duplicate_reactions.py]---
Location: zulip-main/zerver/migrations/0287_clear_duplicate_reactions.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Count


def clear_duplicate_reactions(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Zulip's data model for reactions has enforced via code,
    nontransactionally, that they can only react with one emoji_code
    for a given reaction_type.  This fixes any that were stored in the
    database via a race; the next migration will add the appropriate
    database-level unique constraint.
    """
    Reaction = apps.get_model("zerver", "Reaction")

    duplicate_reactions = (
        Reaction.objects.all()
        .values("user_profile_id", "message_id", "reaction_type", "emoji_code")
        .annotate(Count("id"))
        .filter(id__count__gt=1)
    )
    for duplicate_reaction in duplicate_reactions:
        duplicate_reaction.pop("id__count")
        to_cleanup = Reaction.objects.filter(**duplicate_reaction)[1:]
        for reaction in to_cleanup:
            reaction.delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0286_merge_0260_0285"),
    ]

    operations = [
        migrations.RunPython(
            clear_duplicate_reactions, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0288_reaction_unique_on_emoji_code.py]---
Location: zulip-main/zerver/migrations/0288_reaction_unique_on_emoji_code.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-19 08:16

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0287_clear_duplicate_reactions"),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name="archivedreaction",
            unique_together={
                ("user_profile", "message", "emoji_name"),
                ("user_profile", "message", "reaction_type", "emoji_code"),
            },
        ),
        migrations.AlterUniqueTogether(
            name="reaction",
            unique_together={
                ("user_profile", "message", "emoji_name"),
                ("user_profile", "message", "reaction_type", "emoji_code"),
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0289_tighten_attachment_size.py]---
Location: zulip-main/zerver/migrations/0289_tighten_attachment_size.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-20 19:57

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0288_reaction_unique_on_emoji_code"),
    ]

    operations = [
        migrations.AlterField(
            model_name="archivedattachment",
            name="size",
            field=models.IntegerField(default=0),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="attachment",
            name="size",
            field=models.IntegerField(default=0),
            preserve_default=False,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0290_remove_night_mode_add_color_scheme.py]---
Location: zulip-main/zerver/migrations/0290_remove_night_mode_add_color_scheme.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-20 15:22

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

COLOR_SCHEME_AUTOMATIC = 1
COLOR_SCHEME_NIGHT = 2


# Set color_scheme to night mode, if night_mode is True.
def set_color_scheme_to_night_mode(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserProfile.objects.filter(night_mode=True).update(color_scheme=COLOR_SCHEME_NIGHT)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0289_tighten_attachment_size"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="color_scheme",
            field=models.PositiveSmallIntegerField(default=COLOR_SCHEME_AUTOMATIC),
        ),
        migrations.RunPython(
            set_color_scheme_to_night_mode, reverse_code=migrations.RunPython.noop, elidable=True
        ),
        migrations.RemoveField(
            model_name="userprofile",
            name="night_mode",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0291_realm_retention_days_not_null.py]---
Location: zulip-main/zerver/migrations/0291_realm_retention_days_not_null.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-24 09:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0290_remove_night_mode_add_color_scheme"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="message_retention_days",
            field=models.IntegerField(default=-1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0292_update_default_value_of_invited_as.py]---
Location: zulip-main/zerver/migrations/0292_update_default_value_of_invited_as.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-21 21:09

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0291_realm_retention_days_not_null"),
    ]

    operations = [
        migrations.AlterField(
            model_name="multiuseinvite",
            name="invited_as",
            field=models.PositiveSmallIntegerField(default=400),
        ),
        migrations.AlterField(
            model_name="preregistrationuser",
            name="invited_as",
            field=models.PositiveSmallIntegerField(default=400),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0293_update_invite_as_dict_values.py]---
Location: zulip-main/zerver/migrations/0293_update_invite_as_dict_values.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-21 21:13

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def update_invite_as_dict_values(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    PreregistrationUser = apps.get_model("zerver", "PreregistrationUser")
    MultiuseInvite = apps.get_model("zerver", "MultiuseInvite")

    OLD_INVITE_AS_DICT = dict(
        MEMBER=1,
        REALM_ADMIN=2,
        GUEST_USER=3,
        REALM_OWNER=4,
    )
    NEW_INVITE_AS_DICT = dict(
        REALM_OWNER=100,
        REALM_ADMIN=200,
        MEMBER=400,
        GUEST_USER=600,
    )

    PreregistrationUser.objects.filter(invited_as=OLD_INVITE_AS_DICT["REALM_OWNER"]).update(
        invited_as=NEW_INVITE_AS_DICT["REALM_OWNER"]
    )
    PreregistrationUser.objects.filter(invited_as=OLD_INVITE_AS_DICT["REALM_ADMIN"]).update(
        invited_as=NEW_INVITE_AS_DICT["REALM_ADMIN"]
    )
    PreregistrationUser.objects.filter(invited_as=OLD_INVITE_AS_DICT["MEMBER"]).update(
        invited_as=NEW_INVITE_AS_DICT["MEMBER"]
    )
    PreregistrationUser.objects.filter(invited_as=OLD_INVITE_AS_DICT["GUEST_USER"]).update(
        invited_as=NEW_INVITE_AS_DICT["GUEST_USER"]
    )

    MultiuseInvite.objects.filter(invited_as=OLD_INVITE_AS_DICT["REALM_OWNER"]).update(
        invited_as=NEW_INVITE_AS_DICT["REALM_OWNER"]
    )
    MultiuseInvite.objects.filter(invited_as=OLD_INVITE_AS_DICT["REALM_ADMIN"]).update(
        invited_as=NEW_INVITE_AS_DICT["REALM_ADMIN"]
    )
    MultiuseInvite.objects.filter(invited_as=OLD_INVITE_AS_DICT["MEMBER"]).update(
        invited_as=NEW_INVITE_AS_DICT["MEMBER"]
    )
    MultiuseInvite.objects.filter(invited_as=OLD_INVITE_AS_DICT["GUEST_USER"]).update(
        invited_as=NEW_INVITE_AS_DICT["GUEST_USER"]
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0292_update_default_value_of_invited_as"),
    ]

    operations = [
        migrations.RunPython(
            update_invite_as_dict_values, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0294_remove_userprofile_pointer.py]---
Location: zulip-main/zerver/migrations/0294_remove_userprofile_pointer.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-07-03 12:53

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0293_update_invite_as_dict_values"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="userprofile",
            name="pointer",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0295_case_insensitive_email_indexes.py]---
Location: zulip-main/zerver/migrations/0295_case_insensitive_email_indexes.py
Signals: Django

```python
from django.db import migrations, models
from django.db.models.functions import Upper


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0294_remove_userprofile_pointer"),
    ]

    operations = [
        migrations.AddConstraint(
            model_name="userprofile",
            constraint=models.UniqueConstraint(
                models.F("realm"),
                Upper(models.F("email")),
                name="zerver_userprofile_realm_id_email_uniq",
            ),
        ),
        migrations.AddConstraint(
            model_name="userprofile",
            constraint=models.UniqueConstraint(
                models.F("realm"),
                Upper(models.F("delivery_email")),
                name="zerver_userprofile_realm_id_delivery_email_uniq",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="userprofile",
            unique_together=set(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0296_remove_userprofile_short_name.py]---
Location: zulip-main/zerver/migrations/0296_remove_userprofile_short_name.py
Signals: Django

```python
# Generated by Django 2.2.14 on 2020-07-16 11:06

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0295_case_insensitive_email_indexes"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="userprofile",
            name="short_name",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0297_draft.py]---
Location: zulip-main/zerver/migrations/0297_draft.py
Signals: Django

```python
# Generated by Django 2.2.14 on 2020-07-23 17:07

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0296_remove_userprofile_short_name"),
    ]

    operations = [
        migrations.CreateModel(
            name="Draft",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("topic", models.CharField(db_index=True, max_length=60)),
                ("content", models.TextField()),
                ("last_edit_time", models.DateTimeField(db_index=True)),
                (
                    "recipient",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        to="zerver.Recipient",
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0298_fix_realmauditlog_format.py]---
Location: zulip-main/zerver/migrations/0298_fix_realmauditlog_format.py
Signals: Django

```python
# Generated by Django 2.2.14 on 2020-08-07 19:13

import json

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def update_realmauditlog_values(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """
    This migration fixes two issues with the RealmAuditLog format for certain event types:
    * The notifications_stream and signup_notifications_stream fields had the
      Stream objects passed into `ujson.dumps()` and thus marshalled as a giant
      JSON object, when the intent was to store the stream ID.
    * The default_sending_stream would also been marshalled wrong, but are part
      of a feature that nobody should be using, so we simply assert that's the case.
    * Changes the structure of the extra_data JSON dictionaries for those
      RealmAuditLog entries with a sub-property field from:
      {
          OLD_VALUE: {"property": property, "value": old_value},
          NEW_VALUE: {"property": property, "value": new_value},
      }

      to the more natural:

      {
          OLD_VALUE: old_value,
          NEW_VALUE: new_value,
          "property": property,
      }
    """
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    # Constants from models/realm_audit_logs.py
    USER_DEFAULT_SENDING_STREAM_CHANGED = 129
    USER_DEFAULT_REGISTER_STREAM_CHANGED = 130
    USER_DEFAULT_ALL_PUBLIC_STREAMS_CHANGED = 131
    # Note that this was renamed to USER_SETTING_CHANGED sometime
    # after this migration; we preserve the original name here to
    # highlight that as of this migration, only notification settings
    # had RealmAuditLog entries for changes.
    USER_NOTIFICATION_SETTINGS_CHANGED = 132
    REALM_PROPERTY_CHANGED = 207
    SUBSCRIPTION_PROPERTY_CHANGED = 304
    OLD_VALUE = "1"
    NEW_VALUE = "2"

    unlikely_event_types = [
        USER_DEFAULT_SENDING_STREAM_CHANGED,
        USER_DEFAULT_REGISTER_STREAM_CHANGED,
        USER_DEFAULT_ALL_PUBLIC_STREAMS_CHANGED,
    ]
    # These 3 event types are the ones that used a format with
    # OLD_VALUE containing a dictionary with a `property` key.
    affected_event_types = [
        REALM_PROPERTY_CHANGED,
        USER_NOTIFICATION_SETTINGS_CHANGED,
        SUBSCRIPTION_PROPERTY_CHANGED,
    ]
    improperly_marshalled_properties = [
        "notifications_stream",
        "signup_notifications_stream",
    ]

    # These are also corrupted but are part of a feature nobody uses,
    # so it's not worth writing code to fix them.
    assert not RealmAuditLog.objects.filter(event_type__in=unlikely_event_types).exists()

    for ra in RealmAuditLog.objects.filter(event_type__in=affected_event_types):
        extra_data = json.loads(ra.extra_data)
        old_key = extra_data[OLD_VALUE]
        new_key = extra_data[NEW_VALUE]

        # Skip any already-migrated values in case we're running this
        # migration a second time.
        if not isinstance(old_key, dict) and not isinstance(new_key, dict):
            continue
        if "value" not in old_key or "value" not in new_key:
            continue

        old_value = old_key["value"]
        new_value = new_key["value"]
        prop = old_key["property"]

        # The `authentication_methods` key is the only event whose
        # action value type is expected to be a dictionary.  That
        # property is marshalled properly but still wants the second
        # migration below.
        if prop != "authentication_methods":
            # For the other properties, we have `stream` rather than `stream['id']`
            # in the original extra_data object; the fix is simply to extract
            # the intended ID field via `value = value['id']`.
            if isinstance(old_value, dict):
                assert prop in improperly_marshalled_properties
                old_value = old_value["id"]
            if isinstance(new_value, dict):
                assert prop in improperly_marshalled_properties
                new_value = new_value["id"]

        # Sanity check that the original event has exactly the keys we expect.
        assert set(extra_data.keys()) <= {OLD_VALUE, NEW_VALUE}

        ra.extra_data = json.dumps(
            {
                OLD_VALUE: old_value,
                NEW_VALUE: new_value,
                "property": prop,
            }
        )
        ra.save(update_fields=["extra_data"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0297_draft"),
    ]

    operations = [
        migrations.RunPython(
            update_realmauditlog_values, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0299_subscription_role.py]---
Location: zulip-main/zerver/migrations/0299_subscription_role.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-10 18:44

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0298_fix_realmauditlog_format"),
    ]

    operations = [
        migrations.AddField(
            model_name="subscription",
            name="role",
            field=models.PositiveSmallIntegerField(db_index=True, default=50),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0300_add_attachment_is_web_public.py]---
Location: zulip-main/zerver/migrations/0300_add_attachment_is_web_public.py
Signals: Django

```python
# Generated by Django 2.2.14 on 2020-07-31 21:15

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0299_subscription_role"),
    ]

    operations = [
        migrations.AddField(
            model_name="archivedattachment",
            name="is_web_public",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="attachment",
            name="is_web_public",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0301_fix_unread_messages_in_deactivated_streams.py]---
Location: zulip-main/zerver/migrations/0301_fix_unread_messages_in_deactivated_streams.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    """
    We're changing the stream deactivation process to make it mark all messages
    in the stream as read. For things to be consistent with streams that have been
    deactivated before this change, we need a migration to fix those old streams,
    to have all messages marked as read.
    """

    dependencies = [
        ("zerver", "0300_add_attachment_is_web_public"),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
                UPDATE zerver_usermessage SET flags = flags | 1
                FROM zerver_message
                INNER JOIN zerver_stream ON zerver_stream.recipient_id = zerver_message.recipient_id
                WHERE zerver_message.id = zerver_usermessage.message_id
                AND zerver_stream.deactivated;
            """,
            reverse_sql="",
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0302_case_insensitive_stream_name_index.py]---
Location: zulip-main/zerver/migrations/0302_case_insensitive_stream_name_index.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0301_fix_unread_messages_in_deactivated_streams"),
    ]

    operations = [
        # We do Stream lookups case-insensitively with respect to the name, but we were missing
        # the appropriate (realm_id, upper(name::text)) unique index to enforce uniqueness
        # on database level.
        migrations.RunSQL(
            """
            CREATE UNIQUE INDEX zerver_stream_realm_id_name_uniq ON zerver_stream (realm_id, upper(name::text));
        """
        ),
        migrations.AlterUniqueTogether(
            name="stream",
            unique_together=set(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0303_realm_wildcard_mention_policy.py]---
Location: zulip-main/zerver/migrations/0303_realm_wildcard_mention_policy.py
Signals: Django

```python
# Generated by Django 2.2.14 on 2020-09-04 16:28

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0302_case_insensitive_stream_name_index"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="wildcard_mention_policy",
            field=models.PositiveSmallIntegerField(default=4),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0304_remove_default_status_of_default_private_streams.py]---
Location: zulip-main/zerver/migrations/0304_remove_default_status_of_default_private_streams.py
Signals: Django

```python
# Generated by Django 2.2.14 on 2020-08-10 20:21

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def remove_default_status_of_default_private_streams(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    DefaultStream = apps.get_model("zerver", "DefaultStream")
    DefaultStream.objects.filter(stream__invite_only=True).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0303_realm_wildcard_mention_policy"),
    ]

    operations = [
        migrations.RunPython(
            remove_default_status_of_default_private_streams,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0305_realm_deactivated_redirect.py]---
Location: zulip-main/zerver/migrations/0305_realm_deactivated_redirect.py
Signals: Django

```python
# Generated by Django 2.2.16 on 2020-10-30 06:53

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0304_remove_default_status_of_default_private_streams"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="deactivated_redirect",
            field=models.URLField(max_length=128, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0306_custom_profile_field_date_format.py]---
Location: zulip-main/zerver/migrations/0306_custom_profile_field_date_format.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    """
    We previously accepted invalid ISO 8601 dates like 1909-3-5 for
    date values of custom profile fields. Correct them by adding the
    missing leading zeros: 1909-03-05.
    """

    dependencies = [
        ("zerver", "0305_realm_deactivated_redirect"),
    ]

    operations = [
        migrations.RunSQL(
            sql="""\
                UPDATE zerver_customprofilefieldvalue
                SET value = to_char(to_date(value, 'YYYY-MM-DD'), 'YYYY-MM-DD')
                FROM zerver_customprofilefield AS f
                WHERE f.id = field_id
                AND f.field_type = 4
                AND CASE
                        WHEN f.field_type = 4
                        THEN value <> to_char(to_date(value, 'YYYY-MM-DD'), 'YYYY-MM-DD')
                    END;
            """,
            reverse_sql="",
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0307_rename_api_super_user_to_can_forge_sender.py]---
Location: zulip-main/zerver/migrations/0307_rename_api_super_user_to_can_forge_sender.py
Signals: Django

```python
# Generated by Django 2.2.17 on 2020-12-20 13:06

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0306_custom_profile_field_date_format"),
    ]

    operations = [
        migrations.RenameField(
            model_name="userprofile",
            old_name="is_api_super_user",
            new_name="can_forge_sender",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0308_remove_reduntant_realm_meta_permissions.py]---
Location: zulip-main/zerver/migrations/0308_remove_reduntant_realm_meta_permissions.py
Signals: Django

```python
# Generated by Django 2.2.17 on 2020-12-20 14:01

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0307_rename_api_super_user_to_can_forge_sender"),
    ]

    operations = [
        migrations.AlterModelOptions(
            name="realm",
            options={},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0309_userprofile_can_create_users.py]---
Location: zulip-main/zerver/migrations/0309_userprofile_can_create_users.py
Signals: Django

```python
# Generated by Django 2.2.17 on 2020-12-20 14:18

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0308_remove_reduntant_realm_meta_permissions"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="can_create_users",
            field=models.BooleanField(db_index=True, default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0310_jsonfield.py]---
Location: zulip-main/zerver/migrations/0310_jsonfield.py
Signals: Django

```python
# Generated by Django 3.1.5 on 2021-01-10 11:30


from django.db import migrations


class Migration(migrations.Migration):
    """
    This empty migration is only retained for Django's tracking.
    """

    dependencies = [
        ("zerver", "0309_userprofile_can_create_users"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0311_userprofile_default_view.py]---
Location: zulip-main/zerver/migrations/0311_userprofile_default_view.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-03-10 04:14

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0310_jsonfield"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="default_view",
            field=models.TextField(default="recent_topics"),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0312_subscription_is_user_active.py]---
Location: zulip-main/zerver/migrations/0312_subscription_is_user_active.py
Signals: Django

```python
# Generated by Django 3.1.5 on 2021-01-31 15:17

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0311_userprofile_default_view"),
    ]

    operations = [
        migrations.AddField(
            model_name="subscription",
            name="is_user_active",
            field=models.BooleanField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0313_finish_is_user_active_migration.py]---
Location: zulip-main/zerver/migrations/0313_finish_is_user_active_migration.py
Signals: Django

```python
# Generated by Django 3.1.5 on 2021-02-07 14:56

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import connection, migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def backfill_is_user_active(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Subscription = apps.get_model("zerver", "Subscription")
    BATCH_SIZE = 1000
    lower_id_bound = 0

    max_id = Subscription.objects.aggregate(models.Max("id"))["id__max"]
    if max_id is None:
        # No Subscription entries
        return
    while lower_id_bound <= max_id:
        print(f"Processed {lower_id_bound} / {max_id}")
        upper_id_bound = lower_id_bound + BATCH_SIZE
        with connection.cursor() as cursor:
            cursor.execute(
                """
                UPDATE zerver_subscription
                SET is_user_active = zerver_userprofile.is_active
                FROM zerver_userprofile
                WHERE zerver_subscription.user_profile_id = zerver_userprofile.id
                AND zerver_subscription.id BETWEEN %(lower_id_bound)s AND %(upper_id_bound)s
                """,
                {"lower_id_bound": lower_id_bound, "upper_id_bound": upper_id_bound},
            )

        lower_id_bound += BATCH_SIZE + 1


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0312_subscription_is_user_active"),
    ]

    operations = [
        migrations.RunPython(
            backfill_is_user_active, reverse_code=migrations.RunPython.noop, elidable=True
        ),
        # Make the field non-null now that we backfilled.
        migrations.AlterField(
            model_name="subscription",
            name="is_user_active",
            field=models.BooleanField(),
        ),
        AddIndexConcurrently(
            model_name="subscription",
            index=models.Index(
                condition=models.Q(("active", True), ("is_user_active", True)),
                fields=["recipient", "user_profile"],
                name="zerver_subscription_recipient_id_user_profile_id_idx",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0314_muted_user.py]---
Location: zulip-main/zerver/migrations/0314_muted_user.py
Signals: Django

```python
# Generated by Django 3.1.5 on 2021-02-12 12:10

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0313_finish_is_user_active_migration"),
    ]

    operations = [
        migrations.CreateModel(
            name="MutedUser",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("date_muted", models.DateTimeField(default=django.utils.timezone.now)),
                (
                    "muted_user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="+",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="+",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "unique_together": {("user_profile", "muted_user")},
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0315_realmplayground.py]---
Location: zulip-main/zerver/migrations/0315_realmplayground.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-04-07 01:54

import django.core.validators
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0314_muted_user"),
    ]

    operations = [
        migrations.CreateModel(
            name="RealmPlayground",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "url_prefix",
                    models.TextField(validators=[django.core.validators.URLValidator()]),
                ),
                ("name", models.TextField(db_index=True)),
                (
                    "pygments_language",
                    models.CharField(
                        db_index=True,
                        max_length=40,
                        validators=[
                            django.core.validators.RegexValidator(
                                message="Invalid characters in pygments language",
                                regex="^[ a-zA-Z0-9_+-./#]*$",
                            )
                        ],
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
            options={
                "unique_together": {("realm", "name")},
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0316_realm_invite_to_realm_policy.py]---
Location: zulip-main/zerver/migrations/0316_realm_invite_to_realm_policy.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-04-01 19:22

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0315_realmplayground"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="invite_to_realm_policy",
            field=models.PositiveSmallIntegerField(default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0317_migrate_to_invite_to_realm_policy.py]---
Location: zulip-main/zerver/migrations/0317_migrate_to_invite_to_realm_policy.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-04-01 19:27

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def migrate_to_invite_to_realm_policy(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.INVITE_TO_REALM_POLICY_MEMBERS_ONLY = 1
    Realm.INVITE_TO_REALM_POLICY_ADMINS_ONLY = 2
    Realm.objects.filter(invite_by_admins_only=False).update(
        invite_to_realm_policy=Realm.INVITE_TO_REALM_POLICY_MEMBERS_ONLY
    )
    Realm.objects.filter(invite_by_admins_only=True).update(
        invite_to_realm_policy=Realm.INVITE_TO_REALM_POLICY_ADMINS_ONLY
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0316_realm_invite_to_realm_policy"),
    ]

    operations = [
        migrations.RunPython(
            migrate_to_invite_to_realm_policy, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0318_remove_realm_invite_by_admins_only.py]---
Location: zulip-main/zerver/migrations/0318_remove_realm_invite_by_admins_only.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-04-01 19:32

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0317_migrate_to_invite_to_realm_policy"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="invite_by_admins_only",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0319_realm_giphy_rating.py]---
Location: zulip-main/zerver/migrations/0319_realm_giphy_rating.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-03-31 10:06

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0318_remove_realm_invite_by_admins_only"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="giphy_rating",
            field=models.PositiveSmallIntegerField(default=2),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0320_realm_move_messages_between_streams_policy.py]---
Location: zulip-main/zerver/migrations/0320_realm_move_messages_between_streams_policy.py
Signals: Django

```python
# Generated by Django 3.1.7 on 2021-04-09 14:37

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0319_realm_giphy_rating"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="move_messages_between_streams_policy",
            field=models.PositiveSmallIntegerField(default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

````
