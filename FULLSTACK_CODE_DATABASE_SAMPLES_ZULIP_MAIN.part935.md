---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 935
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 935 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0067_archived_models.py]---
Location: zulip-main/zerver/migrations/0067_archived_models.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-26 01:10
import bitfield.models
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0066_realm_inline_url_embed_preview"),
    ]

    operations = [
        migrations.CreateModel(
            name="ArchivedAttachment",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("file_name", models.TextField(db_index=True)),
                ("path_id", models.TextField(db_index=True)),
                ("is_realm_public", models.BooleanField(default=False)),
                (
                    "create_time",
                    models.DateTimeField(db_index=True, default=django.utils.timezone.now),
                ),
                ("size", models.IntegerField(null=True)),
                (
                    "archive_timestamp",
                    models.DateTimeField(db_index=True, default=django.utils.timezone.now),
                ),
            ],
            options={
                "abstract": False,
            },
            bases=(models.Model,),
        ),
        migrations.CreateModel(
            name="ArchivedMessage",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("subject", models.CharField(db_index=True, max_length=60)),
                ("content", models.TextField()),
                ("rendered_content", models.TextField(null=True)),
                ("rendered_content_version", models.IntegerField(null=True)),
                ("pub_date", models.DateTimeField(db_index=True, verbose_name="date published")),
                ("last_edit_time", models.DateTimeField(null=True)),
                ("edit_history", models.TextField(null=True)),
                ("has_attachment", models.BooleanField(db_index=True, default=False)),
                ("has_image", models.BooleanField(db_index=True, default=False)),
                ("has_link", models.BooleanField(db_index=True, default=False)),
                (
                    "archive_timestamp",
                    models.DateTimeField(db_index=True, default=django.utils.timezone.now),
                ),
                (
                    "recipient",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.Recipient"
                    ),
                ),
                (
                    "sender",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
                (
                    "sending_client",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.Client"
                    ),
                ),
            ],
            options={
                "abstract": False,
            },
            bases=(models.Model,),
        ),
        migrations.CreateModel(
            name="ArchivedUserMessage",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "flags",
                    bitfield.models.BitField(
                        [
                            "read",
                            "starred",
                            "collapsed",
                            "mentioned",
                            "wildcard_mentioned",
                            "summarize_in_home",
                            "summarize_in_stream",
                            "force_expand",
                            "force_collapse",
                            "has_alert_word",
                            "historical",
                            "is_me_message",
                        ],
                        default=0,
                    ),
                ),
                (
                    "archive_timestamp",
                    models.DateTimeField(db_index=True, default=django.utils.timezone.now),
                ),
                (
                    "message",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.ArchivedMessage"
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
            options={
                "abstract": False,
            },
            bases=(models.Model,),
        ),
        migrations.AddField(
            model_name="archivedattachment",
            name="messages",
            field=models.ManyToManyField(to="zerver.ArchivedMessage"),
        ),
        migrations.AddField(
            model_name="archivedattachment",
            name="owner",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
            ),
        ),
        migrations.AddField(
            model_name="archivedattachment",
            name="realm",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to="zerver.Realm",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="archivedusermessage",
            unique_together={("user_profile", "message")},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0068_remove_realm_domain.py]---
Location: zulip-main/zerver/migrations/0068_remove_realm_domain.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-13 23:32
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0067_archived_models"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="domain",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0069_realmauditlog_extra_data.py]---
Location: zulip-main/zerver/migrations/0069_realmauditlog_extra_data.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-27 20:00
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0068_remove_realm_domain"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmauditlog",
            name="extra_data",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0070_userhotspot.py]---
Location: zulip-main/zerver/migrations/0070_userhotspot.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-28 00:22
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0069_realmauditlog_extra_data"),
    ]

    operations = [
        migrations.CreateModel(
            name="UserHotspot",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("hotspot", models.CharField(max_length=30)),
                ("timestamp", models.DateTimeField(default=django.utils.timezone.now)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
        migrations.AlterUniqueTogether(
            name="userhotspot",
            unique_together={("user", "hotspot")},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0071_rename_realmalias_to_realmdomain.py]---
Location: zulip-main/zerver/migrations/0071_rename_realmalias_to_realmdomain.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-31 14:21
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0070_userhotspot"),
    ]

    operations = [
        migrations.RenameModel(
            old_name="RealmAlias",
            new_name="RealmDomain",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0072_realmauditlog_add_index_event_time.py]---
Location: zulip-main/zerver/migrations/0072_realmauditlog_add_index_event_time.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-31 05:51
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0071_rename_realmalias_to_realmdomain"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realmauditlog",
            name="event_time",
            field=models.DateTimeField(db_index=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0073_custom_profile_fields.py]---
Location: zulip-main/zerver/migrations/0073_custom_profile_fields.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-04-17 06:49
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0072_realmauditlog_add_index_event_time"),
    ]

    operations = [
        migrations.CreateModel(
            name="CustomProfileField",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("name", models.CharField(max_length=100)),
                (
                    "field_type",
                    models.PositiveSmallIntegerField(
                        choices=[(1, "Integer"), (2, "Float"), (3, "Short text"), (4, "Long text")],
                        default=3,
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.Realm"
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="CustomProfileFieldValue",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("value", models.TextField()),
                (
                    "field",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.CustomProfileField"
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
        migrations.AlterUniqueTogether(
            name="customprofilefieldvalue",
            unique_together={("user_profile", "field")},
        ),
        migrations.AlterUniqueTogether(
            name="customprofilefield",
            unique_together={("realm", "name")},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0074_fix_duplicate_attachments.py]---
Location: zulip-main/zerver/migrations/0074_fix_duplicate_attachments.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-04-13 22:12
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Count


def fix_duplicate_attachments(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Migration 0041 had a bug, where if multiple messages referenced the
    same attachment, rather than creating a single attachment object
    for all of them, we would incorrectly create one for each message.
    This results in exceptions looking up the Attachment object
    corresponding to a file that was used in multiple messages that
    predate migration 0041.

    This migration fixes this by removing the duplicates, moving their
    messages onto a single canonical Attachment object (per path_id).
    """
    Attachment = apps.get_model("zerver", "Attachment")
    # Loop through all groups of Attachment objects with the same `path_id`
    for group in (
        Attachment.objects.values("path_id")
        .annotate(Count("id"))
        .order_by()
        .filter(id__count__gt=1)
    ):
        # Sort by the minimum message ID, to find the first attachment
        attachments = sorted(
            Attachment.objects.filter(path_id=group["path_id"]).order_by("id"),
            key=lambda x: min(x.messages.all().values_list("id")[0]),
        )
        surviving = attachments[0]
        to_cleanup = attachments[1:]
        for a in to_cleanup:
            # For each duplicate attachment, we transfer its messages
            # to the canonical attachment object for that path, and
            # then delete the original attachment.
            for msg in a.messages.all():
                surviving.messages.add(msg)
            surviving.is_realm_public = surviving.is_realm_public or a.is_realm_public
            surviving.save()
            a.delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0073_custom_profile_fields"),
    ]

    operations = [
        migrations.RunPython(fix_duplicate_attachments, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0075_attachment_path_id_unique.py]---
Location: zulip-main/zerver/migrations/0075_attachment_path_id_unique.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-04-13 22:29
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0074_fix_duplicate_attachments"),
    ]

    operations = [
        migrations.AlterField(
            model_name="archivedattachment",
            name="path_id",
            field=models.TextField(db_index=True, unique=True),
        ),
        migrations.AlterField(
            model_name="attachment",
            name="path_id",
            field=models.TextField(db_index=True, unique=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0076_userprofile_emojiset.py]---
Location: zulip-main/zerver/migrations/0076_userprofile_emojiset.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-04-23 19:51
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0075_attachment_path_id_unique"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="emojiset",
            field=models.CharField(
                choices=[
                    ("apple", "Apple"),
                    ("emojione", "Emoji One"),
                    ("google", "Google"),
                    ("twitter", "Twitter"),
                ],
                default="google",
                max_length=20,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0077_add_file_name_field_to_realm_emoji.py]---
Location: zulip-main/zerver/migrations/0077_add_file_name_field_to_realm_emoji.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-03-09 05:23
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0076_userprofile_emojiset"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmemoji",
            name="file_name",
            field=models.TextField(db_index=True, null=True),
        ),
        migrations.RemoveField(
            model_name="realmemoji",
            name="img_url",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0078_service.py]---
Location: zulip-main/zerver/migrations/0078_service.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-04-27 16:55
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0077_add_file_name_field_to_realm_emoji"),
    ]

    operations = [
        migrations.CreateModel(
            name="Service",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("name", models.CharField(max_length=100)),
                ("base_url", models.TextField()),
                ("token", models.TextField()),
                ("interface", models.PositiveSmallIntegerField(default=1)),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0079_remove_old_scheduled_jobs.py]---
Location: zulip-main/zerver/migrations/0079_remove_old_scheduled_jobs.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-05-10 05:59
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def delete_old_scheduled_jobs(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Delete any old scheduled jobs, to handle changes in the format of
    that table.  Ideally, we'd translate the jobs, but it's not really
    worth the development effort to save a few invitation reminders
    and day2 followup emails.
    """
    ScheduledJob = apps.get_model("zerver", "ScheduledJob")
    ScheduledJob.objects.all().delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0078_service"),
    ]

    operations = [
        migrations.RunPython(delete_old_scheduled_jobs, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0080_realm_description_length.py]---
Location: zulip-main/zerver/migrations/0080_realm_description_length.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-05-11 20:27
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0079_remove_old_scheduled_jobs"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="description",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0081_make_emoji_lowercase.py]---
Location: zulip-main/zerver/migrations/0081_make_emoji_lowercase.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-05-02 21:44
import django.core.validators
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def emoji_to_lowercase(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmEmoji = apps.get_model("zerver", "RealmEmoji")
    emoji = RealmEmoji.objects.all()
    for e in emoji:
        # Technically, this could create a conflict, but it's
        # exceedingly unlikely.  If that happens, the sysadmin can
        # manually rename the conflicts with the manage.py shell
        # and then rerun the migration/upgrade.
        e.name = e.name.lower()
        e.save()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0080_realm_description_length"),
    ]

    operations = [
        migrations.RunPython(emoji_to_lowercase, elidable=True),
        migrations.AlterField(
            model_name="realmemoji",
            name="name",
            field=models.TextField(
                validators=[
                    django.core.validators.MinLengthValidator(1),
                    django.core.validators.RegexValidator(
                        message="Invalid characters in emoji name",
                        regex="^[0-9a-z.\\-_]+(?<![.\\-_])$",
                    ),
                ]
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0082_index_starred_user_messages.py]---
Location: zulip-main/zerver/migrations/0082_index_starred_user_messages.py
Signals: Django

```python
from django.db import migrations, models
from django.db.models import Q


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0081_make_emoji_lowercase"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="usermessage",
            index=models.Index(
                "user_profile",
                "message",
                condition=Q(flags__andnz=2),
                name="zerver_usermessage_starred_message_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0083_index_mentioned_user_messages.py]---
Location: zulip-main/zerver/migrations/0083_index_mentioned_user_messages.py
Signals: Django

```python
from django.db import migrations, models
from django.db.models import Q


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0082_index_starred_user_messages"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="usermessage",
            index=models.Index(
                "user_profile",
                "message",
                condition=Q(flags__andnz=8),
                name="zerver_usermessage_mentioned_message_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0084_realmemoji_deactivated.py]---
Location: zulip-main/zerver/migrations/0084_realmemoji_deactivated.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-05-22 14:49
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0083_index_mentioned_user_messages"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmemoji",
            name="deactivated",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0085_fix_bots_with_none_bot_type.py]---
Location: zulip-main/zerver/migrations/0085_fix_bots_with_none_bot_type.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-06-20 10:31
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_bot_type(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    bots = UserProfile.objects.filter(is_bot=True, bot_type=None)
    for bot in bots:
        bot.bot_type = 1
        bot.save()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0084_realmemoji_deactivated"),
    ]

    operations = [
        migrations.RunPython(fix_bot_type, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0086_realm_alter_default_org_type.py]---
Location: zulip-main/zerver/migrations/0086_realm_alter_default_org_type.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-06-26 21:56
from django.db import migrations, models

CORPORATE = 1


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0085_fix_bots_with_none_bot_type"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="org_type",
            field=models.PositiveSmallIntegerField(default=CORPORATE),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0087_remove_old_scheduled_jobs.py]---
Location: zulip-main/zerver/migrations/0087_remove_old_scheduled_jobs.py
Signals: Django

```python
# Generated by Django 1.10.5 on 2017-05-10 05:59
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def delete_old_scheduled_jobs(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Delete any old scheduled jobs, to handle changes in the format of
    send_email. Ideally, we'd translate the jobs, but it's not really
    worth the development effort to save a few invitation reminders
    and day2 followup emails.
    """
    ScheduledJob = apps.get_model("zerver", "ScheduledJob")
    ScheduledJob.objects.all().delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0086_realm_alter_default_org_type"),
    ]

    operations = [
        migrations.RunPython(delete_old_scheduled_jobs, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0088_remove_referral_and_invites.py]---
Location: zulip-main/zerver/migrations/0088_remove_referral_and_invites.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-07-07 08:34
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0087_remove_old_scheduled_jobs"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="referral",
            name="user_profile",
        ),
        migrations.RemoveField(
            model_name="userprofile",
            name="invites_granted",
        ),
        migrations.RemoveField(
            model_name="userprofile",
            name="invites_used",
        ),
        migrations.DeleteModel(
            name="Referral",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0089_auto_20170710_1353.py]---
Location: zulip-main/zerver/migrations/0089_auto_20170710_1353.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-07-10 13:53
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0088_remove_referral_and_invites"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="last_active_message_id",
            field=models.IntegerField(null=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="long_term_idle",
            field=models.BooleanField(db_index=True, default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0090_userprofile_high_contrast_mode.py]---
Location: zulip-main/zerver/migrations/0090_userprofile_high_contrast_mode.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-07-07 15:58
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0089_auto_20170710_1353"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="high_contrast_mode",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0091_realm_allow_edit_history.py]---
Location: zulip-main/zerver/migrations/0091_realm_allow_edit_history.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-07-16 08:57
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0090_userprofile_high_contrast_mode"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="allow_edit_history",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0092_create_scheduledemail.py]---
Location: zulip-main/zerver/migrations/0092_create_scheduledemail.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-07-11 23:41
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0091_realm_allow_edit_history"),
    ]

    operations = [
        migrations.CreateModel(
            name="ScheduledEmail",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("scheduled_timestamp", models.DateTimeField(db_index=True)),
                ("data", models.TextField()),
                ("address", models.EmailField(db_index=True, max_length=254, null=True)),
                ("type", models.PositiveSmallIntegerField()),
                (
                    "user",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "abstract": False,
            },
        ),
        migrations.DeleteModel(
            name="ScheduledJob",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0093_subscription_event_log_backfill.py]---
Location: zulip-main/zerver/migrations/0093_subscription_event_log_backfill.py
Signals: Django

```python
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max
from django.utils.timezone import now as timezone_now


def backfill_subscription_log_events(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    migration_time = timezone_now()
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    Subscription = apps.get_model("zerver", "Subscription")
    Message = apps.get_model("zerver", "Message")
    objects_to_create = []

    subs_query = Subscription.objects.select_related(
        "user_profile", "user_profile__realm", "recipient"
    ).filter(recipient__type=2)
    for sub in subs_query:
        entry = RealmAuditLog(
            realm=sub.user_profile.realm,
            modified_user=sub.user_profile,
            modified_stream_id=sub.recipient.type_id,
            event_last_message_id=0,
            event_type="subscription_created",
            event_time=migration_time,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RealmAuditLog.objects.bulk_create(objects_to_create)
    objects_to_create = []

    event_last_message_id = Message.objects.aggregate(Max("id"))["id__max"]
    migration_time_for_deactivation = timezone_now()
    for sub in subs_query.filter(active=False):
        entry = RealmAuditLog(
            realm=sub.user_profile.realm,
            modified_user=sub.user_profile,
            modified_stream_id=sub.recipient.type_id,
            event_last_message_id=event_last_message_id,
            event_type="subscription_deactivated",
            event_time=migration_time_for_deactivation,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RealmAuditLog.objects.bulk_create(objects_to_create)
    objects_to_create = []


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.objects.filter(event_type="subscription_created").delete()
    RealmAuditLog.objects.filter(event_type="subscription_deactivated").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0092_create_scheduledemail"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmauditlog",
            name="event_last_message_id",
            field=models.IntegerField(null=True),
        ),
        migrations.RunPython(
            backfill_subscription_log_events, reverse_code=reverse_code, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0094_realm_filter_url_validator.py]---
Location: zulip-main/zerver/migrations/0094_realm_filter_url_validator.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-07-22 13:44


from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0093_subscription_event_log_backfill"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0095_index_unread_user_messages.py]---
Location: zulip-main/zerver/migrations/0095_index_unread_user_messages.py
Signals: Django

```python
from django.db import migrations, models
from django.db.models import Q


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0094_realm_filter_url_validator"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="usermessage",
            index=models.Index(
                "user_profile",
                "message",
                condition=Q(flags__andz=1),
                name="zerver_usermessage_unread_message_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0096_add_password_required.py]---
Location: zulip-main/zerver/migrations/0096_add_password_required.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-08-09 04:21
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0095_index_unread_user_messages"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationuser",
            name="password_required",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0097_reactions_emoji_code.py]---
Location: zulip-main/zerver/migrations/0097_reactions_emoji_code.py
Signals: Django

```python
# Generated by Django 1.11.2 on 2017-06-18 21:26
import os

import orjson
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def populate_new_fields(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    # Open the JSON file which contains the data to be used for migration.
    MIGRATION_DATA_PATH = os.path.join(
        os.path.dirname(os.path.dirname(__file__)), "management", "data"
    )
    path_to_unified_reactions = os.path.join(MIGRATION_DATA_PATH, "unified_reactions.json")
    with open(path_to_unified_reactions, "rb") as f:
        unified_reactions = orjson.loads(f.read())

    Reaction = apps.get_model("zerver", "Reaction")
    for reaction in Reaction.objects.all().iterator():
        reaction.emoji_code = unified_reactions.get(reaction.emoji_name)
        if reaction.emoji_code is None:
            # If it's not present in the unified_reactions map, it's a realm emoji.
            reaction.emoji_code = reaction.emoji_name
            if reaction.emoji_name == "zulip":
                # `:zulip:` emoji is a zulip special custom emoji.
                reaction.reaction_type = "zulip_extra_emoji"
            else:
                reaction.reaction_type = "realm_emoji"
        reaction.save()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0096_add_password_required"),
    ]

    operations = [
        migrations.AddField(
            model_name="reaction",
            name="emoji_code",
            field=models.TextField(default="unset"),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="reaction",
            name="reaction_type",
            field=models.CharField(
                choices=[
                    ("unicode_emoji", "Unicode emoji"),
                    ("realm_emoji", "Custom emoji"),
                    ("zulip_extra_emoji", "Zulip extra emoji"),
                ],
                default="unicode_emoji",
                max_length=30,
            ),
        ),
        migrations.RunPython(
            populate_new_fields, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0098_index_has_alert_word_user_messages.py]---
Location: zulip-main/zerver/migrations/0098_index_has_alert_word_user_messages.py
Signals: Django

```python
from django.db import migrations, models
from django.db.models import Q


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0097_reactions_emoji_code"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="usermessage",
            index=models.Index(
                "user_profile",
                "message",
                condition=Q(flags__andnz=512),
                name="zerver_usermessage_has_alert_word_message_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0099_index_wildcard_mentioned_user_messages.py]---
Location: zulip-main/zerver/migrations/0099_index_wildcard_mentioned_user_messages.py
Signals: Django

```python
from django.db import migrations, models
from django.db.models import Q


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0098_index_has_alert_word_user_messages"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="usermessage",
            index=models.Index(
                "user_profile",
                "message",
                condition=Q(flags__andnz=8) | Q(flags__andnz=16),
                name="zerver_usermessage_wildcard_mentioned_message_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
