---
source_txt: fullstack_samples/prowler-master
converted_utc: 2025-12-18T11:26:14Z
part: 29
parts_total: 867
---

# FULLSTACK CODE DATABASE SAMPLES prowler-master

## Verbatim Content (Part 29 of 867)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - prowler-master
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/prowler-master
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0061_daily_severity_summary.py]---
Location: prowler-master/api/src/backend/api/migrations/0061_daily_severity_summary.py
Signals: Django

```python
# Generated by Django 5.1.14 on 2025-12-03 13:38

import uuid

import django.db.models.deletion
from django.db import migrations, models

import api.rls


class Migration(migrations.Migration):
    dependencies = [
        ("api", "0060_attack_surface_overview"),
    ]

    operations = [
        migrations.CreateModel(
            name="DailySeveritySummary",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                ("date", models.DateField()),
                ("critical", models.IntegerField(default=0)),
                ("high", models.IntegerField(default=0)),
                ("medium", models.IntegerField(default=0)),
                ("low", models.IntegerField(default=0)),
                ("informational", models.IntegerField(default=0)),
                ("muted", models.IntegerField(default=0)),
                (
                    "provider",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="daily_severity_summaries",
                        related_query_name="daily_severity_summary",
                        to="api.provider",
                    ),
                ),
                (
                    "scan",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="daily_severity_summaries",
                        related_query_name="daily_severity_summary",
                        to="api.scan",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        to="api.tenant",
                    ),
                ),
            ],
            options={
                "db_table": "daily_severity_summaries",
                "abstract": False,
            },
        ),
        migrations.AddIndex(
            model_name="dailyseveritysummary",
            index=models.Index(
                fields=["tenant_id", "id"],
                name="dss_tenant_id_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="dailyseveritysummary",
            index=models.Index(
                fields=["tenant_id", "provider_id"],
                name="dss_tenant_provider_idx",
            ),
        ),
        migrations.AddConstraint(
            model_name="dailyseveritysummary",
            constraint=models.UniqueConstraint(
                fields=("tenant_id", "provider", "date"),
                name="unique_daily_severity_summary",
            ),
        ),
        migrations.AddConstraint(
            model_name="dailyseveritysummary",
            constraint=api.rls.RowLevelSecurityConstraint(
                "tenant_id",
                name="rls_on_dailyseveritysummary",
                statements=["SELECT", "INSERT", "UPDATE", "DELETE"],
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0062_backfill_daily_severity_summaries.py]---
Location: prowler-master/api/src/backend/api/migrations/0062_backfill_daily_severity_summaries.py
Signals: Django

```python
# Generated by Django 5.1.14 on 2025-12-10

from django.db import migrations
from tasks.tasks import backfill_daily_severity_summaries_task

from api.db_router import MainRouter
from api.rls import Tenant


def trigger_backfill_task(apps, schema_editor):
    """
    Trigger the backfill task for all tenants.

    This dispatches backfill_daily_severity_summaries_task for each tenant
    in the system to populate DailySeveritySummary records from historical scans.
    """
    tenant_ids = Tenant.objects.using(MainRouter.admin_db).values_list("id", flat=True)

    for tenant_id in tenant_ids:
        backfill_daily_severity_summaries_task.delay(tenant_id=str(tenant_id), days=90)


class Migration(migrations.Migration):
    dependencies = [
        ("api", "0061_daily_severity_summary"),
    ]

    operations = [
        migrations.RunPython(trigger_backfill_task, migrations.RunPython.noop),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0063_scan_category_summary.py]---
Location: prowler-master/api/src/backend/api/migrations/0063_scan_category_summary.py
Signals: Django

```python
import uuid

import django.db.models.deletion
from django.db import migrations, models

import api.db_utils
import api.rls


class Migration(migrations.Migration):
    dependencies = [
        ("api", "0062_backfill_daily_severity_summaries"),
    ]

    operations = [
        migrations.CreateModel(
            name="ScanCategorySummary",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=uuid.uuid4,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                (
                    "tenant_id",
                    models.UUIDField(db_index=True, editable=False),
                ),
                (
                    "inserted_at",
                    models.DateTimeField(auto_now_add=True),
                ),
                (
                    "scan",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="category_summaries",
                        related_query_name="category_summary",
                        to="api.scan",
                    ),
                ),
                (
                    "category",
                    models.CharField(max_length=100),
                ),
                (
                    "severity",
                    api.db_utils.SeverityEnumField(
                        choices=[
                            ("critical", "Critical"),
                            ("high", "High"),
                            ("medium", "Medium"),
                            ("low", "Low"),
                            ("informational", "Informational"),
                        ],
                        max_length=50,
                    ),
                ),
                (
                    "total_findings",
                    models.IntegerField(
                        default=0, help_text="Non-muted findings (PASS + FAIL)"
                    ),
                ),
                (
                    "failed_findings",
                    models.IntegerField(
                        default=0,
                        help_text="Non-muted FAIL findings (subset of total_findings)",
                    ),
                ),
                (
                    "new_failed_findings",
                    models.IntegerField(
                        default=0,
                        help_text="Non-muted FAIL with delta='new' (subset of failed_findings)",
                    ),
                ),
            ],
            options={
                "db_table": "scan_category_summaries",
            },
        ),
        migrations.AddIndex(
            model_name="scancategorysummary",
            index=models.Index(
                fields=["tenant_id", "scan"], name="scs_tenant_scan_idx"
            ),
        ),
        migrations.AddConstraint(
            model_name="scancategorysummary",
            constraint=models.UniqueConstraint(
                fields=("tenant_id", "scan_id", "category", "severity"),
                name="unique_category_severity_per_scan",
            ),
        ),
        migrations.AddConstraint(
            model_name="scancategorysummary",
            constraint=api.rls.RowLevelSecurityConstraint(
                field="tenant_id",
                name="rls_on_scancategorysummary",
                statements=["SELECT", "INSERT", "UPDATE", "DELETE"],
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0064_finding_categories.py]---
Location: prowler-master/api/src/backend/api/migrations/0064_finding_categories.py
Signals: Django

```python
import django.contrib.postgres.fields
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("api", "0063_scan_category_summary"),
    ]

    operations = [
        migrations.AddField(
            model_name="finding",
            name="categories",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.CharField(max_length=100),
                blank=True,
                null=True,
                size=None,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: permissions.py]---
Location: prowler-master/api/src/backend/api/rbac/permissions.py
Signals: Django

```python
from enum import Enum
from typing import Optional

from django.db.models import QuerySet
from rest_framework.permissions import BasePermission

from api.db_router import MainRouter
from api.models import Provider, Role, User


class Permissions(Enum):
    MANAGE_USERS = "manage_users"
    MANAGE_ACCOUNT = "manage_account"
    MANAGE_BILLING = "manage_billing"
    MANAGE_PROVIDERS = "manage_providers"
    MANAGE_INTEGRATIONS = "manage_integrations"
    MANAGE_SCANS = "manage_scans"
    UNLIMITED_VISIBILITY = "unlimited_visibility"


class HasPermissions(BasePermission):
    """
    Custom permission to check if the user's role has the required permissions.
    The required permissions should be specified in the view as a list in `required_permissions`.
    """

    def has_permission(self, request, view):
        required_permissions = getattr(view, "required_permissions", [])
        if not required_permissions:
            return True

        user_roles = (
            User.objects.using(MainRouter.admin_db).get(id=request.user.id).roles.all()
        )
        if not user_roles:
            return False

        for perm in required_permissions:
            if not getattr(user_roles[0], perm.value, False):
                return False

        return True


def get_role(user: User) -> Optional[Role]:
    """
    Retrieve the first role assigned to the given user.

    Returns:
        The user's first Role instance if the user has any roles, otherwise None.
    """
    return user.roles.first()


def get_providers(role: Role) -> QuerySet[Provider]:
    """
    Return a distinct queryset of Providers accessible by the given role.

    If the role has no associated provider groups, an empty queryset is returned.

    Args:
        role: A Role instance.

    Returns:
        A QuerySet of Provider objects filtered by the role's provider groups.
        If the role has no provider groups, returns an empty queryset.
    """
    tenant_id = role.tenant_id
    provider_groups = role.provider_groups.all()
    if not provider_groups.exists():
        return Provider.objects.none()

    return Provider.objects.filter(
        tenant_id=tenant_id, provider_groups__in=provider_groups
    ).distinct()
```

--------------------------------------------------------------------------------

````
