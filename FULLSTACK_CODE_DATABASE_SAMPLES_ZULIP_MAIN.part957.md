---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 957
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 957 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0657_set_default_value_for_can_create_bots_group_and_more.py]---
Location: zulip-main/zerver/migrations/0657_set_default_value_for_can_create_bots_group_and_more.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_create_bots_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    bot_creation_policy_to_group_name = {
        1: "role:members",
        2: "role:administrators",
        3: "role:administrators",
    }

    for id, group_name in bot_creation_policy_to_group_name.items():
        Realm.objects.filter(can_create_bots_group=None, bot_creation_policy=id).update(
            can_create_bots_group=NamedUserGroup.objects.filter(
                name=group_name, realm=OuterRef("id"), is_system_group=True
            ).values("pk")
        )


def set_default_value_for_can_create_write_only_bots_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    bot_creation_policy_to_group_name = {
        1: "role:members",
        2: "role:members",
        3: "role:administrators",
    }

    for id, group_name in bot_creation_policy_to_group_name.items():
        Realm.objects.filter(can_create_write_only_bots_group=None, bot_creation_policy=id).update(
            can_create_write_only_bots_group=NamedUserGroup.objects.filter(
                name=group_name, realm=OuterRef("id"), is_system_group=True
            ).values("pk")
        )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0656_realm_can_create_bots_group_and_more"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_create_bots_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
        migrations.RunPython(
            set_default_value_for_can_create_write_only_bots_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0658_alter_realm_can_create_bots_group_and_more.py]---
Location: zulip-main/zerver/migrations/0658_alter_realm_can_create_bots_group_and_more.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-23 15:23

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0657_set_default_value_for_can_create_bots_group_and_more"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_create_bots_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
        migrations.AlterField(
            model_name="realm",
            name="can_create_write_only_bots_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0659_remove_realm_bot_creation_policy.py]---
Location: zulip-main/zerver/migrations/0659_remove_realm_bot_creation_policy.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-27 11:24

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0658_alter_realm_can_create_bots_group_and_more"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="bot_creation_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0660_add_imageattachment_content_type.py]---
Location: zulip-main/zerver/migrations/0660_add_imageattachment_content_type.py
Signals: Django

```python
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef, Subquery


def populate_content_type(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    ImageAttachment = apps.get_model("zerver", "ImageAttachment")
    Attachment = apps.get_model("zerver", "Attachment")

    batch_size = 1000
    min_id = 0
    while True:
        # Update content_types from corresponding Attachments in bulk
        rows_updated = ImageAttachment.objects.filter(
            id__gt=min_id, id__lte=min_id + batch_size
        ).update(
            content_type=Subquery(
                Attachment.objects.filter(path_id=OuterRef("path_id")).values("content_type")
            ),
        )

        if not rows_updated:
            break

        min_id += batch_size
        print(f"Processed ImageAttachments through id {min_id}")


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0659_remove_realm_bot_creation_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="imageattachment",
            name="content_type",
            field=models.TextField(null=True),
        ),
        migrations.RunPython(
            populate_content_type,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0661_archivetransaction_protect_from_deletion.py]---
Location: zulip-main/zerver/migrations/0661_archivetransaction_protect_from_deletion.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-28 06:10

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0660_add_imageattachment_content_type"),
    ]

    operations = [
        migrations.AddField(
            model_name="archivetransaction",
            name="protect_from_deletion",
            field=models.BooleanField(db_index=True, default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0662_clear_realm_channel_fields_if_configured_channel_deactivated.py]---
Location: zulip-main/zerver/migrations/0662_clear_realm_channel_fields_if_configured_channel_deactivated.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-06 09:08

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def clear_realm_channel_fields_if_configured_channel_deactivated(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")

    Realm.objects.filter(moderation_request_channel__deactivated=True).update(
        moderation_request_channel=None
    )
    Realm.objects.filter(new_stream_announcements_stream__deactivated=True).update(
        new_stream_announcements_stream=None
    )
    Realm.objects.filter(signup_announcements_stream__deactivated=True).update(
        signup_announcements_stream=None
    )
    Realm.objects.filter(zulip_update_announcements_stream__deactivated=True).update(
        zulip_update_announcements_stream=None
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0661_archivetransaction_protect_from_deletion"),
    ]

    operations = [
        migrations.RunPython(
            clear_realm_channel_fields_if_configured_channel_deactivated,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0663_realm_enable_guest_user_dm_warning.py]---
Location: zulip-main/zerver/migrations/0663_realm_enable_guest_user_dm_warning.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-06 13:02

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0662_clear_realm_channel_fields_if_configured_channel_deactivated"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="enable_guest_user_dm_warning",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0664_realm_can_summarize_topics_group.py]---
Location: zulip-main/zerver/migrations/0664_realm_can_summarize_topics_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-10 10:31

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0663_realm_enable_guest_user_dm_warning"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_summarize_topics_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0665_set_default_for_can_summarize_topics_group.py]---
Location: zulip-main/zerver/migrations/0665_set_default_for_can_summarize_topics_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-10 10:31

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_for_can_summarize_topics_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    Realm.objects.filter(can_summarize_topics_group=None).update(
        can_summarize_topics_group=NamedUserGroup.objects.filter(
            name="role:everyone", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0664_realm_can_summarize_topics_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_for_can_summarize_topics_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0666_alter_realm_can_summarize_topics_group.py]---
Location: zulip-main/zerver/migrations/0666_alter_realm_can_summarize_topics_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-10 10:36

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0665_set_default_for_can_summarize_topics_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_summarize_topics_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0667_realmuserdefault_hide_ai_features_and_more.py]---
Location: zulip-main/zerver/migrations/0667_realmuserdefault_hide_ai_features_and_more.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-11 10:11

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0666_alter_realm_can_summarize_topics_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="hide_ai_features",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="hide_ai_features",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0668_realm_can_mention_many_users_group.py]---
Location: zulip-main/zerver/migrations/0668_realm_can_mention_many_users_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-08 10:22

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0667_realmuserdefault_hide_ai_features_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_mention_many_users_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0669_set_default_value_for_can_mention_many_users_group.py]---
Location: zulip-main/zerver/migrations/0669_set_default_value_for_can_mention_many_users_group.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_mention_many_users_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    wildcard_mention_policy_to_group_name = {
        1: "role:everyone",
        2: "role:members",
        3: "role:fullmembers",
        5: "role:administrators",
        6: "role:nobody",
        7: "role:moderators",
    }

    for id, group_name in wildcard_mention_policy_to_group_name.items():
        Realm.objects.filter(can_mention_many_users_group=None, wildcard_mention_policy=id).update(
            can_mention_many_users_group=NamedUserGroup.objects.filter(
                name=group_name, realm=OuterRef("id"), is_system_group=True
            ).values("pk")
        )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0668_realm_can_mention_many_users_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_mention_many_users_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0670_alter_realm_can_mention_many_users_group.py]---
Location: zulip-main/zerver/migrations/0670_alter_realm_can_mention_many_users_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-08 10:30

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0669_set_default_value_for_can_mention_many_users_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_mention_many_users_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0671_remove_realm_wildcard_mention_policy.py]---
Location: zulip-main/zerver/migrations/0671_remove_realm_wildcard_mention_policy.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-11 12:00

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0670_alter_realm_can_mention_many_users_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="wildcard_mention_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0672_fix_attachment_realm.py]---
Location: zulip-main/zerver/migrations/0672_fix_attachment_realm.py
Signals: Django

```python
import re

from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_attachment_realm(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Attachment = apps.get_model("zerver", "Attachment")
    ArchivedAttachment = apps.get_model("zerver", "ArchivedAttachment")

    if not Realm.objects.exists():
        return

    internal_realm = Realm.objects.get(string_id=settings.SYSTEM_BOT_REALM)

    print()
    for model in [Attachment, ArchivedAttachment]:
        for attachment in model.objects.filter(realm_id=internal_realm.id).order_by("id"):
            message = attachment.messages.only("realm_id").first()
            if message is not None:
                realm_id = message.realm_id
            else:
                # If attachment.messages is empty, try to infer the realm from path_id.
                # The s3 backend set the path_id based on the correct realm, while the local
                # storage backend formed path_id based on sender's realm (which was wrong
                # for these attachments we're fixing, since the sender was a cross realm bot).
                # We don't need to complicate the logic here with conditioning on the backend
                # because worst case scenario, this just infers the realm to be the system bot
                # realm, thus not changing anything at all.
                matches = re.findall(r"^(\d+)\/", attachment.path_id)
                if not matches:
                    print(
                        f"No realm_id found in path_id '{attachment.path_id}' of attachment {attachment.id}"
                    )
                    continue

                try:
                    realm_id = int(matches[0])
                    if not Realm.objects.filter(id=realm_id).exists():
                        # If the realm doesn't exist (e.g. due to deletion), we can't do anything.
                        continue
                except ValueError:
                    # Don't do anything if path_id doesn't start with a sensible realm id.
                    print(
                        f"Encountered ValueError for realm_id {realm_id} inferred from path_id of attachment {attachment.id}"
                    )
                    continue

            if realm_id == attachment.realm_id:
                # It's already correct, nothing to do.
                continue

            print(
                f"Fixing incorrect realm for {model.__name__} {attachment.id} ({attachment.realm_id} => {realm_id})"
            )
            attachment.realm_id = realm_id
            attachment.save(update_fields=["realm_id"])


class Migration(migrations.Migration):
    """
    Old messages with attachments, sent by cross-realm bots, didn't have
    the realm set correctly to the target realm, this migration fixes it
    by looking at the messages linking to the attachment and setting the realm
    based on the recipient.
    """

    atomic = False

    dependencies = [
        ("zerver", "0671_remove_realm_wildcard_mention_policy"),
    ]

    operations = [
        migrations.RunPython(
            fix_attachment_realm,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0673_stream_can_subscribe_group.py]---
Location: zulip-main/zerver/migrations/0673_stream_can_subscribe_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-17 09:00

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0672_fix_attachment_realm"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_subscribe_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0674_set_default_for_stream_can_subscribe_group.py]---
Location: zulip-main/zerver/migrations/0674_set_default_for_stream_can_subscribe_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-17 09:18

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_subscribe_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "Stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_subscribe_group=None).aggregate(Max("id"))["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_subscribe_group=None).aggregate(Min("id"))["id__min"]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_subscribe_group=None,
            ).update(
                can_subscribe_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0673_stream_can_subscribe_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_subscribe_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0675_alter_stream_can_subscribe_group.py]---
Location: zulip-main/zerver/migrations/0675_alter_stream_can_subscribe_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-17 09:32

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0674_set_default_for_stream_can_subscribe_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_subscribe_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0676_realm_message_edit_history_visibility_policy.py]---
Location: zulip-main/zerver/migrations/0676_realm_message_edit_history_visibility_policy.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-16 10:41

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0675_alter_stream_can_subscribe_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="message_edit_history_visibility_policy",
            field=models.PositiveSmallIntegerField(default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0677_set_default_message_edit_history_visibility_policy.py]---
Location: zulip-main/zerver/migrations/0677_set_default_message_edit_history_visibility_policy.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def set_value_for_message_edit_history_visibility_policy(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    VISIBILITY_ALL = 1
    VISIBILITY_NONE = 3

    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.filter(allow_edit_history=True).update(
        message_edit_history_visibility_policy=VISIBILITY_ALL
    )
    Realm.objects.filter(allow_edit_history=False).update(
        message_edit_history_visibility_policy=VISIBILITY_NONE
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0676_realm_message_edit_history_visibility_policy"),
    ]

    operations = [
        migrations.RunPython(set_value_for_message_edit_history_visibility_policy),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0678_remove_realm_allow_edit_history.py]---
Location: zulip-main/zerver/migrations/0678_remove_realm_allow_edit_history.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-16 10:47

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0677_set_default_message_edit_history_visibility_policy"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="allow_edit_history",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0679_zerver_message_edit_history_id.py]---
Location: zulip-main/zerver/migrations/0679_zerver_message_edit_history_id.py
Signals: Django

```python
# Generated by Django 5.1.6 on 2025-02-26 17:25

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0678_remove_realm_allow_edit_history"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                condition=models.Q(("edit_history__isnull", False)),
                fields=["id"],
                name="zerver_message_edit_history_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0680_rename_general_chat_to_empty_string_topic.py]---
Location: zulip-main/zerver/migrations/0680_rename_general_chat_to_empty_string_topic.py
Signals: Django

```python
from typing import Any

import orjson
from django.conf import settings
from django.db import connection, migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F, Func, JSONField, TextField, Value
from django.db.models.functions import Cast
from django.utils.timezone import now as timezone_now
from psycopg2.sql import SQL, Literal

LAST_EDIT_TIME = timezone_now()
LAST_EDIT_TIMESTAMP = int(LAST_EDIT_TIME.timestamp())


def update_messages_for_topic_edit(message_queryset: Any, notification_bot: Any) -> None:
    edit_history_entry = {
        "user_id": notification_bot.id,
        "timestamp": LAST_EDIT_TIMESTAMP,
        "prev_topic": "general chat",
        "topic": "",
    }
    update_fields: dict[str, object] = {
        "subject": "",
        "last_edit_time": LAST_EDIT_TIME,
        "edit_history": Cast(
            Func(
                Cast(
                    Value(orjson.dumps([edit_history_entry]).decode()),
                    JSONField(),
                ),
                Cast(
                    Func(
                        F("edit_history"),
                        Value("[]"),
                        function="COALESCE",
                    ),
                    JSONField(),
                ),
                function="",
                arg_joiner=" || ",
            ),
            TextField(),
        ),
    }
    message_queryset.update(**update_fields)


def update_user_topic(channel_ids: list[int], user_topic_model: type[Any]) -> None:
    if not channel_ids:
        return

    # Both insert and delete query uses index "zerver_mutedtopic_stream_topic".
    channel_ids_str = SQL(",").join(map(Literal, channel_ids))
    query = SQL(
        """
        INSERT INTO zerver_usertopic(user_profile_id, stream_id, recipient_id, topic_name, last_updated, visibility_policy)
        SELECT user_profile_id, stream_id, recipient_id, '', last_updated, visibility_policy
        FROM zerver_usertopic
        WHERE stream_id IN ({channel_ids})
        AND lower(topic_name) = 'general chat'
        ON CONFLICT (user_profile_id, stream_id, lower(topic_name)) DO UPDATE SET
        last_updated = EXCLUDED.last_updated,
        visibility_policy = EXCLUDED.visibility_policy;
        """
    ).format(channel_ids=channel_ids_str)
    with connection.cursor() as cursor:
        cursor.execute(query)

    user_topic_model.objects.filter(
        stream_id__in=channel_ids, topic_name__iexact="general chat"
    ).delete()


def move_messages_from_general_chat_to_empty_string_topic(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    """Because legacy clients will be unable to distinguish the topic "general chat"
    from the "" topic (displayed as italicized "general chat"), it's helpful
    to not have both types of topics exist in an organization.

    Further, the "general chat" topic is likely to in almost every
    case be the result of an organization that followed our advice to
    just make a "general chat" topic for topic-free chat; the new
    "general chat" feature naturally replaces that learned
    behavior.

    So it makes sense to just consider those older "general chat"
    topics to be the same as the modern general chat topic.

    The technical way to do that is to move messages in "general chat"
    topics to `""`, since we've endeavored to make the distinction between
    those two storage approaches invisible to legacy clients at the API layer.
    """
    Realm = apps.get_model("zerver", "Realm")
    Message = apps.get_model("zerver", "Message")
    UserTopic = apps.get_model("zerver", "UserTopic")
    ArchivedMessage = apps.get_model("zerver", "ArchivedMessage")
    ScheduledMessage = apps.get_model("zerver", "ScheduledMessage")
    UserProfile = apps.get_model("zerver", "UserProfile")

    try:
        internal_realm = Realm.objects.get(string_id=settings.SYSTEM_BOT_REALM)
    except Realm.DoesNotExist:
        # Server not initialized.
        return
    notification_bot = UserProfile.objects.get(
        email__iexact=settings.NOTIFICATION_BOT, realm=internal_realm
    )

    for realm in Realm.objects.all().iterator():
        with transaction.atomic(durable=True):
            # Uses index "zerver_message_realm_upper_subject"
            message_queryset = Message.objects.filter(realm=realm, subject__iexact="general chat")
            channel_ids = list(
                message_queryset.distinct("recipient__type_id").values_list(
                    "recipient__type_id", flat=True
                )
            )

            update_messages_for_topic_edit(message_queryset, notification_bot)

            # Limiting the UserTopic query to only those channels that
            # contain an actual general chat topic does not guaranteed
            # updating all UserTopic rows, since it's possible to
            # follow/mute an empty topic. But it does guarantee that
            # we update all rows that have any current effect.
            update_user_topic(channel_ids, UserTopic)

            # Uses index zerver_archivedmessage_realm_id_fab86889
            archived_message_queryset = ArchivedMessage.objects.filter(
                realm=realm, subject__iexact="general chat"
            )
            update_messages_for_topic_edit(archived_message_queryset, notification_bot)

            ScheduledMessage.objects.filter(realm=realm, subject__iexact="general chat").update(
                subject=""
            )


class Migration(migrations.Migration):
    """
    Zulip now supports empty string as a valid topic name.
    For clients predating this feature, such messages appear
    in "general chat" topic. Messages sent to "general chat" are
    stored in the database as having a "" topic. This migration
    moves the messages from "general chat" topic to `""`.
    """

    atomic = False

    dependencies = [
        ("zerver", "0679_zerver_message_edit_history_id"),
    ]

    operations = [
        migrations.RunPython(
            move_messages_from_general_chat_to_empty_string_topic,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0681_realm_can_manage_billing_group.py]---
Location: zulip-main/zerver/migrations/0681_realm_can_manage_billing_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-17 16:11

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0680_rename_general_chat_to_empty_string_topic"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_manage_billing_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0682_set_default_value_for_can_manage_billing_group.py]---
Location: zulip-main/zerver/migrations/0682_set_default_value_for_can_manage_billing_group.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def set_default_value_for_can_manage_billing_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserGroup = apps.get_model("zerver", "UserGroup")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    OWNERS_GROUP_NAME = "role:owners"

    for realm in Realm.objects.all().iterator():
        if realm.can_manage_billing_group is not None:
            continue

        owners_system_group = NamedUserGroup.objects.get(
            name=OWNERS_GROUP_NAME, realm=realm, is_system_group=True
        )
        billing_admins = UserProfile.objects.filter(
            realm=realm, is_billing_admin=True, is_bot=False, is_active=True
        )

        if billing_admins.exists():
            user_group = UserGroup.objects.create(realm=realm)
            user_group.direct_members.set(list(billing_admins))
            user_group.direct_subgroups.set([owners_system_group])
            realm.can_manage_billing_group = user_group
        else:
            realm.can_manage_billing_group = owners_system_group

        realm.save(update_fields=["can_manage_billing_group"])


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0681_realm_can_manage_billing_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_manage_billing_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0683_alter_realm_can_manage_billing_group.py]---
Location: zulip-main/zerver/migrations/0683_alter_realm_can_manage_billing_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-17 16:18

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0682_set_default_value_for_can_manage_billing_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_manage_billing_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0684_remove_userprofile_is_billing_admin.py]---
Location: zulip-main/zerver/migrations/0684_remove_userprofile_is_billing_admin.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-02-28 10:45

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0683_alter_realm_can_manage_billing_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="userprofile",
            name="is_billing_admin",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0685_remove_realmuserdefault_dense_mode_and_more.py]---
Location: zulip-main/zerver/migrations/0685_remove_realmuserdefault_dense_mode_and_more.py
Signals: Django

```python
# Generated by Django 5.1.6 on 2025-03-08 09:52

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0684_remove_userprofile_is_billing_admin"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realmuserdefault",
            name="dense_mode",
        ),
        migrations.RemoveField(
            model_name="userprofile",
            name="dense_mode",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0686_realm_can_resolve_topics_group.py]---
Location: zulip-main/zerver/migrations/0686_realm_can_resolve_topics_group.py
Signals: Django

```python
# Generated by Django 5.0.5 on 2024-05-11 13:20

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0685_remove_realmuserdefault_dense_mode_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_resolve_topics_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
