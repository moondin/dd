---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 956
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 956 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0626_set_default_value_for_can_invite_users_group.py]---
Location: zulip-main/zerver/migrations/0626_set_default_value_for_can_invite_users_group.py
Signals: Django

```python
# Generated by Django 4.2.1 on 2023-06-12 10:47

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_invite_users_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    invite_to_realm_policy_to_group_name = {
        1: "role:members",
        2: "role:administrators",
        3: "role:fullmembers",
        4: "role:moderators",
        6: "role:nobody",
    }

    for id, group_name in invite_to_realm_policy_to_group_name.items():
        Realm.objects.filter(can_invite_users_group=None, invite_to_realm_policy=id).update(
            can_invite_users_group=NamedUserGroup.objects.filter(
                name=group_name, realm=OuterRef("id"), is_system_group=True
            ).values("pk")
        )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0625_realm_can_invite_users_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_invite_users_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0627_alter_realm_can_invite_users_group.py]---
Location: zulip-main/zerver/migrations/0627_alter_realm_can_invite_users_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-16 07:59

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0626_set_default_value_for_can_invite_users_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_invite_users_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0628_remove_realm_invite_to_realm_policy.py]---
Location: zulip-main/zerver/migrations/0628_remove_realm_invite_to_realm_policy.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-16 08:51

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0627_alter_realm_can_invite_users_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="invite_to_realm_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0629_remove_stream_email_token_backfill_channelemailaddress.py]---
Location: zulip-main/zerver/migrations/0629_remove_stream_email_token_backfill_channelemailaddress.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-21 12:58

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import connection, migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from psycopg2.sql import SQL

from zerver.models.streams import generate_email_token_for_stream


def backfill_channelemailaddress(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")

    with connection.cursor() as cursor:
        cursor.execute(SQL("SELECT MAX(id) FROM zerver_stream;"))
        (max_id,) = cursor.fetchone()

    if max_id is None:
        return

    BATCH_SIZE = 10000
    max_id += BATCH_SIZE / 2
    lower_id_bound = 0
    mail_gateway_bot_id = UserProfile.objects.get(email__iexact=settings.EMAIL_GATEWAY_BOT).id
    while lower_id_bound < max_id:
        upper_id_bound = min(lower_id_bound + BATCH_SIZE, max_id)
        with connection.cursor() as cursor:
            query = SQL("""
                INSERT INTO zerver_channelemailaddress (realm_id, channel_id, creator_id, sender_id, email_token, date_created, deactivated)
                SELECT realm_id, id, creator_id, %(mail_gateway_bot_id)s, email_token, date_created, deactivated
                FROM zerver_stream
                WHERE id > %(lower_id_bound)s AND id <= %(upper_id_bound)s;
                """)
            cursor.execute(
                query,
                {
                    "mail_gateway_bot_id": mail_gateway_bot_id,
                    "lower_id_bound": lower_id_bound,
                    "upper_id_bound": upper_id_bound,
                },
            )

        print(f"Processed {upper_id_bound} / {max_id}")
        lower_id_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0628_remove_realm_invite_to_realm_policy"),
    ]

    operations = [
        migrations.CreateModel(
            name="ChannelEmailAddress",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "email_token",
                    models.CharField(
                        db_index=True,
                        default=generate_email_token_for_stream,
                        max_length=32,
                        unique=True,
                    ),
                ),
                ("date_created", models.DateTimeField(default=django.utils.timezone.now)),
                ("deactivated", models.BooleanField(default=False)),
                (
                    "channel",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.stream"
                    ),
                ),
                (
                    "creator",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="+",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
                (
                    "sender",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="+",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(
                        fields=["realm", "channel"],
                        name="zerver_channelemailaddress_realm_id_channel_id_idx",
                    )
                ],
                "unique_together": {("channel", "creator", "sender")},
            },
        ),
        migrations.RunPython(
            backfill_channelemailaddress, reverse_code=migrations.RunPython.noop, elidable=True
        ),
        migrations.RemoveField(
            model_name="stream",
            name="email_token",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0630_multiuseinvite_groups_preregistrationuser_groups.py]---
Location: zulip-main/zerver/migrations/0630_multiuseinvite_groups_preregistrationuser_groups.py
Signals: Django

```python
# Generated by Django 5.0.8 on 2024-09-19 20:02

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0629_remove_stream_email_token_backfill_channelemailaddress"),
    ]

    operations = [
        migrations.AddField(
            model_name="multiuseinvite",
            name="groups",
            field=models.ManyToManyField(to="zerver.namedusergroup"),
        ),
        migrations.AddField(
            model_name="preregistrationuser",
            name="groups",
            field=models.ManyToManyField(to="zerver.namedusergroup"),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0631_stream_is_recently_active.py]---
Location: zulip-main/zerver/migrations/0631_stream_is_recently_active.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-27 04:58

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0630_multiuseinvite_groups_preregistrationuser_groups"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="is_recently_active",
            field=models.BooleanField(db_default=True, default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0632_preregistrationrealm_data_import_metadata.py]---
Location: zulip-main/zerver/migrations/0632_preregistrationrealm_data_import_metadata.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-28 06:21

import django.core.serializers.json
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0631_stream_is_recently_active"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationrealm",
            name="data_import_metadata",
            field=models.JSONField(
                default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0633_namedusergroup_can_remove_members_group.py]---
Location: zulip-main/zerver/migrations/0633_namedusergroup_can_remove_members_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-24 11:01

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0632_preregistrationrealm_data_import_metadata"),
    ]

    operations = [
        migrations.AddField(
            model_name="namedusergroup",
            name="can_remove_members_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0634_set_default_for_can_remove_members_group.py]---
Location: zulip-main/zerver/migrations/0634_set_default_for_can_remove_members_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-24 11:02

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_remove_members_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = NamedUserGroup.objects.filter(can_remove_members_group=None).aggregate(Max("id"))[
        "id__max"
    ]
    if max_id is None:
        # Do nothing if there are no user groups on the server.
        return

    lower_bound = NamedUserGroup.objects.filter(can_remove_members_group=None).aggregate(Min("id"))[
        "id__min"
    ]

    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for NamedUserGroup")

        with transaction.atomic():
            # Users with permission to manage the group can remove members
            # from the group, so there is no need to give the permission
            # to any other user by default.
            NamedUserGroup.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_remove_members_group=None,
            ).update(
                can_remove_members_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_for_sharding"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0633_namedusergroup_can_remove_members_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_remove_members_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0635_alter_namedusergroup_can_remove_members_group.py]---
Location: zulip-main/zerver/migrations/0635_alter_namedusergroup_can_remove_members_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-24 11:24

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0634_set_default_for_can_remove_members_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="namedusergroup",
            name="can_remove_members_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0636_streams_add_can_administer_channel_group.py]---
Location: zulip-main/zerver/migrations/0636_streams_add_can_administer_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-12 04:57

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0635_alter_namedusergroup_can_remove_members_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_administer_channel_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0637_set_default_for_can_administer_channel_group.py]---
Location: zulip-main/zerver/migrations/0637_set_default_for_can_administer_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-12 05:08

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_administer_channel_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_administer_channel_group=None).aggregate(Max("id"))[
        "id__max"
    ]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_administer_channel_group=None).aggregate(Min("id"))[
        "id__min"
    ]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_administer_channel_group=None,
            ).update(
                can_administer_channel_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0636_streams_add_can_administer_channel_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_administer_channel_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0638_alter_stream_can_administer_channel_group.py]---
Location: zulip-main/zerver/migrations/0638_alter_stream_can_administer_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-11-12 04:57

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0637_set_default_for_can_administer_channel_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_administer_channel_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0639_zh_hant_tw_rename.py]---
Location: zulip-main/zerver/migrations/0639_zh_hant_tw_rename.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-10 15:49

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def update_zh_hant_tw_language(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserProfile.objects.filter(default_language="zh-hant").update(default_language="zh-tw")

    PreregistrationRealm = apps.get_model("zerver", "PreregistrationRealm")
    PreregistrationRealm.objects.filter(default_language="zh-hant").update(default_language="zh-tw")

    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.filter(default_language="zh-hant").update(default_language="zh-tw")


class Migration(migrations.Migration):
    dependencies = [
        # The most recent 9.x migration, since this will be backported
        ("zerver", "0622_backfill_imageattachment_again"),
    ]

    operations = [
        migrations.RunPython(
            update_zh_hant_tw_language,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0640_merge_20241211_1953.py]---
Location: zulip-main/zerver/migrations/0640_merge_20241211_1953.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-11 19:53

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0638_alter_stream_can_administer_channel_group"),
        ("zerver", "0639_zh_hant_tw_rename"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0641_web_suggest_update_time_zone.py]---
Location: zulip-main/zerver/migrations/0641_web_suggest_update_time_zone.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-13 18:35

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0640_merge_20241211_1953"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_suggest_update_timezone",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_suggest_update_timezone",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0642_realm_moderation_request_channel.py]---
Location: zulip-main/zerver/migrations/0642_realm_moderation_request_channel.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-16 07:13

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0641_web_suggest_update_time_zone"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="moderation_request_channel",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="+",
                to="zerver.stream",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0643_realm_scheduled_deletion_date.py]---
Location: zulip-main/zerver/migrations/0643_realm_scheduled_deletion_date.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-10-12 07:03

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0642_realm_moderation_request_channel"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="scheduled_deletion_date",
            field=models.DateTimeField(db_index=True, default=None, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0644_check_update_all_channels_active_status.py]---
Location: zulip-main/zerver/migrations/0644_check_update_all_channels_active_status.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-23 10:03

from datetime import timedelta

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.utils.timezone import now as timezone_now


def check_update_all_channels_active_status(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Channel = apps.get_model("zerver", "Stream")
    Message = apps.get_model("zerver", "Message")
    Realm = apps.get_model("zerver", "Realm")
    Recipient = apps.get_model("zerver", "Recipient")

    Recipient.STREAM = 2
    Channel.LAST_ACTIVITY_DAYS_BEFORE_FOR_ACTIVE = 180

    date_days_ago = timezone_now() - timedelta(days=Channel.LAST_ACTIVITY_DAYS_BEFORE_FOR_ACTIVE)

    for realm in Realm.objects.filter(deactivated=False):
        with transaction.atomic(durable=True):
            active_channel_ids = (
                Message.objects.filter(
                    date_sent__gte=date_days_ago,
                    recipient__type=Recipient.STREAM,
                    realm=realm,
                )
                .values_list("recipient__type_id", flat=True)
                .distinct()
            )

            channels_to_mark_inactive_queryset = Channel.objects.filter(
                is_recently_active=True, realm=realm
            ).exclude(id__in=active_channel_ids)
            channels_to_mark_inactive_queryset.update(is_recently_active=False)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0643_realm_scheduled_deletion_date"),
    ]

    operations = [
        migrations.RunPython(
            check_update_all_channels_active_status,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0645_stream_can_send_message_group.py]---
Location: zulip-main/zerver/migrations/0645_stream_can_send_message_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-09 10:24

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0644_check_update_all_channels_active_status"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_send_message_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0646_set_default_for_can_send_message_group.py]---
Location: zulip-main/zerver/migrations/0646_set_default_for_can_send_message_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-09 10:28

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_send_message_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_send_message_group=None).aggregate(Max("id"))["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_send_message_group=None).aggregate(Min("id"))["id__min"]

    STREAM_POST_POLICY_EVERYONE = 1
    STREAM_POST_POLICY_ADMINS = 2
    STREAM_POST_POLICY_RESTRICT_NEW_MEMBERS = 3
    STREAM_POST_POLICY_MODERATORS = 4

    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_send_message_group=None,
                stream_post_policy=STREAM_POST_POLICY_EVERYONE,
            ).update(
                can_send_message_group=NamedUserGroup.objects.filter(
                    name="role:everyone",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_send_message_group=None,
                stream_post_policy=STREAM_POST_POLICY_ADMINS,
            ).update(
                can_send_message_group=NamedUserGroup.objects.filter(
                    name="role:administrators",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_send_message_group=None,
                stream_post_policy=STREAM_POST_POLICY_RESTRICT_NEW_MEMBERS,
            ).update(
                can_send_message_group=NamedUserGroup.objects.filter(
                    name="role:fullmembers",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_send_message_group=None,
                stream_post_policy=STREAM_POST_POLICY_MODERATORS,
            ).update(
                can_send_message_group=NamedUserGroup.objects.filter(
                    name="role:moderators",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0645_stream_can_send_message_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_send_message_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0647_alter_stream_can_send_message_group.py]---
Location: zulip-main/zerver/migrations/0647_alter_stream_can_send_message_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-09 10:39

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0646_set_default_for_can_send_message_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_send_message_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0648_remove_stream_stream_post_policy.py]---
Location: zulip-main/zerver/migrations/0648_remove_stream_stream_post_policy.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-18 09:24

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0647_alter_stream_can_send_message_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="stream",
            name="stream_post_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0649_realm_can_add_subscribers_group.py]---
Location: zulip-main/zerver/migrations/0649_realm_can_add_subscribers_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-13 08:06

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0648_remove_stream_stream_post_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_add_subscribers_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0650_set_default_for_realm_can_add_subscribers_group.py]---
Location: zulip-main/zerver/migrations/0650_set_default_for_realm_can_add_subscribers_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-13 08:06

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_can_add_subscribers_group_for_existing_realms(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MEMBERS_ONLY = 1
    ADMINS_ONLY = 2
    FULL_MEMBERS_ONLY = 3
    MODERATORS_ONLY = 4

    Realm.objects.filter(
        can_add_subscribers_group=None, invite_to_stream_policy=MEMBERS_ONLY
    ).update(
        can_add_subscribers_group=NamedUserGroup.objects.filter(
            name="role:members", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_add_subscribers_group=None, invite_to_stream_policy=ADMINS_ONLY
    ).update(
        can_add_subscribers_group=NamedUserGroup.objects.filter(
            name="role:administrators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_add_subscribers_group=None, invite_to_stream_policy=FULL_MEMBERS_ONLY
    ).update(
        can_add_subscribers_group=NamedUserGroup.objects.filter(
            name="role:fullmembers", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_add_subscribers_group=None, invite_to_stream_policy=MODERATORS_ONLY
    ).update(
        can_add_subscribers_group=NamedUserGroup.objects.filter(
            name="role:moderators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0649_realm_can_add_subscribers_group"),
    ]

    operations = [
        migrations.RunPython(
            set_can_add_subscribers_group_for_existing_realms,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0651_alter_realm_can_add_subscribers_group.py]---
Location: zulip-main/zerver/migrations/0651_alter_realm_can_add_subscribers_group.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-13 08:07

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0650_set_default_for_realm_can_add_subscribers_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_add_subscribers_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0652_remove_realm_invite_to_stream_policy.py]---
Location: zulip-main/zerver/migrations/0652_remove_realm_invite_to_stream_policy.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-14 07:47

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0651_alter_realm_can_add_subscribers_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="invite_to_stream_policy",
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0653_stream_can_add_subscribers_group.py]---
Location: zulip-main/zerver/migrations/0653_stream_can_add_subscribers_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-17 05:55

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0652_remove_realm_invite_to_stream_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_add_subscribers_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0654_set_default_for_stream_can_add_subscribers_group.py]---
Location: zulip-main/zerver/migrations/0654_set_default_for_stream_can_add_subscribers_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-17 05:55

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_add_subscribers_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_add_subscribers_group=None).aggregate(Max("id"))["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_add_subscribers_group=None).aggregate(Min("id"))[
        "id__min"
    ]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_add_subscribers_group=None,
            ).update(
                can_add_subscribers_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0653_stream_can_add_subscribers_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_add_subscribers_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0655_alter_stream_can_add_subscribers_group.py]---
Location: zulip-main/zerver/migrations/0655_alter_stream_can_add_subscribers_group.py
Signals: Django

```python
# Generated by Django 5.0.9 on 2024-12-17 05:56

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0654_set_default_for_stream_can_add_subscribers_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_add_subscribers_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0656_realm_can_create_bots_group_and_more.py]---
Location: zulip-main/zerver/migrations/0656_realm_can_create_bots_group_and_more.py
Signals: Django

```python
# Generated by Django 5.0.10 on 2025-01-23 15:14

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0655_alter_stream_can_add_subscribers_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_create_bots_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
        migrations.AddField(
            model_name="realm",
            name="can_create_write_only_bots_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
