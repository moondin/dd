---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 959
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 959 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0705_stream_subscriber_count_data_migration.py]---
Location: zulip-main/zerver/migrations/0705_stream_subscriber_count_data_migration.py
Signals: Django

```python
from django.db import connection, migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from psycopg2 import sql


def set_stream_subscribe_count(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Realm = apps.get_model("zerver", "realm")
    Stream = apps.get_model("zerver", "Stream")
    Subscription = apps.get_model("zerver", "subscription")
    Recipient = apps.get_model("zerver", "recipient")

    # Here we compute per-stream subscriber_count in the sub-query
    # which returns a stream_subscribers_table, then Update it
    # in-place using that computed value. The whole query is then
    # executed by one batch per realm.
    query = sql.SQL(
        """UPDATE {stream_table} AS stream
            SET subscriber_count = stream_subscribers_table.count
            FROM (
                SELECT recipient.type_id AS stream_id,
                COUNT(subscription.user_profile_id) AS count
                FROM {subscription_table} AS subscription
                JOIN {recipient_table} AS recipient
                    ON subscription.recipient_id = recipient.id
                WHERE
                    recipient.type = 2
                    AND subscription.active = True
                    AND subscription.is_user_active = True
                GROUP BY stream_id
            ) AS stream_subscribers_table
            WHERE
                stream.realm_id = %(realm_id)s
                AND stream.id = stream_subscribers_table.stream_id;
        """
    ).format(
        stream_table=sql.Identifier(Stream._meta.db_table),
        subscription_table=sql.Identifier(Subscription._meta.db_table),
        recipient_table=sql.Identifier(Recipient._meta.db_table),
    )

    for realm in Realm.objects.all().iterator():
        with connection.cursor() as cursor, transaction.atomic(durable=True):
            cursor.execute(query, {"realm_id": realm.id})


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0704_stream_subscriber_count"),
    ]

    operations = [
        migrations.RunPython(set_stream_subscribe_count),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0706_channelfolder.py]---
Location: zulip-main/zerver/migrations/0706_channelfolder.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-02 09:27

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0705_stream_subscriber_count_data_migration"),
    ]

    operations = [
        migrations.CreateModel(
            name="ChannelFolder",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("name", models.CharField(max_length=100)),
                ("description", models.CharField(default="", max_length=1024)),
                ("rendered_description", models.TextField(default="")),
                ("date_created", models.DateTimeField(default=django.utils.timezone.now)),
                ("is_archived", models.BooleanField(default=False)),
                (
                    "creator",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
            options={
                "unique_together": {("realm", "name")},
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0707_realmauditlog_modified_channel_folder.py]---
Location: zulip-main/zerver/migrations/0707_realmauditlog_modified_channel_folder.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-05 13:27

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0706_channelfolder"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmauditlog",
            name="modified_channel_folder",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zerver.channelfolder"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0708_stream_folder.py]---
Location: zulip-main/zerver/migrations/0708_stream_folder.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-16 07:41

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0707_realmauditlog_modified_channel_folder"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="folder",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to="zerver.channelfolder"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0709_navigationview.py]---
Location: zulip-main/zerver/migrations/0709_navigationview.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-23 20:31

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0708_stream_folder"),
    ]

    operations = [
        migrations.CreateModel(
            name="NavigationView",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("fragment", models.TextField()),
                ("is_pinned", models.BooleanField(default=False)),
                ("name", models.TextField(blank=True, null=True)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
            options={
                "unique_together": {("user", "fragment")},
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0710_realm_topics_policy.py]---
Location: zulip-main/zerver/migrations/0710_realm_topics_policy.py
Signals: Django

```python
# Generated by Django 5.1.7 on 2025-03-24 09:05
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0709_navigationview"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="topics_policy",
            field=models.PositiveSmallIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0711_set_default_value_for_realm_topics_policy.py]---
Location: zulip-main/zerver/migrations/0711_set_default_value_for_realm_topics_policy.py
Signals: Django

```python
from enum import Enum

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


class RealmTopicsPolicyEnum(Enum):
    allow_empty_topic = 2
    disable_empty_topic = 3


def set_default_value_for_realm_topics_policy(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")

    Realm.objects.filter(topics_policy=None, mandatory_topics=True).update(
        topics_policy=RealmTopicsPolicyEnum.disable_empty_topic.value
    )

    Realm.objects.filter(topics_policy=None, mandatory_topics=False).update(
        topics_policy=RealmTopicsPolicyEnum.allow_empty_topic.value
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0710_realm_topics_policy"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_realm_topics_policy,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0712_alter_realm_topics_policy.py]---
Location: zulip-main/zerver/migrations/0712_alter_realm_topics_policy.py
Signals: Django

```python
# Generated by Django 5.1.7 on 2025-03-24 09:11

from enum import Enum

from django.db import migrations, models


class RealmTopicsPolicyEnum(Enum):
    allow_empty_topic = 2


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0711_set_default_value_for_realm_topics_policy"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="topics_policy",
            field=models.PositiveSmallIntegerField(
                default=RealmTopicsPolicyEnum.allow_empty_topic.value
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0713_remove_realm_mandatory_topics.py]---
Location: zulip-main/zerver/migrations/0713_remove_realm_mandatory_topics.py
Signals: Django

```python
# Generated by Django 5.1.7 on 2025-03-24 09:18

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0712_alter_realm_topics_policy"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="mandatory_topics",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0714_realm_can_set_topics_policy_group.py]---
Location: zulip-main/zerver/migrations/0714_realm_can_set_topics_policy_group.py
Signals: Django

```python
# Generated by Django 5.1.7 on 2025-03-29 11:55

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0713_remove_realm_mandatory_topics"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_set_topics_policy_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0715_set_default_value_for_can_set_topics_policy_group.py]---
Location: zulip-main/zerver/migrations/0715_set_default_value_for_can_set_topics_policy_group.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_set_topics_policy_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MEMBERS_GROUP_NAME = "role:members"

    Realm.objects.filter(can_set_topics_policy_group=None).update(
        can_set_topics_policy_group=NamedUserGroup.objects.filter(
            name=MEMBERS_GROUP_NAME, realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0714_realm_can_set_topics_policy_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_set_topics_policy_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0716_alter_realm_can_set_topics_policy_group.py]---
Location: zulip-main/zerver/migrations/0716_alter_realm_can_set_topics_policy_group.py
Signals: Django

```python
# Generated by Django 5.1.7 on 2025-03-29 12:00

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0715_set_default_value_for_can_set_topics_policy_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_set_topics_policy_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0717_stream_topics_policy.py]---
Location: zulip-main/zerver/migrations/0717_stream_topics_policy.py
Signals: Django

```python
# Generated by Django 5.1.7 on 2025-03-29 12:17

from enum import Enum

from django.db import migrations, models


class StreamTopicsPolicyEnum(Enum):
    inherit = 1


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0716_alter_realm_can_set_topics_policy_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="topics_policy",
            field=models.PositiveSmallIntegerField(default=StreamTopicsPolicyEnum.inherit.value),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0718_fix_topics_for_direct_messages.py]---
Location: zulip-main/zerver/migrations/0718_fix_topics_for_direct_messages.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-23 09:25

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max


def fix_topic_for_direct_messages(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Message = apps.get_model("zerver", "Message")
    ArchivedMessage = apps.get_model("zerver", "ArchivedMessage")
    ScheduledMessage = apps.get_model("zerver", "ScheduledMessage")

    RECIPIENT_STREAM = 2

    DM_TOPIC = "\x07"

    BATCH_SIZE = 10000
    for message_model in [Message, ArchivedMessage, ScheduledMessage]:
        lower_bound = 1

        max_id = message_model.objects.aggregate(Max("id"))["id__max"]
        if max_id is None:
            continue

        while lower_bound <= max_id:
            upper_bound = lower_bound + BATCH_SIZE - 1
            print(f"Processing batch {lower_bound} to {upper_bound} for {message_model.__name__}")

            message_model.objects.filter(
                id__range=(lower_bound, upper_bound),
            ).exclude(recipient__type=RECIPIENT_STREAM).update(subject=DM_TOPIC)

            lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0717_stream_topics_policy"),
    ]

    operations = [
        migrations.RunPython(
            fix_topic_for_direct_messages,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
        # We need to run an ANALYZE for the query planner statistics
        # to no longer think most messages have "" as the topic.
        migrations.RunSQL("ANALYZE zerver_message"),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0719_stream_can_move_messages_within_channel_group.py]---
Location: zulip-main/zerver/migrations/0719_stream_can_move_messages_within_channel_group.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-06-05 07:43

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0718_fix_topics_for_direct_messages"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_move_messages_within_channel_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0720_set_default_value_for_can_move_messages_within_channel_group.py]---
Location: zulip-main/zerver/migrations/0720_set_default_value_for_can_move_messages_within_channel_group.py
Signals: Django

```python
from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_move_messages_within_channel_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_move_messages_within_channel_group=None).aggregate(
        Max("id")
    )["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_move_messages_within_channel_group=None).aggregate(
        Min("id")
    )["id__min"]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_move_messages_within_channel_group=None,
            ).update(
                can_move_messages_within_channel_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0719_stream_can_move_messages_within_channel_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_move_messages_within_channel_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0721_alter_stream_can_move_messages_within_channel_group.py]---
Location: zulip-main/zerver/migrations/0721_alter_stream_can_move_messages_within_channel_group.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-06-05 08:05

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0720_set_default_value_for_can_move_messages_within_channel_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_move_messages_within_channel_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0722_stream_can_move_messages_out_of_channel_group.py]---
Location: zulip-main/zerver/migrations/0722_stream_can_move_messages_out_of_channel_group.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-06-09 07:43

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0721_alter_stream_can_move_messages_within_channel_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_move_messages_out_of_channel_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0723_set_default_value_for_can_move_messages_out_of_channel_group.py]---
Location: zulip-main/zerver/migrations/0723_set_default_value_for_can_move_messages_out_of_channel_group.py
Signals: Django

```python
from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_move_messages_out_of_channel_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_move_messages_out_of_channel_group=None).aggregate(
        Max("id")
    )["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_move_messages_out_of_channel_group=None).aggregate(
        Min("id")
    )["id__min"]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_move_messages_out_of_channel_group=None,
            ).update(
                can_move_messages_out_of_channel_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0722_stream_can_move_messages_out_of_channel_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_move_messages_out_of_channel_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0724_alter_stream_can_move_messages_out_of_channel_group.py]---
Location: zulip-main/zerver/migrations/0724_alter_stream_can_move_messages_out_of_channel_group.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-06-10 04:53

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0723_set_default_value_for_can_move_messages_out_of_channel_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_move_messages_out_of_channel_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0725_realmuserdefault_web_left_sidebar_unreads_count_summary_and_more.py]---
Location: zulip-main/zerver/migrations/0725_realmuserdefault_web_left_sidebar_unreads_count_summary_and_more.py
Signals: Django

```python
# Generated by Django 5.1.8 on 2025-05-20 06:47

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0724_alter_stream_can_move_messages_out_of_channel_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_left_sidebar_unreads_count_summary",
            field=models.BooleanField(db_default=True, default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_left_sidebar_unreads_count_summary",
            field=models.BooleanField(db_default=True, default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0726_stream_can_resolve_topics_group.py]---
Location: zulip-main/zerver/migrations/0726_stream_can_resolve_topics_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-30 14:38

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0725_realmuserdefault_web_left_sidebar_unreads_count_summary_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_resolve_topics_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0727_set_default_value_for_stream_can_resolve_topics_group.py]---
Location: zulip-main/zerver/migrations/0727_set_default_value_for_stream_can_resolve_topics_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-30 14:40

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_stream_can_resolve_topics_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_resolve_topics_group=None).aggregate(Max("id"))["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_resolve_topics_group=None).aggregate(Min("id"))[
        "id__min"
    ]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_resolve_topics_group=None,
            ).update(
                can_resolve_topics_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0726_stream_can_resolve_topics_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_stream_can_resolve_topics_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0728_alter_stream_can_resolve_topics_group.py]---
Location: zulip-main/zerver/migrations/0728_alter_stream_can_resolve_topics_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-30 14:44

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0727_set_default_value_for_stream_can_resolve_topics_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_resolve_topics_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0729_externalauthid.py]---
Location: zulip-main/zerver/migrations/0729_externalauthid.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-07-08 00:35

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0728_alter_stream_can_resolve_topics_group"),
    ]

    operations = [
        migrations.CreateModel(
            name="ExternalAuthID",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("date_created", models.DateTimeField(default=django.utils.timezone.now)),
                ("external_auth_method_name", models.TextField()),
                ("external_auth_id", models.TextField()),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
            options={
                "constraints": [
                    models.UniqueConstraint(
                        fields=("realm", "external_auth_method_name", "external_auth_id"),
                        name="zerver_externalauthid_uniq",
                    )
                ],
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0730_pushdevice.py]---
Location: zulip-main/zerver/migrations/0730_pushdevice.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-07-13 03:14

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0729_externalauthid"),
    ]

    operations = [
        migrations.CreateModel(
            name="PushDevice",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "token_kind",
                    models.CharField(choices=[("apns", "APNs"), ("fcm", "FCM")], max_length=4),
                ),
                ("push_account_id", models.BigIntegerField()),
                ("push_public_key", models.TextField()),
                ("bouncer_device_id", models.BigIntegerField(null=True)),
                (
                    "error_code",
                    models.CharField(
                        choices=[
                            ("INVALID_BOUNCER_PUBLIC_KEY", "Invalid Bouncer Public Key"),
                            ("BAD_REQUEST", "Invalid Encrypted Push Registration"),
                            ("REQUEST_EXPIRED", "Request Expired"),
                        ],
                        max_length=100,
                        null=True,
                    ),
                ),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
            options={
                "constraints": [
                    models.UniqueConstraint(
                        fields=("user", "push_account_id"),
                        name="unique_push_device_user_push_account_id",
                    )
                ],
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0731_stream_can_delete_any_message_group.py]---
Location: zulip-main/zerver/migrations/0731_stream_can_delete_any_message_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-26 13:21

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0730_pushdevice"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_delete_any_message_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0732_set_default_value_for_can_delete_any_message_group.py]---
Location: zulip-main/zerver/migrations/0732_set_default_value_for_can_delete_any_message_group.py
Signals: Django

```python
from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_delete_any_message_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_delete_any_message_group=None).aggregate(Max("id"))[
        "id__max"
    ]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_delete_any_message_group=None).aggregate(Min("id"))[
        "id__min"
    ]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_delete_any_message_group=None,
            ).update(
                can_delete_any_message_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0731_stream_can_delete_any_message_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_delete_any_message_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0733_alter_stream_can_delete_any_message_group.py]---
Location: zulip-main/zerver/migrations/0733_alter_stream_can_delete_any_message_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-26 13:24

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0732_set_default_value_for_can_delete_any_message_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_delete_any_message_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0734_stream_can_delete_own_message_group.py]---
Location: zulip-main/zerver/migrations/0734_stream_can_delete_own_message_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-26 13:21

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0733_alter_stream_can_delete_any_message_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_delete_own_message_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0735_set_default_value_for_can_delete_own_message_group.py]---
Location: zulip-main/zerver/migrations/0735_set_default_value_for_can_delete_own_message_group.py
Signals: Django

```python
from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_can_delete_own_message_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_delete_own_message_group=None).aggregate(Max("id"))[
        "id__max"
    ]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_delete_own_message_group=None).aggregate(Min("id"))[
        "id__min"
    ]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_delete_own_message_group=None,
            ).update(
                can_delete_own_message_group=NamedUserGroup.objects.filter(
                    name="role:nobody",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0734_stream_can_delete_own_message_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_delete_own_message_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

````
