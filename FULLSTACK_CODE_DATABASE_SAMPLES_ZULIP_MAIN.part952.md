---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 952
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 952 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0533_set_can_create_public_channel_group.py]---
Location: zulip-main/zerver/migrations/0533_set_can_create_public_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-05-23 14:02

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_can_create_public_channel_group_for_existing_realms(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MEMBERS_ONLY = 1
    ADMINS_ONLY = 2
    FULL_MEMBERS_ONLY = 3
    MODERATORS_ONLY = 4

    Realm.objects.filter(
        can_create_public_channel_group=None, create_public_stream_policy=MEMBERS_ONLY
    ).update(
        can_create_public_channel_group=NamedUserGroup.objects.filter(
            name="role:members", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_create_public_channel_group=None, create_public_stream_policy=ADMINS_ONLY
    ).update(
        can_create_public_channel_group=NamedUserGroup.objects.filter(
            name="role:administrators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_create_public_channel_group=None, create_public_stream_policy=FULL_MEMBERS_ONLY
    ).update(
        can_create_public_channel_group=NamedUserGroup.objects.filter(
            name="role:fullmembers", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_create_public_channel_group=None, create_public_stream_policy=MODERATORS_ONLY
    ).update(
        can_create_public_channel_group=NamedUserGroup.objects.filter(
            name="role:moderators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0532_realm_can_create_public_channel_group"),
    ]

    operations = [
        migrations.RunPython(
            set_can_create_public_channel_group_for_existing_realms,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0534_alter_realm_can_create_public_channel_group.py]---
Location: zulip-main/zerver/migrations/0534_alter_realm_can_create_public_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-05-23 14:10

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0533_set_can_create_public_channel_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_create_public_channel_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0535_remove_realm_create_public_stream_policy.py]---
Location: zulip-main/zerver/migrations/0535_remove_realm_create_public_stream_policy.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-05-30 08:58

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0534_alter_realm_can_create_public_channel_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="create_public_stream_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0536_add_message_type.py]---
Location: zulip-main/zerver/migrations/0536_add_message_type.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-05 17:51

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0535_remove_realm_create_public_stream_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="archivedmessage",
            name="type",
            field=models.PositiveSmallIntegerField(
                choices=[(1, "Normal"), (2, "Resolve Topic Notification")], db_default=1, default=1
            ),
        ),
        migrations.AddField(
            model_name="message",
            name="type",
            field=models.PositiveSmallIntegerField(
                choices=[(1, "Normal"), (2, "Resolve Topic Notification")], db_default=1, default=1
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0537_realm_can_create_private_channel_group.py]---
Location: zulip-main/zerver/migrations/0537_realm_can_create_private_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-17 09:20

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0536_add_message_type"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_create_private_channel_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0538_set_can_create_private_channel_group.py]---
Location: zulip-main/zerver/migrations/0538_set_can_create_private_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-17 09:20

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_can_create_private_channel_group_for_existing_realms(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MEMBERS_ONLY = 1
    ADMINS_ONLY = 2
    FULL_MEMBERS_ONLY = 3
    MODERATORS_ONLY = 4

    Realm.objects.filter(
        can_create_private_channel_group=None, create_private_stream_policy=MEMBERS_ONLY
    ).update(
        can_create_private_channel_group=NamedUserGroup.objects.filter(
            name="role:members", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_create_private_channel_group=None, create_private_stream_policy=ADMINS_ONLY
    ).update(
        can_create_private_channel_group=NamedUserGroup.objects.filter(
            name="role:administrators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_create_private_channel_group=None, create_private_stream_policy=FULL_MEMBERS_ONLY
    ).update(
        can_create_private_channel_group=NamedUserGroup.objects.filter(
            name="role:fullmembers", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        can_create_private_channel_group=None, create_private_stream_policy=MODERATORS_ONLY
    ).update(
        can_create_private_channel_group=NamedUserGroup.objects.filter(
            name="role:moderators", realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0537_realm_can_create_private_channel_group"),
    ]

    operations = [
        migrations.RunPython(
            set_can_create_private_channel_group_for_existing_realms,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0539_alter_realm_can_create_private_channel_group.py]---
Location: zulip-main/zerver/migrations/0539_alter_realm_can_create_private_channel_group.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-17 09:24

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0538_set_can_create_private_channel_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_create_private_channel_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0540_remove_realm_create_private_stream_policy.py]---
Location: zulip-main/zerver/migrations/0540_remove_realm_create_private_stream_policy.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-17 14:43

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0539_alter_realm_can_create_private_channel_group"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="create_private_stream_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0541_alter_realmauditlog_options.py]---
Location: zulip-main/zerver/migrations/0541_alter_realmauditlog_options.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-27 00:12

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0540_remove_realm_create_private_stream_policy"),
    ]

    operations = [
        migrations.AlterModelOptions(
            name="realmauditlog",
            options={"ordering": ["id"]},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0542_onboardingusermessage.py]---
Location: zulip-main/zerver/migrations/0542_onboardingusermessage.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-27 06:03

import bitfield.models
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0541_alter_realmauditlog_options"),
    ]

    operations = [
        migrations.CreateModel(
            name="OnboardingUserMessage",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("flags", bitfield.models.BitField(["read", "historical", "starred"], default=0)),
                (
                    "message",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.message"
                    ),
                ),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0543_preregistrationuser_notify_referrer_on_join.py]---
Location: zulip-main/zerver/migrations/0543_preregistrationuser_notify_referrer_on_join.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-28 17:34

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0542_onboardingusermessage"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationuser",
            name="notify_referrer_on_join",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0544_copy_avatar_images.py]---
Location: zulip-main/zerver/migrations/0544_copy_avatar_images.py
Signals: Django

```python
import contextlib
import hashlib
import os
from typing import Any

import boto3
import pyvips
from botocore.client import Config
from botocore.exceptions import ClientError
from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import QuerySet
from django.utils.timezone import now as timezone_now

IMAGE_BOMB_TOTAL_PIXELS = 90000000
DEFAULT_AVATAR_SIZE = 100
MEDIUM_AVATAR_SIZE = 500


def resize_avatar(
    image_data: bytes | pyvips.Image,
    size: int,
) -> bytes | None:
    try:
        source_image = pyvips.Image.new_from_buffer(image_data, "")
        if source_image.width * source_image.height > IMAGE_BOMB_TOTAL_PIXELS:
            return None

        return pyvips.Image.thumbnail_buffer(
            image_data,
            size,
            height=size,
            crop=pyvips.Interesting.CENTRE,
        ).write_to_buffer(".png")
    except pyvips.Error:
        return None


def new_hash(user_profile: Any) -> str:
    user_key = (
        str(user_profile.id) + ":" + str(user_profile.avatar_version) + ":" + settings.AVATAR_SALT
    )
    return hashlib.sha256(user_key.encode()).hexdigest()[:40]


def old_hash(user_profile: Any) -> str:
    user_key = str(user_profile.id) + settings.AVATAR_SALT
    return hashlib.sha1(user_key.encode()).hexdigest()


def do_remove_avatar(user_profile: Any, apps: StateApps) -> None:
    avatar_source = "G"  # UserProfile.AVATAR_FROM_GRAVATAR
    user_profile.avatar_source = avatar_source
    user_profile.avatar_version += 1
    user_profile.save(update_fields=["avatar_source", "avatar_version"])
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.objects.create(
        realm_id=user_profile.realm_id,
        modified_user_id=user_profile.id,
        event_type=123,  # RealmAuditLog.USER_AVATAR_SOURCE_CHANGED,
        extra_data={"avatar_source": avatar_source},
        event_time=timezone_now(),
        acting_user=None,
    )


class SkipImageError(Exception):
    def __init__(self, message: str, user: Any) -> None:
        super().__init__(message)
        self.user = user


# Just the image types from zerver.lib.upload.INLINE_MIME_TYPES
INLINE_IMAGE_MIME_TYPES = [
    "image/apng",
    "image/avif",
    "image/gif",
    "image/jpeg",
    "image/png",
    "image/webp",
    # To avoid cross-site scripting attacks, DO NOT add types such
    # as image/svg+xml.
]


def thumbnail_s3_avatars(users: QuerySet[Any], apps: StateApps) -> None:
    avatar_bucket = boto3.resource(
        "s3",
        aws_access_key_id=settings.S3_KEY,
        aws_secret_access_key=settings.S3_SECRET_KEY,
        region_name=settings.S3_REGION,
        endpoint_url=settings.S3_ENDPOINT_URL,
        config=Config(
            signature_version=None,
            s3={"addressing_style": settings.S3_ADDRESSING_STYLE},
        ),
    ).Bucket(settings.S3_AVATAR_BUCKET)
    for total_processed, user in enumerate(users):
        try:
            old_base = os.path.join(str(user.realm_id), old_hash(user))
            new_base = os.path.join(str(user.realm_id), new_hash(user))

            if total_processed % 100 == 0:
                print(f"Processing {total_processed}/{len(users)} user avatars")

            with contextlib.suppress(ClientError):
                # Check if we've already uploaded this one; if so, continue.
                avatar_bucket.Object(new_base + ".original").load()
                continue

            try:
                old_data = avatar_bucket.Object(old_base + ".original").get()
                metadata = old_data["Metadata"]
                metadata["avatar_version"] = str(user.avatar_version)
                original_bytes = old_data["Body"].read()
            except ClientError:
                raise SkipImageError(f"Failed to fetch {old_base}", user)

            # INLINE_IMAGE_MIME_TYPES changing (e.g. adding
            # "image/avif") means this may not match the old
            # content-disposition.
            inline_type = old_data["ContentType"] in INLINE_IMAGE_MIME_TYPES
            extra_params = {}
            if not inline_type:
                extra_params["ContentDisposition"] = "attachment"

            avatar_bucket.Object(new_base + ".original").copy_from(
                CopySource=f"{settings.S3_AVATAR_BUCKET}/{old_base}.original",
                MetadataDirective="REPLACE",
                Metadata=metadata,
                ContentType=old_data["ContentType"],
                CacheControl="public, max-age=31536000, immutable",
                **extra_params,  # type: ignore[arg-type] # The dynamic kwargs here confuse mypy.
            )

            small = resize_avatar(original_bytes, DEFAULT_AVATAR_SIZE)
            if small is None:
                raise SkipImageError(f"Failed to resize {old_base}", user)
            avatar_bucket.Object(new_base + ".png").put(
                Metadata=metadata,
                ContentType="image/png",
                CacheControl="public, max-age=31536000, immutable",
                Body=small,
            )
            medium = resize_avatar(original_bytes, MEDIUM_AVATAR_SIZE)
            if medium is None:
                raise SkipImageError(f"Failed to medium resize {old_base}", user)
            avatar_bucket.Object(new_base + "-medium.png").put(
                Metadata=metadata,
                ContentType="image/png",
                CacheControl="public, max-age=31536000, immutable",
                Body=medium,
            )
        except SkipImageError as e:
            print(f"{e!s} for {e.user}; reverting to gravatar")
            do_remove_avatar(e.user, apps)


def thumbnail_local_avatars(users: QuerySet[Any], apps: StateApps) -> None:
    total_processed = 0
    assert settings.LOCAL_AVATARS_DIR is not None
    for total_processed, user in enumerate(users):
        try:
            old_base = os.path.join(settings.LOCAL_AVATARS_DIR, str(user.realm_id), old_hash(user))
            new_base = os.path.join(settings.LOCAL_AVATARS_DIR, str(user.realm_id), new_hash(user))

            if total_processed % 100 == 0:
                print(f"Processing {total_processed}/{len(users)} user avatars")

            if os.path.exists(new_base + "-medium.png"):
                # This user's avatar has already been migrated.
                continue

            with contextlib.suppress(FileNotFoundError):
                # Remove the hard link, if present from a previous failed run.
                os.remove(new_base + ".original")

            # We hardlink, rather than copying, so we don't take any extra space.
            try:
                os.link(old_base + ".original", new_base + ".original")
                with open(old_base + ".original", "rb") as f:
                    original_bytes = f.read()
            except OSError:
                raise SkipImageError(f"Failed to read {old_base}", user)

            small = resize_avatar(original_bytes, DEFAULT_AVATAR_SIZE)
            if small is None:
                raise SkipImageError(f"Failed to resize {old_base}", user)
            with open(new_base + ".png", "wb") as f:
                f.write(small)

            medium = resize_avatar(original_bytes, MEDIUM_AVATAR_SIZE)
            if medium is None:
                raise SkipImageError(f"Failed to medium resize {old_base}", user)
            with open(new_base + "-medium.png", "wb") as f:
                f.write(medium)
        except SkipImageError as e:
            print(f"{e!s} for {e.user}; reverting to gravatar")
            do_remove_avatar(e.user, apps)


def thumbnail_avatars(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    users = (
        UserProfile.objects.filter(avatar_source="U")
        .only("id", "realm_id", "avatar_version")
        .order_by("id")
    )
    if settings.LOCAL_AVATARS_DIR is not None:
        thumbnail_local_avatars(users, apps)
    else:
        thumbnail_s3_avatars(users, apps)


class Migration(migrations.Migration):
    atomic = False
    elidable = True

    dependencies = [
        ("zerver", "0543_preregistrationuser_notify_referrer_on_join"),
    ]

    operations = [migrations.RunPython(thumbnail_avatars, elidable=True)]
```

--------------------------------------------------------------------------------

---[FILE: 0545_attachment_content_type.py]---
Location: zulip-main/zerver/migrations/0545_attachment_content_type.py
Signals: Django

```python
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0544_copy_avatar_images"),
    ]

    operations = [
        migrations.AddField(
            model_name="archivedattachment",
            name="content_type",
            field=models.TextField(null=True),
        ),
        migrations.AddField(
            model_name="attachment",
            name="content_type",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0546_rename_huddle_directmessagegroup_and_more.py]---
Location: zulip-main/zerver/migrations/0546_rename_huddle_directmessagegroup_and_more.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-07-05 10:44

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0545_attachment_content_type"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[],
            state_operations=[
                migrations.RenameModel(old_name="Huddle", new_name="DirectMessageGroup"),
                migrations.AlterModelTable(name="directmessagegroup", table="zerver_huddle"),
            ],
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0547_realmuserdefault_web_navigate_to_sent_message_and_more.py]---
Location: zulip-main/zerver/migrations/0547_realmuserdefault_web_navigate_to_sent_message_and_more.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-07-08 19:22

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0546_rename_huddle_directmessagegroup_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_navigate_to_sent_message",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_navigate_to_sent_message",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0548_realmuserdefault_web_channel_default_view_and_more.py]---
Location: zulip-main/zerver/migrations/0548_realmuserdefault_web_channel_default_view_and_more.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-07-08 18:20

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0547_realmuserdefault_web_navigate_to_sent_message_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_channel_default_view",
            field=models.SmallIntegerField(db_default=1, default=1),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_channel_default_view",
            field=models.SmallIntegerField(db_default=1, default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0549_realm_direct_message_initiator_group_and_more.py]---
Location: zulip-main/zerver/migrations/0549_realm_direct_message_initiator_group_and_more.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-01 10:02

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0548_realmuserdefault_web_channel_default_view_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="direct_message_initiator_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
        migrations.AddField(
            model_name="realm",
            name="direct_message_permission_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0550_set_default_value_for_realm_direct_message_initiator_group_and_more.py]---
Location: zulip-main/zerver/migrations/0550_set_default_value_for_realm_direct_message_initiator_group_and_more.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-01 10:03


from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_direct_message_initiator_group_and_more(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    EVERYONE_GROUP_NAME = "role:everyone"
    NOBODY_GROUP_NAME = "role:nobody"
    PRIVATE_MESSAGE_POLICY_DISABLED = 2

    Realm.objects.filter(
        direct_message_initiator_group=None,
    ).update(
        direct_message_initiator_group=NamedUserGroup.objects.filter(
            name=EVERYONE_GROUP_NAME, realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        direct_message_permission_group=None, private_message_policy=PRIVATE_MESSAGE_POLICY_DISABLED
    ).update(
        direct_message_permission_group=NamedUserGroup.objects.filter(
            name=NOBODY_GROUP_NAME, realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )
    Realm.objects.filter(
        direct_message_permission_group=None,
    ).exclude(private_message_policy=PRIVATE_MESSAGE_POLICY_DISABLED).update(
        direct_message_permission_group=NamedUserGroup.objects.filter(
            name=EVERYONE_GROUP_NAME, realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0549_realm_direct_message_initiator_group_and_more"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_direct_message_initiator_group_and_more,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0551_alter_realm_direct_message_initiator_group_and_more.py]---
Location: zulip-main/zerver/migrations/0551_alter_realm_direct_message_initiator_group_and_more.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2024-01-01 11:28

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0550_set_default_value_for_realm_direct_message_initiator_group_and_more"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="direct_message_initiator_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
        migrations.AlterField(
            model_name="realm",
            name="direct_message_permission_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0552_remove_realm_private_message_policy.py]---
Location: zulip-main/zerver/migrations/0552_remove_realm_private_message_policy.py
Signals: Django

```python
# Generated by Django 5.0.6 on 2024-06-27 04:46

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0551_alter_realm_direct_message_initiator_group_and_more"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="private_message_policy",
        ),
    ]
```

--------------------------------------------------------------------------------

````
