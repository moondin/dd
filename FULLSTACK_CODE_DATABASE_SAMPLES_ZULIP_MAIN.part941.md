---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 941
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 941 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0257_fix_has_link_attribute.py]---
Location: zulip-main/zerver/migrations/0257_fix_has_link_attribute.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-10-07 05:25

import time
from typing import cast

import lxml
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

BATCH_SIZE = 1000


def process_batch(apps: StateApps, id_start: int, id_end: int, last_id: int) -> None:
    Message = apps.get_model("zerver", "Message")
    for message in Message.objects.filter(id__gte=id_start, id__lte=id_end).order_by("id"):
        if message.rendered_content in ["", None]:
            # There have been bugs in the past that made it possible
            # for a message to have "" or None as its rendered_content; we
            # need to skip those because lxml won't process them.
            #
            # They should safely already have the correct state
            #   has_link=has_image=has_attachment=False.
            continue

        if message.id % 1000 == 0:
            print(f"Processed {message.id} / {last_id}")

        # Because we maintain the Attachment table, this should be as
        # simple as just checking if there's any Attachment
        # objects associated with this message.
        has_attachment = message.attachment_set.exists()

        # For has_link and has_image, we need to parse the messages.
        # Links are simple -- look for a link in the message.
        lxml_obj = lxml.html.fromstring(message.rendered_content)
        has_link = any(True for link in lxml_obj.iter("a"))

        # has_image refers to inline image previews, so we just check
        # for the relevant CSS class.
        has_image = any(
            True for img in cast(lxml.html.HtmlMixin, lxml_obj).find_class("message_inline_image")
        )

        if (
            message.has_link == has_link
            and message.has_attachment == has_attachment
            and message.has_image == has_image
        ):
            # No need to spend time with the database if there aren't changes.
            continue
        message.has_image = has_image
        message.has_link = has_link
        message.has_attachment = has_attachment
        message.save(update_fields=["has_link", "has_attachment", "has_image"])


def fix_has_link(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Message = apps.get_model("zerver", "Message")
    if not Message.objects.exists():
        # Nothing to do, and Message.objects.latest() will crash.
        return

    # This migration logic assumes that either the server is not
    # running, or that it's being run after the logic to correct how
    # `has_link` and friends are set for new messages have been
    # deployed.
    last_id = Message.objects.latest("id").id

    id_range_lower_bound = 0
    id_range_upper_bound = 0 + BATCH_SIZE
    while id_range_upper_bound <= last_id:
        process_batch(apps, id_range_lower_bound, id_range_upper_bound, last_id)

        id_range_lower_bound = id_range_upper_bound + 1
        id_range_upper_bound = id_range_lower_bound + BATCH_SIZE
        time.sleep(0.1)

    if last_id > id_range_lower_bound:
        # Copy for the last batch.
        process_batch(apps, id_range_lower_bound, last_id, last_id)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0256_userprofile_stream_set_recipient_column_values"),
    ]

    operations = [
        migrations.RunPython(fix_has_link, reverse_code=migrations.RunPython.noop, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0258_enable_online_push_notifications_default.py]---
Location: zulip-main/zerver/migrations/0258_enable_online_push_notifications_default.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2019-12-11 00:41

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0257_fix_has_link_attribute"),
    ]

    operations = [
        migrations.AlterField(
            model_name="userprofile",
            name="enable_online_push_notifications",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0259_missedmessageemailaddress.py]---
Location: zulip-main/zerver/migrations/0259_missedmessageemailaddress.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-06 01:23

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0258_enable_online_push_notifications_default"),
    ]

    operations = [
        migrations.CreateModel(
            name="MissedMessageEmailAddress",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("email_token", models.CharField(db_index=True, max_length=34, unique=True)),
                (
                    "timestamp",
                    models.DateTimeField(db_index=True, default=django.utils.timezone.now),
                ),
                ("times_used", models.PositiveIntegerField(db_index=True, default=0)),
                (
                    "message",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.Message"
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0260_missed_message_addresses_from_redis_to_db.py]---
Location: zulip-main/zerver/migrations/0260_missed_message_addresses_from_redis_to_db.py
Signals: Django

```python
import secrets

from django.core.exceptions import ObjectDoesNotExist
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

# Imported to avoid needing to duplicate Redis-related code.
from zerver.lib.redis_utils import get_redis_client


def generate_missed_message_token() -> str:
    return "mm" + secrets.token_hex(16)


def move_missed_message_addresses_to_database(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    redis_client = get_redis_client()
    MissedMessageEmailAddress = apps.get_model("zerver", "MissedMessageEmailAddress")
    UserProfile = apps.get_model("zerver", "UserProfile")
    Message = apps.get_model("zerver", "Message")
    Recipient = apps.get_model("zerver", "Recipient")
    RECIPIENT_PERSONAL = 1
    RECIPIENT_STREAM = 2

    all_mm_keys = redis_client.keys("missed_message:*")
    for key in all_mm_keys:
        # Don't migrate mm addresses that have already been used.
        if redis_client.hincrby(key, "uses_left", -1) < 0:
            redis_client.delete(key)
            continue

        user_profile_id, recipient_id, subject_b = redis_client.hmget(
            key, "user_profile_id", "recipient_id", "subject"
        )
        if user_profile_id is None or recipient_id is None or subject_b is None:
            # Missing data, skip this key; this should never happen
            redis_client.delete(key)
            continue

        topic_name = subject_b.decode()

        # The data model for missed-message emails has changed in two
        # key ways: We're moving it from Redis to the database for
        # better persistence, and also replacing the stream + topic
        # (as the reply location) with a message to reply to.  Because
        # the Redis data structure only had stream/topic pairs, we use
        # the following migration logic to find the latest message in
        # the thread indicated by the Redis data (if it exists).
        try:
            user_profile = UserProfile.objects.get(id=user_profile_id)
            recipient = Recipient.objects.get(id=recipient_id)

            if recipient.type == RECIPIENT_STREAM:
                message = Message.objects.filter(
                    subject__iexact=topic_name, recipient_id=recipient.id
                ).latest("id")
            elif recipient.type == RECIPIENT_PERSONAL:
                # Tie to the latest PM from the sender to this user;
                # we expect at least one existed because it generated
                # this missed-message email, so we can skip the
                # normally required additional check for messages we
                # ourselves sent to the target user.
                message = Message.objects.filter(
                    recipient_id=user_profile.recipient_id, sender_id=recipient.type_id
                ).latest("id")
            else:
                message = Message.objects.filter(recipient_id=recipient.id).latest("id")
        except ObjectDoesNotExist:
            # If all messages in the original thread were deleted or
            # had their topics edited, we can't find an appropriate
            # message to tag; we just skip migrating this message.
            # The consequence (replies to this particular
            # missed-message email bouncing) is acceptable.
            redis_client.delete(key)
            continue

        # The timestamp will be set to the default (now) which means
        # the address will take longer to expire than it would have in
        # Redis, but this small issue is probably worth the simplicity
        # of not having to figure out the precise timestamp.
        MissedMessageEmailAddress.objects.create(
            message=message, user_profile=user_profile, email_token=generate_missed_message_token()
        )
        # We successfully transferred this missed-message email's data
        # to the database, so this message can be deleted from Redis.
        redis_client.delete(key)


class Migration(migrations.Migration):
    # Atomicity is not feasible here, since we're doing operations on Redis too.
    # It's better to be non-atomic on both Redis and database, than atomic
    # on the database and not on Redis.
    atomic = False

    dependencies = [
        ("zerver", "0259_missedmessageemailaddress"),
    ]

    operations = [
        migrations.RunPython(
            move_missed_message_addresses_to_database,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0261_pregistrationuser_clear_invited_as_admin.py]---
Location: zulip-main/zerver/migrations/0261_pregistrationuser_clear_invited_as_admin.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-06-16 22:26

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def clear_preregistrationuser_invited_as_admin(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    """This migration fixes any PreregistrationUser objects that might
    have been already corrupted to have the administrator role by the
    buggy original version of migration
    0198_preregistrationuser_invited_as.

    Since invitations that create new users as administrators are
    rare, it is cleaner to just remove the role from all
    PreregistrationUser objects than to filter for just those older
    invitation objects that could have been corrupted by the original
    migration, which would have been possible using the
    django_migrations table to check the date when the buggy migration
    was run.
    """
    INVITED_AS_MEMBER = 1
    INVITED_AS_REALM_ADMIN = 2
    PreregistrationUser = apps.get_model("zerver", "PreregistrationUser")
    PreregistrationUser.objects.filter(invited_as=INVITED_AS_REALM_ADMIN).update(
        invited_as=INVITED_AS_MEMBER
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0260_missed_message_addresses_from_redis_to_db"),
    ]

    operations = [
        migrations.RunPython(
            clear_preregistrationuser_invited_as_admin,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0261_realm_private_message_policy.py]---
Location: zulip-main/zerver/migrations/0261_realm_private_message_policy.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-08 00:32
from django.db import migrations, models

PRIVATE_MESSAGE_POLICY_UNLIMITED = 1


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0260_missed_message_addresses_from_redis_to_db"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="private_message_policy",
            field=models.PositiveSmallIntegerField(default=PRIVATE_MESSAGE_POLICY_UNLIMITED),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0262_mutedtopic_date_muted.py]---
Location: zulip-main/zerver/migrations/0262_mutedtopic_date_muted.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-17 15:26
from datetime import datetime, timezone

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0261_realm_private_message_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="mutedtopic",
            name="date_muted",
            field=models.DateTimeField(default=datetime(2020, 1, 1, 0, 0, tzinfo=timezone.utc)),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0263_stream_stream_post_policy.py]---
Location: zulip-main/zerver/migrations/0263_stream_stream_post_policy.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-27 22:03
from django.db import migrations, models

STREAM_POST_POLICY_EVERYONE = 1


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0262_mutedtopic_date_muted"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="stream_post_policy",
            field=models.PositiveSmallIntegerField(default=STREAM_POST_POLICY_EVERYONE),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0264_migrate_is_announcement_only.py]---
Location: zulip-main/zerver/migrations/0264_migrate_is_announcement_only.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-25 23:47

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def upgrade_stream_post_policy(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Stream = apps.get_model("zerver", "Stream")
    Stream.STREAM_POST_POLICY_EVERYONE = 1
    Stream.STREAM_POST_POLICY_ADMINS = 2
    Stream.objects.filter(is_announcement_only=False).update(
        stream_post_policy=Stream.STREAM_POST_POLICY_EVERYONE
    )
    Stream.objects.filter(is_announcement_only=True).update(
        stream_post_policy=Stream.STREAM_POST_POLICY_ADMINS
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0263_stream_stream_post_policy"),
    ]

    operations = [
        migrations.RunPython(
            upgrade_stream_post_policy, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0265_remove_stream_is_announcement_only.py]---
Location: zulip-main/zerver/migrations/0265_remove_stream_is_announcement_only.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-27 22:05

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0264_migrate_is_announcement_only"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="stream",
            name="is_announcement_only",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0266_userpresence_realm.py]---
Location: zulip-main/zerver/migrations/0266_userpresence_realm.py
Signals: Django

```python
# Generated by Django 1.11.28 on 2020-02-08 20:19
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0265_remove_stream_is_announcement_only"),
    ]

    operations = [
        migrations.AddField(
            model_name="userpresence",
            name="realm",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zerver.Realm"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0267_backfill_userpresence_realm_id.py]---
Location: zulip-main/zerver/migrations/0267_backfill_userpresence_realm_id.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0266_userpresence_realm"),
    ]

    operations = [
        migrations.RunSQL(
            """
            UPDATE zerver_userpresence
            SET realm_id = zerver_userprofile.realm_id
            FROM zerver_userprofile
            WHERE zerver_userprofile.id = zerver_userpresence.user_profile_id;
            """,
            reverse_sql="UPDATE zerver_userpresence SET realm_id = NULL",
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0268_add_userpresence_realm_timestamp_index.py]---
Location: zulip-main/zerver/migrations/0268_add_userpresence_realm_timestamp_index.py
Signals: Django

```python
# Generated by Django 1.11.28 on 2020-02-08 20:34
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0267_backfill_userpresence_realm_id"),
    ]

    operations = [
        migrations.AlterField(
            model_name="userpresence",
            name="realm",
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="zerver.Realm"),
        ),
        migrations.AddIndex(
            model_name="userpresence",
            index=models.Index(
                fields=["realm", "timestamp"],
                name="zerver_userpresence_realm_id_timestamp_25f410da_idx",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0269_gitlab_auth.py]---
Location: zulip-main/zerver/migrations/0269_gitlab_auth.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2020-01-29 17:30

import bitfield.models
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0268_add_userpresence_realm_timestamp_index"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="authentication_methods",
            field=bitfield.models.BitField(
                [
                    "Google",
                    "Email",
                    "GitHub",
                    "LDAP",
                    "Dev",
                    "RemoteUser",
                    "AzureAD",
                    "SAML",
                    "GitLab",
                ],
                default=2147483647,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0270_huddle_recipient.py]---
Location: zulip-main/zerver/migrations/0270_huddle_recipient.py
Signals: Django

```python
# Generated by Django 2.2.10 on 2020-03-15 17:25
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0269_gitlab_auth"),
    ]

    operations = [
        migrations.AddField(
            model_name="huddle",
            name="recipient",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to="zerver.Recipient"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0271_huddle_set_recipient_column_values.py]---
Location: zulip-main/zerver/migrations/0271_huddle_set_recipient_column_values.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0270_huddle_recipient"),
    ]

    operations = [
        migrations.RunSQL(
            """
            UPDATE zerver_huddle
            SET recipient_id = zerver_recipient.id
            FROM zerver_recipient
            WHERE zerver_recipient.type_id = zerver_huddle.id AND zerver_recipient.type = 3;
            """,
            reverse_sql="UPDATE zerver_huddle SET recipient_id = NULL",
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0272_realm_default_code_block_language.py]---
Location: zulip-main/zerver/migrations/0272_realm_default_code_block_language.py
Signals: Django

```python
# Generated by Django 2.2.10 on 2020-03-31 00:21

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0271_huddle_set_recipient_column_values"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="default_code_block_language",
            field=models.TextField(default=None, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0273_migrate_old_bot_messages.py]---
Location: zulip-main/zerver/migrations/0273_migrate_old_bot_messages.py
Signals: Django

```python
from typing import Any

from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_messages(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Conceptually, this migration cleans up the old NEW_USER_BOT and FEEDBACK_BOT
    UserProfile objects (their implementations were removed long ago).

    We do this by:
    * Changing their sent messages to have been sent by NOTIFICATION_BOT.
    * Changing their 1:1 PMs to be PMs with NOTIFICATION_BOT and deleting their
      PM recipient object.
    * Deleting any Huddles that involve them (zulip.com data suggests there are none,
      so this is mainly out of caution) and Recipient objects (which will cascade to
      associated Subscription, Message, and UserMessage objects if they exist).
    * Deleting their UserProfile objects.

    The end result if these users are completely removed, with any
    messages that might have been associated with them transferred
    to NOTIFICATION_BOT to preserve history.
    """
    UserProfile = apps.get_model("zerver", "UserProfile")
    Huddle = apps.get_model("zerver", "Huddle")
    Subscription = apps.get_model("zerver", "Subscription")
    Recipient = apps.get_model("zerver", "Recipient")
    RECIPIENT_HUDDLE = 3
    Message = apps.get_model("zerver", "Message")
    Realm = apps.get_model("zerver", "Realm")

    try:
        internal_realm = Realm.objects.get(string_id=settings.SYSTEM_BOT_REALM)
    except Realm.DoesNotExist:
        # Server not initialized, or no system bot realm. Either way, we shouldn't do anything.
        return

    def get_bot_by_delivery_email(email: str) -> Any:
        return UserProfile.objects.get(delivery_email__iexact=email.strip(), realm=internal_realm)

    notification_bot = get_bot_by_delivery_email(settings.NOTIFICATION_BOT)

    def fix_messages_by_bot(bot_profile: Any) -> None:
        Message.objects.filter(sender=bot_profile).update(sender=notification_bot)
        Message.objects.filter(recipient=bot_profile.recipient).update(
            recipient=notification_bot.recipient
        )

    def clean_up_bot(bot_profile: Any) -> None:
        huddle_recipient_ids = Subscription.objects.filter(
            user_profile_id=bot_profile.id, recipient__type=RECIPIENT_HUDDLE
        ).values_list("recipient_id", flat=True)
        Huddle.objects.filter(recipient_id__in=huddle_recipient_ids).delete()
        Recipient.objects.filter(id__in=huddle_recipient_ids).delete()

        personal_recipient_id = bot_profile.recipient_id
        bot_profile.delete()
        Recipient.objects.filter(id=personal_recipient_id).delete()

    new_user_bot_email = getattr(settings, "NEW_USER_BOT", "new-user-bot@zulip.com")
    try:
        new_user_bot = get_bot_by_delivery_email(new_user_bot_email)
        fix_messages_by_bot(new_user_bot)
        clean_up_bot(new_user_bot)
    except UserProfile.DoesNotExist:
        pass

    feedback_bot_email = getattr(settings, "FEEDBACK_BOT", "feedback@zulip.com")
    try:
        feedback_bot = get_bot_by_delivery_email(feedback_bot_email)
        fix_messages_by_bot(feedback_bot)
        clean_up_bot(feedback_bot)
    except UserProfile.DoesNotExist:
        pass


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0272_realm_default_code_block_language"),
    ]

    operations = [
        migrations.RunPython(fix_messages, reverse_code=migrations.RunPython.noop, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0274_nullbooleanfield_to_booleanfield.py]---
Location: zulip-main/zerver/migrations/0274_nullbooleanfield_to_booleanfield.py
Signals: Django

```python
# Generated by Django 2.2.12 on 2020-04-26 17:53

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0273_migrate_old_bot_messages"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="invite_only",
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="audible_notifications",
            field=models.BooleanField(default=None, null=True),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="desktop_notifications",
            field=models.BooleanField(default=None, null=True),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="email_notifications",
            field=models.BooleanField(default=None, null=True),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="is_muted",
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="push_notifications",
            field=models.BooleanField(default=None, null=True),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="wildcard_mentions_notify",
            field=models.BooleanField(default=None, null=True),
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="enter_sends",
            field=models.BooleanField(default=False, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0275_remove_userprofile_last_pointer_updater.py]---
Location: zulip-main/zerver/migrations/0275_remove_userprofile_last_pointer_updater.py
Signals: Django

```python
# Generated by Django 2.2.10 on 2020-02-19 20:54

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0274_nullbooleanfield_to_booleanfield"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="userprofile",
            name="last_pointer_updater",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0276_alertword.py]---
Location: zulip-main/zerver/migrations/0276_alertword.py
Signals: Django

```python
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0275_remove_userprofile_last_pointer_updater"),
    ]

    operations = [
        migrations.CreateModel(
            name="AlertWord",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("word", models.TextField()),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.Realm"
                    ),
                ),
                (
                    "user_profile",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
            options={
                "unique_together": {("user_profile", "word")},
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0277_migrate_alert_word.py]---
Location: zulip-main/zerver/migrations/0277_migrate_alert_word.py
Signals: Django

```python
import orjson
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def move_to_separate_table(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    AlertWord = apps.get_model("zerver", "AlertWord")

    for user_profile in UserProfile.objects.all().iterator():
        list_of_words = orjson.loads(user_profile.alert_words)

        # Remove duplicates with our case-insensitive model.
        word_dict: dict[str, str] = {}
        for word in list_of_words:
            word_dict[word.lower()] = word

        AlertWord.objects.bulk_create(
            AlertWord(user_profile=user_profile, word=word, realm=user_profile.realm)
            for word in word_dict.values()
        )


def move_back_to_user_profile(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    AlertWord = apps.get_model("zerver", "AlertWord")
    UserProfile = apps.get_model("zerver", "UserProfile")

    user_ids_and_words = AlertWord.objects.all().values("user_profile_id", "word")
    user_ids_with_words: dict[int, list[str]] = {}

    for id_and_word in user_ids_and_words:
        user_ids_with_words.setdefault(id_and_word["user_profile_id"], [])
        user_ids_with_words[id_and_word["user_profile_id"]].append(id_and_word["word"])

    for user_id, words in user_ids_with_words.items():
        user_profile = UserProfile.objects.get(id=user_id)
        user_profile.alert_words = orjson.dumps(words).decode()
        user_profile.save(update_fields=["alert_words"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0276_alertword"),
    ]

    operations = [
        migrations.RunPython(move_to_separate_table, move_back_to_user_profile, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0278_remove_userprofile_alert_words.py]---
Location: zulip-main/zerver/migrations/0278_remove_userprofile_alert_words.py
Signals: Django

```python
# Generated by Django 2.2.10 on 2020-03-23 20:08

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0277_migrate_alert_word"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="userprofile",
            name="alert_words",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0279_message_recipient_subject_indexes.py]---
Location: zulip-main/zerver/migrations/0279_message_recipient_subject_indexes.py
Signals: Django

```python
# Generated by Django 2.2.12 on 2020-04-30 00:35

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models
from django.db.models import F
from django.db.models.functions import Upper


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0278_remove_userprofile_alert_words"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                "recipient",
                Upper("subject"),
                F("id").desc(nulls_last=True),
                name="zerver_message_recipient_upper_subject",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                "recipient",
                "subject",
                F("id").desc(nulls_last=True),
                name="zerver_message_recipient_subject",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0280_userprofile_presence_enabled.py]---
Location: zulip-main/zerver/migrations/0280_userprofile_presence_enabled.py
Signals: Django

```python
# Generated by Django 2.2.12 on 2020-05-01 16:22

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0279_message_recipient_subject_indexes"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="presence_enabled",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0281_zoom_oauth.py]---
Location: zulip-main/zerver/migrations/0281_zoom_oauth.py
Signals: Django

```python
# Generated by Django 1.11.25 on 2019-11-06 22:40

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0280_userprofile_presence_enabled"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="zoom_token",
            field=models.JSONField(default=None, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0282_remove_zoom_video_chat.py]---
Location: zulip-main/zerver/migrations/0282_remove_zoom_video_chat.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-09-24 00:15

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0281_zoom_oauth"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="zoom_api_key",
        ),
        migrations.RemoveField(
            model_name="realm",
            name="zoom_api_secret",
        ),
        migrations.RemoveField(
            model_name="realm",
            name="zoom_user_id",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0283_apple_auth.py]---
Location: zulip-main/zerver/migrations/0283_apple_auth.py
Signals: Django

```python
# Generated by Django 2.2.13 on 2020-06-09 09:37

import bitfield.models
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0282_remove_zoom_video_chat"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="authentication_methods",
            field=bitfield.models.BitField(
                [
                    "Google",
                    "Email",
                    "GitHub",
                    "LDAP",
                    "Dev",
                    "RemoteUser",
                    "AzureAD",
                    "SAML",
                    "GitLab",
                    "Apple",
                ],
                default=2147483647,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0284_convert_realm_admins_to_realm_owners.py]---
Location: zulip-main/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py
Signals: Django

```python
# Generated by Django 2.2.12 on 2020-05-16 18:34
from typing import Any

import orjson
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Count
from django.utils.timezone import now as timezone_now


def set_realm_admins_as_realm_owners(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")

    UserProfile.ROLE_REALM_OWNER = 100
    UserProfile.ROLE_REALM_ADMINISTRATOR = 200
    UserProfile.ROLE_MEMBER = 400
    UserProfile.ROLE_GUEST = 600

    RealmAuditLog.USER_ROLE_CHANGED = 105
    RealmAuditLog.OLD_VALUE = "1"
    RealmAuditLog.NEW_VALUE = "2"
    RealmAuditLog.ROLE_COUNT = "10"
    RealmAuditLog.ROLE_COUNT_HUMANS = "11"
    RealmAuditLog.ROLE_COUNT_BOTS = "12"

    def realm_user_count_by_role(realm: Any) -> dict[str, Any]:
        human_counts = {
            str(UserProfile.ROLE_REALM_ADMINISTRATOR): 0,
            str(UserProfile.ROLE_REALM_OWNER): 0,
            str(UserProfile.ROLE_MEMBER): 0,
            str(UserProfile.ROLE_GUEST): 0,
        }
        for value_dict in (
            UserProfile.objects.filter(realm=realm, is_bot=False, is_active=True)
            .values("role")
            .annotate(Count("role"))
        ):
            human_counts[str(value_dict["role"])] = value_dict["role__count"]
        bot_count = UserProfile.objects.filter(realm=realm, is_bot=True, is_active=True).count()
        return {
            RealmAuditLog.ROLE_COUNT_HUMANS: human_counts,
            RealmAuditLog.ROLE_COUNT_BOTS: bot_count,
        }

    objects_to_create = []

    for user in UserProfile.objects.filter(
        is_active=True, role=UserProfile.ROLE_REALM_ADMINISTRATOR
    ):
        user.role = UserProfile.ROLE_REALM_OWNER
        user.save(update_fields=["role"])
        audit_log_entry = RealmAuditLog(
            realm=user.realm,
            modified_user=user,
            event_type=RealmAuditLog.USER_ROLE_CHANGED,
            event_time=timezone_now(),
            extra_data=orjson.dumps(
                {
                    RealmAuditLog.OLD_VALUE: UserProfile.ROLE_REALM_ADMINISTRATOR,
                    RealmAuditLog.NEW_VALUE: UserProfile.ROLE_REALM_OWNER,
                    RealmAuditLog.ROLE_COUNT: realm_user_count_by_role(user.realm),
                }
            ).decode(),
        )
        objects_to_create.append(audit_log_entry)
    RealmAuditLog.objects.bulk_create(objects_to_create)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0283_apple_auth"),
    ]

    operations = [
        migrations.RunPython(
            set_realm_admins_as_realm_owners, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

````
