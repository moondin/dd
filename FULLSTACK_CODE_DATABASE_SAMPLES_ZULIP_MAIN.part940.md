---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 940
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 940 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0231_add_archive_transaction_model.py]---
Location: zulip-main/zerver/migrations/0231_add_archive_transaction_model.py
Signals: Django

```python
# Generated by Django 1.11.20 on 2019-06-23 21:20

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0230_rename_to_enable_stream_audible_notifications"),
    ]

    operations = [
        migrations.CreateModel(
            name="ArchiveTransaction",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                (
                    "timestamp",
                    models.DateTimeField(db_index=True, default=django.utils.timezone.now),
                ),
                ("restored", models.BooleanField(db_index=True, default=False)),
                ("type", models.PositiveSmallIntegerField(db_index=True)),
                (
                    "realm",
                    models.ForeignKey(
                        null=True, on_delete=django.db.models.deletion.CASCADE, to="zerver.Realm"
                    ),
                ),
            ],
        ),
        migrations.RemoveField(
            model_name="archivedattachment",
            name="archive_timestamp",
        ),
        migrations.RemoveField(
            model_name="archivedmessage",
            name="archive_timestamp",
        ),
        migrations.RemoveField(
            model_name="archivedreaction",
            name="archive_timestamp",
        ),
        migrations.RemoveField(
            model_name="archivedsubmessage",
            name="archive_timestamp",
        ),
        migrations.RemoveField(
            model_name="archivedusermessage",
            name="archive_timestamp",
        ),
        migrations.AddField(
            model_name="archivedmessage",
            name="archive_transaction",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                to="zerver.ArchiveTransaction",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0232_make_archive_transaction_field_not_nullable.py]---
Location: zulip-main/zerver/migrations/0232_make_archive_transaction_field_not_nullable.py
Signals: Django

```python
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    """
    Tables cannot have data deleted from them and be altered in a single transaction,
    but we need the DELETEs to be atomic together. So we set atomic=False for the migration
    in general, and run the DELETEs in one transaction, and AlterField in another.
    """

    atomic = False

    dependencies = [
        ("zerver", "0231_add_archive_transaction_model"),
    ]

    operations = [
        migrations.RunSQL(
            """
        BEGIN;
        DELETE FROM zerver_archivedusermessage;
        DELETE FROM zerver_archivedreaction;
        DELETE FROM zerver_archivedsubmessage;
        DELETE FROM zerver_archivedattachment_messages;
        DELETE FROM zerver_archivedattachment;
        DELETE FROM zerver_archivedmessage;
        DELETE FROM zerver_archivetransaction;
        COMMIT;
        """,
            elidable=True,
        ),
        migrations.AlterField(
            model_name="archivedmessage",
            name="archive_transaction",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE, to="zerver.ArchiveTransaction"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0233_userprofile_avatar_hash.py]---
Location: zulip-main/zerver/migrations/0233_userprofile_avatar_hash.py
Signals: Django

```python
# Generated by Django 1.11.20 on 2019-06-28 22:38

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0232_make_archive_transaction_field_not_nullable"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="avatar_hash",
            field=models.CharField(max_length=64, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0234_add_external_account_custom_profile_field.py]---
Location: zulip-main/zerver/migrations/0234_add_external_account_custom_profile_field.py
Signals: Django

```python
# Generated by Django 1.11.20 on 2019-05-30 08:18

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0233_userprofile_avatar_hash"),
    ]

    operations = [
        migrations.AlterField(
            model_name="customprofilefield",
            name="field_type",
            field=models.PositiveSmallIntegerField(
                choices=[
                    (1, "Short text"),
                    (2, "Long text"),
                    (4, "Date picker"),
                    (5, "Link"),
                    (7, "External account"),
                    (3, "List of options"),
                    (6, "Person picker"),
                ],
                default=1,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0235_userprofile_desktop_icon_count_display.py]---
Location: zulip-main/zerver/migrations/0235_userprofile_desktop_icon_count_display.py
Signals: Django

```python
# Generated by Django 1.11.20 on 2019-06-29 18:22
from django.db import migrations, models

DESKTOP_ICON_COUNT_DISPLAY_MESSAGES = 1


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0234_add_external_account_custom_profile_field"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="desktop_icon_count_display",
            field=models.PositiveSmallIntegerField(default=DESKTOP_ICON_COUNT_DISPLAY_MESSAGES),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0236_remove_illegal_characters_email_full.py]---
Location: zulip-main/zerver/migrations/0236_remove_illegal_characters_email_full.py
Signals: Django

```python
# Generated by Django 1.11.20 on 2019-06-28 21:45

from unicodedata import category

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

NAME_INVALID_CHARS = ["*", "`", "\\", ">", '"', "@"]


def remove_name_illegal_chars(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    for user in UserProfile.objects.all().iterator():
        user.full_name = "".join(
            char
            for char in user.full_name
            if (char not in NAME_INVALID_CHARS) and (category(char)[0] != "C")
        )
        user.save(update_fields=["full_name"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0235_userprofile_desktop_icon_count_display"),
    ]

    operations = [
        migrations.RunPython(remove_name_illegal_chars, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0237_rename_zulip_realm_to_zulipinternal.py]---
Location: zulip-main/zerver/migrations/0237_rename_zulip_realm_to_zulipinternal.py
Signals: Django

```python
from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def rename_zulip_realm_to_zulipinternal(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    if not settings.PRODUCTION:
        return

    Realm = apps.get_model("zerver", "Realm")
    UserProfile = apps.get_model("zerver", "UserProfile")

    if not Realm.objects.exists():
        # Database not yet populated, do nothing:
        return

    if Realm.objects.filter(string_id="zulipinternal").exists():
        return
    if not Realm.objects.filter(string_id="zulip").exists():
        # If the user renamed the `zulip` system bot realm (or deleted
        # it), there's nothing for us to do.
        return

    internal_realm = Realm.objects.get(string_id="zulip")

    # For safety, as a sanity check, verify that "internal_realm" is indeed the realm for system bots:
    welcome_bot = UserProfile.objects.get(email="welcome-bot@zulip.com")
    assert welcome_bot.realm.id == internal_realm.id

    internal_realm.string_id = "zulipinternal"
    internal_realm.name = "System use only"
    internal_realm.save()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0236_remove_illegal_characters_email_full"),
    ]

    operations = [
        migrations.RunPython(rename_zulip_realm_to_zulipinternal, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0238_usermessage_bigint_id.py]---
Location: zulip-main/zerver/migrations/0238_usermessage_bigint_id.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-22 22:02

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0237_rename_zulip_realm_to_zulipinternal"),
    ]

    operations = [
        migrations.AddField(
            model_name="archivedusermessage",
            name="bigint_id",
            field=models.BigIntegerField(null=True),
        ),
        migrations.AddField(
            model_name="usermessage",
            name="bigint_id",
            field=models.BigIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0239_usermessage_copy_id_to_bigint_id.py]---
Location: zulip-main/zerver/migrations/0239_usermessage_copy_id_to_bigint_id.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-21 21:43

import time

from django.db import connection, migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Min
from psycopg2.sql import SQL

BATCH_SIZE = 10000


def sql_copy_id_to_bigint_id(id_range_lower_bound: int, id_range_upper_bound: int) -> None:
    query = SQL(
        """
            UPDATE zerver_usermessage
            SET bigint_id = id
            WHERE id BETWEEN %(lower_bound)s AND %(upper_bound)s
    """
    )
    with connection.cursor() as cursor:
        cursor.execute(
            query,
            {
                "lower_bound": id_range_lower_bound,
                "upper_bound": id_range_upper_bound,
            },
        )


def copy_id_to_bigid(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserMessage = apps.get_model("zerver", "UserMessage")
    if not UserMessage.objects.exists():
        # Nothing to do
        return

    #  TODO: is  the below lookup fast enough, considering there's no index on bigint_id?
    first_uncopied_id = UserMessage.objects.filter(bigint_id__isnull=True).aggregate(Min("id"))[
        "id__min"
    ]
    # Note: the below id can fall in a segment
    # where bigint_id = id already, but it's not a big problem
    # this will just do some redundant UPDATEs.
    last_id = UserMessage.objects.latest("id").id

    id_range_lower_bound = first_uncopied_id
    id_range_upper_bound = first_uncopied_id + BATCH_SIZE
    while id_range_upper_bound <= last_id:
        sql_copy_id_to_bigint_id(id_range_lower_bound, id_range_upper_bound)
        id_range_lower_bound = id_range_upper_bound + 1
        id_range_upper_bound = id_range_lower_bound + BATCH_SIZE
        time.sleep(0.1)

    if last_id > id_range_lower_bound:
        # Copy for the last batch.
        sql_copy_id_to_bigint_id(id_range_lower_bound, last_id)


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0238_usermessage_bigint_id"),
    ]

    operations = [
        migrations.RunSQL(
            """
        CREATE FUNCTION zerver_usermessage_bigint_id_to_id_trigger_function()
        RETURNS trigger AS $$
        BEGIN
            NEW.bigint_id = NEW.id;
            RETURN NEW;
        END
        $$ LANGUAGE 'plpgsql';

        CREATE TRIGGER zerver_usermessage_bigint_id_to_id_trigger
        BEFORE INSERT ON zerver_usermessage
        FOR EACH ROW
        EXECUTE PROCEDURE zerver_usermessage_bigint_id_to_id_trigger_function();
        """
        ),
        migrations.RunPython(copy_id_to_bigid, elidable=True),
        migrations.RunSQL(
            """
        CREATE UNIQUE INDEX CONCURRENTLY zerver_usermessage_bigint_id_idx ON zerver_usermessage (bigint_id);
        """
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0240_usermessage_migrate_bigint_id_into_id.py]---
Location: zulip-main/zerver/migrations/0240_usermessage_migrate_bigint_id_into_id.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-23 21:03

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0239_usermessage_copy_id_to_bigint_id"),
    ]

    # Note that this migration needs to work whether
    # zerver_usermessage.bigint_id was created as a serial column (for
    # Zulip initially installed with Django < 4.1) or an identity
    # column (for Zulip initially installed with Django â‰¥ 4.1).  If
    # you need to edit it, remember to test both cases.

    operations = [
        migrations.RunSQL(
            """
            DROP TRIGGER zerver_usermessage_bigint_id_to_id_trigger ON zerver_usermessage;
            DROP FUNCTION zerver_usermessage_bigint_id_to_id_trigger_function();

            ALTER TABLE zerver_usermessage
                ALTER COLUMN bigint_id SET NOT NULL,
                DROP CONSTRAINT zerver_usermessage_pkey,
                ALTER COLUMN id DROP IDENTITY IF EXISTS,
                ALTER COLUMN id DROP NOT NULL,
                ALTER COLUMN id DROP DEFAULT;
            ALTER TABLE zerver_usermessage RENAME COLUMN id TO id_old;
            ALTER TABLE zerver_usermessage RENAME COLUMN bigint_id TO id;
            DROP SEQUENCE IF EXISTS zerver_usermessage_id_seq;
            ALTER TABLE zerver_usermessage
                ADD CONSTRAINT zerver_usermessage_pkey PRIMARY KEY USING INDEX zerver_usermessage_bigint_id_idx,
                ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
            SELECT setval(
                'zerver_usermessage_id_seq',
                GREATEST(
                    (SELECT max(id) FROM zerver_usermessage),
                    (SELECT max(id) FROM zerver_archivedusermessage)
                )
            );
            """,
            state_operations=[
                # This just tells Django to understand executing the above SQL as if it just ran the operations below,
                # so that it knows these model changes are handled and doesn't to generate them on its own
                # in the future makemigration calls.
                migrations.RemoveField(
                    model_name="usermessage",
                    name="bigint_id",
                ),
                migrations.AlterField(
                    model_name="usermessage",
                    name="id",
                    field=models.BigAutoField(primary_key=True, serialize=False),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0241_usermessage_bigint_id_migration_finalize.py]---
Location: zulip-main/zerver/migrations/0241_usermessage_bigint_id_migration_finalize.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-23 22:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0240_usermessage_migrate_bigint_id_into_id"),
    ]

    operations = [
        migrations.RunSQL("ALTER TABLE zerver_usermessage DROP COLUMN id_old;"),
        migrations.RemoveField(
            model_name="archivedusermessage",
            name="bigint_id",
        ),
        migrations.AlterField(
            model_name="archivedusermessage",
            name="id",
            field=models.BigAutoField(primary_key=True, serialize=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0242_fix_bot_email_property.py]---
Location: zulip-main/zerver/migrations/0242_fix_bot_email_property.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-09-23 20:39

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_bot_email_property(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    for user_profile in UserProfile.objects.filter(is_bot=True):
        if user_profile.email != user_profile.delivery_email:
            user_profile.email = user_profile.delivery_email
            user_profile.save(update_fields=["email"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0241_usermessage_bigint_id_migration_finalize"),
    ]

    operations = [
        migrations.RunPython(
            fix_bot_email_property, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0243_message_add_date_sent_column.py]---
Location: zulip-main/zerver/migrations/0243_message_add_date_sent_column.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-28 00:47

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0242_fix_bot_email_property"),
    ]

    operations = [
        migrations.AddField(
            model_name="archivedmessage",
            name="date_sent",
            field=models.DateTimeField(null=True, verbose_name="date sent"),
        ),
        migrations.AddField(
            model_name="message",
            name="date_sent",
            field=models.DateTimeField(null=True, verbose_name="date sent"),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0244_message_copy_pub_date_to_date_sent.py]---
Location: zulip-main/zerver/migrations/0244_message_copy_pub_date_to_date_sent.py
Signals: Django

```python
import time

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import connection, migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Min
from psycopg2.sql import SQL

BATCH_SIZE = 1000


def sql_copy_pub_date_to_date_sent(id_range_lower_bound: int, id_range_upper_bound: int) -> None:
    query = SQL(
        """
            UPDATE zerver_message
            SET date_sent = pub_date
            WHERE id BETWEEN %(lower_bound)s AND %(upper_bound)s
    """
    )
    with connection.cursor() as cursor:
        cursor.execute(
            query,
            {
                "lower_bound": id_range_lower_bound,
                "upper_bound": id_range_upper_bound,
            },
        )


def copy_pub_date_to_date_sent(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Message = apps.get_model("zerver", "Message")
    if not Message.objects.exists():
        # Nothing to do
        return

    first_uncopied_id = Message.objects.filter(date_sent__isnull=True).aggregate(Min("id"))[
        "id__min"
    ]
    # Note: the below id can fall in a segment
    # where date_sent = pub_date already, but it's not a big problem
    # this will just do some redundant UPDATEs.
    last_id = Message.objects.latest("id").id

    id_range_lower_bound = first_uncopied_id
    id_range_upper_bound = first_uncopied_id + BATCH_SIZE
    while id_range_upper_bound <= last_id:
        sql_copy_pub_date_to_date_sent(id_range_lower_bound, id_range_upper_bound)
        id_range_lower_bound = id_range_upper_bound + 1
        id_range_upper_bound = id_range_lower_bound + BATCH_SIZE
        time.sleep(0.1)

    if last_id > id_range_lower_bound:
        # Copy for the last batch.
        sql_copy_pub_date_to_date_sent(id_range_lower_bound, last_id)


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0243_message_add_date_sent_column"),
    ]

    operations = [
        migrations.RunSQL(
            """
        CREATE FUNCTION zerver_message_date_sent_to_pub_date_trigger_function()
        RETURNS trigger AS $$
        BEGIN
            NEW.date_sent = NEW.pub_date;
            RETURN NEW;
        END
        $$ LANGUAGE 'plpgsql';

        CREATE TRIGGER zerver_message_date_sent_to_pub_date_trigger
        BEFORE INSERT ON zerver_message
        FOR EACH ROW
        EXECUTE PROCEDURE zerver_message_date_sent_to_pub_date_trigger_function();
        """
        ),
        migrations.RunPython(copy_pub_date_to_date_sent, elidable=True),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                AddIndexConcurrently(
                    model_name="message",
                    index=models.Index("date_sent", name="zerver_message_date_sent_3b5b05d8"),
                ),
            ],
            state_operations=[
                migrations.AlterField(
                    model_name="message",
                    name="date_sent",
                    field=models.DateTimeField(db_index=True, null=True, verbose_name="date sent"),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0245_message_date_sent_finalize_part1.py]---
Location: zulip-main/zerver/migrations/0245_message_date_sent_finalize_part1.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-23 21:03

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0244_message_copy_pub_date_to_date_sent"),
    ]

    operations = [
        migrations.RunSQL(
            """
            DROP TRIGGER zerver_message_date_sent_to_pub_date_trigger ON zerver_message;
            DROP FUNCTION zerver_message_date_sent_to_pub_date_trigger_function();
            """
        ),
        migrations.AlterField(
            model_name="message",
            name="date_sent",
            field=models.DateTimeField(db_index=True, verbose_name="date sent"),
        ),
        migrations.AlterField(
            model_name="message",
            name="pub_date",
            field=models.DateTimeField(db_index=True, null=True, verbose_name="date published"),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0246_message_date_sent_finalize_part2.py]---
Location: zulip-main/zerver/migrations/0246_message_date_sent_finalize_part2.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-08-28 19:48

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0245_message_date_sent_finalize_part1"),
    ]

    operations = [
        # Until now, date_sent was in ArchivedMessage only for the sake of keeping the model
        # compatible with Message.
        #  We can now remove it, and rename pub_date to date_sent to have this column
        # set correctly for all existing rows.
        migrations.RemoveField(
            model_name="archivedmessage",
            name="date_sent",
        ),
        migrations.RenameField(
            model_name="archivedmessage",
            old_name="pub_date",
            new_name="date_sent",
        ),
        # All the below AlterField does is change verbose_name, which doesn't even generate any SQL,
        # it's just a purely-Django attribute.
        migrations.AlterField(
            model_name="archivedmessage",
            name="date_sent",
            field=models.DateTimeField(db_index=True, verbose_name="date sent"),
        ),
        # Django doesn't rename the index when renaming a column, which can be confusing
        # for someone inspecting the table in the future who's not aware of the old name.
        # We should rename appropriately here.
        migrations.RunSQL(
            """
        ALTER INDEX IF EXISTS zerver_archivedmessage_pub_date_509062c8 RENAME TO zerver_archivedmessage_date_sent_509062c8
        """
        ),
        migrations.RemoveField(
            model_name="message",
            name="pub_date",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0247_realmauditlog_event_type_to_int.py]---
Location: zulip-main/zerver/migrations/0247_realmauditlog_event_type_to_int.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-10-02 16:48

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

INT_VALUE = {
    "user_created": "101",
    "user_activated": "102",
    "user_deactivated": "103",
    "user_reactivated": "104",
    "user_soft_activated": "120",
    "user_soft_deactivated": "121",
    "user_password_changed": "122",
    "user_avatar_source_changed": "123",
    "user_full_name_changed": "124",
    "user_email_changed": "125",
    "user_tos_version_changed": "126",
    "user_api_key_changed": "127",
    "user_bot_owner_changed": "128",
    "realm_deactivated": "201",
    "realm_reactivated": "202",
    "realm_scrubbed": "203",
    "realm_plan_type_changed": "204",
    "realm_logo_changed": "205",
    "realm_exported": "206",
    "subscription_created": "301",
    "subscription_activated": "302",
    "subscription_deactivated": "303",
    "stripe_customer_created": "401",
    "stripe_card_changed": "402",
    "stripe_plan_changed": "403",
    "stripe_plan_quantity_reset": "404",
    "customer_created": "501",
    "customer_plan_created": "502",
}

STR_VALUE = {
    101: "user_created",
    102: "user_activated",
    103: "user_deactivated",
    104: "user_reactivated",
    120: "user_soft_activated",
    121: "user_soft_deactivated",
    122: "user_password_changed",
    123: "user_avatar_source_changed",
    124: "user_full_name_changed",
    125: "user_email_changed",
    126: "user_tos_version_changed",
    127: "user_api_key_changed",
    128: "user_bot_owner_changed",
    201: "realm_deactivated",
    202: "realm_reactivated",
    203: "realm_scrubbed",
    204: "realm_plan_type_changed",
    205: "realm_logo_changed",
    206: "realm_exported",
    301: "subscription_created",
    302: "subscription_activated",
    303: "subscription_deactivated",
    401: "stripe_customer_created",
    402: "stripe_card_changed",
    403: "stripe_plan_changed",
    404: "stripe_plan_quantity_reset",
    501: "customer_created",
    502: "customer_plan_created",
}


def update_existing_event_type_values(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    for log_entry in RealmAuditLog.objects.all().iterator():
        log_entry.event_type_int = INT_VALUE[log_entry.event_type]
        log_entry.save(update_fields=["event_type_int"])


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    for log_entry in RealmAuditLog.objects.all().iterator():
        log_entry.event_type = STR_VALUE[log_entry.event_type_int]
        log_entry.save(update_fields=["event_type"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0246_message_date_sent_finalize_part2"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmauditlog",
            name="event_type_int",
            field=models.PositiveSmallIntegerField(null=True),
        ),
        migrations.AlterField(
            model_name="realmauditlog",
            name="event_type",
            field=models.CharField(max_length=40, null=True),
        ),
        migrations.RunPython(
            update_existing_event_type_values, reverse_code=reverse_code, elidable=True
        ),
        migrations.RemoveField(
            model_name="realmauditlog",
            name="event_type",
        ),
        migrations.RenameField(
            model_name="realmauditlog",
            old_name="event_type_int",
            new_name="event_type",
        ),
        migrations.AlterField(
            model_name="realmauditlog",
            name="event_type",
            field=models.PositiveSmallIntegerField(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0248_userprofile_role_start.py]---
Location: zulip-main/zerver/migrations/0248_userprofile_role_start.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-10-03 22:27
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def update_role(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    # The values at the time of this migration
    UserProfile.ROLE_REALM_ADMINISTRATOR = 200
    UserProfile.ROLE_MEMBER = 400
    UserProfile.ROLE_GUEST = 600
    for user in UserProfile.objects.all().iterator():
        if user.is_realm_admin:
            user.role = UserProfile.ROLE_REALM_ADMINISTRATOR
        elif user.is_guest:
            user.role = UserProfile.ROLE_GUEST
        else:
            user.role = UserProfile.ROLE_MEMBER
        user.save(update_fields=["role"])


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserProfile.ROLE_REALM_ADMINISTRATOR = 200
    UserProfile.ROLE_GUEST = 600
    for user in UserProfile.objects.all().iterator():
        if user.role == UserProfile.ROLE_REALM_ADMINISTRATOR:
            user.is_realm_admin = True
            user.save(update_fields=["is_realm_admin"])
        elif user.role == UserProfile.ROLE_GUEST:
            user.is_guest = True
            user.save(update_fields=["is_guest"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0247_realmauditlog_event_type_to_int"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="role",
            field=models.PositiveSmallIntegerField(null=True),
        ),
        migrations.RunPython(update_role, reverse_code=reverse_code, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0249_userprofile_role_finish.py]---
Location: zulip-main/zerver/migrations/0249_userprofile_role_finish.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-10-03 23:40

from django.db import migrations, models

# The values at the time of this migration
ROLE_MEMBER = 400


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0248_userprofile_role_start"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="userprofile",
            name="is_guest",
        ),
        migrations.RemoveField(
            model_name="userprofile",
            name="is_realm_admin",
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="role",
            field=models.PositiveSmallIntegerField(db_index=True, default=ROLE_MEMBER),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0250_saml_auth.py]---
Location: zulip-main/zerver/migrations/0250_saml_auth.py
Signals: Django

```python
# Generated by Django 1.11.23 on 2019-09-19 00:50

import bitfield.models
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0249_userprofile_role_finish"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="authentication_methods",
            field=bitfield.models.BitField(
                ["Google", "Email", "GitHub", "LDAP", "Dev", "RemoteUser", "AzureAD", "SAML"],
                default=2147483647,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0251_prereg_user_add_full_name.py]---
Location: zulip-main/zerver/migrations/0251_prereg_user_add_full_name.py
Signals: Django

```python
# Generated by Django 1.11.25 on 2019-10-31 20:31

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0250_saml_auth"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationuser",
            name="full_name",
            field=models.CharField(max_length=100, null=True),
        ),
        migrations.AddField(
            model_name="preregistrationuser",
            name="full_name_validated",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0252_realm_user_group_edit_policy.py]---
Location: zulip-main/zerver/migrations/0252_realm_user_group_edit_policy.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-10-16 22:48
from django.db import migrations, models

USER_GROUP_EDIT_POLICY_MEMBERS = 1


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0251_prereg_user_add_full_name"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="user_group_edit_policy",
            field=models.PositiveSmallIntegerField(default=USER_GROUP_EDIT_POLICY_MEMBERS),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0253_userprofile_wildcard_mentions_notify.py]---
Location: zulip-main/zerver/migrations/0253_userprofile_wildcard_mentions_notify.py
Signals: Django

```python
# Generated by Django 1.11.25 on 2019-11-06 23:43

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0252_realm_user_group_edit_policy"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="wildcard_mentions_notify",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="subscription",
            name="wildcard_mentions_notify",
            field=models.BooleanField(null=True, default=None),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0254_merge_0209_0253.py]---
Location: zulip-main/zerver/migrations/0254_merge_0209_0253.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2019-11-21 01:47

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0253_userprofile_wildcard_mentions_notify"),
        ("zerver", "0209_user_profile_no_empty_password"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0255_userprofile_stream_add_recipient_column.py]---
Location: zulip-main/zerver/migrations/0255_userprofile_stream_add_recipient_column.py
Signals: Django

```python
# Generated by Django 1.11.26 on 2019-11-27 21:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0254_merge_0209_0253"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="recipient",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to="zerver.Recipient"
            ),
        ),
        migrations.AddField(
            model_name="stream",
            name="recipient",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to="zerver.Recipient"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0256_userprofile_stream_set_recipient_column_values.py]---
Location: zulip-main/zerver/migrations/0256_userprofile_stream_set_recipient_column_values.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0255_userprofile_stream_add_recipient_column"),
    ]

    operations = [
        migrations.RunSQL(
            """
            UPDATE zerver_userprofile
            SET recipient_id = zerver_recipient.id
            FROM zerver_recipient
            WHERE zerver_recipient.type_id = zerver_userprofile.id AND zerver_recipient.type = 1;
            """,
            reverse_sql="UPDATE zerver_userprofile SET recipient_id = NULL",
            elidable=True,
        ),
        migrations.RunSQL(
            """
            UPDATE zerver_stream
            SET recipient_id = zerver_recipient.id
            FROM zerver_recipient
            WHERE zerver_recipient.type_id = zerver_stream.id AND zerver_recipient.type = 2;
            """,
            reverse_sql="UPDATE zerver_stream SET recipient_id = NULL",
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

````
