---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 950
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 950 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0493_rename_userhotspot_to_onboardingstep.py]---
Location: zulip-main/zerver/migrations/0493_rename_userhotspot_to_onboardingstep.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-12-01 06:55

from django.db import migrations

from zerver.lib.migrate import rename_indexes_constraints


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0492_realm_push_notifications_enabled_and_more"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RenameField(
                    model_name="UserHotspot", old_name="hotspot", new_name="onboarding_step"
                ),
                migrations.RunPython(
                    rename_indexes_constraints(
                        "zerver_userhotspot",
                        "zerver_onboardingstep",
                    ),
                    reverse_code=rename_indexes_constraints(
                        "zerver_onboardingstep",
                        "zerver_userhotspot",
                    ),
                ),
            ],
            state_operations=[
                migrations.RenameField(
                    model_name="UserHotspot", old_name="hotspot", new_name="onboarding_step"
                ),
                migrations.RenameModel(old_name="UserHotspot", new_name="OnboardingStep"),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0494_realmuserdefault_automatically_follow_topics_where_mentioned_and_more.py]---
Location: zulip-main/zerver/migrations/0494_realmuserdefault_automatically_follow_topics_where_mentioned_and_more.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-12-10 13:18

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0493_rename_userhotspot_to_onboardingstep"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="automatically_follow_topics_where_mentioned",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="automatically_follow_topics_where_mentioned",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0495_scheduledmessage_read_by_sender.py]---
Location: zulip-main/zerver/migrations/0495_scheduledmessage_read_by_sender.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-14 00:09

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0494_realmuserdefault_automatically_follow_topics_where_mentioned_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="scheduledmessage",
            name="read_by_sender",
            field=models.BooleanField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0496_alter_scheduledmessage_read_by_sender.py]---
Location: zulip-main/zerver/migrations/0496_alter_scheduledmessage_read_by_sender.py
Signals: Django

```python
# Generated by Django 4.2.8 on 2023-12-14 06:18

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F, Q
from django.db.models.functions import Lower


def populate_read_by_sender(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    ScheduledMessage = apps.get_model("zerver", "ScheduledMessage")
    ScheduledMessage.objects.annotate(
        sending_client_name_lower=Lower("sending_client__name")
    ).filter(
        Q(
            sending_client_name_lower__in=(
                "zulipandroid",
                "zulipios",
                "zulipdesktop",
                "zulipmobile",
                "zulipelectron",
                "zulipterminal",
                "snipe",
                "website",
                "ios",
                "android",
            )
        )
        | Q(sending_client_name_lower__contains="desktop app"),
        ~Q(recipient=F("sender__recipient")),
        read_by_sender=None,
    ).update(read_by_sender=True)
    ScheduledMessage.objects.filter(read_by_sender=None).update(read_by_sender=False)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0495_scheduledmessage_read_by_sender"),
    ]

    operations = [
        migrations.RunPython(
            populate_read_by_sender,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
        migrations.AlterField(
            model_name="scheduledmessage",
            name="read_by_sender",
            field=models.BooleanField(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0497_resort_edit_history.py]---
Location: zulip-main/zerver/migrations/0497_resort_edit_history.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0496_alter_scheduledmessage_read_by_sender"),
    ]

    operations = [
        migrations.RunSQL(
            # Update with properly-sorted history for messages changed
            # after 5c96f942060e was merged.
            """
            WITH sorted_history AS (
                SELECT zerver_message.id AS rowid,
                       JSONB_AGG(value ORDER BY (value->>'timestamp')::NUMERIC desc) AS updated_history
                FROM zerver_message
                    CROSS JOIN JSONB_ARRAY_ELEMENTS(zerver_message.edit_history::jsonb)
                WHERE zerver_message.edit_history IS NOT NULL
                  AND zerver_message.last_edit_time > '2024-02-14'
                  AND JSONB_ARRAY_LENGTH(zerver_message.edit_history::jsonb) > 1
                GROUP BY zerver_message.id
                ORDER BY zerver_message.id
            )
            UPDATE zerver_message
                SET edit_history = sorted_history.updated_history::text
            FROM sorted_history
            WHERE zerver_message.id = sorted_history.rowid
              AND zerver_message.edit_history::jsonb != sorted_history.updated_history
            """,
            reverse_sql="",
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0498_rename_notifications_stream_realm_new_stream_announcements_stream.py]---
Location: zulip-main/zerver/migrations/0498_rename_notifications_stream_realm_new_stream_announcements_stream.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-07 11:09

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0497_resort_edit_history"),
    ]

    operations = [
        migrations.RenameField(
            model_name="realm",
            old_name="notifications_stream",
            new_name="new_stream_announcements_stream",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0499_rename_signup_notifications_stream_realm_signup_announcements_stream.py]---
Location: zulip-main/zerver/migrations/0499_rename_signup_notifications_stream_realm_signup_announcements_stream.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-07 16:42

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0498_rename_notifications_stream_realm_new_stream_announcements_stream"),
    ]

    operations = [
        migrations.RenameField(
            model_name="realm",
            old_name="signup_notifications_stream",
            new_name="signup_announcements_stream",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0500_realm_zulip_update_announcements_stream.py]---
Location: zulip-main/zerver/migrations/0500_realm_zulip_update_announcements_stream.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-08 07:34

import django.db.models.deletion
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F


def set_initial_value_for_zulip_update_announcements_stream(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.exclude(new_stream_announcements_stream__isnull=True).update(
        zulip_update_announcements_stream=F("new_stream_announcements_stream")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0499_rename_signup_notifications_stream_realm_signup_announcements_stream"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="zulip_update_announcements_stream",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="+",
                to="zerver.stream",
            ),
        ),
        migrations.RunPython(
            set_initial_value_for_zulip_update_announcements_stream,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0501_delete_dangling_usermessages.py]---
Location: zulip-main/zerver/migrations/0501_delete_dangling_usermessages.py
Signals: Django

```python
import sys
from contextlib import ExitStack, redirect_stdout
from typing import TextIO

from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

BUILD_BAD_MOVES_TABLE = """
    CREATE TEMPORARY TABLE bad_moves_cve_2024_27286 AS (
      WITH messages_with_dangling_usermessages AS (
        SELECT zerver_message.id AS message_id,
               ARRAY_AGG(DISTINCT zerver_usermessage.id) AS extra_usermessage_ids,
               edit_history::jsonb

          FROM zerver_message

          JOIN zerver_stream
            ON zerver_stream.recipient_id = zerver_message.recipient_id

          JOIN zerver_usermessage
            ON zerver_usermessage.message_id = zerver_message.id

          LEFT JOIN zerver_subscription
            ON zerver_subscription.recipient_id = zerver_stream.recipient_id
           AND zerver_subscription.user_profile_id = zerver_usermessage.user_profile_id

         WHERE zerver_stream.invite_only
           AND zerver_subscription.id IS NULL
           AND zerver_message.edit_history IS NOT NULL

         GROUP BY zerver_message.id
      )
      SELECT message_id,
             extra_usermessage_ids,
             (history_entry->>'timestamp') AS timestamp_moved,
             (history_entry->>'prev_stream')::numeric AS moved_from_stream_id,
             (history_entry->>'stream')::numeric AS moved_to_stream_id
        FROM messages_with_dangling_usermessages
       CROSS JOIN JSONB_ARRAY_ELEMENTS(edit_history) AS history_entry
       WHERE history_entry->>'prev_stream' IS NOT NULL
       ORDER BY 1 ASC
    )
"""


# The SQL query above builds a `bad_moves_cve_2024_27286` temporary table, which
# finds all moved messages where there are UserMessage rows but no
# Subscription rows.  However, the difficulty is that this has a
# false-negative: between 2bc3924672fb and e566e985e4d2,
# multi-message moves only recorded their move on one of the
# messages.  There may thus be messages with dangling UserMessage
# rows which are in the same topic as ones we found already, but
# do not record as having moved, so were not found by that filter.
#
# We determine when zerver/0310_jsoonfield, the migration next merged
# after e566e985e4d2 was merged, was run, and examine all messages
# moved earlier than that migration.  We do not limit the early side
# of moves, since it is already naturally bounded by when message
# moves were introduced, and it is plausible that servers were running
# message-move the code before it was merged.
#
# For each potential single-message move in this range, we examine all
# other messages in the topic which were sent before the move, and
# check them for dangling UserMessage rows from users who are not
# subscribed.  We then compare those newly-found messages against the
# known bad messages to guess which move was responsible for them.
BROADEN_MOVES = """
    INSERT INTO bad_moves_cve_2024_27286 (
      WITH other_messages AS (
        SELECT messages_in_topic.id AS message_id,
               messages_in_topic.recipient_id,
               UPPER(messages_in_topic.subject) AS upper_topic,
               messages_in_topic.date_sent
          FROM bad_moves_cve_2024_27286

          JOIN zerver_message bad_message
            ON bad_moves_cve_2024_27286.message_id = bad_message.id

          JOIN zerver_message messages_in_topic
            ON bad_message.recipient_id = messages_in_topic.recipient_id
           AND UPPER(bad_message.subject) = UPPER(messages_in_topic.subject)

         WHERE TO_TIMESTAMP(timestamp_moved::numeric) < (
                   SELECT applied FROM django_migrations WHERE app = 'zerver' AND name = '0310_jsonfield'
               )
           AND messages_in_topic.date_sent < TO_TIMESTAMP(timestamp_moved::numeric)
           AND messages_in_topic.id NOT IN (SELECT already.message_id FROM bad_moves_cve_2024_27286 already)

         GROUP BY 1
      ),
      other_bad_messages AS (
        SELECT other_messages.message_id,
               other_messages.recipient_id,
               other_messages.upper_topic,
               other_messages.date_sent,
               ARRAY_AGG(DISTINCT zerver_usermessage.id) as extra_usermessage_ids

          FROM other_messages

          JOIN zerver_usermessage
            ON zerver_usermessage.message_id = other_messages.message_id

          LEFT JOIN zerver_subscription
            ON zerver_subscription.recipient_id = other_messages.recipient_id
           AND zerver_subscription.user_profile_id = zerver_usermessage.user_profile_id

         WHERE zerver_subscription.id IS NULL

         GROUP BY 1, 2, 3, 4
      )
      SELECT other_bad_messages.message_id,
             other_bad_messages.extra_usermessage_ids,
             move_trigger.timestamp_moved,
             move_trigger.moved_from_stream_id,
             move_trigger.moved_to_stream_id
        FROM other_bad_messages
        LEFT JOIN LATERAL (
          SELECT bad_moves_cve_2024_27286.*
            FROM bad_moves_cve_2024_27286
            JOIN zerver_message
              ON zerver_message.id = bad_moves_cve_2024_27286.message_id
            JOIN zerver_stream
              ON zerver_stream.recipient_id = zerver_message.recipient_id
             AND bad_moves_cve_2024_27286.moved_to_stream_id = zerver_stream.id
           WHERE other_bad_messages.recipient_id = zerver_message.recipient_id
             AND other_bad_messages.upper_topic = UPPER(zerver_message.subject)
             AND TO_TIMESTAMP(bad_moves_cve_2024_27286.timestamp_moved::numeric) > other_bad_messages.date_sent
           ORDER BY bad_moves_cve_2024_27286.message_id ASC, bad_moves_cve_2024_27286.timestamp_moved ASC
           LIMIT 1
        ) move_trigger ON true
    )
"""


def log_extra_usermessage_rows(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Message = apps.get_model("zerver", "message")
    UserMessage = apps.get_model("zerver", "usermessage")
    Stream = apps.get_model("zerver", "stream")

    messages = Message.objects.raw(
        "SELECT * FROM zerver_message JOIN bad_moves_cve_2024_27286 ON message_id = zerver_message.id"
    )
    if len(messages) == 0:  # RawQuerySet does not have .exists() or .count()
        return

    with ExitStack() as stack:
        if settings.PRODUCTION:
            log_file: TextIO = stack.enter_context(
                open("/var/log/zulip/migrations_0501_delete_dangling_usermessages.log", "w")
            )
        else:
            log_file = sys.stderr
            print(file=log_file)
        stack.enter_context(redirect_stdout(log_file))

        for message in messages:
            realm = message.realm
            # Reimplement realm.url
            if realm.string_id == "":
                hostname = settings.EXTERNAL_HOST
            else:
                hostname = settings.REALM_HOSTS.get(
                    realm.string_id, f"{realm.string_id}.{settings.EXTERNAL_HOST}"
                )

            stream = Stream.objects.only("id").get(recipient_id=message.recipient_id)
            print(
                f"{settings.EXTERNAL_URI_SCHEME}{hostname}/#narrow/stream/{stream.id}/near/{message.id}",
            )
            print(
                f"    Moved at {message.timestamp_moved} from stream id {message.moved_from_stream_id} to {message.moved_to_stream_id}"
            )

            # Find out how many of those are users, and not bots
            ums = (
                UserMessage.objects.filter(
                    id__in=message.extra_usermessage_ids, user_profile__is_bot=False
                )
                .select_related("user_profile")
                .only("flags", "user_profile__delivery_email")
            )
            print(
                f"    Was still readable by {len(ums)} users, {len(message.extra_usermessage_ids) - len(ums)} bots",
            )
            if len(message.extra_usermessage_ids) > 25:
                continue
            for um in ums:
                read = "(read)" if um.flags & 1 else "(unread)"
                print(f"        {um.user_profile.delivery_email} {read}")
            print()


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0496_alter_scheduledmessage_read_by_sender"),
    ]

    operations = [
        migrations.RunSQL(BUILD_BAD_MOVES_TABLE, elidable=True),
        migrations.RunSQL(BROADEN_MOVES, elidable=True),
        migrations.RunPython(
            log_extra_usermessage_rows, reverse_code=migrations.RunPython.noop, elidable=True
        ),
        migrations.RunSQL(
            """
            DELETE FROM zerver_usermessage
             WHERE id IN (SELECT UNNEST(extra_usermessage_ids) FROM bad_moves_cve_2024_27286)
            """,
            elidable=True,
        ),
        migrations.RunSQL("DROP TABLE bad_moves_cve_2024_27286", elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0501_mark_introduce_zulip_view_modals_as_read.py]---
Location: zulip-main/zerver/migrations/0501_mark_introduce_zulip_view_modals_as_read.py
Signals: Django

```python
# Generated by Django 4.2.10 on 2024-03-11 04:43

from django.db import connection, migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Q
from django.utils.timezone import now as timezone_now
from psycopg2.sql import SQL


def mark_introduce_zulip_view_modals_as_read(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    with connection.cursor() as cursor:
        cursor.execute(
            SQL(
                "SELECT MAX(id) FROM zerver_userprofile WHERE is_bot = False AND is_mirror_dummy = False;"
            )
        )
        (max_id,) = cursor.fetchone()

    if max_id is None:
        return

    BATCH_SIZE = 10000
    lower_id_bound = 0
    timestamp_value = timezone_now()
    while lower_id_bound < max_id:
        upper_id_bound = min(lower_id_bound + BATCH_SIZE, max_id)
        with connection.cursor() as cursor:
            query = SQL("""
                INSERT INTO zerver_onboardingstep (user_id, onboarding_step, timestamp)
                SELECT id, step, %(timestamp_value)s
                FROM zerver_userprofile
                CROSS JOIN UNNEST(%(step_names)s) step
                WHERE is_bot = False
                AND is_mirror_dummy = False
                AND id > %(lower_id_bound)s AND id <= %(upper_id_bound)s;
                """)
            cursor.execute(
                query,
                {
                    "timestamp_value": timestamp_value,
                    "step_names": ["intro_inbox_view_modal", "intro_recent_view_modal"],
                    "lower_id_bound": lower_id_bound,
                    "upper_id_bound": upper_id_bound,
                },
            )

        print(f"Processed {upper_id_bound} / {max_id}")
        lower_id_bound += BATCH_SIZE


def mark_introduce_zulip_view_modals_as_unread(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    OnboardingStep = apps.get_model("zerver", "OnboardingStep")

    OnboardingStep.objects.filter(
        Q(onboarding_step="intro_inbox_view_modal") | Q(onboarding_step="intro_recent_view_modal")
    ).delete()


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0500_realm_zulip_update_announcements_stream"),
    ]

    operations = [
        migrations.RunPython(
            mark_introduce_zulip_view_modals_as_read,
            reverse_code=mark_introduce_zulip_view_modals_as_unread,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0502_merge_20240319_2236.py]---
Location: zulip-main/zerver/migrations/0502_merge_20240319_2236.py
Signals: Django

```python
# Generated by Django 4.2.10 on 2024-03-19 22:36

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0501_delete_dangling_usermessages"),
        ("zerver", "0501_mark_introduce_zulip_view_modals_as_read"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0503_realm_zulip_update_announcements_level.py]---
Location: zulip-main/zerver/migrations/0503_realm_zulip_update_announcements_level.py
Signals: Django

```python
# Generated by Django 4.2.9 on 2024-02-13 06:18

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0502_merge_20240319_2236"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="zulip_update_announcements_level",
            field=models.PositiveIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0504_customprofilefield_required.py]---
Location: zulip-main/zerver/migrations/0504_customprofilefield_required.py
Signals: Django

```python
# Generated by Django 4.2.10 on 2024-03-01 09:04

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0503_realm_zulip_update_announcements_level"),
    ]

    operations = [
        migrations.AddField(
            model_name="customprofilefield",
            name="required",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0505_realmuserdefault_web_font_size_px_and_more.py]---
Location: zulip-main/zerver/migrations/0505_realmuserdefault_web_font_size_px_and_more.py
Signals: Django

```python
# Generated by Django 4.2.11 on 2024-03-26 20:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0504_customprofilefield_required"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_font_size_px",
            field=models.PositiveSmallIntegerField(default=14),
        ),
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_line_height_percent",
            field=models.PositiveSmallIntegerField(default=122),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_font_size_px",
            field=models.PositiveSmallIntegerField(default=14),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_line_height_percent",
            field=models.PositiveSmallIntegerField(default=122),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0506_realm_require_unique_names.py]---
Location: zulip-main/zerver/migrations/0506_realm_require_unique_names.py
Signals: Django

```python
# Generated by Django 4.2.11 on 2024-03-27 20:08

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0505_realmuserdefault_web_font_size_px_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="require_unique_names",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0507_rework_realm_upload_quota_gb.py]---
Location: zulip-main/zerver/migrations/0507_rework_realm_upload_quota_gb.py
Signals: Django

```python
# Generated by Django 4.2.10 on 2024-03-10 04:02

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0506_realm_require_unique_names"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="realm",
            name="upload_quota_gb",
        ),
        migrations.AddField(
            model_name="realm",
            name="custom_upload_quota_gb",
            field=models.IntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0508_realmuserdefault_receives_typing_notifications_and_more.py]---
Location: zulip-main/zerver/migrations/0508_realmuserdefault_receives_typing_notifications_and_more.py
Signals: Django

```python
# Generated by Django 4.2.12 on 2024-04-16 14:06

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0507_rework_realm_upload_quota_gb"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="receives_typing_notifications",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="receives_typing_notifications",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0509_fix_emoji_metadata.py]---
Location: zulip-main/zerver/migrations/0509_fix_emoji_metadata.py
Signals: Django

```python
import re
from typing import Any

import boto3
from botocore.client import Config
from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Exists, OuterRef


def fix_emoji_metadata(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    if settings.LOCAL_UPLOADS_DIR is not None:
        return

    bucket = boto3.resource(
        "s3",
        aws_access_key_id=settings.S3_KEY,
        aws_secret_access_key=settings.S3_SECRET_KEY,
        region_name=settings.S3_REGION,
        endpoint_url=settings.S3_ENDPOINT_URL,
        config=Config(
            signature_version=None,
            s3={"addressing_style": settings.S3_ADDRESSING_STYLE},
        ),
    ).Bucket(settings.S3_AVATAR_BUCKET)

    Realm = apps.get_model("zerver", "Realm")
    RealmEmoji = apps.get_model("zerver", "RealmEmoji")
    UserProfile = apps.get_model("zerver", "UserProfile")

    for realm in Realm.objects.filter(
        Exists(RealmEmoji.objects.filter(realm_id=OuterRef("id")))
    ).only("id"):
        fallback_owner = (
            UserProfile.objects.filter(realm=realm.id, is_bot=False, role=100, is_active=True)
            .order_by("id")
            .first()
        )
        assert fallback_owner is not None

        emoji_by_filename: dict[str, Any] = {}
        for emoji in RealmEmoji.objects.filter(realm_id=realm.id).exclude(file_name=None):
            assert emoji.file_name is not None
            if emoji.author_id is None:
                emoji.author_id = fallback_owner.id
                emoji.save(update_fields=["author_id"])
            if emoji.file_name not in emoji_by_filename:
                # Slack imports may have multiple RealmEmoji rows for
                # the same file_name; we pick one arbitrarily
                emoji_by_filename[emoji.file_name] = emoji

        for obj_summary in bucket.objects.filter(Prefix=f"{realm.id}/emoji/images/"):
            match = re.match(r"^\d+/emoji/images/(.+)$", obj_summary.key)
            assert match
            emoji_filename = match.group(1)
            if emoji_filename not in emoji_by_filename:
                continue
            emoji = emoji_by_filename[emoji_filename]
            assert emoji.author_id is not None

            head = bucket.meta.client.head_object(Bucket=bucket.name, Key=obj_summary.key)
            metadata = head["Metadata"]
            changed = False
            if metadata.get("realm_id") is None:
                metadata["realm_id"] = str(realm.id)
                changed = True
            if metadata.get("user_profile_id") is None:
                metadata["user_profile_id"] = str(emoji.author_id)
                changed = True

            if not changed:
                continue

            assert not head.get("ContentDisposition")
            obj_summary.copy_from(
                ContentType=head["ContentType"],
                CopySource=f"{bucket.name}/{obj_summary.key}",
                Metadata=metadata,
                MetadataDirective="REPLACE",
            )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0508_realmuserdefault_receives_typing_notifications_and_more"),
    ]

    operations = [
        migrations.RunPython(
            fix_emoji_metadata, reverse_code=migrations.RunPython.noop, elidable=True
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0510_add_realmauditlog_realm_event_type_index.py]---
Location: zulip-main/zerver/migrations/0510_add_realmauditlog_realm_event_type_index.py
Signals: Django

```python
# Generated by Django 4.2.12 on 2024-04-17 10:33

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0509_fix_emoji_metadata"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="realmauditlog",
            index=models.Index(
                fields=["realm", "event_type", "event_time"],
                name="zerver_realmauditlog_realm__event_type__event_time",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0511_stream_creator.py]---
Location: zulip-main/zerver/migrations/0511_stream_creator.py
Signals: Django

```python
# Generated by Django 4.2.11 on 2024-04-05 06:09

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def backfill_creator_id_from_realm_audit_log(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RealmAuditLog = apps.get_model("zerver", "RealmAuditLog")
    RealmAuditLog.STREAM_CREATED = 601
    Stream = apps.get_model("zerver", "Stream")

    stream_updates = []
    for audit_log_entry in RealmAuditLog.objects.select_related("modified_stream").filter(
        event_type=RealmAuditLog.STREAM_CREATED,
        acting_user_id__isnull=False,
    ):
        assert audit_log_entry.modified_stream is not None
        stream = audit_log_entry.modified_stream
        stream.creator_id = audit_log_entry.acting_user_id
        stream_updates.append(stream)

    Stream.objects.bulk_update(stream_updates, ["creator_id"], batch_size=1000)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0510_add_realmauditlog_realm_event_type_index"),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="creator",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
            ),
        ),
        migrations.RunPython(
            backfill_creator_id_from_realm_audit_log,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0512_namedusergroup.py]---
Location: zulip-main/zerver/migrations/0512_namedusergroup.py
Signals: Django

```python
# Generated by Django 4.2.12 on 2024-04-19 03:44

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0511_stream_creator"),
    ]

    operations = [
        migrations.CreateModel(
            name="NamedUserGroup",
            fields=[
                (
                    "usergroup_ptr",
                    models.OneToOneField(
                        auto_created=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        parent_link=True,
                        primary_key=True,
                        related_name="named_user_group",
                        serialize=False,
                        to="zerver.usergroup",
                    ),
                ),
                ("named_group_name", models.CharField(db_column="name", max_length=100)),
                ("named_group_description", models.TextField(db_column="description", default="")),
                (
                    "named_group_is_system_group",
                    models.BooleanField(db_column="is_system_group", default=False),
                ),
                (
                    "named_group_can_mention_group",
                    models.ForeignKey(
                        db_column="can_mention_group_id",
                        on_delete=django.db.models.deletion.RESTRICT,
                        to="zerver.usergroup",
                    ),
                ),
                (
                    "realm_for_sharding",
                    models.ForeignKey(
                        db_column="realm_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="zerver.realm",
                    ),
                ),
            ],
            options={
                "unique_together": {("realm_for_sharding", "named_group_name")},
            },
            bases=("zerver.usergroup",),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0513_copy_groups_data_to_named_user_group.py]---
Location: zulip-main/zerver/migrations/0513_copy_groups_data_to_named_user_group.py
Signals: Django

```python
# Generated by Django 4.2.11 on 2024-04-03 13:36

from django.db import connection, migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from psycopg2.sql import SQL


def create_named_user_group_objects_for_groups(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    BATCH_SIZE = 1000
    with connection.cursor() as cursor:
        cursor.execute(SQL("SELECT MAX(id) FROM zerver_usergroup"))
        (max_id,) = cursor.fetchone()

    if max_id is None:
        return

    # Make sure we run past the end in case of new rows created while we run.
    max_id += BATCH_SIZE / 2
    lower_id_bound = 0
    while lower_id_bound < max_id:
        upper_id_bound = min(lower_id_bound + BATCH_SIZE, max_id)
        with connection.cursor() as cursor:
            query = SQL("""
                INSERT INTO zerver_namedusergroup (usergroup_ptr_id, realm_id, name, description, is_system_group, can_mention_group_id)
                SELECT id, realm_id, name, description, is_system_group, can_mention_group_id
                FROM zerver_usergroup
                WHERE id > %(lower_id_bound)s AND id <= %(upper_id_bound)s
                ON CONFLICT (usergroup_ptr_id) DO UPDATE SET
                    name = excluded.name,
                    description = excluded.description,
                    can_mention_group_id = excluded.can_mention_group_id
                """)
            cursor.execute(
                query,
                {
                    "lower_id_bound": lower_id_bound,
                    "upper_id_bound": upper_id_bound,
                },
            )

        print(f"Processed {upper_id_bound} / {max_id}")
        lower_id_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0512_namedusergroup"),
    ]

    operations = [
        migrations.RunPython(
            create_named_user_group_objects_for_groups,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0514_update_usergroup_foreign_keys_to_namedusergroup.py]---
Location: zulip-main/zerver/migrations/0514_update_usergroup_foreign_keys_to_namedusergroup.py
Signals: Django

```python
# Generated by Django 4.2.12 on 2024-04-17 10:39

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0513_copy_groups_data_to_named_user_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realmauditlog",
            name="modified_user_group",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zerver.namedusergroup"
            ),
        ),
        migrations.AlterField(
            model_name="scheduledmessagenotificationemail",
            name="mentioned_user_group",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zerver.namedusergroup"
            ),
        ),
        migrations.AlterField(
            model_name="groupgroupmembership",
            name="subgroup",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="+",
                to="zerver.namedusergroup",
            ),
        ),
        migrations.AlterField(
            model_name="usergroup",
            name="direct_subgroups",
            field=models.ManyToManyField(
                related_name="direct_supergroups",
                through="zerver.GroupGroupMembership",
                through_fields=("supergroup", "subgroup"),
                to="zerver.namedusergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
