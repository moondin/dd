---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 949
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 949 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0468_rename_followup_day_email_templates.py]---
Location: zulip-main/zerver/migrations/0468_rename_followup_day_email_templates.py
Signals: Django

```python
# Generated by Django 4.2.2 on 2023-07-11 10:45

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F, Func, JSONField, TextField, Value
from django.db.models.functions import Cast

# ScheduledMessage.type for onboarding emails from zerver/models/scheduled_jobs.py
WELCOME = 1


def update_for_followup_day_email_templates_rename(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    ScheduledEmail = apps.get_model("zerver", "ScheduledEmail")

    account_registered_emails = ScheduledEmail.objects.annotate(
        as_jsonb=Cast("data", JSONField())
    ).filter(type=WELCOME, as_jsonb__template_prefix="zerver/emails/followup_day1")
    account_registered_emails.update(
        data=Cast(
            Func(
                F("as_jsonb"),
                Value(["template_prefix"]),
                Value("zerver/emails/account_registered", JSONField()),
                function="jsonb_set",
            ),
            TextField(),
        )
    )

    onboarding_zulip_topics_emails = ScheduledEmail.objects.annotate(
        as_jsonb=Cast("data", JSONField())
    ).filter(type=WELCOME, as_jsonb__template_prefix="zerver/emails/followup_day2")
    onboarding_zulip_topics_emails.update(
        data=Cast(
            Func(
                F("as_jsonb"),
                Value(["template_prefix"]),
                Value("zerver/emails/onboarding_zulip_topics", JSONField()),
                function="jsonb_set",
            ),
            TextField(),
        )
    )


def revert_followup_day_email_templates_rename(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    ScheduledEmail = apps.get_model("zerver", "ScheduledEmail")

    rename_extradata_realmauditlog_extra_data_json = ScheduledEmail.objects.annotate(
        as_jsonb=Cast("data", JSONField())
    ).filter(type=WELCOME, as_jsonb__template_prefix="zerver/emails/account_registered")
    rename_extradata_realmauditlog_extra_data_json.update(
        data=Cast(
            Func(
                F("as_jsonb"),
                Value(["template_prefix"]),
                Value("zerver/emails/followup_day1", JSONField()),
                function="jsonb_set",
            ),
            TextField(),
        )
    )

    rename_extradata_realmauditlog_extra_data_json = ScheduledEmail.objects.annotate(
        as_jsonb=Cast("data", JSONField())
    ).filter(type=WELCOME, as_jsonb__template_prefix="zerver/emails/onboarding_zulip_topics")
    rename_extradata_realmauditlog_extra_data_json.update(
        data=Cast(
            Func(
                F("as_jsonb"),
                Value(["template_prefix"]),
                Value("zerver/emails/followup_day2", JSONField()),
                function="jsonb_set",
            ),
            TextField(),
        )
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0467_rename_extradata_realmauditlog_extra_data_json"),
    ]

    operations = [
        migrations.RunPython(
            update_for_followup_day_email_templates_rename,
            reverse_code=revert_followup_day_email_templates_rename,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0469_realm_create_multiuse_invite_group.py]---
Location: zulip-main/zerver/migrations/0469_realm_create_multiuse_invite_group.py
Signals: Django

```python
# Generated by Django 4.2.1 on 2023-05-31 07:28

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0468_rename_followup_day_email_templates"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="create_multiuse_invite_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0470_set_default_value_for_create_multiuse_invite_group.py]---
Location: zulip-main/zerver/migrations/0470_set_default_value_for_create_multiuse_invite_group.py
Signals: Django

```python
# Generated by Django 4.2.1 on 2023-06-03 10:53

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def set_default_value_for_create_multiuse_invite_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    UserGroup = apps.get_model("zerver", "UserGroup")

    UserGroup.ADMINISTRATORS_GROUP_NAME = "role:administrators"

    for realm in Realm.objects.all().iterator():
        if realm.create_multiuse_invite_group is not None:
            continue

        # Prior to the new create_multiuse_invite_group field being
        # created, multi-use invitation links could only be created
        # and managed by administrators, regardless of
        # invite_to_realm_policy. We replicate that policy for the
        # initial value of the new setting.
        admins_group = UserGroup.objects.get(
            name=UserGroup.ADMINISTRATORS_GROUP_NAME, realm=realm, is_system_group=True
        )
        realm.create_multiuse_invite_group = admins_group

        realm.save(update_fields=["create_multiuse_invite_group"])


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0469_realm_create_multiuse_invite_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_create_multiuse_invite_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0471_alter_realm_create_multiuse_invite_group.py]---
Location: zulip-main/zerver/migrations/0471_alter_realm_create_multiuse_invite_group.py
Signals: Django

```python
# Generated by Django 4.2.1 on 2023-06-06 08:26

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0470_set_default_value_for_create_multiuse_invite_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="create_multiuse_invite_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0472_add_message_realm_id_indexes.py]---
Location: zulip-main/zerver/migrations/0472_add_message_realm_id_indexes.py
Signals: Django

```python
import django.db.models.functions.text
from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0471_alter_realm_create_multiuse_invite_group"),
    ]

    # The non-realm_id-prefixed versions will be removed in the next migration.
    operations = [
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                models.F("recipient_id"),
                models.F("id"),
                name="zerver_message_realm_recipient_id",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                models.F("recipient_id"),
                models.F("date_sent"),
                name="zerver_message_realm_recipient_date_sent",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                models.F("sender_id"),
                models.F("recipient_id"),
                name="zerver_message_realm_sender_recipient",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"), models.F("date_sent"), name="zerver_message_realm_date_sent"
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                django.db.models.functions.text.Upper("subject"),
                models.OrderBy(models.F("id"), descending=True, nulls_last=True),
                name="zerver_message_realm_upper_subject",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                models.F("recipient_id"),
                django.db.models.functions.text.Upper("subject"),
                models.OrderBy(models.F("id"), descending=True, nulls_last=True),
                name="zerver_message_realm_recipient_upper_subject",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                models.F("recipient_id"),
                models.F("subject"),
                models.OrderBy(models.F("id"), descending=True, nulls_last=True),
                name="zerver_message_realm_recipient_subject",
            ),
        ),
        AddIndexConcurrently(
            model_name="message",
            index=models.Index(
                models.F("realm_id"),
                models.OrderBy(models.F("id"), descending=True, nulls_last=True),
                name="zerver_message_realm_id",
            ),
        ),
        AddIndexConcurrently(
            model_name="scheduledmessage",
            index=models.Index(
                condition=models.Q(("delivered", False)),
                fields=["realm_id", "sender", "delivery_type", "scheduled_timestamp"],
                name="zerver_realm_unsent_scheduled_messages_by_user",
            ),
        ),
        migrations.RunSQL(
            sql="CREATE STATISTICS IF NOT EXISTS zerver_message_realm_recipient ON realm_id, recipient_id FROM zerver_message",
            reverse_sql="DROP STATISTICS IF EXISTS zerver_message_realm_recipient",
        ),
        migrations.RunSQL(
            sql="CREATE STATISTICS IF NOT EXISTS zerver_message_realm_sender ON realm_id, sender_id FROM zerver_message",
            reverse_sql="DROP STATISTICS IF EXISTS zerver_message_realm_sender",
        ),
        migrations.RunSQL("ANALYZE zerver_message"),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0473_remove_message_non_realm_id_indexes.py]---
Location: zulip-main/zerver/migrations/0473_remove_message_non_realm_id_indexes.py
Signals: Django

```python
from django.contrib.postgres.operations import RemoveIndexConcurrently
from django.db import migrations


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0472_add_message_realm_id_indexes"),
    ]

    operations = [
        RemoveIndexConcurrently(
            model_name="message",
            name="upper_subject_idx",
        ),
        RemoveIndexConcurrently(
            model_name="message",
            name="zerver_message_recipient_upper_subject",
        ),
        RemoveIndexConcurrently(
            model_name="message",
            name="zerver_message_recipient_subject",
        ),
        RemoveIndexConcurrently(
            model_name="scheduledmessage",
            name="zerver_unsent_scheduled_messages_by_user",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0474_realmuserdefault_web_stream_unreads_count_display_policy_and_more.py]---
Location: zulip-main/zerver/migrations/0474_realmuserdefault_web_stream_unreads_count_display_policy_and_more.py
Signals: Django

```python
# Generated by Django 4.2.4 on 2023-08-27 04:01

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0473_remove_message_non_realm_id_indexes"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_stream_unreads_count_display_policy",
            field=models.PositiveSmallIntegerField(default=2),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_stream_unreads_count_display_policy",
            field=models.PositiveSmallIntegerField(default=2),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0475_realm_jitsi_server_url.py]---
Location: zulip-main/zerver/migrations/0475_realm_jitsi_server_url.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-19 17:02

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0474_realmuserdefault_web_stream_unreads_count_display_policy_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="jitsi_server_url",
            field=models.URLField(default=None, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0476_realmuserdefault_automatically_follow_topics_policy_and_more.py]---
Location: zulip-main/zerver/migrations/0476_realmuserdefault_automatically_follow_topics_policy_and_more.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-19 10:52

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0475_realm_jitsi_server_url"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="automatically_follow_topics_policy",
            field=models.PositiveSmallIntegerField(
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="realmuserdefault",
            name="automatically_unmute_topics_in_muted_streams_policy",
            field=models.PositiveSmallIntegerField(
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="automatically_follow_topics_policy",
            field=models.PositiveSmallIntegerField(
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="automatically_unmute_topics_in_muted_streams_policy",
            field=models.PositiveSmallIntegerField(
                null=True,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0477_alter_realmuserdefault_automatically_follow_topics_policy_and_more.py]---
Location: zulip-main/zerver/migrations/0477_alter_realmuserdefault_automatically_follow_topics_policy_and_more.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-10-02 05:53

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0476_realmuserdefault_automatically_follow_topics_policy_and_more"),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0478_realm_enable_guest_user_indicator.py]---
Location: zulip-main/zerver/migrations/0478_realm_enable_guest_user_indicator.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-13 11:12

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0477_alter_realmuserdefault_automatically_follow_topics_policy_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="enable_guest_user_indicator",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0479_realm_uuid_realm_uuid_owner_secret.py]---
Location: zulip-main/zerver/migrations/0479_realm_uuid_realm_uuid_owner_secret.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-10-06 09:21

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0478_realm_enable_guest_user_indicator"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="uuid",
            field=models.UUIDField(null=True, unique=True),
        ),
        migrations.AddField(
            model_name="realm",
            name="uuid_owner_secret",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0480_realm_backfill_uuid_and_secret.py]---
Location: zulip-main/zerver/migrations/0480_realm_backfill_uuid_and_secret.py
Signals: Django

```python
import secrets
import uuid

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def generate_api_key() -> str:
    """
    This is a copy of zerver.lib.utils.generate_api_key. Importing code that's prone
    to change in a migration is something we generally avoid, to ensure predictable,
    consistent behavior of the migration across time.
    """

    api_key = ""
    while len(api_key) < 32:
        api_key += secrets.token_urlsafe(3 * 9).replace("_", "").replace("-", "")
    return api_key[:32]


def generate_realm_uuid_owner_secret() -> str:
    token = generate_api_key()

    return f"zuliprealm_{token}"


def backfill_realm_uuid_and_secret(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")

    max_id = Realm.objects.aggregate(models.Max("id"))["id__max"]
    if max_id is None:
        # Nothing to do if there are no realms yet.
        return

    BATCH_SIZE = 100
    lower_bound = 0

    while lower_bound < max_id:
        realms_to_update = []
        for realm in Realm.objects.filter(
            id__gt=lower_bound,
            id__lte=lower_bound + BATCH_SIZE,
            # We're setting uuid and uuid_owner_secret together, so it's enough
            # to query for one of them being None.
            uuid=None,
        ).only("id", "uuid", "uuid_owner_secret"):
            realm.uuid = uuid.uuid4()
            realm.uuid_owner_secret = generate_realm_uuid_owner_secret()
            realms_to_update.append(realm)
        lower_bound += BATCH_SIZE

        Realm.objects.bulk_update(realms_to_update, ["uuid", "uuid_owner_secret"])


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0479_realm_uuid_realm_uuid_owner_secret"),
    ]

    operations = [
        migrations.RunPython(
            backfill_realm_uuid_and_secret,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0481_alter_realm_uuid_alter_realm_uuid_owner_secret.py]---
Location: zulip-main/zerver/migrations/0481_alter_realm_uuid_alter_realm_uuid_owner_secret.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-10-06 10:08

import uuid

from django.db import migrations, models

from zerver.models.realms import generate_realm_uuid_owner_secret


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0480_realm_backfill_uuid_and_secret"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="uuid",
            field=models.UUIDField(default=uuid.uuid4, unique=True),
        ),
        migrations.AlterField(
            model_name="realm",
            name="uuid_owner_secret",
            field=models.TextField(default=generate_realm_uuid_owner_secret),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0482_automatically_follow_unmute_topics_policy_defaults.py]---
Location: zulip-main/zerver/migrations/0482_automatically_follow_unmute_topics_policy_defaults.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-10-20 23:43

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max

AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_SEND = 2
AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_INITIATION = 3


def set_default_user_topic_policies(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    UserProfile = apps.get_model("zerver", "UserProfile")

    BATCH_SIZE = 1000

    # In deployments which run migrations without stopping the server
    # (e.g. Zulip Cloud), nothing prevents new users from being
    # created while we are doing these batched updates.  We add an
    # extra BATCH_SIZE in order to minimize the risk that we will
    # leave any newly-created users with the old values.  This is not
    # a guarantee, of course, as new users may be created between
    # whenever this migration finishes and when the server restarts
    # into the new default.
    max_id_realm_user_default = (
        RealmUserDefault.objects.aggregate(Max("id", default=0))["id__max"] + BATCH_SIZE
    )
    max_id_user_profile = (
        UserProfile.objects.aggregate(Max("id", default=0))["id__max"] + BATCH_SIZE
    )

    lower_bound = 0
    while lower_bound < max_id_realm_user_default:
        RealmUserDefault.objects.filter(
            id__gt=lower_bound, id__lte=lower_bound + BATCH_SIZE
        ).update(
            automatically_follow_topics_policy=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_INITIATION,
            automatically_unmute_topics_in_muted_streams_policy=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_SEND,
        )
        lower_bound += BATCH_SIZE

    lower_bound = 0
    while lower_bound < max_id_user_profile:
        UserProfile.objects.filter(id__gt=lower_bound, id__lte=lower_bound + BATCH_SIZE).update(
            automatically_follow_topics_policy=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_INITIATION,
            automatically_unmute_topics_in_muted_streams_policy=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_SEND,
        )
        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0481_alter_realm_uuid_alter_realm_uuid_owner_secret"),
    ]

    operations = [
        migrations.RunPython(
            set_default_user_topic_policies,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="automatically_follow_topics_policy",
            field=models.PositiveSmallIntegerField(
                null=False,
                default=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_INITIATION,
            ),
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="automatically_unmute_topics_in_muted_streams_policy",
            field=models.PositiveSmallIntegerField(
                null=False,
                default=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_SEND,
            ),
        ),
        migrations.AlterField(
            model_name="realmuserdefault",
            name="automatically_follow_topics_policy",
            field=models.PositiveSmallIntegerField(
                null=False,
                default=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_INITIATION,
            ),
        ),
        migrations.AlterField(
            model_name="realmuserdefault",
            name="automatically_unmute_topics_in_muted_streams_policy",
            field=models.PositiveSmallIntegerField(
                null=False,
                default=AUTOMATICALLY_CHANGE_VISIBILITY_POLICY_ON_SEND,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0483_rename_escape_navigates_to_default_view_realmuserdefault_web_escape_navigates_to_home_view_and_more.py]---
Location: zulip-main/zerver/migrations/0483_rename_escape_navigates_to_default_view_realmuserdefault_web_escape_navigates_to_home_view_and_more.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-10-25 14:49

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0482_automatically_follow_unmute_topics_policy_defaults"),
    ]

    operations = [
        migrations.RenameField(
            model_name="realmuserdefault",
            old_name="escape_navigates_to_default_view",
            new_name="web_escape_navigates_to_home_view",
        ),
        migrations.RenameField(
            model_name="realmuserdefault",
            old_name="default_view",
            new_name="web_home_view",
        ),
        migrations.RenameField(
            model_name="userprofile",
            old_name="escape_navigates_to_default_view",
            new_name="web_escape_navigates_to_home_view",
        ),
        migrations.RenameField(
            model_name="userprofile",
            old_name="default_view",
            new_name="web_home_view",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0484_preregistrationrealm_default_language.py]---
Location: zulip-main/zerver/migrations/0484_preregistrationrealm_default_language.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-12 19:58

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        (
            "zerver",
            "0483_rename_escape_navigates_to_default_view_realmuserdefault_web_escape_navigates_to_home_view_and_more",
        ),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationrealm",
            name="default_language",
            field=models.CharField(default="en", max_length=50),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0485_alter_usermessage_flags_and_add_index.py]---
Location: zulip-main/zerver/migrations/0485_alter_usermessage_flags_and_add_index.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-10-19 06:37

import bitfield.models
from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0484_preregistrationrealm_default_language"),
    ]

    operations = [
        migrations.AlterField(
            model_name="archivedusermessage",
            name="flags",
            field=bitfield.models.BitField(
                [
                    "read",
                    "starred",
                    "collapsed",
                    "mentioned",
                    "stream_wildcard_mentioned",
                    "topic_wildcard_mentioned",
                    "group_mentioned",
                    "force_expand",
                    "force_collapse",
                    "has_alert_word",
                    "historical",
                    "is_private",
                    "active_mobile_push_notification",
                ],
                default=0,
            ),
        ),
        migrations.AlterField(
            model_name="usermessage",
            name="flags",
            field=bitfield.models.BitField(
                [
                    "read",
                    "starred",
                    "collapsed",
                    "mentioned",
                    "stream_wildcard_mentioned",
                    "topic_wildcard_mentioned",
                    "group_mentioned",
                    "force_expand",
                    "force_collapse",
                    "has_alert_word",
                    "historical",
                    "is_private",
                    "active_mobile_push_notification",
                ],
                default=0,
            ),
        ),
        AddIndexConcurrently(
            model_name="usermessage",
            index=models.Index(
                "user_profile",
                "message",
                condition=models.Q(("flags__andnz", 120)),
                name="zerver_usermessage_any_mentioned_message_id",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0486_clear_old_data_for_unused_usermessage_flags.py]---
Location: zulip-main/zerver/migrations/0486_clear_old_data_for_unused_usermessage_flags.py
Signals: Django

```python
from django.contrib.postgres.operations import AddIndexConcurrently, RemoveIndexConcurrently
from django.db import connection, migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from psycopg2.sql import SQL


def clear_old_data_for_unused_usermessage_flags(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    """Because 'topic_wildcard_mentioned' and 'group_mentioned' flags are
    reused flag slots (ref: c37871a) in the 'flags' bitfield, we're not
    confident that their value is in 0 state on very old servers, and this
    migration is to ensure that's the case.
    Additionally, we are clearing 'force_expand' and 'force_collapse' unused
    flags to save future work.
    """
    with connection.cursor() as cursor:
        cursor.execute(SQL("SELECT MAX(id) FROM zerver_usermessage WHERE flags & 480 <> 0;"))
        (max_id,) = cursor.fetchone()

    # nothing to update
    if not max_id:
        return

    BATCH_SIZE = 5000
    lower_id_bound = 0
    while lower_id_bound < max_id:
        upper_id_bound = min(lower_id_bound + BATCH_SIZE, max_id)
        with connection.cursor() as cursor:
            query = SQL(
                """
                    UPDATE zerver_usermessage
                    SET flags = (flags & ~(1 << 5) & ~(1 << 6) & ~(1 << 7) & ~(1 << 8))
                    WHERE flags & 480 <> 0
                    AND id > %(lower_id_bound)s AND id <= %(upper_id_bound)s;
            """
            )
            cursor.execute(
                query,
                {"lower_id_bound": lower_id_bound, "upper_id_bound": upper_id_bound},
            )

        print(f"Processed {upper_id_bound} / {max_id}")
        lower_id_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0485_alter_usermessage_flags_and_add_index"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="usermessage",
            index=models.Index(
                "id",
                condition=models.Q(("flags__andnz", 480)),
                name="zerver_usermessage_temp_clear_flags",
            ),
        ),
        migrations.RunPython(
            clear_old_data_for_unused_usermessage_flags,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
        RemoveIndexConcurrently(
            model_name="usermessage",
            name="zerver_usermessage_temp_clear_flags",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0487_realm_can_access_all_users_group.py]---
Location: zulip-main/zerver/migrations/0487_realm_can_access_all_users_group.py
Signals: Django

```python
# Generated by Django 4.1.7 on 2023-03-23 14:40

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0486_clear_old_data_for_unused_usermessage_flags"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_access_all_users_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0488_set_default_value_for_can_access_all_users_group.py]---
Location: zulip-main/zerver/migrations/0488_set_default_value_for_can_access_all_users_group.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-21 14:00

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_access_all_users_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    UserGroup = apps.get_model("zerver", "UserGroup")

    EVERYONE_GROUP_NAME = "role:everyone"

    Realm.objects.filter(can_access_all_users_group=None).update(
        can_access_all_users_group=UserGroup.objects.filter(
            name=EVERYONE_GROUP_NAME, realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0487_realm_can_access_all_users_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_access_all_users_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0489_alter_realm_can_access_all_users_group.py]---
Location: zulip-main/zerver/migrations/0489_alter_realm_can_access_all_users_group.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-21 14:07

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0488_set_default_value_for_can_access_all_users_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_access_all_users_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0490_renumber_options_desktop_icon_count_display.py]---
Location: zulip-main/zerver/migrations/0490_renumber_options_desktop_icon_count_display.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-17 04:55

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

OLD_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION = 2
NEW_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION = 3
OLD_DESKTOP_ICON_COUNT_DISPLAY_NONE = 3
NEW_DESKTOP_ICON_COUNT_DISPLAY_NONE = 4


def renumber_options(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    # We added a new option 'DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION_FOLLOWED_TOPIC'
    # for 'desktop_icon_count_display' setting. It has the value 2.
    # The following options are renumbered:
    # * 'DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION' from 2 to 3
    # * 'DESKTOP_ICON_COUNT_DISPLAY_NONE' from 3 to 4
    # The migration is to update these values.
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    UserProfile = apps.get_model("zerver", "UserProfile")

    UserProfile.objects.filter(
        desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_NONE
    ).update(desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_NONE)
    RealmUserDefault.objects.filter(
        desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_NONE
    ).update(desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_NONE)

    UserProfile.objects.filter(
        desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION
    ).update(desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION)
    RealmUserDefault.objects.filter(
        desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION
    ).update(desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION)


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")
    UserProfile = apps.get_model("zerver", "UserProfile")

    UserProfile.objects.filter(
        desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION
    ).update(desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION)
    RealmUserDefault.objects.filter(
        desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION
    ).update(desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_DM_MENTION)

    UserProfile.objects.filter(
        desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_NONE
    ).update(desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_NONE)
    RealmUserDefault.objects.filter(
        desktop_icon_count_display=NEW_DESKTOP_ICON_COUNT_DISPLAY_NONE
    ).update(desktop_icon_count_display=OLD_DESKTOP_ICON_COUNT_DISPLAY_NONE)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0489_alter_realm_can_access_all_users_group"),
    ]

    operations = [
        migrations.RunPython(renumber_options, reverse_code=reverse_code, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0491_alter_realmuserdefault_web_home_view_and_more.py]---
Location: zulip-main/zerver/migrations/0491_alter_realmuserdefault_web_home_view_and_more.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-25 16:08

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0490_renumber_options_desktop_icon_count_display"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realmuserdefault",
            name="web_home_view",
            field=models.TextField(default="inbox"),
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="web_home_view",
            field=models.TextField(default="inbox"),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0492_realm_push_notifications_enabled_and_more.py]---
Location: zulip-main/zerver/migrations/0492_realm_push_notifications_enabled_and_more.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-28 14:04

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0491_alter_realmuserdefault_web_home_view_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="push_notifications_enabled",
            field=models.BooleanField(db_index=True, default=False),
        ),
        migrations.AddField(
            model_name="realm",
            name="push_notifications_enabled_end_timestamp",
            field=models.DateTimeField(default=None, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

````
