---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:15Z
part: 1281
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 1281 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0016_remote_counts.py]---
Location: zulip-main/zilencer/migrations/0016_remote_counts.py
Signals: Django

```python
# Generated by Django 1.11.18 on 2019-02-02 06:02

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0015_delete_billing"),
    ]

    operations = [
        migrations.CreateModel(
            name="RemoteInstallationCount",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("property", models.CharField(max_length=32)),
                ("subgroup", models.CharField(max_length=16, null=True)),
                ("end_time", models.DateTimeField()),
                ("value", models.BigIntegerField()),
                ("remote_id", models.IntegerField(db_index=True)),
                (
                    "server",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zilencer.RemoteZulipServer"
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="RemoteRealmCount",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("property", models.CharField(max_length=32)),
                ("subgroup", models.CharField(max_length=16, null=True)),
                ("end_time", models.DateTimeField()),
                ("value", models.BigIntegerField()),
                ("realm_id", models.IntegerField(db_index=True)),
                ("remote_id", models.IntegerField(db_index=True)),
                (
                    "server",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zilencer.RemoteZulipServer"
                    ),
                ),
            ],
        ),
        migrations.AlterUniqueTogether(
            name="remoterealmcount",
            unique_together={("server", "realm_id", "property", "subgroup", "end_time")},
        ),
        migrations.AddIndex(
            model_name="remoterealmcount",
            index=models.Index(
                fields=["property", "end_time"],
                name="zilencer_remoterealmcount_property_end_time_506a0b38_idx",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="remoteinstallationcount",
            unique_together={("server", "property", "subgroup", "end_time")},
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0017_installationcount_indexes.py]---
Location: zulip-main/zilencer/migrations/0017_installationcount_indexes.py
Signals: Django

```python
# Generated by Django 1.11.20 on 2019-04-23 20:17

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0016_remote_counts"),
    ]

    operations = [
        migrations.AddIndex(
            model_name="remoteinstallationcount",
            index=models.Index(
                fields=["server", "remote_id"],
                name="zilencer_remoteinstallat_server_id_remote_id_f72e4c30_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="remoterealmcount",
            index=models.Index(
                fields=["server", "remote_id"],
                name="zilencer_remoterealmcount_server_id_remote_id_de1573d8_idx",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0018_remoterealmauditlog.py]---
Location: zulip-main/zilencer/migrations/0018_remoterealmauditlog.py
Signals: Django

```python
# Generated by Django 1.11.24 on 2019-10-03 00:10

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0017_installationcount_indexes"),
    ]

    operations = [
        migrations.CreateModel(
            name="RemoteRealmAuditLog",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("realm_id", models.IntegerField(db_index=True)),
                ("remote_id", models.IntegerField(db_index=True)),
                ("event_time", models.DateTimeField(db_index=True)),
                ("backfilled", models.BooleanField(default=False)),
                ("extra_data", models.TextField(null=True)),
                ("event_type", models.PositiveSmallIntegerField()),
                (
                    "server",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zilencer.RemoteZulipServer"
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0019_remotezulipserver_plan_type.py]---
Location: zulip-main/zilencer/migrations/0019_remotezulipserver_plan_type.py
Signals: Django

```python
# Generated by Django 3.2.9 on 2021-12-01 16:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0018_remoterealmauditlog"),
    ]

    operations = [
        migrations.AddField(
            model_name="remotezulipserver",
            name="plan_type",
            field=models.PositiveSmallIntegerField(default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0020_remotezulipserverauditlog.py]---
Location: zulip-main/zilencer/migrations/0020_remotezulipserverauditlog.py
Signals: Django

```python
# Generated by Django 3.2.9 on 2021-12-06 18:35

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0019_remotezulipserver_plan_type"),
    ]

    operations = [
        migrations.CreateModel(
            name="RemoteZulipServerAuditLog",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("event_time", models.DateTimeField(db_index=True)),
                ("backfilled", models.BooleanField(default=False)),
                ("extra_data", models.TextField(null=True)),
                ("event_type", models.PositiveSmallIntegerField()),
                (
                    "server",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zilencer.remotezulipserver"
                    ),
                ),
            ],
            options={
                "abstract": False,
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0021_alter_remotezulipserver_uuid.py]---
Location: zulip-main/zilencer/migrations/0021_alter_remotezulipserver_uuid.py
Signals: Django

```python
# Generated by Django 3.2.9 on 2021-12-22 10:06

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0020_remotezulipserverauditlog"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remotezulipserver",
            name="uuid",
            field=models.UUIDField(unique=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0022_remotezulipserver_create_audit_log_backfill.py]---
Location: zulip-main/zilencer/migrations/0022_remotezulipserver_create_audit_log_backfill.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def backfill_remote_zulip_server_creation_log_events(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    RemoteZulipServer = apps.get_model("zilencer", "RemoteZulipServer")
    RemoteZulipServerAuditLog = apps.get_model("zilencer", "RemoteZulipServerAuditLog")
    RemoteZulipServerAuditLog.REMOTE_SERVER_CREATED = 10215

    objects_to_create = []
    for remote_server in RemoteZulipServer.objects.all().iterator():
        entry = RemoteZulipServerAuditLog(
            server=remote_server,
            event_type=RemoteZulipServerAuditLog.REMOTE_SERVER_CREATED,
            event_time=remote_server.last_updated,
            backfilled=True,
        )
        objects_to_create.append(entry)
    RemoteZulipServerAuditLog.objects.bulk_create(objects_to_create)


def reverse_code(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    RemoteZulipServerAuditLog = apps.get_model("zilencer", "RemoteZulipServerAuditLog")
    RemoteZulipServerAuditLog.REMOTE_SERVER_CREATED = 10215
    RemoteZulipServerAuditLog.objects.filter(
        event_type=RemoteZulipServerAuditLog.REMOTE_SERVER_CREATED, backfilled=True
    ).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0021_alter_remotezulipserver_uuid"),
    ]

    operations = [
        migrations.RunPython(
            backfill_remote_zulip_server_creation_log_events,
            reverse_code=reverse_code,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0023_remotezulipserver_deactivated.py]---
Location: zulip-main/zilencer/migrations/0023_remotezulipserver_deactivated.py
Signals: Django

```python
# Generated by Django 3.2.9 on 2021-12-15 17:26

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0022_remotezulipserver_create_audit_log_backfill"),
    ]

    operations = [
        migrations.AddField(
            model_name="remotezulipserver",
            name="deactivated",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0024_remotepushdevicetoken_user_uuid.py]---
Location: zulip-main/zilencer/migrations/0024_remotepushdevicetoken_user_uuid.py
Signals: Django

```python
# Generated by Django 3.2.9 on 2021-12-27 21:10

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0023_remotezulipserver_deactivated"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remotepushdevicetoken",
            name="user_id",
            field=models.BigIntegerField(db_index=True, null=True),
        ),
        migrations.AddField(
            model_name="remotepushdevicetoken",
            name="user_uuid",
            field=models.UUIDField(null=True),
        ),
        migrations.AlterUniqueTogether(
            name="remotepushdevicetoken",
            unique_together={
                ("server", "user_uuid", "kind", "token"),
                ("server", "user_id", "kind", "token"),
            },
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0025_alter_remotepushdevicetoken_user_id_drop_index.py]---
Location: zulip-main/zilencer/migrations/0025_alter_remotepushdevicetoken_user_id_drop_index.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-10 12:34

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0024_remotepushdevicetoken_user_uuid"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remotepushdevicetoken",
            name="user_id",
            field=models.BigIntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0026_auditlog_models_extra_data_json.py]---
Location: zulip-main/zilencer/migrations/0026_auditlog_models_extra_data_json.py
Signals: Django

```python
# Generated by Django 4.0.7 on 2022-09-30 20:25

import django
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0025_alter_remotepushdevicetoken_user_id_drop_index"),
    ]

    operations = [
        migrations.AddField(
            model_name="remoterealmauditlog",
            name="extra_data_json",
            field=models.JSONField(
                default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder
            ),
        ),
        migrations.AddField(
            model_name="remotezulipserverauditlog",
            name="extra_data_json",
            field=models.JSONField(
                default=dict, encoder=django.core.serializers.json.DjangoJSONEncoder
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0027_backfill_remote_realmauditlog_extradata_to_json_field.py]---
Location: zulip-main/zilencer/migrations/0027_backfill_remote_realmauditlog_extradata_to_json_field.py
Signals: Django

```python
# Generated by Django 4.0.7 on 2022-09-30 20:30

import ast
from collections.abc import Callable

import orjson
from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import F, JSONField, Model
from django.db.models.functions import Cast

# This migration is mostly the same as
# backfill_realmauditlog_extradata_to_json_field in zerver.

OLD_VALUE = "1"
NEW_VALUE = "2"
USER_FULL_NAME_CHANGED = 124
REALM_DISCOUNT_CHANGED = 209
BATCH_SIZE = 5000

OVERWRITE_TEMPLATE = """Audit log entry with id {id} has extra_data_json been inconsistently overwritten.
  The old value is:
{old_value}
  The new value is:
{new_value}
"""


@transaction.atomic
def do_bulk_backfill_extra_data(
    audit_log_model: type[Model], id_lower_bound: int, id_upper_bound: int
) -> None:
    inconsistent_extra_data_json: list[tuple[int, str, object, object]] = []
    # A dict converted with str() will start with a open bracket followed by a
    # single quote, as opposed to a JSON-encoded value, which will use a
    # _double_ quote. We use this to filter out those entries with malformed
    # extra_data to be handled later. This should only update rows with
    # extra_data populated with orjson.dumps.

    # The first query below checks for entries that would have extra_data_json
    # being overwritten by the migration with a value inconsistent with its
    # previous value.
    inconsistent_extra_data_json.extend(
        audit_log_model._default_manager.filter(
            extra_data__isnull=False, id__range=(id_lower_bound, id_upper_bound)
        )
        .annotate(new_extra_data_json=Cast("extra_data", output_field=JSONField()))
        .exclude(extra_data__startswith="{'")
        .exclude(extra_data_json={})
        .exclude(extra_data_json=F("new_extra_data_json"))
        .values_list("id", "extra_data", "extra_data_json", "new_extra_data_json")
    )
    (
        audit_log_model._default_manager.filter(
            extra_data__isnull=False,
            id__range=(id_lower_bound, id_upper_bound),
            extra_data_json__inconsistent_old_extra_data__isnull=True,
        )
        .exclude(extra_data__startswith="{'")
        .update(extra_data_json=Cast("extra_data", output_field=JSONField()))
    )

    python_valued_audit_log_entries = audit_log_model._default_manager.filter(
        extra_data__startswith="{'",
        id__range=(id_lower_bound, id_upper_bound),
        extra_data_json__inconsistent_old_extra_data__isnull=True,
    )
    for audit_log_entry in python_valued_audit_log_entries:
        # extra_data for entries that store dict stringified with builtins.str()
        # are converted back with ast.literal_eval for safety and efficiency.
        old_value = audit_log_entry.extra_data_json  # type: ignore[attr-defined] # The migration cannot depend on zerver.models, which contains the real type of the RealmAuditLog model, so it cannot be properly typed.
        new_value = ast.literal_eval(audit_log_entry.extra_data)  # type: ignore[attr-defined] # Explained above.
        if old_value not in ({}, new_value):
            inconsistent_extra_data_json.append(
                (audit_log_entry.id, audit_log_entry.extra_data, old_value, new_value)  # type: ignore[attr-defined] # Explained above.
            )
        audit_log_entry.extra_data_json = new_value  # type: ignore[attr-defined] # Explained above.
    audit_log_model._default_manager.bulk_update(
        python_valued_audit_log_entries, fields=["extra_data_json"]
    )

    if inconsistent_extra_data_json:
        audit_log_entries = []
        for (
            audit_log_entry_id,
            old_extra_data,
            old_extra_data_json,
            new_extra_data_json,
        ) in inconsistent_extra_data_json:
            audit_log_entry = audit_log_model._default_manager.get(id=audit_log_entry_id)
            assert isinstance(old_extra_data_json, dict)
            if "inconsistent_old_extra_data" in old_extra_data_json:
                # Skip entries that have been backfilled and detected as
                # anomalies before.
                continue
            assert isinstance(new_extra_data_json, dict)
            audit_log_entry.extra_data_json = {  # type: ignore[attr-defined] # Explained above.
                **new_extra_data_json,
                "inconsistent_old_extra_data": old_extra_data,
                "inconsistent_old_extra_data_json": old_extra_data_json,
            }
            audit_log_entries.append(audit_log_entry)
            print(
                OVERWRITE_TEMPLATE.format(
                    id=audit_log_entry_id,
                    old_value=orjson.dumps(old_extra_data_json).decode(),
                    new_value=orjson.dumps(new_extra_data_json).decode(),
                )
            )
        audit_log_model._default_manager.bulk_update(audit_log_entries, fields=["extra_data_json"])


def backfill_extra_data(model_name: str) -> Callable[[StateApps, BaseDatabaseSchemaEditor], None]:
    def inner(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
        audit_log_model = apps.get_model("zilencer", model_name)
        if not audit_log_model.objects.filter(extra_data__isnull=False).exists():
            return

        audit_log_entries = audit_log_model.objects.filter(extra_data__isnull=False)
        id_lower_bound = audit_log_entries.earliest("id").id
        id_upper_bound = audit_log_entries.latest("id").id
        while id_lower_bound <= id_upper_bound:
            do_bulk_backfill_extra_data(
                audit_log_model, id_lower_bound, min(id_lower_bound + BATCH_SIZE, id_upper_bound)
            )
            id_lower_bound += BATCH_SIZE + 1

        do_bulk_backfill_extra_data(audit_log_model, id_lower_bound, id_upper_bound)

    return inner


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zilencer", "0026_auditlog_models_extra_data_json"),
    ]

    operations = [
        migrations.RunPython(
            backfill_extra_data("RemoteRealmAuditLog"),
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
        migrations.RunPython(
            backfill_extra_data("RemoteZulipServerAuditLog"),
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0028_rename_extradatajson_remoteauditlog_extra_data.py]---
Location: zulip-main/zilencer/migrations/0028_rename_extradatajson_remoteauditlog_extra_data.py
Signals: Django

```python
# Generated by Django 4.0.7 on 2022-10-02 17:02

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0027_backfill_remote_realmauditlog_extradata_to_json_field"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="remoterealmauditlog",
            name="extra_data",
        ),
        migrations.RemoveField(
            model_name="remotezulipserverauditlog",
            name="extra_data",
        ),
        migrations.RenameField(
            model_name="remoterealmauditlog",
            old_name="extra_data_json",
            new_name="extra_data",
        ),
        migrations.RenameField(
            model_name="remotezulipserverauditlog",
            old_name="extra_data_json",
            new_name="extra_data",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0029_update_remoterealm_indexes.py]---
Location: zulip-main/zilencer/migrations/0029_update_remoterealm_indexes.py
Signals: Django

```python
# Generated by Django 4.2.5 on 2023-09-13 05:02

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0028_rename_extradatajson_remoteauditlog_extra_data"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remoterealmauditlog",
            name="realm_id",
            field=models.IntegerField(),
        ),
        migrations.AlterField(
            model_name="remoterealmauditlog",
            name="remote_id",
            field=models.IntegerField(),
        ),
        migrations.AlterField(
            model_name="remoterealmcount",
            name="realm_id",
            field=models.IntegerField(),
        ),
        migrations.AlterField(
            model_name="remoterealmcount",
            name="remote_id",
            field=models.IntegerField(),
        ),
        migrations.AddConstraint(
            model_name="remoterealmauditlog",
            constraint=models.UniqueConstraint(
                fields=("server", "remote_id"), name="zilencer_remoterealmauditlog_server_remote"
            ),
        ),
        migrations.AddIndex(
            model_name="remoterealmauditlog",
            index=models.Index(
                fields=["server", "realm_id", "remote_id"],
                name="zilencer_remoterealmauditlog_server_realm_remote",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0030_alter_remoteinstallationcount_remote_id.py]---
Location: zulip-main/zilencer/migrations/0030_alter_remoteinstallationcount_remote_id.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-10-20 00:10

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0029_update_remoterealm_indexes"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remoteinstallationcount",
            name="remote_id",
            field=models.IntegerField(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0031_alter_remoteinstallationcount_remote_id_and_more.py]---
Location: zulip-main/zilencer/migrations/0031_alter_remoteinstallationcount_remote_id_and_more.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-10-23 20:22

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0030_alter_remoteinstallationcount_remote_id"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remoteinstallationcount",
            name="remote_id",
            field=models.IntegerField(null=True),
        ),
        migrations.AlterField(
            model_name="remoterealmcount",
            name="remote_id",
            field=models.IntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0032_remotepushdevicetoken_backfill_ios_app_id.py]---
Location: zulip-main/zilencer/migrations/0032_remotepushdevicetoken_backfill_ios_app_id.py
Signals: Django

```python
from django.db import migrations


class Migration(migrations.Migration):
    """
    Previous versions of zilencer dropped the ios_app_id on the floor
    when registering a push token, and then effectively assumed
    the value was "org.zulip.Zulip".

    We're going to start actually using that parameter.  To preserve
    the existing behavior for existing tokens, backfill the value.
    """

    dependencies = [
        ("zilencer", "0031_alter_remoteinstallationcount_remote_id_and_more"),
    ]

    FORMERLY_IMPLICIT_IOS_APP_ID = "org.zulip.Zulip"

    operations = [
        migrations.RunSQL(
            sql=[
                (
                    """
            UPDATE zilencer_remotepushdevicetoken
            SET ios_app_id = %s
            WHERE kind = 1 AND ios_app_id IS NULL
            """,
                    [FORMERLY_IMPLICIT_IOS_APP_ID],
                )
            ],
            # The updated table is still valid with the old schema;
            # so to reverse, a no-op suffices.
            reverse_sql=[],
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0033_remoterealm.py]---
Location: zulip-main/zilencer/migrations/0033_remoterealm.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-11-02 23:22

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0032_remotepushdevicetoken_backfill_ios_app_id"),
    ]

    operations = [
        migrations.CreateModel(
            name="RemoteRealm",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("uuid", models.UUIDField(unique=True)),
                ("uuid_owner_secret", models.TextField()),
                ("host", models.TextField()),
                ("last_updated", models.DateTimeField(auto_now=True, verbose_name="last updated")),
                ("registration_deactivated", models.BooleanField(default=False)),
                ("realm_deactivated", models.BooleanField(default=False)),
                ("realm_date_created", models.DateTimeField()),
                ("plan_type", models.PositiveSmallIntegerField(db_index=True, default=1)),
                (
                    "server",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zilencer.remotezulipserver"
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0034_remoterealmauditlog_remote_realm_and_more.py]---
Location: zulip-main/zilencer/migrations/0034_remoterealmauditlog_remote_realm_and_more.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-11-08 23:17

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0033_remoterealm"),
    ]

    operations = [
        migrations.AddField(
            model_name="remoterealmauditlog",
            name="remote_realm",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zilencer.remoterealm"
            ),
        ),
        migrations.AlterField(
            model_name="remoterealmauditlog",
            name="remote_id",
            field=models.IntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0035_remoterealmcount_remote_realm_and_more.py]---
Location: zulip-main/zilencer/migrations/0035_remoterealmcount_remote_realm_and_more.py
Signals: Django

```python
# Generated by Django 4.2.6 on 2023-11-09 17:23

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0034_remoterealmauditlog_remote_realm_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="remoterealmcount",
            name="remote_realm",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to="zilencer.remoterealm"
            ),
        ),
        migrations.AlterField(
            model_name="remoterealmcount",
            name="realm_id",
            field=models.IntegerField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0036_remotezulipserver_last_version.py]---
Location: zulip-main/zilencer/migrations/0036_remotezulipserver_last_version.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-17 20:59

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0035_remoterealmcount_remote_realm_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="remotezulipserver",
            name="last_version",
            field=models.CharField(max_length=128, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0037_alter_remoteinstallationcount_unique_together_and_more.py]---
Location: zulip-main/zilencer/migrations/0037_alter_remoteinstallationcount_unique_together_and_more.py
Signals: Django

```python
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Count, Min


def clear_duplicate_counts(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """Clean up duplicated RemoteRealmCount and RemoteInstallationCount rows.

    This is the equivalent of analytics' 0015_clear_duplicate_counts
    migration -- but it also has additional duplicates if there are
    multiple servers submitting information with the same UUID.

    We drop the behaviour of rolling up and updating the value to the
    sum, since the active_users_log:is_bot:day field has a subgroup
    (and is thus not affected by the bug), and the few cases for
    `invites_sent::day` seem more likely to be re-submissions of the
    same data, not duplicates to roll up.

    We must do this step before switching the non-unique indexes to be
    unique, as there are currently violations.

    """
    count_tables = dict(
        realm=apps.get_model("zilencer", "RemoteRealmCount"),
        installation=apps.get_model("zilencer", "RemoteInstallationCount"),
    )

    for name, count_table in count_tables.items():
        value = ["realm_id", "server_id", "property", "end_time"]
        if name == "installation":
            value = ["server_id", "property", "end_time"]
        duplicated_rows = (
            count_table.objects.filter(subgroup=None)
            .values(*value)
            .annotate(Count("id"), Min("id"))
            .filter(id__count__gt=1)
        )

        for duplicated_row in duplicated_rows:
            duplicated_row.pop("id__count")
            first_id = duplicated_row.pop("id__min")
            count_table.objects.filter(**duplicated_row, id__gt=first_id).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0036_remotezulipserver_last_version"),
    ]

    operations = [
        migrations.RunPython(
            clear_duplicate_counts, reverse_code=migrations.RunPython.noop, elidable=True
        ),
        migrations.AddConstraint(
            model_name="remoteinstallationcount",
            constraint=models.UniqueConstraint(
                condition=models.Q(("subgroup__isnull", False)),
                fields=("server", "property", "subgroup", "end_time"),
                name="unique_remote_installation_count",
            ),
        ),
        migrations.AddConstraint(
            model_name="remoteinstallationcount",
            constraint=models.UniqueConstraint(
                condition=models.Q(("subgroup__isnull", True)),
                fields=("server", "property", "end_time"),
                name="unique_remote_installation_count_null_subgroup",
            ),
        ),
        migrations.AddConstraint(
            model_name="remoterealmcount",
            constraint=models.UniqueConstraint(
                condition=models.Q(("subgroup__isnull", False)),
                fields=("server", "realm_id", "property", "subgroup", "end_time"),
                name="unique_remote_realm_installation_count",
            ),
        ),
        migrations.AddConstraint(
            model_name="remoterealmcount",
            constraint=models.UniqueConstraint(
                condition=models.Q(("subgroup__isnull", True)),
                fields=("server", "realm_id", "property", "end_time"),
                name="unique_remote_realm_installation_count_null_subgroup",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="remoteinstallationcount",
            unique_together=set(),
        ),
        migrations.AlterUniqueTogether(
            name="remoterealmcount",
            unique_together=set(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0038_unique_server_remote_id.py]---
Location: zulip-main/zilencer/migrations/0038_unique_server_remote_id.py
Signals: Django

```python
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0037_alter_remoteinstallationcount_unique_together_and_more"),
    ]

    operations = [
        migrations.AddConstraint(
            model_name="remoteinstallationcount",
            constraint=models.UniqueConstraint(
                condition=models.Q(("remote_id__isnull", False)),
                fields=("server", "remote_id"),
                name="unique_remote_installation_count_server_id_remote_id",
            ),
        ),
        migrations.RemoveIndex(
            model_name="remoteinstallationcount",
            name="zilencer_remoteinstallat_server_id_remote_id_f72e4c30_idx",
        ),
        migrations.AddConstraint(
            model_name="remoterealmcount",
            constraint=models.UniqueConstraint(
                condition=models.Q(("remote_id__isnull", False)),
                fields=("server", "remote_id"),
                name="unique_remote_realm_installation_count_server_id_remote_id",
            ),
        ),
        migrations.RemoveIndex(
            model_name="remoterealmcount",
            name="zilencer_remoterealmcount_server_id_remote_id_de1573d8_idx",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0039_remoterealm_org_type.py]---
Location: zulip-main/zilencer/migrations/0039_remoterealm_org_type.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-27 00:44

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0038_unique_server_remote_id"),
    ]

    operations = [
        migrations.AddField(
            model_name="remoterealm",
            name="org_type",
            field=models.PositiveSmallIntegerField(
                choices=[
                    (0, "Unspecified"),
                    (10, "Business"),
                    (20, "Open-source project"),
                    (30, "Education (non-profit)"),
                    (35, "Education (for-profit)"),
                    (40, "Research"),
                    (50, "Event or conference"),
                    (60, "Non-profit (registered)"),
                    (70, "Government"),
                    (80, "Political group"),
                    (90, "Community"),
                    (100, "Personal"),
                    (1000, "Other"),
                ],
                default=0,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0040_remoterealm_authentication_methods_remoterealm_name.py]---
Location: zulip-main/zilencer/migrations/0040_remoterealm_authentication_methods_remoterealm_name.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-29 22:43

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0039_remoterealm_org_type"),
    ]

    operations = [
        migrations.AddField(
            model_name="remoterealm",
            name="authentication_methods",
            field=models.JSONField(default=dict),
        ),
        migrations.AddField(
            model_name="remoterealm",
            name="name",
            field=models.TextField(default=""),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0041_remotezulipserver_org_type.py]---
Location: zulip-main/zilencer/migrations/0041_remotezulipserver_org_type.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-29 05:16

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0040_remoterealm_authentication_methods_remoterealm_name"),
    ]

    operations = [
        migrations.AddField(
            model_name="remotezulipserver",
            name="org_type",
            field=models.PositiveSmallIntegerField(
                choices=[
                    (0, "Unspecified"),
                    (10, "Business"),
                    (20, "Open-source project"),
                    (30, "Education (non-profit)"),
                    (35, "Education (for-profit)"),
                    (40, "Research"),
                    (50, "Event or conference"),
                    (60, "Non-profit (registered)"),
                    (70, "Government"),
                    (80, "Political group"),
                    (90, "Community"),
                    (100, "Personal"),
                    (1000, "Other"),
                ],
                default=0,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0042_alter_remoterealmauditlog_realm_id.py]---
Location: zulip-main/zilencer/migrations/0042_alter_remoterealmauditlog_realm_id.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-11-30 11:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0041_remotezulipserver_org_type"),
    ]

    operations = [
        migrations.AlterField(
            model_name="remoterealmauditlog",
            name="realm_id",
            field=models.IntegerField(blank=True, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0043_remotepushdevicetoken_remote_realm.py]---
Location: zulip-main/zilencer/migrations/0043_remotepushdevicetoken_remote_realm.py
Signals: Django

```python
# Generated by Django 4.2.7 on 2023-12-01 15:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zilencer", "0042_alter_remoterealmauditlog_realm_id"),
    ]

    operations = [
        migrations.AddField(
            model_name="remotepushdevicetoken",
            name="remote_realm",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to="zilencer.remoterealm"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
