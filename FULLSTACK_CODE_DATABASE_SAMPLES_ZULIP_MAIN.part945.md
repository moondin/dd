---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 945
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 945 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0379_userprofile_uuid.py]---
Location: zulip-main/zerver/migrations/0379_userprofile_uuid.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-05 14:40

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0378_alter_realmuserdefault_realm"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="uuid",
            field=models.UUIDField(null=True, unique=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0380_userprofile_uuid_backfill.py]---
Location: zulip-main/zerver/migrations/0380_userprofile_uuid_backfill.py
Signals: Django

```python
import uuid

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def backfill_user_profile_uuid(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")

    max_id = UserProfile.objects.aggregate(models.Max("id"))["id__max"]
    if max_id is None:
        # Nothing to do if there are no users yet.
        return

    BATCH_SIZE = 10000
    lower_bound = 0

    while lower_bound < max_id:
        user_profiles_to_update = []
        for user_profile in UserProfile.objects.filter(
            id__gt=lower_bound, id__lte=lower_bound + BATCH_SIZE, uuid=None
        ).only("id", "uuid"):
            user_profile.uuid = uuid.uuid4()
            user_profiles_to_update.append(user_profile)
        lower_bound += BATCH_SIZE

        UserProfile.objects.bulk_update(user_profiles_to_update, ["uuid"])


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0379_userprofile_uuid"),
    ]

    operations = [
        migrations.RunPython(
            backfill_user_profile_uuid, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0381_alter_userprofile_uuid.py]---
Location: zulip-main/zerver/migrations/0381_alter_userprofile_uuid.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-05 15:03

import uuid

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0380_userprofile_uuid_backfill"),
    ]

    operations = [
        migrations.AlterField(
            model_name="userprofile",
            name="uuid",
            field=models.UUIDField(default=uuid.uuid4, unique=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0382_create_role_based_system_groups.py]---
Location: zulip-main/zerver/migrations/0382_create_role_based_system_groups.py
Signals: Django

```python
# Generated by Django 3.2.7 on 2021-10-16 12:41

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.utils.timezone import now as timezone_now


def create_role_based_system_groups(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    UserProfile = apps.get_model("zerver", "UserProfile")
    UserGroup = apps.get_model("zerver", "UserGroup")
    GroupGroupMembership = apps.get_model("zerver", "GroupGroupMembership")
    UserGroupMembership = apps.get_model("zerver", "UserGroupMembership")

    UserProfile.ROLE_REALM_OWNER = 100
    UserProfile.ROLE_REALM_ADMINISTRATOR = 200
    UserProfile.ROLE_MODERATOR = 300
    UserProfile.ROLE_MEMBER = 400
    UserProfile.ROLE_GUEST = 600

    realms = Realm.objects.all()

    SYSTEM_USER_GROUP_ROLE_MAP = {
        UserProfile.ROLE_REALM_OWNER: {
            "name": "@role:owners",
            "description": "Owners of this organization",
        },
        UserProfile.ROLE_REALM_ADMINISTRATOR: {
            "name": "@role:administrators",
            "description": "Administrators of this organization, including owners",
        },
        UserProfile.ROLE_MODERATOR: {
            "name": "@role:moderators",
            "description": "Moderators of this organization, including administrators",
        },
        UserProfile.ROLE_MEMBER: {
            "name": "@role:members",
            "description": "Members of this organization, not including guests",
        },
        UserProfile.ROLE_GUEST: {
            "name": "@role:everyone",
            "description": "Everyone in this organization, including guests",
        },
    }

    for realm in realms:
        with transaction.atomic():
            if UserGroup.objects.filter(
                realm=realm, name="@role:internet", is_system_group=True
            ).exists():
                # Handle the case where we are rerunning after a
                # failure, and had already processed this realm.
                continue

            role_system_groups_dict = {
                role: UserGroup(
                    name=user_group_params["name"],
                    description=user_group_params["description"],
                    realm=realm,
                    is_system_group=True,
                )
                for role, user_group_params in SYSTEM_USER_GROUP_ROLE_MAP.items()
            }

            full_members_system_group = UserGroup(
                name="@role:fullmembers",
                description="Members of this organization, not including new accounts and guests",
                realm=realm,
                is_system_group=True,
            )
            everyone_on_internet_system_group = UserGroup(
                name="@role:internet",
                description="Everyone on the Internet",
                realm=realm,
                is_system_group=True,
            )

            system_user_groups_list = [
                role_system_groups_dict[UserProfile.ROLE_REALM_OWNER],
                role_system_groups_dict[UserProfile.ROLE_REALM_ADMINISTRATOR],
                role_system_groups_dict[UserProfile.ROLE_MODERATOR],
                full_members_system_group,
                role_system_groups_dict[UserProfile.ROLE_MEMBER],
                role_system_groups_dict[UserProfile.ROLE_GUEST],
                everyone_on_internet_system_group,
            ]

            UserGroup.objects.bulk_create(system_user_groups_list)

            subgroup_objects = []
            subgroup, remaining_groups = system_user_groups_list[0], system_user_groups_list[1:]
            for supergroup in remaining_groups:
                subgroup_objects.append(
                    GroupGroupMembership(subgroup=subgroup, supergroup=supergroup)
                )
                subgroup = supergroup

            GroupGroupMembership.objects.bulk_create(subgroup_objects)

            users = UserProfile.objects.filter(realm=realm).only("id", "role", "date_joined")
            group_membership_objects = []
            for user in users:
                system_group = role_system_groups_dict[user.role]
                group_membership_objects.append(
                    UserGroupMembership(user_profile=user, user_group=system_group)
                )

                if (
                    user.role == UserProfile.ROLE_MEMBER
                    and (timezone_now() - user.date_joined).days >= realm.waiting_period_threshold
                ):
                    group_membership_objects.append(
                        UserGroupMembership(user_profile=user, user_group=full_members_system_group)
                    )

            UserGroupMembership.objects.bulk_create(group_membership_objects)


def delete_role_based_system_groups(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    UserGroup = apps.get_model("zerver", "UserGroup")
    GroupGroupMembership = apps.get_model("zerver", "GroupGroupMembership")
    UserGroupMembership = apps.get_model("zerver", "UserGroupMembership")
    with transaction.atomic():
        GroupGroupMembership.objects.all().delete()
        UserGroupMembership.objects.filter(user_group__is_system_group=True).delete()
        UserGroup.objects.filter(is_system_group=True).delete()


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0381_alter_userprofile_uuid"),
    ]

    operations = [
        migrations.RunPython(
            create_role_based_system_groups,
            reverse_code=delete_role_based_system_groups,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0383_revoke_invitations_from_deactivated_users.py]---
Location: zulip-main/zerver/migrations/0383_revoke_invitations_from_deactivated_users.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.utils.timezone import now as timezone_now


def revoke_invitations(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Realm = apps.get_model("zerver", "Realm")
    Confirmation = apps.get_model("confirmation", "Confirmation")
    Confirmation.INVITATION = 2
    Confirmation.MULTIUSE_INVITE = 6
    PreregistrationUser = apps.get_model("zerver", "PreregistrationUser")
    UserProfile = apps.get_model("zerver", "UserProfile")
    MultiuseInvite = apps.get_model("zerver", "MultiuseInvite")

    STATUS_REVOKED = 2

    def get_valid_invite_confirmations_generated_by_users(
        user_ids: list[int],
    ) -> list[int]:
        prereg_user_ids = (
            PreregistrationUser.objects.filter(referred_by_id__in=user_ids)
            .exclude(status=STATUS_REVOKED)
            .values_list("id", flat=True)
        )
        confirmation_ids = list(
            Confirmation.objects.filter(
                type=Confirmation.INVITATION,
                object_id__in=prereg_user_ids,
                expiry_date__gte=timezone_now(),
            ).values_list("id", flat=True)
        )

        multiuse_invite_ids = MultiuseInvite.objects.filter(
            referred_by_id__in=user_ids
        ).values_list("id", flat=True)
        confirmation_ids += Confirmation.objects.filter(
            type=Confirmation.MULTIUSE_INVITE,
            expiry_date__gte=timezone_now(),
            object_id__in=multiuse_invite_ids,
        ).values_list("id", flat=True)

        return confirmation_ids

    print()
    for realm_id in Realm.objects.values_list("id", flat=True):
        deactivated_user_ids = UserProfile.objects.filter(
            is_active=False, realm_id=realm_id
        ).values_list("id", flat=True)
        confirmation_ids = get_valid_invite_confirmations_generated_by_users(deactivated_user_ids)

        if len(confirmation_ids) > 0:
            print(
                f"Revoking invitations by deactivated users in realm {realm_id}: {confirmation_ids}"
            )

        Confirmation.objects.filter(id__in=confirmation_ids).update(expiry_date=timezone_now())


class Migration(migrations.Migration):
    """
    User deactivation used to *not* revoke invitations generated by the user.
    This has been fixed in the implementation, but this migration is still needed
    to ensure old invitations are revoked for users who were deactivated in the past.
    """

    atomic = False

    dependencies = [
        ("zerver", "0382_create_role_based_system_groups"),
    ]

    operations = [
        migrations.RunPython(
            revoke_invitations,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0384_alter_realm_not_null.py]---
Location: zulip-main/zerver/migrations/0384_alter_realm_not_null.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-17 23:33

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0383_revoke_invitations_from_deactivated_users"),
    ]

    operations = [
        migrations.AlterField(
            model_name="archivedattachment",
            name="realm",
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"),
        ),
        migrations.AlterField(
            model_name="attachment",
            name="realm",
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0385_attachment_flags_cache.py]---
Location: zulip-main/zerver/migrations/0385_attachment_flags_cache.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-23 03:49

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0384_alter_realm_not_null"),
    ]

    operations = [
        migrations.AlterField(
            model_name="archivedattachment",
            name="is_realm_public",
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.AlterField(
            model_name="archivedattachment",
            name="is_web_public",
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.AlterField(
            model_name="attachment",
            name="is_realm_public",
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.AlterField(
            model_name="attachment",
            name="is_web_public",
            field=models.BooleanField(default=False, null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0386_fix_attachment_caches.py]---
Location: zulip-main/zerver/migrations/0386_fix_attachment_caches.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-03-23 04:32


from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Exists, Model, OuterRef


def fix_attachment_caches(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Attachment = apps.get_model("zerver", "Attachment")
    ArchivedAttachment = apps.get_model("zerver", "ArchivedAttachment")
    Message = apps.get_model("zerver", "Message")
    ArchivedMessage = apps.get_model("zerver", "ArchivedMessage")

    BATCH_SIZE = 10000

    def update_batch(
        attachment_model: type[Model], message_model: type[Model], lower_bound: int
    ) -> None:
        attachment_model._default_manager.filter(
            id__gt=lower_bound, id__lte=lower_bound + BATCH_SIZE
        ).update(
            is_web_public=Exists(
                message_model._default_manager.filter(
                    attachment=OuterRef("id"),
                    recipient__stream__invite_only=False,
                    recipient__stream__is_web_public=True,
                ),
            ),
            is_realm_public=Exists(
                message_model._default_manager.filter(
                    attachment=OuterRef("id"),
                    recipient__stream__invite_only=False,
                )
            ),
        )

    max_id = Attachment.objects.aggregate(models.Max("id"))["id__max"]
    if max_id is not None:
        lower_bound = 0

        while lower_bound < max_id:
            print(f"Processed {lower_bound}/{max_id} attachments.")
            update_batch(Attachment, Message, lower_bound)
            lower_bound += BATCH_SIZE

    max_id = ArchivedAttachment.objects.aggregate(models.Max("id"))["id__max"]
    if max_id is not None:
        lower_bound = 0

        while lower_bound < max_id:
            print(f"Processed {lower_bound}/{max_id} archived attachments.")
            update_batch(ArchivedAttachment, ArchivedMessage, lower_bound)
            lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0385_attachment_flags_cache"),
    ]

    operations = [
        migrations.AlterField(
            model_name="archivedattachment",
            name="messages",
            field=models.ManyToManyField(
                related_name="attachment_set",
                related_query_name="attachment",
                to="zerver.ArchivedMessage",
            ),
        ),
        migrations.RunPython(
            fix_attachment_caches, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0387_reupload_realmemoji_again.py]---
Location: zulip-main/zerver/migrations/0387_reupload_realmemoji_again.py
Signals: Django

```python
from django.conf import settings
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

from zerver.lib.queue import queue_json_publish_rollback_unsafe


def reupload_realm_emoji(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    """As detailed in https://github.com/zulip/zulip/issues/21608, it is
    possible for the deferred_work queue from Zulip 4.x to have been
    started up by puppet during the deployment before migrations were
    run on Zulip 5.0.

    This means that the deferred_work events originally produced by
    migration 0376 might have been processed and discarded without
    effect.

    That code has been removed from the 0376 migration, and we run it
    here, after the upgrade code has been fixed; servers which already
    processed that migration might at worst do this work twice, which
    is harmless aside from being a small waste of resources.
    """

    Realm = apps.get_model("zerver", "Realm")
    if settings.TEST_SUITE:
        # There are no custom emoji in the test suite data set, and
        # the below code won't work because RabbitMQ isn't enabled for
        # the test suite.
        return

    for realm_id in Realm.objects.order_by("id").values_list("id", flat=True):
        event = {
            "type": "reupload_realm_emoji",
            "realm_id": realm_id,
        }
        queue_json_publish_rollback_unsafe("deferred_work", event)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0386_fix_attachment_caches"),
    ]

    operations = [
        migrations.RunPython(
            reupload_realm_emoji, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0388_preregistrationuser_created_user.py]---
Location: zulip-main/zerver/migrations/0388_preregistrationuser_created_user.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-04-09 00:38

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0387_reupload_realmemoji_again"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationuser",
            name="created_user",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="+",
                to=settings.AUTH_USER_MODEL,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0389_userprofile_display_emoji_reaction_users.py]---
Location: zulip-main/zerver/migrations/0389_userprofile_display_emoji_reaction_users.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-04-16 13:45

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0388_preregistrationuser_created_user"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="display_emoji_reaction_users",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="display_emoji_reaction_users",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0390_fix_stream_history_public_to_subscribers.py]---
Location: zulip-main/zerver/migrations/0390_fix_stream_history_public_to_subscribers.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_stream_history_public_to_subscribers(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "Stream")
    Stream.objects.filter(
        invite_only=False, is_in_zephyr_realm=False, history_public_to_subscribers=False
    ).update(history_public_to_subscribers=True)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0389_userprofile_display_emoji_reaction_users"),
    ]

    operations = [
        migrations.RunPython(fix_stream_history_public_to_subscribers, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0391_alter_stream_history_public_to_subscribers.py]---
Location: zulip-main/zerver/migrations/0391_alter_stream_history_public_to_subscribers.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-04-27 15:42

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0390_fix_stream_history_public_to_subscribers"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="history_public_to_subscribers",
            field=models.BooleanField(default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0392_non_nullable_fields.py]---
Location: zulip-main/zerver/migrations/0392_non_nullable_fields.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-04-27 19:14

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0391_alter_stream_history_public_to_subscribers"),
    ]

    operations = [
        migrations.AlterField(
            model_name="customprofilefield",
            name="field_data",
            field=models.TextField(default=""),
        ),
        migrations.AlterField(
            model_name="customprofilefield",
            name="hint",
            field=models.CharField(default="", max_length=80),
        ),
        migrations.AlterField(
            model_name="realmuserdefault",
            name="enter_sends",
            field=models.BooleanField(default=False),
        ),
        migrations.AlterField(
            model_name="stream",
            name="invite_only",
            field=models.BooleanField(default=False),
        ),
        migrations.AlterField(
            model_name="subscription",
            name="is_muted",
            field=models.BooleanField(default=False),
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="enter_sends",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0393_realm_want_advertise_in_communities_directory.py]---
Location: zulip-main/zerver/migrations/0393_realm_want_advertise_in_communities_directory.py
Signals: Django

```python
# Generated by Django 3.2.12 on 2022-04-22 11:24

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0392_non_nullable_fields"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="want_advertise_in_communities_directory",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0394_alter_realm_want_advertise_in_communities_directory.py]---
Location: zulip-main/zerver/migrations/0394_alter_realm_want_advertise_in_communities_directory.py
Signals: Django

```python
# Generated by Django 3.2.13 on 2022-05-18 07:33

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0393_realm_want_advertise_in_communities_directory"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="want_advertise_in_communities_directory",
            field=models.BooleanField(db_index=True, default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0395_alter_realm_wildcard_mention_policy.py]---
Location: zulip-main/zerver/migrations/0395_alter_realm_wildcard_mention_policy.py
Signals: Django

```python
# Generated by Django 3.2.13 on 2022-07-05 12:23

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_wildcard_mention_policy_stream_admins_value(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    WILDCARD_MENTION_POLICY_STREAM_ADMINS = 4
    WILDCARD_MENTION_POLICY_ADMINS = 5
    Realm.objects.filter(wildcard_mention_policy=WILDCARD_MENTION_POLICY_STREAM_ADMINS).update(
        wildcard_mention_policy=WILDCARD_MENTION_POLICY_ADMINS
    )


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0394_alter_realm_want_advertise_in_communities_directory"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="wildcard_mention_policy",
            field=models.PositiveSmallIntegerField(default=5),
        ),
        migrations.RunPython(fix_wildcard_mention_policy_stream_admins_value, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0396_remove_subscription_role.py]---
Location: zulip-main/zerver/migrations/0396_remove_subscription_role.py
Signals: Django

```python
# Generated by Django 3.2.13 on 2022-07-05 12:44

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0395_alter_realm_wildcard_mention_policy"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="subscription",
            name="role",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0397_remove_custom_field_values_for_deleted_options.py]---
Location: zulip-main/zerver/migrations/0397_remove_custom_field_values_for_deleted_options.py
Signals: Django

```python
# Generated by Django 3.2.13 on 2022-06-17 17:39
import orjson
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def remove_custom_field_values_for_deleted_options(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    SELECT_TYPE = 3
    CustomProfileField = apps.get_model("zerver", "CustomProfileField")
    CustomProfileFieldValue = apps.get_model("zerver", "CustomProfileFieldValue")

    select_type_fields = CustomProfileField.objects.filter(field_type=SELECT_TYPE)
    for field in select_type_fields:
        field_data = orjson.loads(field.field_data)
        current_options = list(field_data.keys())
        CustomProfileFieldValue.objects.filter(field=field).exclude(
            value__in=current_options
        ).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0396_remove_subscription_role"),
    ]

    operations = [
        migrations.RunPython(
            remove_custom_field_values_for_deleted_options,
            elidable=True,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0398_tsvector_statistics.py]---
Location: zulip-main/zerver/migrations/0398_tsvector_statistics.py
Signals: Django

```python
# Generated by Django 4.0.6 on 2022-07-18 23:22

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0397_remove_custom_field_values_for_deleted_options"),
    ]

    operations = [
        # The "most common values" list for a tsvector is 10x this
        # number, which defaults to 100.  Increasing it allows for
        # better query planning, at a small cost of size, and
        # `ANALYZE` time.  It only takes effect after the next
        # `ANALYZE`, which we run immediately.
        migrations.RunSQL(
            sql="ALTER TABLE zerver_message ALTER COLUMN search_tsvector SET STATISTICS 10000",
            reverse_sql="ALTER TABLE zerver_message ALTER COLUMNS search_tsvector SET STATISTICS -1",
        ),
        migrations.RunSQL(
            sql="ANALYZE zerver_message",
            reverse_sql=migrations.RunSQL.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0399_preregistrationuser_multiuse_invite.py]---
Location: zulip-main/zerver/migrations/0399_preregistrationuser_multiuse_invite.py
Signals: Django

```python
# Generated by Django 4.0.6 on 2022-07-21 20:10

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0398_tsvector_statistics"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationuser",
            name="multiuse_invite",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.SET_NULL, to="zerver.multiuseinvite"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0400_realmreactivationstatus.py]---
Location: zulip-main/zerver/migrations/0400_realmreactivationstatus.py
Signals: Django

```python
# Generated by Django 4.0.6 on 2022-07-25 20:31

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0399_preregistrationuser_multiuse_invite"),
    ]

    operations = [
        migrations.CreateModel(
            name="RealmReactivationStatus",
            fields=[
                (
                    "id",
                    models.AutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("status", models.IntegerField(default=0)),
                (
                    "realm",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="zerver.realm"
                    ),
                ),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0401_migrate_old_realm_reactivation_links.py]---
Location: zulip-main/zerver/migrations/0401_migrate_old_realm_reactivation_links.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def fix_old_realm_reactivation_confirmations(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    """
    Migration 0400_realmreactivationstatus changed REALM_REACTIVATION Confirmation
    to have a RealmReactivationStatus instance as .content_object. Now we need to migrate
    pre-existing REALM_REACTIVATION Confirmations to follow this format.

    The process is a bit fiddly because Confirmation.content_object is a GenericForeignKey,
    which can't be directly accessed in migration code, so changing it involves manually
    updating the .object_id and .content_type attributes underpinning it.

    For these old Confirmation we don't have a mechanism for tracking which have been used,
    so it's safest to just revoke them all. If any users need a realm reactivation link, it
    can just be re-generated.
    """
    REALM_REACTIVATION = 8

    RealmReactivationStatus = apps.get_model("zerver", "RealmReactivationStatus")
    Realm = apps.get_model("zerver", "Realm")
    Confirmation = apps.get_model("confirmation", "Confirmation")
    ContentType = apps.get_model("contenttypes", "ContentType")

    if not Confirmation.objects.filter(type=REALM_REACTIVATION).exists():
        # No relevant Confirmations so nothing to do, and the database may actually
        # no be provisioned yet, which would make the code below break.
        return

    # .content_type of these old Confirmation will be changed to this.
    realm_reactivation_status_content_type, _created = ContentType.objects.get_or_create(
        model="realmreactivationstatus", app_label="zerver"
    )

    for confirmation in Confirmation.objects.filter(type=REALM_REACTIVATION):
        if confirmation.content_type_id == realm_reactivation_status_content_type.id:
            # This Confirmation is already in the new format.
            continue

        assert confirmation.content_type.model == "realm"
        realm_object_id = confirmation.object_id

        # Sanity check that the realm exists.
        try:
            Realm.objects.get(id=realm_object_id)
        except Realm.DoesNotExist:
            print(
                f"Confirmation {confirmation.id} is tied to realm_id {realm_object_id} which doesn't exist. "
                "This is unexpected! Skipping migrating it."
            )
            continue

        # We create the object with STATUS_REVOKED.
        new_content_object = RealmReactivationStatus(realm_id=realm_object_id, status=2)
        new_content_object.save()

        # Now we can finally change the .content_object. This is done by setting
        # .content_type to the correct ContentType as mentioned above and the object_id
        # to the id of the RealmReactivationStatus instance that's supposed to be
        # the content_object. This works because .content_object is dynamically
        # derived by django from the .content_type and object_id values.
        confirmation.content_type_id = realm_reactivation_status_content_type
        confirmation.object_id = new_content_object.id
        confirmation.save()


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0400_realmreactivationstatus"),
    ]

    operations = [
        migrations.RunPython(fix_old_realm_reactivation_confirmations, elidable=True),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0402_alter_usertopic_visibility_policy.py]---
Location: zulip-main/zerver/migrations/0402_alter_usertopic_visibility_policy.py
Signals: Django

```python
# Generated by Django 4.0.6 on 2022-08-01 20:40

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0401_migrate_old_realm_reactivation_links"),
    ]

    operations = [
        migrations.AlterField(
            model_name="usertopic",
            name="visibility_policy",
            field=models.SmallIntegerField(
                choices=[
                    (1, "Muted topic"),
                    (2, "Unmuted topic in muted stream"),
                    (3, "Followed topic"),
                    (0, "User's default policy for the stream."),
                ],
                default=1,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

````
