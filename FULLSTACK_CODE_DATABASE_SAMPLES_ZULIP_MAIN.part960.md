---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:14Z
part: 960
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 960 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: 0736_alter_stream_can_delete_own_message_group.py]---
Location: zulip-main/zerver/migrations/0736_alter_stream_can_delete_own_message_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-26 13:24

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0735_set_default_value_for_can_delete_own_message_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_delete_own_message_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0737_realm_can_set_delete_message_policy_group.py]---
Location: zulip-main/zerver/migrations/0737_realm_can_set_delete_message_policy_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-26 12:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0736_alter_stream_can_delete_own_message_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="can_set_delete_message_policy_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0738_set_default_value_for_can_set_delete_message_policy_group.py]---
Location: zulip-main/zerver/migrations/0738_set_default_value_for_can_set_delete_message_policy_group.py
Signals: Django

```python
from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import OuterRef


def set_default_value_for_can_set_delete_message_policy_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")

    MODERATORS_GROUP_NAME = "role:moderators"

    Realm.objects.filter(can_set_delete_message_policy_group=None).update(
        can_set_delete_message_policy_group=NamedUserGroup.objects.filter(
            name=MODERATORS_GROUP_NAME, realm=OuterRef("id"), is_system_group=True
        ).values("pk")
    )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0737_realm_can_set_delete_message_policy_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_can_set_delete_message_policy_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0739_alter_realm_can_set_delete_message_policy_group.py]---
Location: zulip-main/zerver/migrations/0739_alter_realm_can_set_delete_message_policy_group.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-26 12:55

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0738_set_default_value_for_can_set_delete_message_policy_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="realm",
            name="can_set_delete_message_policy_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0740_pushdevicetoken_apns_case_insensitive.py]---
Location: zulip-main/zerver/migrations/0740_pushdevicetoken_apns_case_insensitive.py
Signals: Django

```python
import django.db.models.functions.text
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0739_alter_realm_can_set_delete_message_policy_group"),
    ]

    operations = [
        # Update the last_updated to the max for any set of (user_id, kind=1, lower(token))
        migrations.RunSQL(
            """
            WITH dups AS (
              SELECT user_id, kind, LOWER(token) AS token, MAX(last_updated) AS max_last_updated
                FROM zerver_pushdevicetoken
               WHERE kind = 1
               GROUP BY user_id, kind, LOWER(token)
              HAVING COUNT(*) > 1
            )
            UPDATE zerver_pushdevicetoken
               SET last_updated = dups.max_last_updated
              FROM dups
             WHERE zerver_pushdevicetoken.user_id = dups.user_id
               AND zerver_pushdevicetoken.kind = dups.kind
               AND LOWER(zerver_pushdevicetoken.token) = dups.token
            """
        ),
        # And then delete all but the first of each of those sets
        migrations.RunSQL(
            """
            WITH dups AS (
              SELECT user_id, kind, LOWER(token) AS token, MIN(id) AS min_id
                FROM zerver_pushdevicetoken
               WHERE kind = 1
               GROUP BY user_id, kind, LOWER(token)
              HAVING COUNT(*) > 1
            )
            DELETE FROM zerver_pushdevicetoken
             USING dups
             WHERE zerver_pushdevicetoken.user_id = dups.user_id
               AND zerver_pushdevicetoken.kind = dups.kind
               AND LOWER(zerver_pushdevicetoken.token) = dups.token
               AND zerver_pushdevicetoken.id != dups.min_id
            """
        ),
        migrations.AddConstraint(
            model_name="pushdevicetoken",
            constraint=models.UniqueConstraint(
                models.F("user_id"),
                models.F("kind"),
                django.db.models.functions.text.Lower(models.F("token")),
                condition=models.Q(("kind", 1)),
                name="zerver_pushdevicetoken_apns_user_kind_token",
            ),
        ),
        migrations.AddConstraint(
            model_name="pushdevicetoken",
            constraint=models.UniqueConstraint(
                models.F("user_id"),
                models.F("kind"),
                models.F("token"),
                condition=models.Q(("kind", 2)),
                name="zerver_pushdevicetoken_fcm_user_kind_token",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="pushdevicetoken",
            unique_together=set(),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0741_pushdevice_zerver_pushdevice_user_bouncer_device_id_idx.py]---
Location: zulip-main/zerver/migrations/0741_pushdevice_zerver_pushdevice_user_bouncer_device_id_idx.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-22 11:57

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0740_pushdevicetoken_apns_case_insensitive"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="pushdevice",
            index=models.Index(
                condition=models.Q(("bouncer_device_id__isnull", False)),
                fields=["user", "bouncer_device_id"],
                name="zerver_pushdevice_user_bouncer_device_id_idx",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0742_usermessage_zerver_usermessage_is_private_unread_message_id.py]---
Location: zulip-main/zerver/migrations/0742_usermessage_zerver_usermessage_is_private_unread_message_id.py
Signals: Django

```python
from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0741_pushdevice_zerver_pushdevice_user_bouncer_device_id_idx"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="usermessage",
            index=models.Index(
                models.F("user_profile"),
                models.F("message"),
                condition=models.Q(("flags__andnz", 2048), ("flags__andz", 1)),
                name="zerver_usermessage_is_private_unread_message_id",
            ),
        ),
        migrations.RunSQL("ANALYZE zerver_usermessage"),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0743_realm_require_e2ee_push_notifications.py]---
Location: zulip-main/zerver/migrations/0743_realm_require_e2ee_push_notifications.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-28 18:58

from django.conf import settings
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def update_require_e2ee_push_notifications(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Realm = apps.get_model("zerver", "Realm")

    # We use 'getattr' with a default value to allow this migration
    # to run in development environment when PUSH_NOTIFICATION_REDACT_CONTENT
    # setting is removed in the future.
    require_e2ee = getattr(settings, "PUSH_NOTIFICATION_REDACT_CONTENT", False)
    if require_e2ee:
        Realm.objects.update(require_e2ee_push_notifications=require_e2ee)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0742_usermessage_zerver_usermessage_is_private_unread_message_id"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="require_e2ee_push_notifications",
            field=models.BooleanField(db_default=False, default=False),
        ),
        migrations.RunPython(
            update_require_e2ee_push_notifications,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0744_alter_channelfolder_name.py]---
Location: zulip-main/zerver/migrations/0744_alter_channelfolder_name.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-28 07:42

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0743_realm_require_e2ee_push_notifications"),
    ]

    operations = [
        migrations.AlterField(
            model_name="channelfolder",
            name="name",
            field=models.CharField(max_length=60),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0745_usersetting_web_left_sidebar_show_channel_folders.py]---
Location: zulip-main/zerver/migrations/0745_usersetting_web_left_sidebar_show_channel_folders.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-08-01 08:39

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0744_alter_channelfolder_name"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_left_sidebar_show_channel_folders",
            field=models.BooleanField(db_default=True, default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_left_sidebar_show_channel_folders",
            field=models.BooleanField(db_default=True, default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0746_alter_channelfolder_unique_together_and_more.py]---
Location: zulip-main/zerver/migrations/0746_alter_channelfolder_unique_together_and_more.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-29 09:55

import django.db.models.functions.text
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0745_usersetting_web_left_sidebar_show_channel_folders"),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name="channelfolder",
            unique_together=set(),
        ),
        migrations.AddConstraint(
            model_name="channelfolder",
            constraint=models.UniqueConstraint(
                django.db.models.functions.text.Lower("name"),
                models.F("realm"),
                condition=models.Q(("is_archived", False)),
                name="unique_realm_folder_name_when_not_archived",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0747_realmcreationstatus.py]---
Location: zulip-main/zerver/migrations/0747_realmcreationstatus.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-07-04 19:08

import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0746_alter_channelfolder_unique_together_and_more"),
    ]

    operations = [
        migrations.CreateModel(
            name="RealmCreationStatus",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True, primary_key=True, serialize=False, verbose_name="ID"
                    ),
                ),
                ("status", models.IntegerField(default=0)),
                ("date_created", models.DateTimeField(default=django.utils.timezone.now)),
                ("presume_email_valid", models.BooleanField(default=False)),
            ],
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0748_channelfolder_add_order.py]---
Location: zulip-main/zerver/migrations/0748_channelfolder_add_order.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-08-05 08:53

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models.functions import Lower


def migrate_set_order_value(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    Realm = apps.get_model("zerver", "Realm")
    ChannelFolder = apps.get_model("zerver", "ChannelFolder")

    realms = Realm.objects.all()

    for realm in realms:
        channel_folders = list(
            ChannelFolder.objects.filter(realm_id=realm.id)
            .annotate(lower_name=Lower("name"))
            .order_by("lower_name")
        )

        for index, folder in enumerate(channel_folders):
            folder.order = index

        ChannelFolder.objects.bulk_update(channel_folders, ["order"])


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0747_realmcreationstatus"),
    ]

    operations = [
        migrations.AddField(
            model_name="channelfolder",
            name="order",
            field=models.IntegerField(default=0),
        ),
        migrations.RunPython(
            migrate_set_order_value, reverse_code=migrations.RunPython.noop, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0749_scheduledmessage_reminder_note_text.py]---
Location: zulip-main/zerver/migrations/0749_scheduledmessage_reminder_note_text.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-31 03:31

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0748_channelfolder_add_order"),
    ]

    operations = [
        migrations.AddField(
            model_name="scheduledmessage",
            name="reminder_note",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0750_multiuseinvite_welcome_message_custom_text_and_more.py]---
Location: zulip-main/zerver/migrations/0750_multiuseinvite_welcome_message_custom_text_and_more.py
Signals: Django

```python
# Generated by Django 5.2.3 on 2025-06-28 19:12

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0749_scheduledmessage_reminder_note_text"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="welcome_message_custom_text",
            field=models.TextField(default=""),
        ),
        migrations.AddField(
            model_name="multiuseinvite",
            name="welcome_message_custom_text",
            field=models.TextField(null=True),
        ),
        migrations.AddField(
            model_name="preregistrationuser",
            name="welcome_message_custom_text",
            field=models.TextField(null=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0751_externalauthid_zerver_user_externalauth_uniq.py]---
Location: zulip-main/zerver/migrations/0751_externalauthid_zerver_user_externalauth_uniq.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-08-12 18:15

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0750_multiuseinvite_welcome_message_custom_text_and_more"),
    ]

    operations = [
        migrations.AddConstraint(
            model_name="externalauthid",
            constraint=models.UniqueConstraint(
                fields=("user", "external_auth_method_name"), name="zerver_user_externalauth_uniq"
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0752_remove_stream_is_in_zephyr_realm.py]---
Location: zulip-main/zerver/migrations/0752_remove_stream_is_in_zephyr_realm.py
Signals: Django

```python
# Generated by Django 5.2.6 on 2025-09-08 21:01

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0751_externalauthid_zerver_user_externalauth_uniq"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="stream",
            name="is_in_zephyr_realm",
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0753_remove_google_blob_emojiset.py]---
Location: zulip-main/zerver/migrations/0753_remove_google_blob_emojiset.py
Signals: Django

```python
# Generated by Django 5.2.6 on 2025-10-01 18:23

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def remove_google_blob(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    UserProfile = apps.get_model("zerver", "UserProfile")
    RealmUserDefault = apps.get_model("zerver", "RealmUserDefault")

    UserProfile.objects.filter(emojiset="google-blob").update(emojiset="google")
    RealmUserDefault.objects.filter(emojiset="google-blob").update(emojiset="google")


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0751_externalauthid_zerver_user_externalauth_uniq"),
    ]

    operations = [
        migrations.RunPython(remove_google_blob, elidable=True),
        migrations.AlterField(
            model_name="realmuserdefault",
            name="emojiset",
            field=models.CharField(
                choices=[("google", "Google"), ("twitter", "Twitter"), ("text", "Plain text")],
                default="google",
                max_length=20,
            ),
        ),
        migrations.AlterField(
            model_name="userprofile",
            name="emojiset",
            field=models.CharField(
                choices=[("google", "Google"), ("twitter", "Twitter"), ("text", "Plain text")],
                default="google",
                max_length=20,
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0754_merge_20251014_1855.py]---
Location: zulip-main/zerver/migrations/0754_merge_20251014_1855.py
Signals: Django

```python
# Generated by Django 5.2.6 on 2025-10-14 18:55

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0752_remove_stream_is_in_zephyr_realm"),
        ("zerver", "0753_remove_google_blob_emojiset"),
    ]

    operations = []
```

--------------------------------------------------------------------------------

---[FILE: 0755_usermessage_zerver_usermessage_message_active_mobile_push_notification_idx.py]---
Location: zulip-main/zerver/migrations/0755_usermessage_zerver_usermessage_message_active_mobile_push_notification_idx.py
Signals: Django

```python
# Generated by Django 5.2.7 on 2025-10-29 05:28

from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0754_merge_20251014_1855"),
    ]

    operations = [
        AddIndexConcurrently(
            model_name="usermessage",
            index=models.Index(
                models.F("message"),
                condition=models.Q(("flags__andnz", 4096)),
                name="zerver_usermessage_message_active_mobile_push_notification_idx",
            ),
        ),
        migrations.RunSQL("ANALYZE zerver_usermessage"),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0756_handle_same_anonymous_group_used_for_multiple_streams.py]---
Location: zulip-main/zerver/migrations/0756_handle_same_anonymous_group_used_for_multiple_streams.py
Signals: Django

```python
# Generated by Django 5.2.6 on 2025-09-22 15:11

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Value


def handle_same_anonymous_group_used_for_multiple_streams(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "Stream")
    Realm = apps.get_model("zerver", "Realm")
    UserGroup = apps.get_model("zerver", "UserGroup")
    UserGroupMembership = apps.get_model("zerver", "UserGroupMembership")
    GroupGroupMembership = apps.get_model("zerver", "GroupGroupMembership")

    STREAM_GROUP_PERMISSION_SETTINGS_TO_UPDATE = [
        # IMPORTANT: This is a list of the groups that existed at the
        # time of the migration, and should never be updated.
        "can_add_subscribers_group",
        "can_administer_channel_group",
        "can_delete_any_message_group",
        "can_delete_own_message_group",
        "can_move_messages_out_of_channel_group",
        "can_move_messages_within_channel_group",
        "can_remove_subscribers_group",
        "can_resolve_topics_group",
        "can_send_message_group",
        "can_subscribe_group",
    ]

    def get_members_and_subgroups_of_groups(
        group_ids: list[int],
    ) -> dict[int, dict[str, list[int]]]:
        user_members = (
            UserGroupMembership.objects.filter(user_group_id__in=group_ids)
            .annotate(
                member_type=Value("user"),
            )
            .values_list("member_type", "user_group_id", "user_profile_id")
        )

        group_subgroups = (
            GroupGroupMembership.objects.filter(supergroup_id__in=group_ids)
            .annotate(
                member_type=Value("group"),
            )
            .values_list("member_type", "supergroup_id", "subgroup_id")
        )

        results_dict: dict[int, dict[str, list[int]]] = dict()
        for group_id in group_ids:
            results_dict[group_id] = dict(direct_members=[], direct_subgroups=[])

        all_members = user_members.union(group_subgroups)
        for member_type, group_id, member_id in all_members:
            members_dict = results_dict[group_id]
            if member_type == "user":
                members_dict["direct_members"].append(member_id)
            else:
                members_dict["direct_subgroups"].append(member_id)

        return results_dict

    for realm in Realm.objects.all().iterator():
        anonymous_group_ids = UserGroup.objects.filter(
            realm=realm, named_user_group=None
        ).values_list("id", flat=True)
        members_dict = get_members_and_subgroups_of_groups(anonymous_group_ids)

        used_anonymous_group_ids = set()
        user_groups_to_create = []
        streams_to_update = []
        updated_fields = set()

        user_group_memberships_to_create = []
        subgroup_memberships_to_create = []

        for stream in Stream.objects.filter(realm=realm):
            stream_updated = False
            for setting_name in STREAM_GROUP_PERMISSION_SETTINGS_TO_UPDATE:
                setting_group_id = getattr(stream, setting_name + "_id")
                if setting_group_id in anonymous_group_ids:
                    if setting_group_id not in used_anonymous_group_ids:
                        used_anonymous_group_ids.add(setting_group_id)
                        continue

                    # We have an anonymous group that was used twice;
                    # correct this database corruption by creating a
                    # new anonymous group duplicating its contents.
                    print(
                        f"Fixing duplicate anonymous group for channel {stream.id} / {setting_name}"
                    )
                    user_group = UserGroup(realm=realm)
                    setattr(stream, setting_name, user_group)

                    user_groups_to_create.append(user_group)
                    user_group_memberships_to_create.extend(
                        [
                            UserGroupMembership(user_group=user_group, user_profile_id=user_id)
                            for user_id in members_dict[setting_group_id]["direct_members"]
                        ]
                    )
                    subgroup_memberships_to_create.extend(
                        [
                            GroupGroupMembership(supergroup=user_group, subgroup_id=subgroup_id)
                            for subgroup_id in members_dict[setting_group_id]["direct_subgroups"]
                        ]
                    )

                    updated_fields.add(setting_name)
                    stream_updated = True

            if stream_updated:
                streams_to_update.append(stream)

        if streams_to_update:
            with transaction.atomic():
                UserGroup.objects.bulk_create(user_groups_to_create)
                Stream.objects.bulk_update(streams_to_update, fields=updated_fields)
                UserGroupMembership.objects.bulk_create(user_group_memberships_to_create)
                GroupGroupMembership.objects.bulk_create(subgroup_memberships_to_create)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        (
            "zerver",
            "0755_usermessage_zerver_usermessage_message_active_mobile_push_notification_idx",
        ),
    ]

    operations = [
        migrations.RunPython(
            handle_same_anonymous_group_used_for_multiple_streams,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        )
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0757_realmuserdefault_web_inbox_show_channel_folders_and_more.py]---
Location: zulip-main/zerver/migrations/0757_realmuserdefault_web_inbox_show_channel_folders_and_more.py
Signals: Django

```python
# Generated by Django 5.2.7 on 2025-11-05 18:54

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0756_handle_same_anonymous_group_used_for_multiple_streams"),
    ]

    operations = [
        migrations.AddField(
            model_name="realmuserdefault",
            name="web_inbox_show_channel_folders",
            field=models.BooleanField(db_default=True, default=True),
        ),
        migrations.AddField(
            model_name="userprofile",
            name="web_inbox_show_channel_folders",
            field=models.BooleanField(db_default=True, default=True),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0758_remove_pushdevice_push_public_key_and_more.py]---
Location: zulip-main/zerver/migrations/0758_remove_pushdevice_push_public_key_and_more.py
Signals: Django

```python
# Generated by Django 5.2.6 on 2025-10-15 14:12

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0757_realmuserdefault_web_inbox_show_channel_folders_and_more"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="pushdevice",
            name="push_public_key",
        ),
        migrations.AddField(
            model_name="pushdevice",
            name="push_key",
            field=models.BinaryField(default=None),
            preserve_default=False,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0759_userprofile_is_imported_stub.py]---
Location: zulip-main/zerver/migrations/0759_userprofile_is_imported_stub.py
Signals: Django

```python
# Generated by Django 5.2.6 on 2025-10-08 10:03

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0758_remove_pushdevice_push_public_key_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="is_imported_stub",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0760_preregistrationuser_is_realm_importer.py]---
Location: zulip-main/zerver/migrations/0760_preregistrationuser_is_realm_importer.py
Signals: Django

```python
# Generated by Django 5.2.7 on 2025-11-10 15:28

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0759_userprofile_is_imported_stub"),
    ]

    operations = [
        migrations.AddField(
            model_name="preregistrationuser",
            name="is_realm_importer",
            field=models.BooleanField(default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0761_realm_send_channel_events_messages.py]---
Location: zulip-main/zerver/migrations/0761_realm_send_channel_events_messages.py
Signals: Django

```python
# Generated by Django 5.2.7 on 2025-11-08 13:55

from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def set_send_channel_events_messages_for_existing_organizations(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    # We're preserving the `True` prior behavior for existing organizations,
    # while setting the default for new organizations to `False`.
    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.all().update(send_channel_events_messages=True)


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0760_preregistrationuser_is_realm_importer"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="send_channel_events_messages",
            field=models.BooleanField(default=False),
        ),
        migrations.RunPython(
            set_send_channel_events_messages_for_existing_organizations, elidable=True
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0762_realm_owner_full_content_access.py]---
Location: zulip-main/zerver/migrations/0762_realm_owner_full_content_access.py
Signals: Django

```python
# Generated by Django 5.2.7 on 2025-11-27 00:00

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0761_realm_send_channel_events_messages"),
    ]

    operations = [
        migrations.AddField(
            model_name="realm",
            name="owner_full_content_access",
            field=models.BooleanField(default=False, db_default=False),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0763_migrate_realms_using_y_rating_to_use_a_g_rating_for_giphy.py]---
Location: zulip-main/zerver/migrations/0763_migrate_realms_using_y_rating_to_use_a_g_rating_for_giphy.py
Signals: Django

```python
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def use_a_g_rating_instead_of_y_rating(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    # Apparently, GIPHY removed the "Y" rating at some point; so we
    # need to consolidate/collapse our rating level configuration. We
    # round "Y" to the nearest remaining value, "G".
    #
    # The previous mapping was 1->Y, 2->G, 3->PG, 4->PG-13, 5->R
    # We now shift that to 1->G, 2->PG, 3->PG-13, 4->R
    Realm = apps.get_model("zerver", "Realm")
    Realm.objects.filter(giphy_rating__gte=2).update(giphy_rating=models.F("giphy_rating") - 1)


class Migration(migrations.Migration):
    dependencies = [("zerver", "0762_realm_owner_full_content_access")]
    operations = [
        migrations.RunPython(use_a_g_rating_instead_of_y_rating),
        migrations.AlterField(
            model_name="realm",
            name="giphy_rating",
            field=models.PositiveSmallIntegerField(default=1),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0764_stream_can_create_topic_group.py]---
Location: zulip-main/zerver/migrations/0764_stream_can_create_topic_group.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-20 18:22

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        (
            "zerver",
            "0763_migrate_realms_using_y_rating_to_use_a_g_rating_for_giphy",
        ),
    ]

    operations = [
        migrations.AddField(
            model_name="stream",
            name="can_create_topic_group",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0765_set_default_can_create_topic_group.py]---
Location: zulip-main/zerver/migrations/0765_set_default_can_create_topic_group.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-20 18:24

from django.db import migrations, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min, OuterRef


def set_default_value_for_stream_can_create_topic_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    Stream = apps.get_model("zerver", "stream")
    NamedUserGroup = apps.get_model("zerver", "NamedUserGroup")
    BATCH_SIZE = 1000

    max_id = Stream.objects.filter(can_create_topic_group=None).aggregate(Max("id"))["id__max"]
    if max_id is None:
        # Do nothing if there are no channels on the server.
        return

    lower_bound = Stream.objects.filter(can_create_topic_group=None).aggregate(Min("id"))["id__min"]
    while lower_bound <= max_id + BATCH_SIZE / 2:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Stream")

        with transaction.atomic():
            Stream.objects.filter(
                id__range=(lower_bound, upper_bound),
                can_create_topic_group=None,
            ).update(
                can_create_topic_group=NamedUserGroup.objects.filter(
                    name="role:everyone",
                    realm_for_sharding=OuterRef("realm_id"),
                    is_system_group=True,
                ).values("pk")
            )

        lower_bound += BATCH_SIZE


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("zerver", "0764_stream_can_create_topic_group"),
    ]

    operations = [
        migrations.RunPython(
            set_default_value_for_stream_can_create_topic_group,
            elidable=True,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0766_alter_stream_can_create_topic_group.py]---
Location: zulip-main/zerver/migrations/0766_alter_stream_can_create_topic_group.py
Signals: Django

```python
# Generated by Django 5.2.4 on 2025-07-20 18:26

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("zerver", "0765_set_default_can_create_topic_group"),
    ]

    operations = [
        migrations.AlterField(
            model_name="stream",
            name="can_create_topic_group",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.RESTRICT,
                related_name="+",
                to="zerver.usergroup",
            ),
        ),
    ]
```

--------------------------------------------------------------------------------

---[FILE: 0767_rename_zoom_token_to_video_call_provider_tokens.py]---
Location: zulip-main/zerver/migrations/0767_rename_zoom_token_to_video_call_provider_tokens.py
Signals: Django

```python
# Generated by Django 5.2.7 on 2025-11-21 13:51

from django.db import migrations, models, transaction
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps
from django.db.models import Max, Min


def migrate_existing_zoom_tokens(apps: StateApps, schema_editor: BaseDatabaseSchemaEditor) -> None:
    BATCH_SIZE = 10000
    UserProfile = apps.get_model("zerver", "UserProfile")

    applicable_user_rows = UserProfile.objects.filter(zoom_token__isnull=False)
    max_id = applicable_user_rows.aggregate(Max("id"))["id__max"]
    lower_bound = applicable_user_rows.aggregate(Min("id"))["id__min"]

    if max_id is None or lower_bound is None:
        # no users to migrate
        return

    while lower_bound <= max_id:
        upper_bound = lower_bound + BATCH_SIZE - 1
        print(f"Processing batch {lower_bound} to {upper_bound} for Zoom token migration")
        with transaction.atomic():
            users = applicable_user_rows.filter(id__gte=lower_bound, id__lte=upper_bound)
            for user in users.iterator():
                user.third_party_api_state["zoom"] = user.zoom_token
                user.save(update_fields=["third_party_api_state"])
        lower_bound = upper_bound + 1


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("zerver", "0766_alter_stream_can_create_topic_group"),
    ]

    operations = [
        migrations.AddField(
            model_name="userprofile",
            name="third_party_api_state",
            field=models.JSONField(default=dict, db_default={}),
        ),
        migrations.RunPython(migrate_existing_zoom_tokens, reverse_code=migrations.RunPython.noop),
        migrations.RemoveField(
            model_name="userprofile",
            name="zoom_token",
        ),
    ]
```

--------------------------------------------------------------------------------

````
