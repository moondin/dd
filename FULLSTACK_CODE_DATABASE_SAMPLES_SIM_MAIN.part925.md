---
source_txt: fullstack_samples/sim-main
converted_utc: 2025-12-18T11:26:37Z
part: 925
parts_total: 933
---

# FULLSTACK CODE DATABASE SAMPLES sim-main

## Verbatim Content (Part 925 of 933)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - sim-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/sim-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: _journal.json]---
Location: sim-main/packages/db/migrations/meta/_journal.json

```json
{
  "version": "7",
  "dialect": "postgresql",
  "entries": [
    {
      "idx": 0,
      "version": "7",
      "when": 1739697832964,
      "tag": "0000_careless_black_knight",
      "breakpoints": true
    },
    {
      "idx": 1,
      "version": "7",
      "when": 1739773751302,
      "tag": "0001_foamy_dakota_north",
      "breakpoints": true
    },
    {
      "idx": 2,
      "version": "7",
      "when": 1739776634326,
      "tag": "0002_previous_xavin",
      "breakpoints": true
    },
    {
      "idx": 3,
      "version": "7",
      "when": 1739818168546,
      "tag": "0003_smiling_hammerhead",
      "breakpoints": true
    },
    {
      "idx": 4,
      "version": "7",
      "when": 1739819841402,
      "tag": "0004_nasty_mesmero",
      "breakpoints": true
    },
    {
      "idx": 5,
      "version": "7",
      "when": 1739938301181,
      "tag": "0005_shocking_domino",
      "breakpoints": true
    },
    {
      "idx": 6,
      "version": "7",
      "when": 1739939661615,
      "tag": "0006_plain_zzzax",
      "breakpoints": true
    },
    {
      "idx": 7,
      "version": "7",
      "when": 1739995526085,
      "tag": "0007_mute_stepford_cuckoos",
      "breakpoints": true
    },
    {
      "idx": 8,
      "version": "7",
      "when": 1740004147676,
      "tag": "0008_quick_paladin",
      "breakpoints": true
    },
    {
      "idx": 9,
      "version": "7",
      "when": 1740336159745,
      "tag": "0009_cynical_bullseye",
      "breakpoints": true
    },
    {
      "idx": 10,
      "version": "7",
      "when": 1740340257207,
      "tag": "0010_flashy_nebula",
      "breakpoints": true
    },
    {
      "idx": 11,
      "version": "7",
      "when": 1740340299261,
      "tag": "0011_youthful_iron_lad",
      "breakpoints": true
    },
    {
      "idx": 12,
      "version": "7",
      "when": 1741040211301,
      "tag": "0012_minor_dexter_bennett",
      "breakpoints": true
    },
    {
      "idx": 13,
      "version": "7",
      "when": 1741380466542,
      "tag": "0013_dusty_aaron_stack",
      "breakpoints": true
    },
    {
      "idx": 14,
      "version": "7",
      "when": 1741390762290,
      "tag": "0014_nice_dragon_lord",
      "breakpoints": true
    },
    {
      "idx": 15,
      "version": "7",
      "when": 1742039670528,
      "tag": "0015_brief_martin_li",
      "breakpoints": true
    },
    {
      "idx": 16,
      "version": "7",
      "when": 1742197359430,
      "tag": "0016_cultured_butterfly",
      "breakpoints": true
    },
    {
      "idx": 17,
      "version": "7",
      "when": 1742342896119,
      "tag": "0017_curious_ink",
      "breakpoints": true
    },
    {
      "idx": 18,
      "version": "7",
      "when": 1742441034244,
      "tag": "0018_sleepy_champions",
      "breakpoints": true
    },
    {
      "idx": 19,
      "version": "7",
      "when": 1742550910792,
      "tag": "0019_even_lorna_dane",
      "breakpoints": true
    },
    {
      "idx": 20,
      "version": "7",
      "when": 1742552444912,
      "tag": "0020_clear_skreet",
      "breakpoints": true
    },
    {
      "idx": 21,
      "version": "7",
      "when": 1742850849852,
      "tag": "0021_shocking_korath",
      "breakpoints": true
    },
    {
      "idx": 22,
      "version": "7",
      "when": 1742889909342,
      "tag": "0022_gray_galactus",
      "breakpoints": true
    },
    {
      "idx": 23,
      "version": "7",
      "when": 1743024111706,
      "tag": "0023_nervous_tyger_tiger",
      "breakpoints": true
    },
    {
      "idx": 24,
      "version": "7",
      "when": 1743642824678,
      "tag": "0024_next_whizzer",
      "breakpoints": true
    },
    {
      "idx": 25,
      "version": "7",
      "when": 1743643010845,
      "tag": "0025_curved_jubilee",
      "breakpoints": true
    },
    {
      "idx": 26,
      "version": "7",
      "when": 1743654486007,
      "tag": "0026_daily_killraven",
      "breakpoints": true
    },
    {
      "idx": 27,
      "version": "7",
      "when": 1743667795545,
      "tag": "0027_careless_gamora",
      "breakpoints": true
    },
    {
      "idx": 28,
      "version": "7",
      "when": 1744693636978,
      "tag": "0028_absent_triton",
      "breakpoints": true
    },
    {
      "idx": 30,
      "version": "7",
      "when": 1745519847269,
      "tag": "0030_happy_joseph",
      "breakpoints": true
    },
    {
      "idx": 31,
      "version": "7",
      "when": 1745638714702,
      "tag": "0031_lively_nico_minoru",
      "breakpoints": true
    },
    {
      "idx": 32,
      "version": "7",
      "when": 1745973220228,
      "tag": "0032_rare_nico_minoru",
      "breakpoints": true
    },
    {
      "idx": 33,
      "version": "7",
      "when": 1746037443324,
      "tag": "0033_solid_stellaris",
      "breakpoints": true
    },
    {
      "idx": 34,
      "version": "7",
      "when": 1746167417863,
      "tag": "0034_brainy_revanche",
      "breakpoints": true
    },
    {
      "idx": 35,
      "version": "7",
      "when": 1747041949354,
      "tag": "0035_slim_energizer",
      "breakpoints": true
    },
    {
      "idx": 36,
      "version": "7",
      "when": 1747265680027,
      "tag": "0036_married_skreet",
      "breakpoints": true
    },
    {
      "idx": 37,
      "version": "7",
      "when": 1747460441992,
      "tag": "0037_outgoing_madame_hydra",
      "breakpoints": true
    },
    {
      "idx": 38,
      "version": "7",
      "when": 1747559012564,
      "tag": "0038_shocking_thor",
      "breakpoints": true
    },
    {
      "idx": 39,
      "version": "7",
      "when": 1748846346219,
      "tag": "0039_tranquil_speed",
      "breakpoints": true
    },
    {
      "idx": 40,
      "version": "7",
      "when": 1748846439041,
      "tag": "0040_silky_monster_badoon",
      "breakpoints": true
    },
    {
      "idx": 41,
      "version": "7",
      "when": 1749514555378,
      "tag": "0041_sparkling_ma_gnuci",
      "breakpoints": true
    },
    {
      "idx": 42,
      "version": "7",
      "when": 1749784177503,
      "tag": "0042_breezy_miracleman",
      "breakpoints": true
    },
    {
      "idx": 43,
      "version": "7",
      "when": 1750193663357,
      "tag": "0043_silent_the_anarchist",
      "breakpoints": true
    },
    {
      "idx": 44,
      "version": "7",
      "when": 1750369626350,
      "tag": "0044_uneven_killer_shrike",
      "breakpoints": true
    },
    {
      "idx": 45,
      "version": "7",
      "when": 1750379637336,
      "tag": "0045_sour_chameleon",
      "breakpoints": true
    },
    {
      "idx": 46,
      "version": "7",
      "when": 1750527995274,
      "tag": "0046_loose_blizzard",
      "breakpoints": true
    },
    {
      "idx": 47,
      "version": "7",
      "when": 1750794256278,
      "tag": "0047_new_triathlon",
      "breakpoints": true
    },
    {
      "idx": 48,
      "version": "7",
      "when": 1751422991828,
      "tag": "0048_flawless_ultron",
      "breakpoints": true
    },
    {
      "idx": 49,
      "version": "7",
      "when": 1751430703326,
      "tag": "0049_fancy_cardiac",
      "breakpoints": true
    },
    {
      "idx": 50,
      "version": "7",
      "when": 1751659528896,
      "tag": "0050_big_mattie_franklin",
      "breakpoints": true
    },
    {
      "idx": 51,
      "version": "7",
      "when": 1752014976338,
      "tag": "0051_typical_expediter",
      "breakpoints": true
    },
    {
      "idx": 52,
      "version": "7",
      "when": 1752019053066,
      "tag": "0052_fluffy_shinobi_shaw",
      "breakpoints": true
    },
    {
      "idx": 53,
      "version": "7",
      "when": 1752093722331,
      "tag": "0053_gigantic_gabe_jones",
      "breakpoints": true
    },
    {
      "idx": 54,
      "version": "7",
      "when": 1752708227343,
      "tag": "0054_naive_raider",
      "breakpoints": true
    },
    {
      "idx": 55,
      "version": "7",
      "when": 1752720748565,
      "tag": "0055_amused_ender_wiggin",
      "breakpoints": true
    },
    {
      "idx": 56,
      "version": "7",
      "when": 1752789061522,
      "tag": "0056_adorable_franklin_richards",
      "breakpoints": true
    },
    {
      "idx": 57,
      "version": "7",
      "when": 1752980338632,
      "tag": "0057_charming_star_brand",
      "breakpoints": true
    },
    {
      "idx": 58,
      "version": "7",
      "when": 1753211027120,
      "tag": "0058_clean_shiva",
      "breakpoints": true
    },
    {
      "idx": 59,
      "version": "7",
      "when": 1753310161586,
      "tag": "0059_odd_may_parker",
      "breakpoints": true
    },
    {
      "idx": 60,
      "version": "7",
      "when": 1753323514125,
      "tag": "0060_ordinary_nick_fury",
      "breakpoints": true
    },
    {
      "idx": 61,
      "version": "7",
      "when": 1753380613269,
      "tag": "0061_swift_doctor_spectrum",
      "breakpoints": true
    },
    {
      "idx": 62,
      "version": "7",
      "when": 1753383446084,
      "tag": "0062_previous_phantom_reporter",
      "breakpoints": true
    },
    {
      "idx": 63,
      "version": "7",
      "when": 1753558819517,
      "tag": "0063_lame_sandman",
      "breakpoints": true
    },
    {
      "idx": 64,
      "version": "7",
      "when": 1754088313157,
      "tag": "0064_elite_hedge_knight",
      "breakpoints": true
    },
    {
      "idx": 65,
      "version": "7",
      "when": 1754171385971,
      "tag": "0065_solid_newton_destine",
      "breakpoints": true
    },
    {
      "idx": 66,
      "version": "7",
      "when": 1754352106989,
      "tag": "0066_talented_mentor",
      "breakpoints": true
    },
    {
      "idx": 67,
      "version": "7",
      "when": 1754424644234,
      "tag": "0067_safe_bushwacker",
      "breakpoints": true
    },
    {
      "idx": 68,
      "version": "7",
      "when": 1754446277077,
      "tag": "0068_fine_hardball",
      "breakpoints": true
    },
    {
      "idx": 69,
      "version": "7",
      "when": 1754603754177,
      "tag": "0069_lonely_spirit",
      "breakpoints": true
    },
    {
      "idx": 70,
      "version": "7",
      "when": 1754682155062,
      "tag": "0070_charming_wrecking_crew",
      "breakpoints": true
    },
    {
      "idx": 71,
      "version": "7",
      "when": 1754719531015,
      "tag": "0071_free_sharon_carter",
      "breakpoints": true
    },
    {
      "idx": 72,
      "version": "7",
      "when": 1755281098957,
      "tag": "0072_powerful_legion",
      "breakpoints": true
    },
    {
      "idx": 73,
      "version": "7",
      "when": 1755286337930,
      "tag": "0073_hot_champions",
      "breakpoints": true
    },
    {
      "idx": 74,
      "version": "7",
      "when": 1755304368539,
      "tag": "0074_abnormal_dreadnoughts",
      "breakpoints": true
    },
    {
      "idx": 75,
      "version": "7",
      "when": 1755319635487,
      "tag": "0075_lush_moonstone",
      "breakpoints": true
    },
    {
      "idx": 76,
      "version": "7",
      "when": 1755375658161,
      "tag": "0076_damp_vector",
      "breakpoints": true
    },
    {
      "idx": 77,
      "version": "7",
      "when": 1755809024626,
      "tag": "0077_rapid_chimera",
      "breakpoints": true
    },
    {
      "idx": 78,
      "version": "7",
      "when": 1756168384465,
      "tag": "0078_supreme_madrox",
      "breakpoints": true
    },
    {
      "idx": 79,
      "version": "7",
      "when": 1756246702112,
      "tag": "0079_shocking_shriek",
      "breakpoints": true
    },
    {
      "idx": 80,
      "version": "7",
      "when": 1756581886683,
      "tag": "0080_left_riptide",
      "breakpoints": true
    },
    {
      "idx": 81,
      "version": "7",
      "when": 1756602783877,
      "tag": "0081_yellow_shadow_king",
      "breakpoints": true
    },
    {
      "idx": 82,
      "version": "7",
      "when": 1756767479124,
      "tag": "0082_light_blockbuster",
      "breakpoints": true
    },
    {
      "idx": 83,
      "version": "7",
      "when": 1756768177306,
      "tag": "0083_ambiguous_dreadnoughts",
      "breakpoints": true
    },
    {
      "idx": 84,
      "version": "7",
      "when": 1757046301281,
      "tag": "0084_even_lockheed",
      "breakpoints": true
    },
    {
      "idx": 85,
      "version": "7",
      "when": 1757348840739,
      "tag": "0085_daffy_blacklash",
      "breakpoints": true
    },
    {
      "idx": 86,
      "version": "7",
      "when": 1757441740591,
      "tag": "0086_breezy_sister_grimm",
      "breakpoints": true
    },
    {
      "idx": 87,
      "version": "7",
      "when": 1757448419436,
      "tag": "0087_wealthy_landau",
      "breakpoints": true
    },
    {
      "idx": 88,
      "version": "7",
      "when": 1757619657920,
      "tag": "0088_serious_firestar",
      "breakpoints": true
    },
    {
      "idx": 89,
      "version": "7",
      "when": 1757628623657,
      "tag": "0089_amused_pete_wisdom",
      "breakpoints": true
    },
    {
      "idx": 90,
      "version": "7",
      "when": 1757805452908,
      "tag": "0090_fearless_zaladane",
      "breakpoints": true
    },
    {
      "idx": 91,
      "version": "7",
      "when": 1758567567287,
      "tag": "0091_amusing_iron_lad",
      "breakpoints": true
    },
    {
      "idx": 92,
      "version": "7",
      "when": 1758740238058,
      "tag": "0092_mighty_kinsey_walden",
      "breakpoints": true
    },
    {
      "idx": 93,
      "version": "7",
      "when": 1758751182653,
      "tag": "0093_medical_sentinel",
      "breakpoints": true
    },
    {
      "idx": 94,
      "version": "7",
      "when": 1758998206326,
      "tag": "0094_perpetual_the_watchers",
      "breakpoints": true
    },
    {
      "idx": 95,
      "version": "7",
      "when": 1759182244521,
      "tag": "0095_cheerful_albert_cleary",
      "breakpoints": true
    },
    {
      "idx": 96,
      "version": "7",
      "when": 1759534968812,
      "tag": "0096_tranquil_arachne",
      "breakpoints": true
    },
    {
      "idx": 97,
      "version": "7",
      "when": 1759963094548,
      "tag": "0097_dazzling_mephisto",
      "breakpoints": true
    },
    {
      "idx": 98,
      "version": "7",
      "when": 1760206888564,
      "tag": "0098_thick_prima",
      "breakpoints": true
    },
    {
      "idx": 99,
      "version": "7",
      "when": 1760240967304,
      "tag": "0099_deep_sir_ram",
      "breakpoints": true
    },
    {
      "idx": 100,
      "version": "7",
      "when": 1760661127478,
      "tag": "0100_public_black_cat",
      "breakpoints": true
    },
    {
      "idx": 101,
      "version": "7",
      "when": 1761631932261,
      "tag": "0101_missing_doc_processing",
      "breakpoints": true
    },
    {
      "idx": 102,
      "version": "7",
      "when": 1761769369858,
      "tag": "0102_eminent_amphibian",
      "breakpoints": true
    },
    {
      "idx": 103,
      "version": "7",
      "when": 1761845605676,
      "tag": "0103_careful_harpoon",
      "breakpoints": true
    },
    {
      "idx": 104,
      "version": "7",
      "when": 1761848118406,
      "tag": "0104_orange_shinobi_shaw",
      "breakpoints": true
    },
    {
      "idx": 105,
      "version": "7",
      "when": 1761860659858,
      "tag": "0105_glamorous_wrecking_crew",
      "breakpoints": true
    },
    {
      "idx": 106,
      "version": "7",
      "when": 1762371130884,
      "tag": "0106_bitter_captain_midlands",
      "breakpoints": true
    },
    {
      "idx": 107,
      "version": "7",
      "when": 1762565365042,
      "tag": "0107_silky_agent_brand",
      "breakpoints": true
    },
    {
      "idx": 108,
      "version": "7",
      "when": 1762572820066,
      "tag": "0108_cuddly_scream",
      "breakpoints": true
    },
    {
      "idx": 109,
      "version": "7",
      "when": 1763503885555,
      "tag": "0109_bumpy_earthquake",
      "breakpoints": true
    },
    {
      "idx": 110,
      "version": "7",
      "when": 1763511770301,
      "tag": "0110_broken_paladin",
      "breakpoints": true
    },
    {
      "idx": 111,
      "version": "7",
      "when": 1763667488537,
      "tag": "0111_solid_dreadnoughts",
      "breakpoints": true
    },
    {
      "idx": 112,
      "version": "7",
      "when": 1764095386986,
      "tag": "0112_tired_blink",
      "breakpoints": true
    },
    {
      "idx": 113,
      "version": "7",
      "when": 1764370369484,
      "tag": "0113_calm_tiger_shark",
      "breakpoints": true
    },
    {
      "idx": 114,
      "version": "7",
      "when": 1764468360258,
      "tag": "0114_wise_sunfire",
      "breakpoints": true
    },
    {
      "idx": 115,
      "version": "7",
      "when": 1764477997303,
      "tag": "0115_redundant_cerebro",
      "breakpoints": true
    },
    {
      "idx": 116,
      "version": "7",
      "when": 1764820826997,
      "tag": "0116_flimsy_shape",
      "breakpoints": true
    },
    {
      "idx": 117,
      "version": "7",
      "when": 1764909191102,
      "tag": "0117_silly_purifiers",
      "breakpoints": true
    },
    {
      "idx": 118,
      "version": "7",
      "when": 1765231535125,
      "tag": "0118_tiresome_landau",
      "breakpoints": true
    },
    {
      "idx": 119,
      "version": "7",
      "when": 1765271011445,
      "tag": "0119_far_lethal_legion",
      "breakpoints": true
    },
    {
      "idx": 120,
      "version": "7",
      "when": 1765339999291,
      "tag": "0120_illegal_moon_knight",
      "breakpoints": true
    },
    {
      "idx": 121,
      "version": "7",
      "when": 1765434895472,
      "tag": "0121_new_mantis",
      "breakpoints": true
    },
    {
      "idx": 122,
      "version": "7",
      "when": 1765587157593,
      "tag": "0122_pale_absorbing_man",
      "breakpoints": true
    },
    {
      "idx": 123,
      "version": "7",
      "when": 1765932898404,
      "tag": "0123_windy_lockheed",
      "breakpoints": true
    }
  ]
}
```

--------------------------------------------------------------------------------

---[FILE: deregister-sso-provider.ts]---
Location: sim-main/packages/db/scripts/deregister-sso-provider.ts

```typescript
#!/usr/bin/env bun

/**
 * Deregister SSO Provider Script
 *
 * This script removes an SSO provider from the database for a specific user.
 *
 * Usage: bun run packages/db/scripts/deregister-sso-provider.ts
 *
 * Required Environment Variables:
 *   DATABASE_URL=your-database-url
 *   SSO_USER_EMAIL=user@domain.com (user whose SSO provider to remove)
 *   SSO_PROVIDER_ID=provider-id (optional, if not provided will remove all providers for user)
 */

import { and, eq } from 'drizzle-orm'
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import { ssoProvider, user } from '../schema'

// Simple console logger
const logger = {
  info: (message: string, meta?: any) => {
    const timestamp = new Date().toISOString()
    console.log(
      `[${timestamp}] [INFO] [DeregisterSSODB] ${message}`,
      meta ? JSON.stringify(meta, null, 2) : ''
    )
  },
  error: (message: string, meta?: any) => {
    const timestamp = new Date().toISOString()
    console.error(
      `[${timestamp}] [ERROR] [DeregisterSSODB] ${message}`,
      meta ? JSON.stringify(meta, null, 2) : ''
    )
  },
  warn: (message: string, meta?: any) => {
    const timestamp = new Date().toISOString()
    console.warn(
      `[${timestamp}] [WARN] [DeregisterSSODB] ${message}`,
      meta ? JSON.stringify(meta, null, 2) : ''
    )
  },
}

// Get database URL from environment
const CONNECTION_STRING = process.env.POSTGRES_URL ?? process.env.DATABASE_URL
if (!CONNECTION_STRING) {
  console.error('âŒ POSTGRES_URL or DATABASE_URL environment variable is required')
  process.exit(1)
}

const postgresClient = postgres(CONNECTION_STRING, {
  prepare: false,
  idle_timeout: 20,
  connect_timeout: 30,
  max: 10,
  onnotice: () => {},
})
const db = drizzle(postgresClient)

async function getUser(email: string): Promise<{ id: string; email: string } | null> {
  try {
    const users = await db.select().from(user).where(eq(user.email, email))
    if (users.length === 0) {
      logger.error(`No user found with email: ${email}`)
      return null
    }
    return { id: users[0].id, email: users[0].email }
  } catch (error) {
    logger.error('Failed to query user:', error)
    return null
  }
}

async function deregisterSSOProvider(): Promise<boolean> {
  try {
    const userEmail = process.env.SSO_USER_EMAIL
    if (!userEmail) {
      logger.error('âŒ SSO_USER_EMAIL environment variable is required')
      logger.error('')
      logger.error('Example usage:')
      logger.error(
        '  SSO_USER_EMAIL=admin@company.com bun run packages/db/scripts/deregister-sso-provider.ts'
      )
      logger.error('')
      logger.error('Optional: SSO_PROVIDER_ID=provider-id (to remove specific provider)')
      return false
    }

    // Get user
    const targetUser = await getUser(userEmail)
    if (!targetUser) {
      return false
    }

    logger.info(`Found user: ${targetUser.email} (ID: ${targetUser.id})`)

    // Get SSO providers for this user
    const providers = await db
      .select()
      .from(ssoProvider)
      .where(eq(ssoProvider.userId, targetUser.id))

    if (providers.length === 0) {
      logger.warn(`No SSO providers found for user: ${targetUser.email}`)
      return false
    }

    logger.info(`Found ${providers.length} SSO provider(s) for user ${targetUser.email}`)
    for (const provider of providers) {
      logger.info(`  - Provider ID: ${provider.providerId}, Domain: ${provider.domain}`)
    }

    // Check if specific provider ID was requested
    const specificProviderId = process.env.SSO_PROVIDER_ID

    if (specificProviderId) {
      // Delete specific provider
      const providerToDelete = providers.find((p) => p.providerId === specificProviderId)
      if (!providerToDelete) {
        logger.error(`Provider '${specificProviderId}' not found for user ${targetUser.email}`)
        return false
      }

      await db
        .delete(ssoProvider)
        .where(
          and(eq(ssoProvider.userId, targetUser.id), eq(ssoProvider.providerId, specificProviderId))
        )

      logger.info(
        `âœ… Successfully deleted SSO provider '${specificProviderId}' for user ${targetUser.email}`
      )
    } else {
      // Delete all providers for this user
      await db.delete(ssoProvider).where(eq(ssoProvider.userId, targetUser.id))

      logger.info(
        `âœ… Successfully deleted all ${providers.length} SSO provider(s) for user ${targetUser.email}`
      )
    }

    return true
  } catch (error) {
    logger.error('âŒ Failed to deregister SSO provider:', {
      error: error instanceof Error ? error.message : 'Unknown error',
      stack: error instanceof Error ? error.stack : undefined,
    })
    return false
  } finally {
    try {
      await postgresClient.end({ timeout: 5 })
    } catch {}
  }
}

async function main() {
  console.log('ðŸ—‘ï¸  Deregister SSO Provider Script')
  console.log('====================================')
  console.log('This script removes SSO provider records from the database.\n')

  const success = await deregisterSSOProvider()

  if (success) {
    console.log('\nðŸŽ‰ SSO provider deregistration completed successfully!')
    process.exit(0)
  } else {
    console.log('\nðŸ’¥ SSO deregistration failed. Check the logs above for details.')
    process.exit(1)
  }
}

// Handle script execution
main().catch((error) => {
  logger.error('Script execution failed:', { error })
  process.exit(1)
})
```

--------------------------------------------------------------------------------

---[FILE: migrate-deployment-versions.ts]---
Location: sim-main/packages/db/scripts/migrate-deployment-versions.ts

```typescript
#!/usr/bin/env bun

// This script is intentionally self-contained for execution in the migrations image.
// Do not import from the main app code; duplicate minimal schema and DB setup here.

import { sql } from 'drizzle-orm'
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import { v4 as uuidv4 } from 'uuid'

// ---------- Minimal env helpers ----------
function getEnv(name: string): string | undefined {
  if (typeof process !== 'undefined' && process.env && name in process.env) {
    return process.env[name]
  }
  return undefined
}

const CONNECTION_STRING = getEnv('POSTGRES_URL') ?? getEnv('DATABASE_URL')
if (!CONNECTION_STRING) {
  console.error('Missing POSTGRES_URL or DATABASE_URL environment variable')
  process.exit(1)
}

// ---------- Minimal schema (only what we need) ----------
import { boolean, index, integer, json, jsonb, pgTable, text, timestamp } from 'drizzle-orm/pg-core'

// Tables referenced by the script
const workflow = pgTable(
  'workflow',
  {
    id: text('id').primaryKey(),
    userId: text('user_id').notNull(),
    name: text('name').notNull(),
    isDeployed: boolean('is_deployed').notNull().default(false),
    deployedState: json('deployed_state'),
    deployedAt: timestamp('deployed_at'),
  },
  (table) => ({
    userIdIdx: index('workflow_user_id_idx').on(table.userId),
  })
)

const workflowBlocks = pgTable(
  'workflow_blocks',
  {
    id: text('id').primaryKey(),
    workflowId: text('workflow_id').notNull(),
    type: text('type').notNull(),
    name: text('name').notNull(),
    positionX: text('position_x').notNull(),
    positionY: text('position_y').notNull(),
    enabled: boolean('enabled').notNull().default(true),
    horizontalHandles: boolean('horizontal_handles').notNull().default(true),
    isWide: boolean('is_wide').notNull().default(false),
    advancedMode: boolean('advanced_mode').notNull().default(false),
    triggerMode: boolean('trigger_mode').notNull().default(false),
    height: text('height').notNull().default('0'),
    subBlocks: jsonb('sub_blocks').notNull().default('{}'),
    outputs: jsonb('outputs').notNull().default('{}'),
    data: jsonb('data').default('{}'),
    parentId: text('parent_id'),
    extent: text('extent'),
    createdAt: timestamp('created_at').notNull().defaultNow(),
    updatedAt: timestamp('updated_at').notNull().defaultNow(),
  },
  (table) => ({
    workflowIdIdx: index('workflow_blocks_workflow_id_idx').on(table.workflowId),
  })
)

const workflowEdges = pgTable(
  'workflow_edges',
  {
    id: text('id').primaryKey(),
    workflowId: text('workflow_id').notNull(),
    sourceBlockId: text('source_block_id').notNull(),
    targetBlockId: text('target_block_id').notNull(),
    sourceHandle: text('source_handle'),
    targetHandle: text('target_handle'),
    createdAt: timestamp('created_at').notNull().defaultNow(),
  },
  (table) => ({
    workflowIdIdx: index('workflow_edges_workflow_id_idx').on(table.workflowId),
  })
)

const workflowSubflows = pgTable(
  'workflow_subflows',
  {
    id: text('id').primaryKey(),
    workflowId: text('workflow_id').notNull(),
    type: text('type').notNull(),
    config: jsonb('config').notNull().default('{}'),
    createdAt: timestamp('created_at').notNull().defaultNow(),
    updatedAt: timestamp('updated_at').notNull().defaultNow(),
  },
  (table) => ({
    workflowIdIdx: index('workflow_subflows_workflow_id_idx').on(table.workflowId),
  })
)

const workflowDeploymentVersion = pgTable(
  'workflow_deployment_version',
  {
    id: text('id').primaryKey(),
    workflowId: text('workflow_id').notNull(),
    version: integer('version').notNull(),
    state: json('state').notNull(),
    isActive: boolean('is_active').notNull().default(false),
    createdAt: timestamp('created_at').notNull().defaultNow(),
    createdBy: text('created_by'),
  },
  (table) => ({
    workflowIdIdx: index('workflow_deployment_version_workflow_id_idx').on(table.workflowId),
  })
)

// ---------- DB client ----------
const postgresClient = postgres(CONNECTION_STRING, {
  prepare: false,
  idle_timeout: 20,
  connect_timeout: 30,
  max: 10,
  onnotice: () => {},
})
const db = drizzle(postgresClient)

// ---------- Minimal types ----------
type WorkflowState = {
  blocks: Record<string, any>
  edges: Array<{
    id: string
    source: string
    target: string
    sourceHandle?: string | null
    targetHandle?: string | null
  }>
  loops: Record<string, any>
  parallels: Record<string, any>
}

// ---------- Normalized loader (inline of loadWorkflowFromNormalizedTables) ----------
async function loadWorkflowFromNormalizedTables(workflowId: string) {
  const [blocks, edges, subflows] = await Promise.all([
    db.select().from(workflowBlocks).where(sql`${workflowBlocks.workflowId} = ${workflowId}`),
    db.select().from(workflowEdges).where(sql`${workflowEdges.workflowId} = ${workflowId}`),
    db.select().from(workflowSubflows).where(sql`${workflowSubflows.workflowId} = ${workflowId}`),
  ])

  if (blocks.length === 0) return null

  const blocksMap: Record<string, any> = {}
  for (const block of blocks as any[]) {
    const parentId = (block.parentId as string | null) || null
    const extent = (block.extent as string | null) || null

    blocksMap[block.id] = {
      id: block.id,
      type: block.type,
      name: block.name,
      position: {
        x: Number(block.positionX),
        y: Number(block.positionY),
      },
      enabled: block.enabled,
      horizontalHandles: block.horizontalHandles,
      isWide: block.isWide,
      advancedMode: block.advancedMode,
      triggerMode: block.triggerMode,
      height: Number(block.height),
      subBlocks: block.subBlocks || {},
      outputs: block.outputs || {},
      data: {
        ...(block.data || {}),
        ...(parentId && { parentId }),
        ...(extent && { extent }),
      },
      parentId,
      extent,
    }
  }

  const edgesArray = (edges as any[]).map((edge) => ({
    id: edge.id,
    source: edge.sourceBlockId,
    target: edge.targetBlockId,
    sourceHandle: edge.sourceHandle,
    targetHandle: edge.targetHandle,
  }))

  const loops: Record<string, any> = {}
  const parallels: Record<string, any> = {}
  for (const sub of subflows as any[]) {
    const config = sub.config || {}
    if (sub.type === 'loop') {
      loops[sub.id] = { id: sub.id, ...config }
    } else if (sub.type === 'parallel') {
      parallels[sub.id] = { id: sub.id, ...config }
    }
  }

  return {
    blocks: blocksMap,
    edges: edgesArray,
    loops,
    parallels,
    isFromNormalizedTables: true,
  }
}

// ---------- Migration ----------
const DRY_RUN = process.argv.includes('--dry-run')
const BATCH_SIZE = 50

async function migrateWorkflows() {
  console.log('Starting deployment version migration...')
  console.log(`Mode: ${DRY_RUN ? 'DRY RUN' : 'LIVE'}`)
  console.log(`Batch size: ${BATCH_SIZE}`)
  console.log('---')

  try {
    const workflows = await db
      .select({
        id: workflow.id,
        name: workflow.name,
        isDeployed: workflow.isDeployed,
        deployedState: workflow.deployedState,
        deployedAt: workflow.deployedAt,
        userId: workflow.userId,
      })
      .from(workflow)

    console.log(`Found ${workflows.length} workflows to process`)

    const existingVersions = await db
      .select({ workflowId: workflowDeploymentVersion.workflowId })
      .from(workflowDeploymentVersion)

    const existingWorkflowIds = new Set(existingVersions.map((v) => v.workflowId as string))
    console.log(`${existingWorkflowIds.size} workflows already have deployment versions`)

    let successCount = 0
    let skipCount = 0
    let errorCount = 0

    for (let i = 0; i < workflows.length; i += BATCH_SIZE) {
      const batch = workflows.slice(i, i + BATCH_SIZE)
      console.log(
        `\nProcessing batch ${Math.floor(i / BATCH_SIZE) + 1} (workflows ${i + 1}-${Math.min(i + BATCH_SIZE, workflows.length)})`
      )

      const deploymentVersions: Array<{
        id: string
        workflowId: string
        version: number
        state: WorkflowState
        createdAt: Date
        createdBy: string
        isActive: boolean
      }> = []

      for (const wf of batch as any[]) {
        if (existingWorkflowIds.has(wf.id)) {
          console.log(`  [SKIP] ${wf.id} (${wf.name}) - already has deployment version`)
          skipCount++
          continue
        }

        let state: WorkflowState | null = null

        if (wf.deployedState) {
          state = wf.deployedState as WorkflowState
          console.log(`  [DEPLOYED] ${wf.id} (${wf.name}) - using existing deployedState`)
        } else {
          const normalized = await loadWorkflowFromNormalizedTables(wf.id)
          if (normalized) {
            state = {
              blocks: normalized.blocks,
              edges: normalized.edges,
              loops: normalized.loops,
              parallels: normalized.parallels,
            }
            console.log(
              `  [NORMALIZED] ${wf.id} (${wf.name}) - loaded from normalized tables (was deployed: ${wf.isDeployed})`
            )
          } else {
            console.log(`  [SKIP] ${wf.id} (${wf.name}) - no state available`)
            skipCount++
            continue
          }
        }

        if (state) {
          deploymentVersions.push({
            id: uuidv4(),
            workflowId: wf.id,
            version: 1,
            state,
            createdAt: wf.deployedAt || new Date(),
            createdBy: wf.userId || 'migration',
            isActive: true,
          })
          successCount++
        }
      }

      if (deploymentVersions.length > 0) {
        if (DRY_RUN) {
          console.log(`  [DRY RUN] Would insert ${deploymentVersions.length} deployment versions`)
          console.log(`  [DRY RUN] Would mark ${deploymentVersions.length} workflows as deployed`)
        } else {
          try {
            await db.insert(workflowDeploymentVersion).values(deploymentVersions)
            console.log(`  [SUCCESS] Inserted ${deploymentVersions.length} deployment versions`)

            const workflowIds = deploymentVersions.map((v) => v.workflowId)
            await db
              .update(workflow)
              .set({
                isDeployed: true,
                deployedAt: new Date(),
              })
              .where(
                sql`${workflow.id} IN (${sql.join(
                  workflowIds.map((id) => sql`${id}`),
                  sql`, `
                )})`
              )
            console.log(`  [SUCCESS] Marked ${workflowIds.length} workflows as deployed`)
          } catch (error) {
            console.error(`  [ERROR] Failed to insert batch:`, error)
            errorCount += deploymentVersions.length
            successCount -= deploymentVersions.length
          }
        }
      }
    }

    console.log('\n---')
    console.log('Migration Summary:')
    console.log(`  Success: ${successCount} workflows`)
    console.log(`  Skipped: ${skipCount} workflows`)
    console.log(`  Errors: ${errorCount} workflows`)

    if (DRY_RUN) {
      console.log('\n[DRY RUN] No changes were made to the database.')
      console.log('Run without --dry-run flag to apply changes.')
    } else {
      console.log('\nMigration completed successfully!')
    }
  } catch (error) {
    console.error('Fatal error during migration:', error)
    process.exit(1)
  } finally {
    try {
      await postgresClient.end({ timeout: 5 })
    } catch {}
  }
}

migrateWorkflows()
  .then(() => {
    console.log('\nDone!')
    process.exit(0)
  })
  .catch((error) => {
    console.error('Unexpected error:', error)
    process.exit(1)
  })
```

--------------------------------------------------------------------------------

````
