---
source_txt: fullstack_samples/zulip-main
converted_utc: 2025-12-18T13:06:13Z
part: 444
parts_total: 1290
---

# FULLSTACK CODE DATABASE SAMPLES zulip-main

## Verbatim Content (Part 444 of 1290)

````text
================================================================================
FULLSTACK SAMPLES CODE DATABASE (VERBATIM) - zulip-main
================================================================================
Generated: December 18, 2025
Source: fullstack_samples/zulip-main
================================================================================

NOTES:
- This output is verbatim because the source is user-owned.
- Large/binary files may be skipped by size/binary detection limits.

================================================================================

---[FILE: zulip.template.erb]---
Location: zulip-main/puppet/zulip/templates/logrotate/zulip.template.erb

```text
# Logfiles generated by Django understand logrotate's standard
# "create" functionality, via logging.handlers.WatchedFileHandler

/var/log/zulip/analytics.log
/var/log/zulip/auth.log
/var/log/zulip/digest.log
/var/log/zulip/email_deliverer.log
/var/log/zulip/email_content.log
/var/log/zulip/email_mirror.log
/var/log/zulip/errors.log
/var/log/zulip/ldap.log
/var/log/zulip/manage.log
/var/log/zulip/message_retention.log
/var/log/zulip/deliver_scheduled_messages.log
/var/log/zulip/send_email.log
/var/log/zulip/slow_queries.log
/var/log/zulip/soft_deactivation.log
/var/log/zulip/sync_ldap_user_data.log
/var/log/zulip/webhooks_errors.log
/var/log/zulip/webhooks_unsupported_events.log
/var/log/zulip/workers.log
{
    missingok
    rotate 3
    size 25M
    compress
    delaycompress
    notifempty
    create 644 zulip zulip
}

/var/log/zulip/server.log
{
    missingok
    rotate <%= @access_log_retention_days %>
    daily
    compress
    delaycompress
    notifempty
    create 644 zulip zulip
}

# Logfiles generated from supervisor _do not_ understand logrotate,
# and thus must use copytruncate.  They also must not use supervisor's
# built-in log rotation.
/var/log/zulip/tornado-*.log
/var/log/zulip/tornado.log
/var/log/zulip/tusd.log
{
    missingok
    rotate <%= @access_log_retention_days %>
    daily
    compress
    delaycompress
    notifempty
    copytruncate
}
```

--------------------------------------------------------------------------------

---[FILE: healthcheck.conf.template.erb]---
Location: zulip-main/puppet/zulip/templates/nginx/healthcheck.conf.template.erb

```text
location /health {
    allow 127.0.0.1;
    allow ::1;

<% @loadbalancers.each do |host| -%>
    allow <%= host %>;
<% end -%>

    deny all;

    include uwsgi_params;
}
```

--------------------------------------------------------------------------------

---[FILE: s3-cache.template.erb]---
Location: zulip-main/puppet/zulip/templates/nginx/s3-cache.template.erb

```text
# nginx does its own DNS resolution, which is necessary here to
# resolve the IP of the S3 server.  Point it at whatever is configured
# first in /etc/resolv.conf.  The validity duration is set to match
# S3's DNS validity.
resolver <%= @nginx_resolver_ip %> valid=300s;
resolver_timeout 10s;

# This cache is only used if S3 file storage is configured.
proxy_cache_path /srv/zulip-uploaded-files-cache
    levels=1:2
    keys_zone=uploads:<%= @s3_memory_cache_size %>
    inactive=<%= @s3_cache_inactive_time %>
    max_size=<%= @s3_disk_cache_size %>;

# This is used when proxying requests to S3; we wish to know if the
# proxied request is asking to override the Content-Disposition in its
# response, so we can adjust our cache key.  Unfortunately, $arg_foo
# style variables pre-parsed from query parameters don't work with
# query parameters with dashes, so we parse it out by hand.  Despite
# needing to be declared at the 'http' level,. nginx applies maps like
# this lazily, so this only affects internal S3 proxied requests.

map $args $s3_disposition_cache_key {
    default "";
    "~(^|&)(?<param>response-content-disposition=[^&]+)" "?$param";
}
```

--------------------------------------------------------------------------------

---[FILE: tornado-upstreams.conf.template.erb]---
Location: zulip-main/puppet/zulip/templates/nginx/tornado-upstreams.conf.template.erb

```text
<% if @tornado_ports.length > 1 -%>
<% @tornado_ports.each do |port| -%>
upstream tornado<%= port %> {
    server 127.0.0.1:<%= port %>;
    keepalive 10000;
}
<% end -%>
<% @tornado_groups.each do |group| -%>
<% if group.length > 1 -%>
upstream tornado<%= group.join('_') %> {
    random;
<% group.each do |port| -%>
    server 127.0.0.1:<%= port %>;
<% end -%>
    keepalive 10000;
}
<% end -%>
<% end -%>
<% else -%>
upstream tornado {
    server 127.0.0.1:9800;
    keepalive 10000;
}
<% end -%>
```

--------------------------------------------------------------------------------

---[FILE: trusted-proto.template.erb]---
Location: zulip-main/puppet/zulip/templates/nginx/trusted-proto.template.erb

```text
<% if @loadbalancers.empty? %>
# "set" is not supported at the server level, so use a map:
map $remote_addr $trusted_x_forwarded_proto {
    default $scheme;
}
map "$scheme:$http_x_forwarded_for" $x_proxy_misconfiguration {
    "~^https?:." "No proxies configured in Zulip, but reverse proxy headers were detected from $remote_addr; Zulip must be configured with the IP addresses of reverse proxies to trust.  See https://zulip.readthedocs.io/en/latest/production/reverse-proxies.html";
    "~^http:$" "Request came in over HTTP, with no proxy headers; if HTTPS is disabled in Zulip, it must be behind a proxy which does TLS termination.  See https://zulip.readthedocs.io/en/latest/production/reverse-proxies.html";
    default "";
}
<% else %>
# Check if the request's original `REMOTE_ADDR` header was from a
# trusted host -- that is, the request did bounce through a proxy and
# we should trust `X-Forwarded-Proto`
geo $realip_remote_addr $is_x_forwarded_proto_trusted {
    default 0;
<% @loadbalancers.each do |host| -%>
    <%= host %> 1;
<% end -%>
}

# Check if the IP address that we resolved the request as coming
# (after looking at X-Forwarded-For, if any) from is actually the proxy
# itself.
geo $remote_addr $is_from_proxy {
    default 0;
<% @loadbalancers.each do |host| -%>
    <%= host %> 1;
<% end -%>
}

# We set $trusted_x_forwarded_proto in two steps because `geo` does
# not support variable interpolation in the value, but does support
# CIDR notation, which the loadbalancer list may use.
map "$is_x_forwarded_proto_trusted:$http_x_forwarded_proto" $trusted_x_forwarded_proto {
    "~^0:" $scheme;
<%- if @lb_rejects_http_requests -%>
    "~^1:$" "https";
<% end -%>
    "~^1:" $http_x_forwarded_proto;
}

map "$is_from_proxy:$is_x_forwarded_proto_trusted:$http_x_forwarded_proto" $x_proxy_misconfiguration {
    "~^0:0:" "Incorrect reverse proxy IPs set in Zulip (try $remote_addr?); see https://zulip.readthedocs.io/en/latest/production/reverse-proxies.html";
<%- if not @lb_rejects_http_requests -%>
    "~^0:1:$" "No X-Forwarded-Proto header sent from trusted proxy $realip_remote_addr; see example configurations in https://zulip.readthedocs.io/en/latest/production/reverse-proxies.html";
<% end -%>
    default "";
}
<% end %>
```

--------------------------------------------------------------------------------

---[FILE: zulip-enterprise.template.erb]---
Location: zulip-main/puppet/zulip/templates/nginx/zulip-enterprise.template.erb

```text
# For local IPC -- tusd to Django, or Django to Tornado
server {
<% if @nginx_http_only -%>
    listen 127.0.0.1:<%= @nginx_listen_port %>;
<% else -%>
    listen 127.0.0.1:80;
<% end -%>
    include /etc/nginx/zulip-include/app;
    include /etc/nginx/zulip-include/localhost.d/*.conf;
}


<% if @nginx_http_only -%>
<% else -%>
server {
    listen 80;
    listen [::]:80;

    location / {
        return 301 https://$host$request_uri;
    }

    include /etc/nginx/zulip-include/certbot;
}
<% end -%>

include /etc/nginx/zulip-include/trusted-proto;
include /etc/nginx/zulip-include/s3-cache;
include /etc/nginx/zulip-include/upstreams;
include /etc/zulip/nginx_sharding_map.conf;


server {
<% if @nginx_http_only -%>
    listen <%= @nginx_listen_port %>;
    listen [::]:<%= @nginx_listen_port %>;
<% else -%>
    listen <%= @nginx_listen_port %> ssl http2;
    listen [::]:<%= @nginx_listen_port %> ssl http2;

    ssl_certificate <%= @ssl_dir %>/certs/zulip.combined-chain.crt;
    ssl_certificate_key <%= @ssl_dir %>/private/zulip.key;
<% end -%>

    include /etc/nginx/zulip-include/certbot;
    include /etc/nginx/zulip-include/app;
}
```

--------------------------------------------------------------------------------

---[FILE: zulip.conf.template.erb]---
Location: zulip-main/puppet/zulip/templates/postgresql/zulip.conf.template.erb

```text
<% unless @listen_addresses.nil? -%>
# Bind to specific address
listen_addresses = <%= @listen_addresses %>
<% end -%>

# This has an improved set of stopwords.
default_text_search_config = 'zulip.english_us_search'

# Provide more comprehensive on-disk logs
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 7d
log_rotation_size = 100MB
log_min_duration_statement = 500
log_line_prefix = '%m [%c]: [%l-1] '
log_checkpoints = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 100

# Adjust autovacuum for having many mostly-append-only tables
autovacuum_freeze_max_age = 2000000000
vacuum_freeze_min_age     = 1000000000
vacuum_freeze_table_age   = 1800000000

# Performance settings
max_connections = 1000
maintenance_work_mem = <%= @maintenance_work_mem %>
effective_cache_size = <%= @effective_cache_size %>
work_mem = <%= @work_mem %>
shared_buffers = <%= @shared_buffers %>
<% unless @wal_buffers.nil? -%>
wal_buffers = <%= @wal_buffers %>
<% end -%>
<% unless @min_wal_size.nil? -%>
min_wal_size = <%= @min_wal_size %>
<% end -%>
<% unless @max_wal_size.nil? -%>
max_wal_size = <%= @max_wal_size %>
<% end -%>
<% unless @random_page_cost.nil? -%>
random_page_cost = <%= @random_page_cost %>
<% end -%>
<% unless @effective_io_concurrency.nil? -%>
effective_io_concurrency = <%= @effective_io_concurrency %>
<% end -%>
<% unless @max_worker_processes.nil? -%>
max_worker_processes = <%= @max_worker_processes %>
<% end -%>
<% unless @max_parallel_workers_per_gather.nil? -%>
max_parallel_workers_per_gather = <%= @max_parallel_workers_per_gather %>
<% end -%>
<% unless @max_parallel_workers.nil? -%>
max_parallel_workers = <%= @max_parallel_workers %>
<% end -%>
<% unless @max_parallel_maintenance_workers.nil? -%>
max_parallel_maintenance_workers = <%= @max_parallel_maintenance_workers %>
<% end -%>

<% if @s3_backups_bucket != '' -%>
# WAL backups to S3 (may also be used for replication)
archive_mode = on
archive_command = '/usr/bin/timeout 10m /usr/local/bin/env-wal-g wal-push %p'
restore_command = '/usr/local/bin/env-wal-g wal-fetch "%f" "%p"'
<% end -%>
<% unless @replication_primary.nil? || @replication_user.nil? -%>
# Streaming replication
primary_conninfo = 'host=<%= @replication_primary %> user=<%= @replication_user -%>
<% if @replication_password != '' %> password=<%= @replication_password %><% end -%>
<% unless @ssl_mode.nil? %> sslmode=<%= @ssl_mode %><% end -%>
'
<% end -%>

<% unless @ssl_cert_file.nil? -%>
ssl_cert_file = '<%= @ssl_cert_file %>'
<% end -%>
<% unless @ssl_key_file.nil? -%>
ssl_key_file = '<%= @ssl_key_file %>'
<% end -%>
<% unless @ssl_ca_file.nil? -%>
ssl_ca_file = '<%= @ssl_ca_file %>'
<% end -%>
```

--------------------------------------------------------------------------------

````
